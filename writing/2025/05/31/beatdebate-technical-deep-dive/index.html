<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=../../19/concept-visualizer-technical-deep-dive/ rel=prev><link rel=icon href=../../../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.14"><title>BeatDebate â€” Technical Deep Dive - SulmanK Blog</title><link rel=stylesheet href=../../../../../assets/stylesheets/main.342714a4.min.css><link rel=stylesheet href=../../../../../assets/stylesheets/palette.06af60db.min.css><style>:root{--md-admonition-icon--note:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M1%207.775V2.75C1%201.784%201.784%201%202.75%201h5.025c.464%200%20.91.184%201.238.513l6.25%206.25a1.75%201.75%200%200%201%200%202.474l-5.026%205.026a1.75%201.75%200%200%201-2.474%200l-6.25-6.25A1.75%201.75%200%200%201%201%207.775m1.5%200c0%20.066.026.13.073.177l6.25%206.25a.25.25%200%200%200%20.354%200l5.025-5.025a.25.25%200%200%200%200-.354l-6.25-6.25a.25.25%200%200%200-.177-.073H2.75a.25.25%200%200%200-.25.25ZM6%205a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E');--md-admonition-icon--abstract:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2.5%201.75v11.5c0%20.138.112.25.25.25h3.17a.75.75%200%200%201%200%201.5H2.75A1.75%201.75%200%200%201%201%2013.25V1.75C1%20.784%201.784%200%202.75%200h8.5C12.216%200%2013%20.784%2013%201.75v7.736a.75.75%200%200%201-1.5%200V1.75a.25.25%200%200%200-.25-.25h-8.5a.25.25%200%200%200-.25.25m13.274%209.537zl-4.557%204.45a.75.75%200%200%201-1.055-.008l-1.943-1.95a.75.75%200%200%201%201.062-1.058l1.419%201.425%204.026-3.932a.75.75%200%201%201%201.048%201.074M4.75%204h4.5a.75.75%200%200%201%200%201.5h-4.5a.75.75%200%200%201%200-1.5M4%207.75A.75.75%200%200%201%204.75%207h2a.75.75%200%200%201%200%201.5h-2A.75.75%200%200%201%204%207.75%22/%3E%3C/svg%3E');--md-admonition-icon--info:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M0%208a8%208%200%201%201%2016%200A8%208%200%200%201%200%208m8-6.5a6.5%206.5%200%201%200%200%2013%206.5%206.5%200%200%200%200-13M6.5%207.75A.75.75%200%200%201%207.25%207h1a.75.75%200%200%201%20.75.75v2.75h.25a.75.75%200%200%201%200%201.5h-2a.75.75%200%200%201%200-1.5h.25v-2h-.25a.75.75%200%200%201-.75-.75M8%206a1%201%200%201%201%200-2%201%201%200%200%201%200%202%22/%3E%3C/svg%3E');--md-admonition-icon--tip:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M3.499.75a.75.75%200%200%201%201.5%200v.996C5.9%202.903%206.793%203.65%207.662%204.376l.24.202c-.036-.694.055-1.422.426-2.163C9.1.873%2010.794-.045%2012.622.26%2014.408.558%2016%201.94%2016%204.25c0%201.278-.954%202.575-2.44%202.734l.146.508.065.22c.203.701.412%201.455.476%202.226.142%201.707-.4%203.03-1.487%203.898C11.714%2014.671%2010.27%2015%208.75%2015h-6a.75.75%200%200%201%200-1.5h1.376a4.5%204.5%200%200%201-.563-1.191%203.84%203.84%200%200%201-.05-2.063%204.65%204.65%200%200%201-2.025-.293.75.75%200%200%201%20.525-1.406c1.357.507%202.376-.006%202.698-.318l.009-.01a.747.747%200%200%201%201.06%200%20.75.75%200%200%201-.012%201.074c-.912.92-.992%201.835-.768%202.586.221.74.745%201.337%201.196%201.621H8.75c1.343%200%202.398-.296%203.074-.836.635-.507%201.036-1.31.928-2.602-.05-.603-.216-1.224-.422-1.93l-.064-.221c-.12-.407-.246-.84-.353-1.29a2.4%202.4%200%200%201-.507-.441%203.1%203.1%200%200%201-.633-1.248.75.75%200%200%201%201.455-.364c.046.185.144.436.31.627.146.168.353.305.712.305.738%200%201.25-.615%201.25-1.25%200-1.47-.95-2.315-2.123-2.51-1.172-.196-2.227.387-2.706%201.345-.46.92-.27%201.774.019%203.062l.042.19.01.05c.348.443.666.949.94%201.553a.75.75%200%201%201-1.365.62c-.553-1.217-1.32-1.94-2.3-2.768L6.7%205.527c-.814-.68-1.75-1.462-2.692-2.619a3.7%203.7%200%200%200-1.023.88c-.406.495-.663%201.036-.722%201.508.116.122.306.21.591.239.388.038.797-.06%201.032-.19a.75.75%200%200%201%20.728%201.31c-.515.287-1.23.439-1.906.373-.682-.067-1.473-.38-1.879-1.193L.75%205.677V5.5c0-.984.48-1.94%201.077-2.664.46-.559%201.05-1.055%201.673-1.353z%22/%3E%3C/svg%3E');--md-admonition-icon--success:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M13.78%204.22a.75.75%200%200%201%200%201.06l-7.25%207.25a.75.75%200%200%201-1.06%200L2.22%209.28a.75.75%200%200%201%20.018-1.042.75.75%200%200%201%201.042-.018L6%2010.94l6.72-6.72a.75.75%200%200%201%201.06%200%22/%3E%3C/svg%3E');--md-admonition-icon--question:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M0%208a8%208%200%201%201%2016%200A8%208%200%200%201%200%208m8-6.5a6.5%206.5%200%201%200%200%2013%206.5%206.5%200%200%200%200-13M6.92%206.085h.001a.749.749%200%201%201-1.342-.67c.169-.339.436-.701.849-.977C6.845%204.16%207.369%204%208%204a2.76%202.76%200%200%201%201.637.525c.503.377.863.965.863%201.725%200%20.448-.115.83-.329%201.15-.205.307-.47.513-.692.662-.109.072-.22.138-.313.195l-.006.004a6%206%200%200%200-.26.16%201%201%200%200%200-.276.245.75.75%200%200%201-1.248-.832c.184-.264.42-.489.692-.661q.154-.1.313-.195l.007-.004c.1-.061.182-.11.258-.161a1%201%200%200%200%20.277-.245C8.96%206.514%209%206.427%209%206.25a.61.61%200%200%200-.262-.525A1.27%201.27%200%200%200%208%205.5c-.369%200-.595.09-.74.187a1%201%200%200%200-.34.398M9%2011a1%201%200%201%201-2%200%201%201%200%200%201%202%200%22/%3E%3C/svg%3E');--md-admonition-icon--warning:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M6.457%201.047c.659-1.234%202.427-1.234%203.086%200l6.082%2011.378A1.75%201.75%200%200%201%2014.082%2015H1.918a1.75%201.75%200%200%201-1.543-2.575Zm1.763.707a.25.25%200%200%200-.44%200L1.698%2013.132a.25.25%200%200%200%20.22.368h12.164a.25.25%200%200%200%20.22-.368Zm.53%203.996v2.5a.75.75%200%200%201-1.5%200v-2.5a.75.75%200%200%201%201.5%200M9%2011a1%201%200%201%201-2%200%201%201%200%200%201%202%200%22/%3E%3C/svg%3E');--md-admonition-icon--failure:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2.344%202.343za8%208%200%200%201%2011.314%2011.314A8.002%208.002%200%200%201%20.234%2010.089a8%208%200%200%201%202.11-7.746m1.06%2010.253a6.5%206.5%200%201%200%209.108-9.275%206.5%206.5%200%200%200-9.108%209.275M6.03%204.97%208%206.94l1.97-1.97a.749.749%200%200%201%201.275.326.75.75%200%200%201-.215.734L9.06%208l1.97%201.97a.749.749%200%200%201-.326%201.275.75.75%200%200%201-.734-.215L8%209.06l-1.97%201.97a.749.749%200%200%201-1.275-.326.75.75%200%200%201%20.215-.734L6.94%208%204.97%206.03a.75.75%200%200%201%20.018-1.042.75.75%200%200%201%201.042-.018%22/%3E%3C/svg%3E');--md-admonition-icon--danger:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M9.504.43a1.516%201.516%200%200%201%202.437%201.713L10.415%205.5h2.123c1.57%200%202.346%201.909%201.22%203.004l-7.34%207.142a1.25%201.25%200%200%201-.871.354h-.302a1.25%201.25%200%200%201-1.157-1.723L5.633%2010.5H3.462c-1.57%200-2.346-1.909-1.22-3.004zm1.047%201.074L3.286%208.571A.25.25%200%200%200%203.462%209H6.75a.75.75%200%200%201%20.694%201.034l-1.713%204.188%206.982-6.793A.25.25%200%200%200%2012.538%207H9.25a.75.75%200%200%201-.683-1.06l2.008-4.418.003-.006-.004-.009-.006-.006-.008-.001q-.005%200-.009.004%22/%3E%3C/svg%3E');--md-admonition-icon--bug:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M4.72.22a.75.75%200%200%201%201.06%200l1%20.999a3.5%203.5%200%200%201%202.441%200l.999-1a.748.748%200%200%201%201.265.332.75.75%200%200%201-.205.729l-.775.776c.616.63.995%201.493.995%202.444v.327q0%20.15-.025.292c.408.14.764.392%201.029.722l1.968-.787a.75.75%200%200%201%20.556%201.392L13%207.258V9h2.25a.75.75%200%200%201%200%201.5H13v.5q-.002.615-.141%201.186l2.17.868a.75.75%200%200%201-.557%201.392l-2.184-.873A5%205%200%200%201%208%2016a5%205%200%200%201-4.288-2.427l-2.183.873a.75.75%200%200%201-.558-1.392l2.17-.868A5%205%200%200%201%203%2011v-.5H.75a.75.75%200%200%201%200-1.5H3V7.258L.971%206.446a.75.75%200%200%201%20.558-1.392l1.967.787c.265-.33.62-.583%201.03-.722a1.7%201.7%200%200%201-.026-.292V4.5c0-.951.38-1.814.995-2.444L4.72%201.28a.75.75%200%200%201%200-1.06m.53%206.28a.75.75%200%200%200-.75.75V11a3.5%203.5%200%201%200%207%200V7.25a.75.75%200%200%200-.75-.75ZM6.173%205h3.654A.17.17%200%200%200%2010%204.827V4.5a2%202%200%201%200-4%200v.327c0%20.096.077.173.173.173%22/%3E%3C/svg%3E');--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5%205.782V2.5h-.25a.75.75%200%200%201%200-1.5h6.5a.75.75%200%200%201%200%201.5H11v3.282l3.666%205.76C15.619%2013.04%2014.543%2015%2012.767%2015H3.233c-1.776%200-2.852-1.96-1.899-3.458Zm-2.4%206.565a.75.75%200%200%200%20.633%201.153h9.534a.75.75%200%200%200%20.633-1.153L12.225%2010.5h-8.45ZM9.5%202.5h-3V6c0%20.143-.04.283-.117.403L4.73%209h6.54L9.617%206.403A.75.75%200%200%201%209.5%206Z%22/%3E%3C/svg%3E');--md-admonition-icon--quote:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M1.75%202.5h10.5a.75.75%200%200%201%200%201.5H1.75a.75.75%200%200%201%200-1.5m4%205h8.5a.75.75%200%200%201%200%201.5h-8.5a.75.75%200%200%201%200-1.5m0%205h8.5a.75.75%200%200%201%200%201.5h-8.5a.75.75%200%200%201%200-1.5M2.5%207.75v6a.75.75%200%200%201-1.5%200v-6a.75.75%200%200%201%201.5%200%22/%3E%3C/svg%3E');}</style><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../../../assets/_mkdocstrings.css><script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><link href=../../../../../assets/stylesheets/glightbox.min.css rel=stylesheet><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style><script src=../../../../../assets/javascripts/glightbox.min.js></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=black data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#beatdebate-technical-deep-dive class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../../.. title="SulmanK Blog" class="md-header__button md-logo" aria-label="SulmanK Blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> SulmanK Blog </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> BeatDebate â€” Technical Deep Dive </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/SulmanK/blog/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> blog </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../../.. class=md-tabs__link> Home </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../../../ class=md-tabs__link> Writing </a> </li> <li class=md-tabs__item> <a href=../../../../../contact/ class=md-tabs__link> Contact </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation hidden> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../../.. title="SulmanK Blog" class="md-nav__button md-logo" aria-label="SulmanK Blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> SulmanK Blog </label> <div class=md-nav__source> <a href=https://github.com/SulmanK/blog/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> blog </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <div class="md-nav__link md-nav__container"> <a href=../../../../ class="md-nav__link "> <span class=md-ellipsis> Writing </span> </a> <label class="md-nav__link " for=__nav_2 id=__nav_2_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Writing </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex> <span class=md-ellipsis> Archive </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Archive </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../archive/2025/ class=md-nav__link> <span class=md-ellipsis> 2025 </span> </a> </li> <li class=md-nav__item> <a href=../../../../archive/2024/ class=md-nav__link> <span class=md-ellipsis> 2024 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex> <span class=md-ellipsis> Categories </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Categories </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../category/ai/ class=md-nav__link> <span class=md-ellipsis> AI </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/agent/ class=md-nav__link> <span class=md-ellipsis> Agent </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/agentic-workflow/ class=md-nav__link> <span class=md-ellipsis> Agentic Workflow </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/cloud-architecture/ class=md-nav__link> <span class=md-ellipsis> Cloud Architecture </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/data-engineering/ class=md-nav__link> <span class=md-ellipsis> Data Engineering </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/data-science/ class=md-nav__link> <span class=md-ellipsis> Data Science </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/deep-learning-recommendation-models/ class=md-nav__link> <span class=md-ellipsis> Deep Learning Recommendation Models </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/exploratory-data-analysis/ class=md-nav__link> <span class=md-ellipsis> Exploratory Data Analysis </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/fastapi/ class=md-nav__link> <span class=md-ellipsis> FastAPI </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/full-stack/ class=md-nav__link> <span class=md-ellipsis> Full Stack </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/gcp/ class=md-nav__link> <span class=md-ellipsis> GCP </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/llms/ class=md-nav__link> <span class=md-ellipsis> LLMs </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/ml/ class=md-nav__link> <span class=md-ellipsis> ML </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/machine-learning/ class=md-nav__link> <span class=md-ellipsis> Machine Learning </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/model-selection/ class=md-nav__link> <span class=md-ellipsis> Model Selection </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/music-technology/ class=md-nav__link> <span class=md-ellipsis> Music Technology </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/react/ class=md-nav__link> <span class=md-ellipsis> React </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/recsys-challenge-2024/ class=md-nav__link> <span class=md-ellipsis> RecSys Challenge 2024 </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/recommendation-systems/ class=md-nav__link> <span class=md-ellipsis> Recommendation Systems </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/recommender-systems/ class=md-nav__link> <span class=md-ellipsis> Recommender Systems </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/terraform/ class=md-nav__link> <span class=md-ellipsis> Terraform </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/web-development/ class=md-nav__link> <span class=md-ellipsis> Web Development </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/cloud/ class=md-nav__link> <span class=md-ellipsis> cloud </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/end-to-end-pipeline/ class=md-nav__link> <span class=md-ellipsis> end-to-end pipeline </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../../contact/ class=md-nav__link> <span class=md-ellipsis> Contact </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> <nav class=md-nav aria-label=Introduction> <ul class=md-nav__list> <li class=md-nav__item> <a href=#what-youll-learn class=md-nav__link> <span class=md-ellipsis> What youâ€™ll learn </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#system-architecture class=md-nav__link> <span class=md-ellipsis> System Architecture </span> </a> </li> <li class=md-nav__item> <a href=#scoring-ranking-the-judges-deliberation class=md-nav__link> <span class=md-ellipsis> Scoring &amp; Ranking: The Judge's Deliberation </span> </a> <nav class=md-nav aria-label="Scoring & Ranking: The Judge's Deliberation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#stage-1-component-based-scoring class=md-nav__link> <span class=md-ellipsis> Stage 1: Component-Based Scoring </span> </a> </li> <li class=md-nav__item> <a href=#stage-2-intent-aware-ranking class=md-nav__link> <span class=md-ellipsis> Stage 2: Intent-Aware Ranking </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#getting-started class=md-nav__link> <span class=md-ellipsis> Getting Started </span> </a> </li> <li class=md-nav__item> <a href=#1-the-backend-fastapi-langgraph-and-an-llm-planner class=md-nav__link> <span class=md-ellipsis> 1. The Backend: FastAPI, LangGraph, and an LLM Planner </span> </a> <nav class=md-nav aria-label="1. The Backend: FastAPI, LangGraph, and an LLM Planner"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#key-components-technologies class=md-nav__link> <span class=md-ellipsis> Key Components &amp; Technologies </span> </a> <nav class=md-nav aria-label="Key Components & Technologies"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#fastapi class=md-nav__link> <span class=md-ellipsis> FastAPI </span> </a> </li> <li class=md-nav__item> <a href=#langgraph class=md-nav__link> <span class=md-ellipsis> LangGraph </span> </a> </li> <li class=md-nav__item> <a href=#pydantic class=md-nav__link> <span class=md-ellipsis> Pydantic </span> </a> </li> <li class=md-nav__item> <a href=#layered-architecture class=md-nav__link> <span class=md-ellipsis> Layered Architecture </span> </a> <nav class=md-nav aria-label="Layered Architecture"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#api-layer class=md-nav__link> <span class=md-ellipsis> API Layer </span> </a> </li> <li class=md-nav__item> <a href=#agent-layer class=md-nav__link> <span class=md-ellipsis> Agent Layer </span> </a> </li> <li class=md-nav__item> <a href=#services class=md-nav__link> <span class=md-ellipsis> Services </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-the-frontend-gradio-for-interactive-music-discovery class=md-nav__link> <span class=md-ellipsis> 2. The Frontend: Gradio for Interactive Music Discovery </span> </a> <nav class=md-nav aria-label="2. The Frontend: Gradio for Interactive Music Discovery"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#key-ui-components-features class=md-nav__link> <span class=md-ellipsis> Key UI Components &amp; Features </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#conclusion class=md-nav__link> <span class=md-ellipsis> Conclusion </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-content md-content--post" data-md-component=content> <div class="md-sidebar md-sidebar--post" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class="md-sidebar__inner md-post"> <nav class="md-nav md-nav--primary"> <div class=md-post__back> <div class="md-nav__title md-nav__container"> <a href=../../../../ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> <span class=md-ellipsis> Back to index </span> </a> </div> </div> <div class="md-post__authors md-typeset"> <div class="md-profile md-post__profile"> <span class="md-author md-author--long"> <img src="https://avatars.githubusercontent.com/u/43801845?v=4" alt="Sulman Khan"> </span> <span class=md-profile__description> <strong> <a href=https://github.com/SulmanK>Sulman Khan</a> </strong> <br> Creator </span> </div> </div> <ul class="md-post__meta md-nav__list"> <li class="md-nav__item md-nav__item--section"> <div class=md-post__title> <span class=md-ellipsis> Metadata </span> </div> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg> <time datetime="2025-05-31 00:00:00+00:00" class=md-ellipsis>2025/05/31</time> </div> </li> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg> <span class=md-ellipsis> in <a href=../../../../category/ai/ >AI</a>, <a href=../../../../category/agent/ >Agent</a>, <a href=../../../../category/agentic-workflow/ >Agentic Workflow</a>, <a href=../../../../category/music-technology/ >Music Technology</a>, <a href=../../../../category/machine-learning/ >Machine Learning</a>, <a href=../../../../category/recommender-systems/ >Recommender Systems</a>, <a href=../../../../category/full-stack/ >Full Stack</a></span> </div> </li> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg> <span class=md-ellipsis> 19 min read </span> </div> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <article class="md-content__inner md-typeset"> <a href=https://github.com/SulmanK/blog/edit/master/docs/writing/posts/beatdebate.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75z"/></svg> </a> <a href=https://github.com/SulmanK/blog/raw/master/docs/writing/posts/beatdebate.md title="View source of this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5"/></svg> </a> <h1 id=beatdebate-technical-deep-dive>BeatDebate â€” Technical Deep Dive<a class=headerlink href=#beatdebate-technical-deep-dive title="Permanent link">&para;</a></h1> <h2 id=introduction>Introduction<a class=headerlink href=#introduction title="Permanent link">&para;</a></h2> <div class="admonition abstract"> <p class=admonition-title>Purpose</p> <p>BeatDebate is a proof-of-concept web app that shows how a <strong>large-language-model (LLM) planner</strong> can orchestrate specialised agents to deliver transparent, long-tail music recommendations in under seven seconds. </p> <p>Check out the <a href=https://github.com/SulmanK/BeatDebate>project GitHub repository</a> for the full code and detailed documentation. Here is the <a href=https://huggingface.co/spaces/SulmanK/BeatDebate>web application</a>. Check out the AgentX <a href=https://llmagents-learning.org/sp25>course</a>.</p> </div> <div class="admonition info"> <p class=admonition-title>Problem Statement</p> <p>Standard collaborative-filtering pipelines optimise clicks but amplify popularity bias and tell listeners nothing about <em>why</em> a song appears. BeatDebate flips the workflow: first an LLM writes an explicit machine-readable plan, then lightweight agents execute it, and finally a Judge agent converts plan weights into human-readable explanations.</p> </div> <h3 id=what-youll-learn><strong>What youâ€™ll learn</strong><a class=headerlink href=#what-youll-learn title="Permanent link">&para;</a></h3> <ul> <li><strong>Designing an LLM-planned recommender</strong> â€” externalising reasoning as JSON so downstream agents become cheap and debuggable. </li> <li><strong>Using LangGraph for agent orchestration</strong> â€” a typed DAG with retries, time-outs, and state-passing. </li> <li><strong>Balancing novelty and relevance</strong> with dual advocate agents (Genre-Mood vs. Discovery). </li> <li><strong>Generating explanations by design</strong> rather than post-hoc. </li> <li><strong>Running at interactive speed</strong> on commodity hardware for &lt;$0.04 per query.</li> </ul> <!-- more --> <h2 id=system-architecture>System Architecture<a class=headerlink href=#system-architecture title="Permanent link">&para;</a></h2> <p><a class=glightbox href=../../../../img/bd_arch_diagram.png data-type=image data-width=auto data-height=auto data-title="Architecture Diagram" data-desc-position=bottom><img alt="Architecture Diagram" src=../../../../img/bd_arch_diagram.png></a></p> <ol> <li><strong>User query</strong> enters via a Gradio chat front-end. </li> <li><strong>PlannerAgent</strong> (Gemini-2.0 Flash) classifies intent, sets novelty/similarity weights, and emits a <code>planning_strategy</code> JSON. A planner-agent system excels at translating that goal into a concrete, executable strategy.</li> <li><strong>Genre-MoodAgent</strong> fetches stylistically coherent tracks; <strong>DiscoveryAgent</strong> hunts low-playcount gems. </li> <li><strong>JudgeAgent</strong> ranks and explains using the Plannerâ€™s evaluation rubric. </li> <li>Results stream back with Spotify previews.</li> </ol> <p>LangGraph moves a single <code>MusicRecommenderState</code> object through the graph, enforcing type safety and providing span-level tracing.</p> <h2 id=scoring-ranking-the-judges-deliberation>Scoring &amp; Ranking: The Judge's Deliberation<a class=headerlink href=#scoring-ranking-the-judges-deliberation title="Permanent link">&para;</a></h2> <p>The heart of BeatDebate's decision-making lies in its two-stage evaluation process, handled by the JudgeAgent. This process is designed to be both intelligent and adaptable, moving beyond a single, rigid algorithm to dynamically define a "good" recommendation based on the user's specific intent.</p> <h3 id=stage-1-component-based-scoring>Stage 1: Component-Based Scoring<a class=headerlink href=#stage-1-component-based-scoring title="Permanent link">&para;</a></h3> <p>Before ranking, each potential track is evaluated across multiple dimensions by a ComprehensiveQualityScorer. This creates a 360-degree profile for every song:</p> <ul> <li> <p><strong>Quality Score:</strong> Measures intrinsic musical quality using characteristics like energy, danceability, and emotional positivity (valence). This ensures we recommend well-produced and musically sound tracks.</p> </li> <li> <p><strong>Novelty / Underground Score:</strong> This is the core "discovery" metric. Calculated from Last.fm listener and play-count data, a high novelty score indicates a track is likely an underground gem the user hasn't heard before. This directly combats the "filter bubble" of mainstream platforms.</p> </li> <li> <p><strong>Contextual Relevance Score:</strong> Quantifies how well a track's metadata (artist, genre, tags) aligns with the user's query. If a user asks for "sad indie," this score is high for tracks matching those terms.</p> </li> <li> <p><strong>Similarity Score:</strong> For "music like X" queries, this score measures stylistic and sonic similarity, often using multi-hop artist connections to find nuanced and surprising links.</p> </li> </ul> <p>At the end of this stage, every candidate track has a rich profile of scores (e.g., Quality: 0.8, Novelty: 0.9, Relevance: 0.7).</p> <h3 id=stage-2-intent-aware-ranking>Stage 2: Intent-Aware Ranking<a class=headerlink href=#stage-2-intent-aware-ranking title="Permanent link">&para;</a></h3> <p>This is the system's strategic core. The "best" track for a discovery query is fundamentally different from the "best" track for a by artist query. The RankingEngine calculates a final weighted score, but the weights are provided by the PlannerAgent's strategy and change based on the user's intent. The power of the planning-centric approach becomes clear when observing how the <code>JudgeAgent</code>'s evaluation criteria adapt to different user intents. The <code>PlannerAgent</code> dynamically assigns different scoring weights based on the classified intent, ensuring the final recommendations are optimized for the user's specific goal. The table below illustrates this adaptive ranking strategy.</p> <table> <thead> <tr> <th style="text-align: left;">If the User Asks For...</th> <th style="text-align: left;">The Planner's Strategy Prioritizes...</th> <th style="text-align: left;">Why This is Beneficial</th> </tr> </thead> <tbody> <tr> <td style="text-align: left;"><strong>"Underground electronic music"</strong><br>(Intent: <code>DISCOVERY</code>)</td> <td style="text-align: left;"><strong>Novelty</strong>: 50% <br> <strong>Underground</strong>: 30% <br> <strong>Quality</strong>: 15%</td> <td style="text-align: left;">The system understands the primary goal is finding something new. It heavily rewards tracks with low play-counts and intentionally de-prioritizes popular hits.</td> </tr> <tr> <td style="text-align: left;"><strong>"Music by The Beatles"</strong><br>(Intent: <code>BY_ARTIST</code>)</td> <td style="text-align: left;"><strong>Quality</strong>: 50% <br> <strong>Popularity</strong>: 30% <br> <strong>Recency</strong>: 20%</td> <td style="text-align: left;">The system focuses on the artist's most well-regarded and popular songs. <strong>Novelty is ignored</strong>, and popularity is rewarded to provide representative tracks.</td> </tr> <tr> <td style="text-align: left;"><strong>"Music like Kendrick Lamar but jazzy"</strong><br>(Intent: <code>HYBRID_SIMILARITY_GENRE</code>)</td> <td style="text-align: left;"><strong>Relevance</strong>: 45% <br> <strong>Quality</strong>: 30% <br> <strong>Diversity</strong>: 15%</td> <td style="text-align: left;">The system's main goal is to find tracks that match <em>both</em> constraints. It prioritizes the relevance score and <strong>ignores novelty</strong> to find the best examples of this genre fusion.</td> </tr> <tr> <td style="text-align: left;"><strong>"Music for studying"</strong><br>(Intent: <code>CONTEXTUAL</code>)</td> <td style="text-align: left;"><strong>Context Fit</strong>: 60% <br> <strong>Quality</strong>: 25% <br> <strong>Familiarity</strong>: 15%</td> <td style="text-align: left;">The system understands this is a functional request. It prioritizes tracks that fit the "studying" context (e.g., instrumental, low energy) and slightly favors familiar but not mainstream tracks, which can be less distracting.</td> </tr> </tbody> </table> <h2 id=getting-started>Getting Started<a class=headerlink href=#getting-started title="Permanent link">&para;</a></h2> <p><div class="language-bash highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>git<span class=w> </span>clone<span class=w> </span>https://github.com/your-org/beatdebate
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=nb>cd</span><span class=w> </span>beatdebate
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>uv<span class=w> </span>run<span class=w> </span>python<span class=w> </span>-m<span class=w> </span>src.main
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=c1># Point browser to http://localhost:7860</span>
</span></code></pre></div> Set these environment variables: <div class="language-bash highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=nv>LASTFM_API_KEY</span><span class=o>=</span>your_lastfm_api_key_here
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=nv>LASTFM_SHARED_SECRET</span><span class=o>=</span>your_lastfm_shared_secret_here
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=nv>SPOTIFY_CLIENT_ID</span><span class=o>=</span>your_spotify_client_id_here
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=nv>SPOTIFY_CLIENT_SECRET</span><span class=o>=</span>your_spotify_client_secret_here
</span></code></pre></div></p> <h2 id=1-the-backend-fastapi-langgraph-and-an-llm-planner>1. The Backend: FastAPI, LangGraph, and an LLM Planner<a class=headerlink href=#1-the-backend-fastapi-langgraph-and-an-llm-planner title="Permanent link">&para;</a></h2> <p>The BeatDebate backend turns a chat prompt into a ranked, explained playlist in one HTTP call.<br> Everything is Python 3.11; <strong>FastAPI</strong> exposes the <code>/recommend</code> endpoint, <strong>LangGraph</strong> orchestrates four agents, and <strong>Pydantic</strong> types the shared state.</p> <h3 id=key-components-technologies>Key Components &amp; Technologies<a class=headerlink href=#key-components-technologies title="Permanent link">&para;</a></h3> <h4 id=fastapi>FastAPI<a class=headerlink href=#fastapi title="Permanent link">&para;</a></h4> <p>Chosen for its async-first design (perfect for I/O-bound API calls to Last.fm, Spotify and Gemini) and native Pydantic validation.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=c1># src/api/backend.py (illustrative snippet)</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=kn>from</span><span class=w> </span><span class=nn>fastapi</span><span class=w> </span><span class=kn>import</span> <span class=n>APIRouter</span><span class=p>,</span> <span class=n>HTTPException</span> <span class=c1># Corrected: FastAPI uses HTTPException</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=kn>from</span><span class=w> </span><span class=nn>src.models.agent_models</span><span class=w> </span><span class=kn>import</span> <span class=n>MusicRecommenderState</span> <span class=c1># Assuming this path</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=kn>from</span><span class=w> </span><span class=nn>src.services.enhanced_recommendation_service</span><span class=w> </span><span class=kn>import</span> <span class=n>get_recommendation_service</span><span class=p>,</span> <span class=n>RecommendationRequest</span> <span class=c1># Using enhanced service</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=n>router</span> <span class=o>=</span> <span class=n>APIRouter</span><span class=p>()</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=n>recommendation_service</span> <span class=o>=</span> <span class=n>get_recommendation_service</span><span class=p>()</span> <span class=c1># Assuming service is initialized elsewhere</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=nd>@router</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/recommendations&quot;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=nb>list</span><span class=p>[</span><span class=nb>str</span><span class=p>])</span> <span class=c1># Updated endpoint</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>recommend_tracks</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>RecommendationRequest</span><span class=p>):</span> <span class=c1># Updated request model</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>recommendation_service</span><span class=p>:</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>503</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=s2>&quot;Recommendation service not available&quot;</span><span class=p>)</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a>    <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>recommendation_service</span><span class=o>.</span><span class=n>get_recommendations</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a>    <span class=k>return</span> <span class=p>[</span><span class=n>track</span><span class=o>.</span><span class=n>name</span> <span class=k>for</span> <span class=n>track</span> <span class=ow>in</span> <span class=n>result</span><span class=o>.</span><span class=n>recommendations</span><span class=p>]</span> <span class=c1># Simplified for example</span>
</span></code></pre></div> <h4 id=langgraph>LangGraph<a class=headerlink href=#langgraph title="Permanent link">&para;</a></h4> <p>A tiny DAG with four nodes; advocates run in parallel.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=c1># src/services/recommendation_engine.py (excerpt based on your LangGraph design)</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=kn>from</span><span class=w> </span><span class=nn>langgraph.graph</span><span class=w> </span><span class=kn>import</span> <span class=n>StateGraph</span><span class=p>,</span> <span class=n>END</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=kn>from</span><span class=w> </span><span class=nn>src.models.agent_models</span><span class=w> </span><span class=kn>import</span> <span class=n>MusicRecommenderState</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=c1># ... import agent classes ...</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=k>class</span><span class=w> </span><span class=nc>RecommendationEngine</span><span class=p>:</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>    <span class=c1># ...</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>    <span class=k>def</span><span class=w> </span><span class=nf>_build_workflow_graph</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>StateGraph</span><span class=p>:</span> <span class=c1># Corrected method name</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>        <span class=n>workflow</span> <span class=o>=</span> <span class=n>StateGraph</span><span class=p>(</span><span class=n>MusicRecommenderState</span><span class=p>)</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>        <span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&quot;planner&quot;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_planner_node</span><span class=p>)</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>        <span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&quot;genre_mood_advocate&quot;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_genre_mood_node</span><span class=p>)</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a>        <span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&quot;discovery_advocate&quot;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_discovery_node</span><span class=p>)</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a>        <span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&quot;judge&quot;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_judge_node</span><span class=p>)</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a>        <span class=n>workflow</span><span class=o>.</span><span class=n>set_entry_point</span><span class=p>(</span><span class=s2>&quot;planner&quot;</span><span class=p>)</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a>        <span class=c1># ... connect nodes ...</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a>        <span class=c1># For example:</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a>        <span class=n>workflow</span><span class=o>.</span><span class=n>add_conditional_edges</span><span class=p>(</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a>            <span class=s2>&quot;planner&quot;</span><span class=p>,</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_route_agents</span><span class=p>,</span> <span class=c1># Example router</span>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a>            <span class=p>{</span>
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a>                <span class=s2>&quot;discovery_only&quot;</span><span class=p>:</span> <span class=s2>&quot;discovery_advocate&quot;</span><span class=p>,</span>
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a>                <span class=s2>&quot;genre_mood_only&quot;</span><span class=p>:</span> <span class=s2>&quot;genre_mood_advocate&quot;</span><span class=p>,</span>
</span><span id=__span-3-24><a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a>                <span class=s2>&quot;both_agents&quot;</span><span class=p>:</span> <span class=s2>&quot;discovery_advocate&quot;</span><span class=p>,</span> <span class=c1># Start of parallel execution</span>
</span><span id=__span-3-25><a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a>                <span class=s2>&quot;judge_only&quot;</span><span class=p>:</span> <span class=s2>&quot;judge&quot;</span>
</span><span id=__span-3-26><a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a>            <span class=p>}</span>
</span><span id=__span-3-27><a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a>        <span class=p>)</span>
</span><span id=__span-3-28><a id=__codelineno-3-28 name=__codelineno-3-28 href=#__codelineno-3-28></a>        <span class=c1># ... other edges for parallel flow and to judge ...</span>
</span><span id=__span-3-29><a id=__codelineno-3-29 name=__codelineno-3-29 href=#__codelineno-3-29></a>        <span class=n>workflow</span><span class=o>.</span><span class=n>add_edge</span><span class=p>(</span><span class=s2>&quot;judge&quot;</span><span class=p>,</span> <span class=n>END</span><span class=p>)</span>
</span><span id=__span-3-30><a id=__codelineno-3-30 name=__codelineno-3-30 href=#__codelineno-3-30></a>        <span class=k>return</span> <span class=n>workflow</span><span class=o>.</span><span class=n>compile</span><span class=p>()</span>
</span><span id=__span-3-31><a id=__codelineno-3-31 name=__codelineno-3-31 href=#__codelineno-3-31></a>    <span class=c1># ...</span>
</span></code></pre></div> <h4 id=pydantic>Pydantic<a class=headerlink href=#pydantic title="Permanent link">&para;</a></h4> <p>Pydantic is the backbone for data validation and settings management throughout BeatDebate. Its primary role in the backend is defining the <code>MusicRecommenderState</code> model (<code>src/models/agent_models.py</code>). <div class="language-python highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=c1># src/models/agent_models.py (abridged - MusicRecommenderState)</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>List</span><span class=p>,</span> <span class=n>Any</span><span class=p>,</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Annotated</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=kn>from</span><span class=w> </span><span class=nn>pydantic</span><span class=w> </span><span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=c1># Reducer examples (from your agent_models.py)</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=k>def</span><span class=w> </span><span class=nf>keep_first</span><span class=p>(</span><span class=n>x</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span> <span class=n>y</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Any</span><span class=p>:</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>    <span class=k>if</span> <span class=n>x</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>or</span> <span class=p>(</span><span class=nb>isinstance</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=p>(</span><span class=nb>list</span><span class=p>,</span> <span class=nb>dict</span><span class=p>,</span> <span class=nb>str</span><span class=p>))</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>):</span> <span class=k>return</span> <span class=n>y</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>    <span class=k>return</span> <span class=n>x</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=k>def</span><span class=w> </span><span class=nf>list_append_reducer</span><span class=p>(</span><span class=n>x</span><span class=p>:</span> <span class=n>List</span><span class=p>,</span> <span class=n>y</span><span class=p>:</span> <span class=n>List</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>:</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>    <span class=k>if</span> <span class=n>x</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span> <span class=n>x</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>    <span class=k>if</span> <span class=n>y</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span> <span class=n>y</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a>    <span class=k>return</span> <span class=n>x</span> <span class=o>+</span> <span class=n>y</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=k>class</span><span class=w> </span><span class=nc>MusicRecommenderState</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a>    <span class=n>user_query</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>keep_first</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a>    <span class=c1># ... many other fields like planning_strategy, entities, etc. ...</span>
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a>    <span class=n>genre_mood_recommendations</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>],</span> <span class=n>list_append_reducer</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default_factory</span><span class=o>=</span><span class=nb>list</span><span class=p>)</span>
</span><span id=__span-4-19><a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a>    <span class=n>discovery_recommendations</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>],</span> <span class=n>list_append_reducer</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default_factory</span><span class=o>=</span><span class=nb>list</span><span class=p>)</span>
</span><span id=__span-4-20><a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a>    <span class=n>final_recommendations</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>],</span> <span class=n>list_append_reducer</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default_factory</span><span class=o>=</span><span class=nb>list</span><span class=p>)</span> <span class=c1># Corrected reducer based on typical usage</span>
</span><span id=__span-4-21><a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a>    <span class=n>reasoning_log</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> <span class=n>list_append_reducer</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default_factory</span><span class=o>=</span><span class=nb>list</span><span class=p>)</span>
</span><span id=__span-4-22><a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a>    <span class=c1># ...</span>
</span></code></pre></div></p> <h4 id=layered-architecture>Layered Architecture<a class=headerlink href=#layered-architecture title="Permanent link">&para;</a></h4> <h5 id=api-layer>API Layer<a class=headerlink href=#api-layer title="Permanent link">&para;</a></h5> <ul> <li><strong>(<code>src/api/</code>):</strong><ul> <li> <p>This layer serves as the unified gateway for all external service interactions, ensuring consistency, robustness, and maintainability. It's not just about exposing endpoints with FastAPI but also about how the application consumes external music data APIs.</p> <ul> <li> <p><strong>(<code>src/api/backend.py</code>):</strong></p> <ul> <li> <p>Exposes the primary HTTP endpoints (like <code>/recommendations</code>, <code>/planning</code>) for the Gradio frontend and potentially other clients.</p> </li> <li> <p>Handles request validation using Pydantic models defined in <code>src/models/</code>.</p> </li> <li> <p>Orchestrates calls to the EnhancedRecommendationService to initiate the agent workflow.</p> </li> <li> <p>Manages application lifecycle events (startup/shutdown) for initializing and closing resources like the recommendation service and API clients (as seen in lifespan manager in <code>src/api/backend.py</code>).</p> </li> </ul> <div class="language-python highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=c1># src/api/backend.py (Illustrative Snippet)</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=kn>from</span><span class=w> </span><span class=nn>fastapi</span><span class=w> </span><span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>HTTPException</span><span class=p>,</span> <span class=n>Depends</span> <span class=c1># Ensure Depends is imported</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=kn>from</span><span class=w> </span><span class=nn>pydantic</span><span class=w> </span><span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span> <span class=c1># Ensure necessary typing imports</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=c1># Assuming these are correctly pathed in your project</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=kn>from</span><span class=w> </span><span class=nn>src.services.enhanced_recommendation_service</span><span class=w> </span><span class=kn>import</span> <span class=p>(</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>    <span class=n>EnhancedRecommendationService</span><span class=p>,</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>    <span class=n>RecommendationRequest</span> <span class=k>as</span> <span class=n>ServiceRequest</span><span class=p>,</span> <span class=c1># Renaming to avoid Pydantic model conflict</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a>    <span class=n>RecommendationResponse</span> <span class=k>as</span> <span class=n>ServiceResponse</span><span class=p>,</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a>    <span class=n>get_recommendation_service</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=p>)</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=kn>from</span><span class=w> </span><span class=nn>src.models.metadata_models</span><span class=w> </span><span class=kn>import</span> <span class=n>UnifiedTrackMetadata</span> <span class=c1># For response model</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a><span class=c1># Placeholder for lifespan manager and other initializations</span>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a><span class=c1># async def lifespan(app: FastAPI): ...</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a><span class=c1># app = FastAPI(lifespan=lifespan)</span>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span> <span class=c1># Simplified for snippet</span>
</span><span id=__span-5-19><a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a>
</span><span id=__span-5-20><a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a><span class=c1># --- Pydantic Model for API Request ---</span>
</span><span id=__span-5-21><a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a><span class=k>class</span><span class=w> </span><span class=nc>APIRecommendationRequest</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-5-22><a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a>    <span class=n>query</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>min_length</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;User&#39;s music preference query&quot;</span><span class=p>)</span>
</span><span id=__span-5-23><a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a>    <span class=n>session_id</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Session ID for conversation context&quot;</span><span class=p>)</span>
</span><span id=__span-5-24><a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a>    <span class=n>max_recommendations</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Number of recommendations&quot;</span><span class=p>)</span>
</span><span id=__span-5-25><a id=__codelineno-5-25 name=__codelineno-5-25 href=#__codelineno-5-25></a>    <span class=c1># Add other relevant fields from your actual RecommendationRequest</span>
</span><span id=__span-5-26><a id=__codelineno-5-26 name=__codelineno-5-26 href=#__codelineno-5-26></a>
</span><span id=__span-5-27><a id=__codelineno-5-27 name=__codelineno-5-27 href=#__codelineno-5-27></a><span class=c1># --- Pydantic Model for API Response Track ---</span>
</span><span id=__span-5-28><a id=__codelineno-5-28 name=__codelineno-5-28 href=#__codelineno-5-28></a><span class=k>class</span><span class=w> </span><span class=nc>APITrackResponse</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-5-29><a id=__codelineno-5-29 name=__codelineno-5-29 href=#__codelineno-5-29></a>    <span class=n>title</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-5-30><a id=__codelineno-5-30 name=__codelineno-5-30 href=#__codelineno-5-30></a>    <span class=n>artist</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-5-31><a id=__codelineno-5-31 name=__codelineno-5-31 href=#__codelineno-5-31></a>    <span class=n>album</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-5-32><a id=__codelineno-5-32 name=__codelineno-5-32 href=#__codelineno-5-32></a>    <span class=n>preview_url</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-5-33><a id=__codelineno-5-33 name=__codelineno-5-33 href=#__codelineno-5-33></a>    <span class=n>explanation</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-5-34><a id=__codelineno-5-34 name=__codelineno-5-34 href=#__codelineno-5-34></a>    <span class=c1># Add other relevant fields from your UnifiedTrackMetadata or TrackRecommendation</span>
</span><span id=__span-5-35><a id=__codelineno-5-35 name=__codelineno-5-35 href=#__codelineno-5-35></a>
</span><span id=__span-5-36><a id=__codelineno-5-36 name=__codelineno-5-36 href=#__codelineno-5-36></a><span class=c1># --- Pydantic Model for API Response ---</span>
</span><span id=__span-5-37><a id=__codelineno-5-37 name=__codelineno-5-37 href=#__codelineno-5-37></a><span class=k>class</span><span class=w> </span><span class=nc>APIRecommendationResponse</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-5-38><a id=__codelineno-5-38 name=__codelineno-5-38 href=#__codelineno-5-38></a>    <span class=n>recommendations</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>APITrackResponse</span><span class=p>]</span>
</span><span id=__span-5-39><a id=__codelineno-5-39 name=__codelineno-5-39 href=#__codelineno-5-39></a>    <span class=n>reasoning_log</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
</span><span id=__span-5-40><a id=__codelineno-5-40 name=__codelineno-5-40 href=#__codelineno-5-40></a>    <span class=n>session_id</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-5-41><a id=__codelineno-5-41 name=__codelineno-5-41 href=#__codelineno-5-41></a>    <span class=c1># Add other relevant fields like strategy_used, processing_time etc.</span>
</span><span id=__span-5-42><a id=__codelineno-5-42 name=__codelineno-5-42 href=#__codelineno-5-42></a>
</span><span id=__span-5-43><a id=__codelineno-5-43 name=__codelineno-5-43 href=#__codelineno-5-43></a><span class=nd>@app</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/recommendations&quot;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>APIRecommendationResponse</span><span class=p>)</span>
</span><span id=__span-5-44><a id=__codelineno-5-44 name=__codelineno-5-44 href=#__codelineno-5-44></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>get_recommendations</span><span class=p>(</span>
</span><span id=__span-5-45><a id=__codelineno-5-45 name=__codelineno-5-45 href=#__codelineno-5-45></a>    <span class=n>request</span><span class=p>:</span> <span class=n>APIRecommendationRequest</span><span class=p>,</span>
</span><span id=__span-5-46><a id=__codelineno-5-46 name=__codelineno-5-46 href=#__codelineno-5-46></a>    <span class=c1># Using a dependency function to get the service instance</span>
</span><span id=__span-5-47><a id=__codelineno-5-47 name=__codelineno-5-47 href=#__codelineno-5-47></a>    <span class=c1># This assumes get_recommendation_service is properly set up to provide an initialized service</span>
</span><span id=__span-5-48><a id=__codelineno-5-48 name=__codelineno-5-48 href=#__codelineno-5-48></a>    <span class=n>recommendation_service</span><span class=p>:</span> <span class=n>EnhancedRecommendationService</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_recommendation_service</span><span class=p>)</span>
</span><span id=__span-5-49><a id=__codelineno-5-49 name=__codelineno-5-49 href=#__codelineno-5-49></a><span class=p>):</span>
</span><span id=__span-5-50><a id=__codelineno-5-50 name=__codelineno-5-50 href=#__codelineno-5-50></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>recommendation_service</span><span class=p>:</span>
</span><span id=__span-5-51><a id=__codelineno-5-51 name=__codelineno-5-51 href=#__codelineno-5-51></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>503</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=s2>&quot;Recommendation service not available&quot;</span><span class=p>)</span>
</span><span id=__span-5-52><a id=__codelineno-5-52 name=__codelineno-5-52 href=#__codelineno-5-52></a>
</span><span id=__span-5-53><a id=__codelineno-5-53 name=__codelineno-5-53 href=#__codelineno-5-53></a>    <span class=k>try</span><span class=p>:</span>
</span><span id=__span-5-54><a id=__codelineno-5-54 name=__codelineno-5-54 href=#__codelineno-5-54></a>        <span class=c1># Map API request model to service request model</span>
</span><span id=__span-5-55><a id=__codelineno-5-55 name=__codelineno-5-55 href=#__codelineno-5-55></a>        <span class=n>service_request_data</span> <span class=o>=</span> <span class=n>ServiceRequest</span><span class=p>(</span>
</span><span id=__span-5-56><a id=__codelineno-5-56 name=__codelineno-5-56 href=#__codelineno-5-56></a>            <span class=n>query</span><span class=o>=</span><span class=n>request</span><span class=o>.</span><span class=n>query</span><span class=p>,</span>
</span><span id=__span-5-57><a id=__codelineno-5-57 name=__codelineno-5-57 href=#__codelineno-5-57></a>            <span class=n>session_id</span><span class=o>=</span><span class=n>request</span><span class=o>.</span><span class=n>session_id</span><span class=p>,</span>
</span><span id=__span-5-58><a id=__codelineno-5-58 name=__codelineno-5-58 href=#__codelineno-5-58></a>            <span class=n>max_recommendations</span><span class=o>=</span><span class=n>request</span><span class=o>.</span><span class=n>max_recommendations</span>
</span><span id=__span-5-59><a id=__codelineno-5-59 name=__codelineno-5-59 href=#__codelineno-5-59></a>            <span class=c1># Map other fields as necessary, e.g., chat_context</span>
</span><span id=__span-5-60><a id=__codelineno-5-60 name=__codelineno-5-60 href=#__codelineno-5-60></a>        <span class=p>)</span>
</span><span id=__span-5-61><a id=__codelineno-5-61 name=__codelineno-5-61 href=#__codelineno-5-61></a>
</span><span id=__span-5-62><a id=__codelineno-5-62 name=__codelineno-5-62 href=#__codelineno-5-62></a>        <span class=c1># Call the enhanced recommendation service</span>
</span><span id=__span-5-63><a id=__codelineno-5-63 name=__codelineno-5-63 href=#__codelineno-5-63></a>        <span class=n>service_response</span><span class=p>:</span> <span class=n>ServiceResponse</span> <span class=o>=</span> <span class=k>await</span> <span class=n>recommendation_service</span><span class=o>.</span><span class=n>get_recommendations</span><span class=p>(</span><span class=n>service_request_data</span><span class=p>)</span>
</span><span id=__span-5-64><a id=__codelineno-5-64 name=__codelineno-5-64 href=#__codelineno-5-64></a>
</span><span id=__span-5-65><a id=__codelineno-5-65 name=__codelineno-5-65 href=#__codelineno-5-65></a>        <span class=c1># Transform service response (List[UnifiedTrackMetadata]) to API response (List[APITrackResponse])</span>
</span><span id=__span-5-66><a id=__codelineno-5-66 name=__codelineno-5-66 href=#__codelineno-5-66></a>        <span class=n>api_tracks</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-5-67><a id=__codelineno-5-67 name=__codelineno-5-67 href=#__codelineno-5-67></a>        <span class=k>for</span> <span class=n>track_meta</span> <span class=ow>in</span> <span class=n>service_response</span><span class=o>.</span><span class=n>recommendations</span><span class=p>:</span>
</span><span id=__span-5-68><a id=__codelineno-5-68 name=__codelineno-5-68 href=#__codelineno-5-68></a>            <span class=n>api_tracks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>APITrackResponse</span><span class=p>(</span>
</span><span id=__span-5-69><a id=__codelineno-5-69 name=__codelineno-5-69 href=#__codelineno-5-69></a>                <span class=n>title</span><span class=o>=</span><span class=n>track_meta</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span><span id=__span-5-70><a id=__codelineno-5-70 name=__codelineno-5-70 href=#__codelineno-5-70></a>                <span class=n>artist</span><span class=o>=</span><span class=n>track_meta</span><span class=o>.</span><span class=n>artist</span><span class=p>,</span>
</span><span id=__span-5-71><a id=__codelineno-5-71 name=__codelineno-5-71 href=#__codelineno-5-71></a>                <span class=n>album</span><span class=o>=</span><span class=n>track_meta</span><span class=o>.</span><span class=n>album</span><span class=p>,</span>
</span><span id=__span-5-72><a id=__codelineno-5-72 name=__codelineno-5-72 href=#__codelineno-5-72></a>                <span class=n>preview_url</span><span class=o>=</span><span class=n>track_meta</span><span class=o>.</span><span class=n>preview_url</span><span class=p>,</span>
</span><span id=__span-5-73><a id=__codelineno-5-73 name=__codelineno-5-73 href=#__codelineno-5-73></a>                <span class=n>explanation</span><span class=o>=</span><span class=n>track_meta</span><span class=o>.</span><span class=n>recommendation_reason</span>
</span><span id=__span-5-74><a id=__codelineno-5-74 name=__codelineno-5-74 href=#__codelineno-5-74></a>                <span class=c1># Map other fields</span>
</span><span id=__span-5-75><a id=__codelineno-5-75 name=__codelineno-5-75 href=#__codelineno-5-75></a>            <span class=p>))</span>
</span><span id=__span-5-76><a id=__codelineno-5-76 name=__codelineno-5-76 href=#__codelineno-5-76></a>
</span><span id=__span-5-77><a id=__codelineno-5-77 name=__codelineno-5-77 href=#__codelineno-5-77></a>        <span class=k>return</span> <span class=n>APIRecommendationResponse</span><span class=p>(</span>
</span><span id=__span-5-78><a id=__codelineno-5-78 name=__codelineno-5-78 href=#__codelineno-5-78></a>            <span class=n>recommendations</span><span class=o>=</span><span class=n>api_tracks</span><span class=p>,</span>
</span><span id=__span-5-79><a id=__codelineno-5-79 name=__codelineno-5-79 href=#__codelineno-5-79></a>            <span class=n>reasoning_log</span><span class=o>=</span><span class=n>service_response</span><span class=o>.</span><span class=n>reasoning</span><span class=p>,</span>
</span><span id=__span-5-80><a id=__codelineno-5-80 name=__codelineno-5-80 href=#__codelineno-5-80></a>            <span class=n>session_id</span><span class=o>=</span><span class=n>service_response</span><span class=o>.</span><span class=n>session_id</span>
</span><span id=__span-5-81><a id=__codelineno-5-81 name=__codelineno-5-81 href=#__codelineno-5-81></a>            <span class=c1># Map other fields</span>
</span><span id=__span-5-82><a id=__codelineno-5-82 name=__codelineno-5-82 href=#__codelineno-5-82></a>        <span class=p>)</span>
</span><span id=__span-5-83><a id=__codelineno-5-83 name=__codelineno-5-83 href=#__codelineno-5-83></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-5-84><a id=__codelineno-5-84 name=__codelineno-5-84 href=#__codelineno-5-84></a>        <span class=c1># Log the error using your structured logger</span>
</span><span id=__span-5-85><a id=__codelineno-5-85 name=__codelineno-5-85 href=#__codelineno-5-85></a>        <span class=c1># logger.error(&quot;Recommendation processing error&quot;, exc_info=True)</span>
</span><span id=__span-5-86><a id=__codelineno-5-86 name=__codelineno-5-86 href=#__codelineno-5-86></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;An unexpected error occurred: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div> </li> <li> <p><strong>Client Abstraction &amp; Standardization:</strong></p> <ul> <li> <p><code>base_client.py</code> (<code>BaseAPIClient</code>): This is a crucial piece for code reuse. It provides a foundational class for all external API clients (Last.fm, Spotify). Key responsibilities include:</p> </li> <li> <p>Unified HTTP request handling using <code>aiohttp.ClientSession</code> for asynchronous operations.</p> </li> <li> <p>Standardized error handling and retry mechanisms (e.g., exponential backoff).</p> </li> <li> <p>Integration with the UnifiedRateLimiter to ensure all API calls respect external service rate limits.</p> </li> <li> <p>Abstracting common logic like parsing JSON responses and handling API-specific error formats (subclasses implement <code>_extract_api_error</code>).</p> </li> <li> <p><code>lastfm_client.py</code> (<code>LastFmClient</code>) and <code>spotify_client.py</code> (<code>SpotifyClient</code>): These are concrete implementations inheriting from <code>BaseAPIClient</code>.</p> <ul> <li> <p>They encapsulate all logic specific to interacting with the Last.fm and Spotify Web APIs, respectively. This includes endpoint definitions, parameter formatting, and parsing service-specific response structures into standardized Pydantic models (like <code>TrackMetadata</code> from <code>src/api/lastfm_client.py</code> or <code>SpotifyTrack</code> from <code>src/api/spotify_client.py</code>).</p> </li> <li> <p>For example, <code>LastFmClient</code> handles searching tracks, getting track info, similar tracks, and artist info, while <code>SpotifyClient</code> manages authentication (OAuth Client Credentials flow) and fetching track details or audio features.</p> </li> </ul> <div class="language-python highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=c1># src/api/lastfm_client.py (Illustrative snippet of _make_lastfm_request)</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=k>class</span><span class=w> </span><span class=nc>LastFmClient</span><span class=p>(</span><span class=n>BaseAPIClient</span><span class=p>):</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>    <span class=c1># ...</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>_make_lastfm_request</span><span class=p>(</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>        <span class=bp>self</span><span class=p>,</span> 
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>        <span class=n>method</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>        <span class=n>params</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>        <span class=c1># ...</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>        <span class=n>request_params</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>            <span class=s2>&quot;method&quot;</span><span class=p>:</span> <span class=n>method</span><span class=p>,</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a>            <span class=s2>&quot;api_key&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>api_key</span><span class=p>,</span>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a>            <span class=s2>&quot;format&quot;</span><span class=p>:</span> <span class=s2>&quot;json&quot;</span><span class=p>,</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a>            <span class=o>**</span><span class=p>(</span><span class=n>params</span> <span class=ow>or</span> <span class=p>{})</span>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a>        <span class=p>}</span>
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a>        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_make_request</span><span class=p>(</span> <span class=c1># Calls BaseAPIClient&#39;s method</span>
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a>            <span class=n>endpoint</span><span class=o>=</span><span class=s2>&quot;&quot;</span><span class=p>,</span> <span class=c1># Last.fm uses query params on base URL</span>
</span><span id=__span-6-18><a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a>            <span class=n>params</span><span class=o>=</span><span class=n>request_params</span><span class=p>,</span>
</span><span id=__span-6-19><a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a>            <span class=c1># ...</span>
</span><span id=__span-6-20><a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a>        <span class=p>)</span>
</span></code></pre></div> </li> </ul> </li> </ul> </li> </ul> </li> </ul> <h5 id=agent-layer>Agent Layer<a class=headerlink href=#agent-layer title="Permanent link">&para;</a></h5> <ul> <li> <p><strong>(<code>src/agent/</code>):</strong></p> <ul> <li> <p>This layer is where the core intelligence for music discovery, analysis, and decision-making resides. Instead of a monolithic AI, BeatDebate employs a team of specialized agents, each with a distinct role, working in concert to fulfill the user's request. This design promotes modularity, specialization, and transparent reasoning.</p> </li> <li> <p><strong><code>base_agent.py</code> (<code>BaseAgent</code>):</strong></p> <ul> <li>This abstract base class provides common scaffolding for all agents.</li> <li>It includes shared functionalities like integration with the LLM client (Gemini), standardized logging via <code>structlog</code>, performance monitoring hooks (tracking processing times, success/error counts), and basic error handling.</li> <li>A key feature is the management of a <code>_reasoning_steps</code> list, allowing each agent to document its decision-making process, contributing to the overall explainability of the system. <div class="language-python highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=c1># src/agents/base_agent.py (Illustrative Snippet)</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=k>class</span><span class=w> </span><span class=nc>BaseAgent</span><span class=p>(</span><span class=n>ABC</span><span class=p>):</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>config</span><span class=p>:</span> <span class=n>AgentConfig</span><span class=p>,</span> <span class=n>llm_client</span><span class=p>,</span> <span class=n>api_service</span><span class=p>,</span> <span class=n>metadata_service</span><span class=p>,</span> <span class=n>rate_limiter</span><span class=p>):</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>        <span class=bp>self</span><span class=o>.</span><span class=n>config</span> <span class=o>=</span> <span class=n>config</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>        <span class=bp>self</span><span class=o>.</span><span class=n>agent_name</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>agent_name</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>        <span class=c1># ... other initializations for llm_utils, logger, etc. ...</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_reasoning_steps</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span> <span class=c1># Initialize here</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>    <span class=nd>@abstractmethod</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>:</span> <span class=n>MusicRecommenderState</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>MusicRecommenderState</span><span class=p>:</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a>        <span class=k>pass</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a>    <span class=k>def</span><span class=w> </span><span class=nf>add_reasoning_step</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>step</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>confidence</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.8</span><span class=p>):</span>
</span><span id=__span-7-14><a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_reasoning_steps</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>step</span><span class=p>)</span>
</span><span id=__span-7-15><a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&quot;Reasoning step added&quot;</span><span class=p>,</span> <span class=n>step</span><span class=o>=</span><span class=n>step</span><span class=p>,</span> <span class=n>confidence</span><span class=o>=</span><span class=n>confidence</span><span class=p>)</span>
</span></code></pre></div></li> </ul> </li> <li> <p><strong>Shared Agent Components (<code>src/agents/components/</code>):</strong></p> <ul> <li>To avoid code duplication and promote reusability <em>within</em> the agent layer, common utilities used by multiple agents are centralized here. This is a key design choice for maintainability.</li> <li><strong><code>llm_utils.py</code> (<code>LLMUtils</code>):</strong> Standardizes calls to the Gemini LLM, including prompt construction, JSON response parsing, error handling, and rate limiting integration. All agents use this for their LLM interactions.</li> <li><strong><code>entity_extraction_utils.py</code> (<code>EntityExtractionUtils</code>):</strong> Provides pattern-based methods for extracting entities like artists and genres. This serves as a fallback or supplement to LLM-based extraction.</li> <li><strong><code>query_analysis_utils.py</code> (<code>QueryAnalysisUtils</code>):</strong> Contains helpers for analyzing query characteristics (intent, complexity, mood indicators) using pattern matching.</li> <li><strong><code>unified_candidate_generator.py</code> (<code>UnifiedCandidateGenerator</code>):</strong> A crucial component that consolidates track candidate generation logic. Both <code>GenreMoodAgent</code> and <code>DiscoveryAgent</code> use this to fetch an initial pool of potential tracks based on different strategies (e.g., genre-focused, discovery-focused), ensuring consistent data fetching.</li> <li><strong><code>quality_scorer.py</code> (<code>ComprehensiveQualityScorer</code>):</strong> Implements a multi-dimensional system for scoring track quality, considering audio features (placeholder for now), popularity balance, user engagement signals (placeholder), and genre/mood fit. Used by advocate agents and the judge.</li> </ul> </li> <li> <p><strong>Specialized Agents (each in its own subdirectory like <code>src/agents/planner/</code>):</strong></p> <ul> <li> <p><strong><code>PlannerAgent</code> (<code>src/agents/planner/agent.py</code>):</strong></p> <ul> <li>The strategic coordinator. It's the first agent to process the user query.</li> <li>Utilizes the <code>QueryUnderstandingEngine</code> (from <code>src/agents/planner/query_understanding_engine.py</code>) which leverages <code>LLMUtils</code> for deep query analysis.</li> <li>Its primary output is the <code>planning_strategy</code> which includes <code>task_analysis</code>, <code>coordination_strategy</code> for advocate agents, and an <code>evaluation_framework</code> for the <code>JudgeAgent</code>. This structured plan is the core of BeatDebate's explainable AI approach.</li> <li>The enhanced version also incorporates <code>EntityRecognizer</code> (which might use <code>EntityExtractionUtils</code> and <code>LLMUtils</code>) and <code>ConversationContextManager</code> for richer, context-aware planning. <div class="language-python highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=c1># src/agents/planner/agent.py (Illustrative Snippet)</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=k>class</span><span class=w> </span><span class=nc>PlannerAgent</span><span class=p>(</span><span class=n>BaseAgent</span><span class=p>):</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>:</span> <span class=n>MusicRecommenderState</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>MusicRecommenderState</span><span class=p>:</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>        <span class=c1># Phase 1: Query Understanding (uses QueryUnderstandingEngine)</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>        <span class=n>query_understanding</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_understand_user_query</span><span class=p>(</span><span class=n>state</span><span class=o>.</span><span class=n>user_query</span><span class=p>)</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>        <span class=n>state</span><span class=o>.</span><span class=n>query_understanding</span> <span class=o>=</span> <span class=n>query_understanding</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>        <span class=n>state</span><span class=o>.</span><span class=n>entities</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_convert_understanding_to_entities</span><span class=p>(</span><span class=n>query_understanding</span><span class=p>)</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>        <span class=c1># Phase 2: Task Analysis (uses LLMUtils or fallbacks)</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>        <span class=n>task_analysis</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_analyze_task_complexity</span><span class=p>(</span><span class=n>state</span><span class=o>.</span><span class=n>user_query</span><span class=p>,</span> <span class=n>query_understanding</span><span class=p>)</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>        <span class=n>state</span><span class=o>.</span><span class=n>intent_analysis</span> <span class=o>=</span> <span class=n>task_analysis</span> <span class=c1># Critical for other agents</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a>        <span class=c1># Phase 3: Planning Strategy Creation (internal logic)</span>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>        <span class=n>planning_strategy</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_planning_strategy</span><span class=p>(</span><span class=n>query_understanding</span><span class=p>,</span> <span class=n>task_analysis</span><span class=p>)</span>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a>        <span class=n>state</span><span class=o>.</span><span class=n>planning_strategy</span> <span class=o>=</span> <span class=n>planning_strategy</span>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a>        <span class=c1># ...</span>
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a>        <span class=k>return</span> <span class=n>state</span>
</span></code></pre></div></li> </ul> </li> <li> <p><strong><code>GenreMoodAgent</code> (<code>src/agents/genre_mood/agent.py</code>):</strong></p> <ul> <li>Focuses on finding tracks that match the user's specified or inferred genre and mood preferences.</li> <li>Takes its part of the <code>coordination_strategy</code> from the <code>PlannerAgent</code>.</li> <li>Uses the <code>UnifiedCandidateGenerator</code> with a "genre_mood" strategy and <code>QualityScorer</code>.</li> <li>May employ helper modules like <code>MoodLogic</code> and <code>TagGenerator</code> for specialized processing. <div class="language-python highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=c1># src/agents/genre_mood/agent.py (Illustrative Snippet - Process Overview)</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=k>class</span><span class=w> </span><span class=nc>GenreMoodAgent</span><span class=p>(</span><span class=n>BaseAgent</span><span class=p>):</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>:</span> <span class=n>MusicRecommenderState</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>MusicRecommenderState</span><span class=p>:</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&quot;Starting genre/mood agent processing&quot;</span><span class=p>)</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>        <span class=n>entities</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>entities</span> <span class=ow>or</span> <span class=p>{}</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>        <span class=n>intent_analysis</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>intent_analysis</span> <span class=ow>or</span> <span class=p>{}</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a>        <span class=c1># Adapt parameters based on detected intent (e.g., &#39;genre_mood&#39;, &#39;contextual&#39;)</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_adapt_to_intent</span><span class=p>(</span><span class=n>intent_analysis</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;intent&#39;</span><span class=p>,</span> <span class=s1>&#39;genre_mood&#39;</span><span class=p>))</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a>        <span class=c1># Generate candidates using shared generator</span>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a>        <span class=n>candidates</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>candidate_generator</span><span class=o>.</span><span class=n>generate_candidate_pool</span><span class=p>(</span>
</span><span id=__span-9-13><a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a>            <span class=n>entities</span><span class=o>=</span><span class=n>entities</span><span class=p>,</span>
</span><span id=__span-9-14><a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a>            <span class=n>intent_analysis</span><span class=o>=</span><span class=n>intent_analysis</span><span class=p>,</span>
</span><span id=__span-9-15><a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a>            <span class=n>agent_type</span><span class=o>=</span><span class=s2>&quot;genre_mood&quot;</span><span class=p>,</span>
</span><span id=__span-9-16><a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a>            <span class=n>target_candidates</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>target_candidates</span><span class=p>,</span>
</span><span id=__span-9-17><a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a>            <span class=n>detected_intent</span><span class=o>=</span><span class=n>intent_analysis</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;intent&#39;</span><span class=p>,</span> <span class=s1>&#39;genre_mood&#39;</span><span class=p>)</span>
</span><span id=__span-9-18><a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a>        <span class=p>)</span>
</span><span id=__span-9-19><a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Generated </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>candidates</span><span class=p>)</span><span class=si>}</span><span class=s2> candidates&quot;</span><span class=p>)</span>
</span><span id=__span-9-20><a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a>
</span><span id=__span-9-21><a id=__codelineno-9-21 name=__codelineno-9-21 href=#__codelineno-9-21></a>        <span class=c1># Score candidates for genre/mood fit and quality</span>
</span><span id=__span-9-22><a id=__codelineno-9-22 name=__codelineno-9-22 href=#__codelineno-9-22></a>        <span class=n>scored_candidates</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_score_candidates</span><span class=p>(</span><span class=n>candidates</span><span class=p>,</span> <span class=n>entities</span><span class=p>,</span> <span class=n>intent_analysis</span><span class=p>)</span>
</span><span id=__span-9-23><a id=__codelineno-9-23 name=__codelineno-9-23 href=#__codelineno-9-23></a>
</span><span id=__span-9-24><a id=__codelineno-9-24 name=__codelineno-9-24 href=#__codelineno-9-24></a>        <span class=c1># Filter and rank based on requirements</span>
</span><span id=__span-9-25><a id=__codelineno-9-25 name=__codelineno-9-25 href=#__codelineno-9-25></a>        <span class=n>filtered_candidates</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_filter_by_genre_requirements</span><span class=p>(</span><span class=n>scored_candidates</span><span class=p>,</span> <span class=n>entities</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm_client</span><span class=p>)</span>
</span><span id=__span-9-26><a id=__codelineno-9-26 name=__codelineno-9-26 href=#__codelineno-9-26></a>
</span><span id=__span-9-27><a id=__codelineno-9-27 name=__codelineno-9-27 href=#__codelineno-9-27></a>        <span class=c1># Apply diversity based on context (handles by_artist, followup etc.)</span>
</span><span id=__span-9-28><a id=__codelineno-9-28 name=__codelineno-9-28 href=#__codelineno-9-28></a>        <span class=n>context_override_data</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=s1>&#39;context_override&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span><span id=__span-9-29><a id=__codelineno-9-29 name=__codelineno-9-29 href=#__codelineno-9-29></a>        <span class=n>filtered_candidates</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_ensure_diversity</span><span class=p>(</span>
</span><span id=__span-9-30><a id=__codelineno-9-30 name=__codelineno-9-30 href=#__codelineno-9-30></a>            <span class=n>filtered_candidates</span><span class=p>,</span> <span class=n>entities</span><span class=p>,</span> <span class=n>intent_analysis</span><span class=p>,</span> <span class=n>context_override_data</span>
</span><span id=__span-9-31><a id=__codelineno-9-31 name=__codelineno-9-31 href=#__codelineno-9-31></a>        <span class=p>)</span>
</span><span id=__span-9-32><a id=__codelineno-9-32 name=__codelineno-9-32 href=#__codelineno-9-32></a>
</span><span id=__span-9-33><a id=__codelineno-9-33 name=__codelineno-9-33 href=#__codelineno-9-33></a>        <span class=n>recommendations</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_recommendations</span><span class=p>(</span>
</span><span id=__span-9-34><a id=__codelineno-9-34 name=__codelineno-9-34 href=#__codelineno-9-34></a>            <span class=n>filtered_candidates</span><span class=p>[:</span><span class=bp>self</span><span class=o>.</span><span class=n>final_recommendations</span><span class=p>],</span> <span class=n>entities</span><span class=p>,</span> <span class=n>intent_analysis</span>
</span><span id=__span-9-35><a id=__codelineno-9-35 name=__codelineno-9-35 href=#__codelineno-9-35></a>        <span class=p>)</span>
</span><span id=__span-9-36><a id=__codelineno-9-36 name=__codelineno-9-36 href=#__codelineno-9-36></a>        <span class=n>state</span><span class=o>.</span><span class=n>genre_mood_recommendations</span> <span class=o>=</span> <span class=p>[</span><span class=n>rec</span><span class=o>.</span><span class=n>model_dump</span><span class=p>()</span> <span class=k>for</span> <span class=n>rec</span> <span class=ow>in</span> <span class=n>recommendations</span><span class=p>]</span>
</span><span id=__span-9-37><a id=__codelineno-9-37 name=__codelineno-9-37 href=#__codelineno-9-37></a>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Genre/mood agent completed, </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>recommendations</span><span class=p>)</span><span class=si>}</span><span class=s2> recommendations.&quot;</span><span class=p>)</span>
</span><span id=__span-9-38><a id=__codelineno-9-38 name=__codelineno-9-38 href=#__codelineno-9-38></a>        <span class=k>return</span> <span class=n>state</span>
</span><span id=__span-9-39><a id=__codelineno-9-39 name=__codelineno-9-39 href=#__codelineno-9-39></a>
</span><span id=__span-9-40><a id=__codelineno-9-40 name=__codelineno-9-40 href=#__codelineno-9-40></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>_calculate_genre_mood_score</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>candidate</span><span class=p>,</span> <span class=n>entities</span><span class=p>,</span> <span class=n>intent_analysis</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span><span id=__span-9-41><a id=__codelineno-9-41 name=__codelineno-9-41 href=#__codelineno-9-41></a>        <span class=c1># Uses self.api_service to check genre match via track/artist tags</span>
</span><span id=__span-9-42><a id=__codelineno-9-42 name=__codelineno-9-42 href=#__codelineno-9-42></a>        <span class=c1># Considers mood_mappings, energy_mappings from MoodLogic</span>
</span><span id=__span-9-43><a id=__codelineno-9-43 name=__codelineno-9-43 href=#__codelineno-9-43></a>        <span class=c1># ... detailed scoring logic ...</span>
</span><span id=__span-9-44><a id=__codelineno-9-44 name=__codelineno-9-44 href=#__codelineno-9-44></a>        <span class=n>score</span> <span class=o>=</span> <span class=mf>0.0</span>
</span><span id=__span-9-45><a id=__codelineno-9-45 name=__codelineno-9-45 href=#__codelineno-9-45></a>        <span class=n>target_genres</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_extract_target_genres</span><span class=p>(</span><span class=n>entities</span><span class=p>)</span>
</span><span id=__span-9-46><a id=__codelineno-9-46 name=__codelineno-9-46 href=#__codelineno-9-46></a>        <span class=k>for</span> <span class=n>genre</span> <span class=ow>in</span> <span class=n>target_genres</span><span class=p>:</span>
</span><span id=__span-9-47><a id=__codelineno-9-47 name=__codelineno-9-47 href=#__codelineno-9-47></a>            <span class=n>match_result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_check_genre_match</span><span class=p>(</span><span class=n>candidate</span><span class=p>,</span> <span class=n>genre</span><span class=p>)</span>
</span><span id=__span-9-48><a id=__codelineno-9-48 name=__codelineno-9-48 href=#__codelineno-9-48></a>            <span class=k>if</span> <span class=n>match_result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;matches&#39;</span><span class=p>):</span>
</span><span id=__span-9-49><a id=__codelineno-9-49 name=__codelineno-9-49 href=#__codelineno-9-49></a>                <span class=n>score</span> <span class=o>+=</span> <span class=mf>0.6</span> <span class=o>*</span> <span class=n>match_result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;confidence&#39;</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>)</span> <span class=c1># Boost by confidence</span>
</span><span id=__span-9-50><a id=__codelineno-9-50 name=__codelineno-9-50 href=#__codelineno-9-50></a>        <span class=c1># ... add mood and energy scoring ...</span>
</span><span id=__span-9-51><a id=__codelineno-9-51 name=__codelineno-9-51 href=#__codelineno-9-51></a>        <span class=k>return</span> <span class=nb>min</span><span class=p>(</span><span class=n>score</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>)</span>
</span></code></pre></div></li> </ul> </li> <li> <p><strong><code>DiscoveryAgent</code> (<code>src/agents/discovery/agent.py</code>):</strong></p> <ul> <li>Specializes in finding novel, under-the-radar, or serendipitous tracks.</li> <li>Also guided by the <code>PlannerAgent</code>'s <code>coordination_strategy</code>.</li> <li>Leverages <code>UnifiedCandidateGenerator</code> with a "discovery" strategy and <code>QualityScorer</code>.</li> <li>Its internal logic might involve components like <code>SimilarityExplorer</code> and <code>UndergroundDetector</code> for multi-hop similarity and identifying obscure artists. <div class="language-python highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=c1># src/agents/discovery/agent.py (Illustrative Snippet - Process Overview)</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=k>class</span><span class=w> </span><span class=nc>DiscoveryAgent</span><span class=p>(</span><span class=n>BaseAgent</span><span class=p>):</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>:</span> <span class=n>MusicRecommenderState</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>MusicRecommenderState</span><span class=p>:</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>        <span class=n>entities</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>entities</span> <span class=ow>or</span> <span class=p>{}</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a>        <span class=n>intent_analysis</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>intent_analysis</span> <span class=ow>or</span> <span class=p>{}</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_adapt_to_intent</span><span class=p>(</span><span class=n>intent_analysis</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;intent&#39;</span><span class=p>,</span> <span class=s1>&#39;discovery&#39;</span><span class=p>))</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a>        <span class=c1># Generate candidates using discovery-focused strategy</span>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a>        <span class=n>candidates</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>candidate_generator</span><span class=o>.</span><span class=n>generate_candidate_pool</span><span class=p>(</span>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a>            <span class=n>entities</span><span class=o>=</span><span class=n>entities</span><span class=p>,</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a>            <span class=n>intent_analysis</span><span class=o>=</span><span class=n>intent_analysis</span><span class=p>,</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a>            <span class=n>agent_type</span><span class=o>=</span><span class=s2>&quot;discovery&quot;</span><span class=p>,</span>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a>            <span class=c1># ...</span>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a>        <span class=p>)</span>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a>        <span class=c1># Score, filter, and create recommendations</span>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a>        <span class=c1># ...</span>
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a>        <span class=n>state</span><span class=o>.</span><span class=n>discovery_recommendations</span> <span class=o>=</span> <span class=p>[</span><span class=n>rec</span><span class=o>.</span><span class=n>model_dump</span><span class=p>()</span> <span class=k>for</span> <span class=n>rec</span> <span class=ow>in</span> <span class=n>recommendations</span><span class=p>]</span>
</span><span id=__span-10-18><a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a>        <span class=k>return</span> <span class=n>state</span>
</span></code></pre></div></li> </ul> </li> <li> <p><strong><code>JudgeAgent</code> (<code>src/agents/judge/agent.py</code>):</strong></p> <ul> <li>The final arbiter. It evaluates candidates from both advocate agents.</li> <li>Uses the <code>evaluation_framework</code> (weights, diversity targets) from the <code>PlannerAgent</code>'s strategy.</li> <li>Employs <code>RankingLogic</code> for scoring and selection, and <code>ConversationalExplainer</code> (which uses <code>LLMUtils</code>) to generate human-readable explanations for each chosen track.</li> <li>The "Enhanced JudgeAgent" (as per design docs) incorporates more sophisticated prompt-driven ranking, contextual relevance, and discovery appropriateness scoring. <div class="language-python highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=c1># src/agents/judge/agent.py (Illustrative Snippet - Process Overview)</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=k>class</span><span class=w> </span><span class=nc>JudgeAgent</span><span class=p>(</span><span class=n>BaseAgent</span><span class=p>):</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>:</span> <span class=n>MusicRecommenderState</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>MusicRecommenderState</span><span class=p>:</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&quot;Starting judge agent processing&quot;</span><span class=p>)</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>        <span class=n>all_candidates</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_collect_all_candidates</span><span class=p>(</span><span class=n>state</span><span class=p>)</span> <span class=c1># From GenreMood &amp; Discovery</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>all_candidates</span><span class=p>:</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a>            <span class=n>state</span><span class=o>.</span><span class=n>final_recommendations</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a>            <span class=k>return</span> <span class=n>state</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a>        <span class=c1># Score all candidates (quality, relevance, intent alignment, etc.)</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a>        <span class=c1># This step internally uses QualityScorer and context/intent specific logic</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a>        <span class=n>scored_candidates_with_details</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_score_all_candidates</span><span class=p>(</span><span class=n>all_candidates</span><span class=p>,</span> <span class=n>state</span><span class=p>)</span>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a>        <span class=c1># Rank candidates using intent-aware RankingLogic</span>
</span><span id=__span-11-16><a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a>        <span class=c1># The intent is pulled from state.query_understanding.intent</span>
</span><span id=__span-11-17><a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a>        <span class=n>ranked_candidates</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_rank_candidates</span><span class=p>(</span><span class=n>scored_candidates_with_details</span><span class=p>,</span> <span class=n>state</span><span class=p>)</span>
</span><span id=__span-11-18><a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a>
</span><span id=__span-11-19><a id=__codelineno-11-19 name=__codelineno-11-19 href=#__codelineno-11-19></a>        <span class=c1># Select final recommendations with diversity</span>
</span><span id=__span-11-20><a id=__codelineno-11-20 name=__codelineno-11-20 href=#__codelineno-11-20></a>        <span class=c1># The diversity logic also considers the intent (e.g., allowing more from one artist if &#39;by_artist&#39;)</span>
</span><span id=__span-11-21><a id=__codelineno-11-21 name=__codelineno-11-21 href=#__codelineno-11-21></a>        <span class=n>final_selections</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_select_with_diversity</span><span class=p>(</span><span class=n>ranked_candidates</span><span class=p>,</span> <span class=n>state</span><span class=p>)</span>
</span><span id=__span-11-22><a id=__codelineno-11-22 name=__codelineno-11-22 href=#__codelineno-11-22></a>
</span><span id=__span-11-23><a id=__codelineno-11-23 name=__codelineno-11-23 href=#__codelineno-11-23></a>        <span class=n>final_recommendations_with_explanations</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_generate_explanations</span><span class=p>(</span><span class=n>final_selections</span><span class=p>,</span> <span class=n>state</span><span class=p>)</span>
</span><span id=__span-11-24><a id=__codelineno-11-24 name=__codelineno-11-24 href=#__codelineno-11-24></a>
</span><span id=__span-11-25><a id=__codelineno-11-25 name=__codelineno-11-25 href=#__codelineno-11-25></a>        <span class=c1># Convert to dict for state (as per MusicRecommenderState annotation)</span>
</span><span id=__span-11-26><a id=__codelineno-11-26 name=__codelineno-11-26 href=#__codelineno-11-26></a>        <span class=n>state</span><span class=o>.</span><span class=n>final_recommendations</span> <span class=o>=</span> <span class=p>[</span><span class=n>rec</span><span class=o>.</span><span class=n>model_dump</span><span class=p>()</span> <span class=k>for</span> <span class=n>rec</span> <span class=ow>in</span> <span class=n>final_recommendations_with_explanations</span><span class=p>]</span>
</span><span id=__span-11-27><a id=__codelineno-11-27 name=__codelineno-11-27 href=#__codelineno-11-27></a>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Judge agent completed, </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>state</span><span class=o>.</span><span class=n>final_recommendations</span><span class=p>)</span><span class=si>}</span><span class=s2> final recommendations.&quot;</span><span class=p>)</span>
</span><span id=__span-11-28><a id=__codelineno-11-28 name=__codelineno-11-28 href=#__codelineno-11-28></a>        <span class=k>return</span> <span class=n>state</span>
</span><span id=__span-11-29><a id=__codelineno-11-29 name=__codelineno-11-29 href=#__codelineno-11-29></a>
</span><span id=__span-11-30><a id=__codelineno-11-30 name=__codelineno-11-30 href=#__codelineno-11-30></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>_rank_candidates</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>scored_candidates_with_details</span><span class=p>,</span> <span class=n>state</span><span class=p>):</span>
</span><span id=__span-11-31><a id=__codelineno-11-31 name=__codelineno-11-31 href=#__codelineno-11-31></a>        <span class=c1># Determine intent (e.g., &#39;artist_similarity&#39;, &#39;hybrid_discovery_primary&#39;)</span>
</span><span id=__span-11-32><a id=__codelineno-11-32 name=__codelineno-11-32 href=#__codelineno-11-32></a>        <span class=n>intent</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>query_understanding</span><span class=o>.</span><span class=n>intent</span><span class=o>.</span><span class=n>value</span> <span class=k>if</span> <span class=n>state</span><span class=o>.</span><span class=n>query_understanding</span> <span class=k>else</span> <span class=s1>&#39;balanced&#39;</span>
</span><span id=__span-11-33><a id=__codelineno-11-33 name=__codelineno-11-33 href=#__codelineno-11-33></a>        <span class=k>if</span> <span class=n>intent</span> <span class=o>==</span> <span class=s1>&#39;hybrid&#39;</span><span class=p>:</span> <span class=c1># Refine to sub-type if hybrid</span>
</span><span id=__span-11-34><a id=__codelineno-11-34 name=__codelineno-11-34 href=#__codelineno-11-34></a>            <span class=n>intent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_detect_hybrid_subtype</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span><span id=__span-11-35><a id=__codelineno-11-35 name=__codelineno-11-35 href=#__codelineno-11-35></a>
</span><span id=__span-11-36><a id=__codelineno-11-36 name=__codelineno-11-36 href=#__codelineno-11-36></a>        <span class=c1># Get weights and novelty threshold based on this refined intent</span>
</span><span id=__span-11-37><a id=__codelineno-11-37 name=__codelineno-11-37 href=#__codelineno-11-37></a>        <span class=n>scoring_weights</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ranking_logic</span><span class=o>.</span><span class=n>get_intent_weights</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span> <span class=n>state</span><span class=o>.</span><span class=n>entities</span><span class=p>,</span> <span class=n>state</span><span class=o>.</span><span class=n>intent_analysis</span><span class=p>)</span>
</span><span id=__span-11-38><a id=__codelineno-11-38 name=__codelineno-11-38 href=#__codelineno-11-38></a>        <span class=n>novelty_threshold</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ranking_logic</span><span class=o>.</span><span class=n>get_novelty_threshold</span><span class=p>(</span><span class=n>intent</span><span class=p>)</span>
</span><span id=__span-11-39><a id=__codelineno-11-39 name=__codelineno-11-39 href=#__codelineno-11-39></a>
</span><span id=__span-11-40><a id=__codelineno-11-40 name=__codelineno-11-40 href=#__codelineno-11-40></a>        <span class=c1># Rank using these intent-specific parameters</span>
</span><span id=__span-11-41><a id=__codelineno-11-41 name=__codelineno-11-41 href=#__codelineno-11-41></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>ranking_logic</span><span class=o>.</span><span class=n>rank_recommendations</span><span class=p>(</span>
</span><span id=__span-11-42><a id=__codelineno-11-42 name=__codelineno-11-42 href=#__codelineno-11-42></a>            <span class=n>candidates</span><span class=o>=</span><span class=n>scored_candidates_with_details</span><span class=p>,</span>
</span><span id=__span-11-43><a id=__codelineno-11-43 name=__codelineno-11-43 href=#__codelineno-11-43></a>            <span class=n>intent</span><span class=o>=</span><span class=n>intent</span><span class=p>,</span>
</span><span id=__span-11-44><a id=__codelineno-11-44 name=__codelineno-11-44 href=#__codelineno-11-44></a>            <span class=n>entities</span><span class=o>=</span><span class=n>state</span><span class=o>.</span><span class=n>entities</span><span class=p>,</span>
</span><span id=__span-11-45><a id=__codelineno-11-45 name=__codelineno-11-45 href=#__codelineno-11-45></a>            <span class=n>intent_analysis</span><span class=o>=</span><span class=n>state</span><span class=o>.</span><span class=n>intent_analysis</span><span class=p>,</span>
</span><span id=__span-11-46><a id=__codelineno-11-46 name=__codelineno-11-46 href=#__codelineno-11-46></a>            <span class=n>novelty_threshold</span><span class=o>=</span><span class=n>novelty_threshold</span><span class=p>,</span>
</span><span id=__span-11-47><a id=__codelineno-11-47 name=__codelineno-11-47 href=#__codelineno-11-47></a>            <span class=n>scoring_weights</span><span class=o>=</span><span class=n>scoring_weights</span>
</span><span id=__span-11-48><a id=__codelineno-11-48 name=__codelineno-11-48 href=#__codelineno-11-48></a>        <span class=p>)</span>
</span></code></pre></div></li> </ul> </li> </ul> </li> </ul> </li> </ul> <h5 id=services>Services<a class=headerlink href=#services title="Permanent link">&para;</a></h5> <ul> <li><strong>(<code>src/services/</code>):</strong><ul> <li> <p>This layer acts as an intermediary between the API/UI and the agent system, managing workflows and shared resources.</p> <ul> <li> <p><strong><code>enhanced_recommendation_service.py</code> (<code>EnhancedRecommendationService</code>):</strong></p> <ul> <li>This is the primary service responsible for handling a user's recommendation request from end-to-end.</li> <li><strong>Agent Initialization:</strong> It instantiates all agents (<code>PlannerAgent</code>, <code>GenreMoodAgent</code>, <code>DiscoveryAgent</code>, <code>JudgeAgent</code>), injecting necessary dependencies like the <code>APIService</code>, <code>MetadataService</code>, LLM client, and rate limiters. This dependency injection pattern is crucial for creating testable and configurable agents.</li> <li><strong>LangGraph Workflow Orchestration:</strong> It defines and compiles the LangGraph state graph. This graph dictates the flow of execution:<ol> <li><code>PlannerAgent</code> runs first.</li> <li>Based on the planner's output (specifically <code>agent_sequence</code> in the <code>planning_strategy</code>), it conditionally routes to either <code>DiscoveryAgent</code> only, <code>GenreMoodAgent</code> only, or both in parallel.</li> <li>Outputs from advocate agents are collected in the <code>MusicRecommenderState</code>.</li> <li><code>JudgeAgent</code> runs last to produce the final recommendations.</li> </ol> </li> <li><strong>State Management:</strong> It initiates the <code>MusicRecommenderState</code> and manages its passage through the LangGraph workflow.</li> <li><strong>Response Formatting:</strong> It converts the final agent outputs into a user-friendly <code>RecommendationResponse</code>, often involving calls to <code>APIService</code> to enrich track data (e.g., adding Spotify preview URLs). <div class="language-python highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=c1># src/services/enhanced_recommendation_service.py (Illustrative Snippet - Graph Building)</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=k>class</span><span class=w> </span><span class=nc>EnhancedRecommendationService</span><span class=p>:</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>    <span class=k>def</span><span class=w> </span><span class=nf>_build_workflow_graph</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>StateGraph</span><span class=p>:</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>        <span class=n>workflow</span> <span class=o>=</span> <span class=n>StateGraph</span><span class=p>(</span><span class=n>MusicRecommenderState</span><span class=p>)</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>        <span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&quot;planner&quot;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_planner_node</span><span class=p>)</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a>        <span class=c1># ... add advocate and judge nodes ...</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a>        <span class=n>workflow</span><span class=o>.</span><span class=n>set_entry_point</span><span class=p>(</span><span class=s2>&quot;planner&quot;</span><span class=p>)</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a>        <span class=n>workflow</span><span class=o>.</span><span class=n>add_conditional_edges</span><span class=p>(</span><span class=s2>&quot;planner&quot;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_route_agents</span><span class=p>,</span> <span class=o>...</span><span class=p>)</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a>        <span class=c1># ... define other edges for the workflow ...</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a>        <span class=n>workflow</span><span class=o>.</span><span class=n>add_edge</span><span class=p>(</span><span class=s2>&quot;judge&quot;</span><span class=p>,</span> <span class=n>END</span><span class=p>)</span>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a>        <span class=k>return</span> <span class=n>workflow</span><span class=o>.</span><span class=n>compile</span><span class=p>()</span>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>get_recommendations</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>:</span> <span class=n>ServiceRequest</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ServiceResponse</span><span class=p>:</span>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>initialize_agents</span><span class=p>()</span> <span class=c1># Ensure agents are ready</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a>        <span class=c1># ... create initial MusicRecommenderState ...</span>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a>        <span class=c1># ... (NEW) Analyze context using self.context_analyzer ...</span>
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17 href=#__codelineno-12-17></a>        <span class=n>workflow_state</span> <span class=o>=</span> <span class=n>MusicRecommenderState</span><span class=p>(</span><span class=n>user_query</span><span class=o>=</span><span class=n>request</span><span class=o>.</span><span class=n>query</span><span class=p>,</span> <span class=o>...</span><span class=p>,</span> <span class=n>context_override</span><span class=o>=</span><span class=n>context_override_data</span><span class=p>)</span>
</span><span id=__span-12-18><a id=__codelineno-12-18 name=__codelineno-12-18 href=#__codelineno-12-18></a>        <span class=n>final_state</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>graph</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>(</span><span class=n>workflow_state</span><span class=p>)</span>
</span><span id=__span-12-19><a id=__codelineno-12-19 name=__codelineno-12-19 href=#__codelineno-12-19></a>        <span class=c1># ... process final_state and convert to ServiceResponse ...</span>
</span><span id=__span-12-20><a id=__codelineno-12-20 name=__codelineno-12-20 href=#__codelineno-12-20></a>        <span class=k>return</span> <span class=n>ServiceResponse</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></code></pre></div></li> </ul> </li> <li> <p><strong><code>api_service.py</code> (<code>APIService</code>):</strong> <em>(Described in the API Layer, but used extensively by services)</em></p> <ul> <li>Provides a centralized and abstracted way for all services (and subsequently agents, via dependency injection) to interact with external music APIs like Last.fm and Spotify.</li> <li>It uses the <code>APIClientFactory</code> to get configured <code>LastFmClient</code> and <code>SpotifyClient</code> instances, ensuring shared rate limiters and session management.</li> </ul> </li> <li> <p><strong><code>metadata_service.py</code> (<code>MetadataService</code>):</strong></p> <ul> <li>Offers unified functions for fetching and processing track and artist metadata.</li> <li>It can combine information from multiple sources (e.g., Last.fm and Spotify) into a <code>UnifiedTrackMetadata</code> or <code>UnifiedArtistMetadata</code> object, providing a consistent data view to the rest of the application.</li> </ul> </li> <li> <p><strong><code>conversation_context_service.py</code> (<code>ConversationContextManager</code>):</strong></p> <ul> <li>Manages the history of interactions within a user session.</li> <li>Tracks queries, extracted entities from those queries, recommendations provided, and any user feedback.</li> <li>This service is crucial for enabling multi-turn conversations and allowing the system to understand evolving user preferences.</li> </ul> </li> <li> <p><strong><code>smart_context_manager.py</code> (<code>SmartContextManager</code>):</strong></p> <ul> <li>Works in tandem with the <code>ConversationContextManager</code>.</li> <li>Its key responsibility is to <em>intelligently decide</em> whether to maintain the current conversation context, modify it, or reset it entirely based on the user's new query.</li> <li>It analyzes the new query for intent changes (e.g., switching from "music like Artist A" to "music like Artist B", or from "workout music" to "study music") and explicit reset triggers (e.g., "never mind").</li> <li>The <code>EnhancedRecommendationService</code> uses this manager (via its <code>ContextAwareIntentAnalyzer</code> which uses LLM capabilities) <em>before</em> invoking the agent workflow to determine the appropriate context to pass to the <code>PlannerAgent</code>. <div class="language-python highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=c1># src/services/enhanced_recommendation_service.py (Illustrative usage of context_analyzer)</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=c1># (Inside get_recommendations method)</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=c1># ...</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=n>context_override</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>context_analyzer</span><span class=o>.</span><span class=n>analyze_context</span><span class=p>(</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a>    <span class=n>request</span><span class=o>.</span><span class=n>query</span><span class=p>,</span> <span class=n>conversation_history</span> <span class=c1># conversation_history fetched via self.context_manager</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=p>)</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=c1># ...</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=n>workflow_state</span> <span class=o>=</span> <span class=n>MusicRecommenderState</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>context_override</span><span class=o>=</span><span class=n>context_override</span><span class=p>)</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=c1># ...</span>
</span></code></pre></div></li> </ul> </li> <li> <p><strong><code>cache_manager.py</code> (<code>CacheManager</code>):</strong></p> <ul> <li>Provides a file-based caching layer (using <code>diskcache</code>) for API responses, track metadata, and potentially agent strategies.</li> <li>It helps reduce redundant API calls, improve performance, and stay within API rate limits. Different cache types (e.g., "lastfm", "spotify", "tracks") with configurable TTLs are managed.</li> </ul> </li> </ul> </li> </ul> </li> </ul> <p>Okay, here's the "Frontend" section for your blog post, drawing from your UI components (<code>src/ui/</code>) and the overall system design.</p> <hr> <h2 id=2-the-frontend-gradio-for-interactive-music-discovery>2. The Frontend: Gradio for Interactive Music Discovery<a class=headerlink href=#2-the-frontend-gradio-for-interactive-music-discovery title="Permanent link">&para;</a></h2> <p>The user interface for BeatDebate is built using <strong>Gradio</strong>, enabling a rapid, interactive, and chat-first experience. Gradio was chosen for its simplicity in creating web UIs for machine learning models and agent-based systems, and its seamless integration with Python backends. The frontend is designed to be intuitive, providing not just recommendations but also insights into the AI's decision-making process.</p> <h3 id=key-ui-components-features>Key UI Components &amp; Features<a class=headerlink href=#key-ui-components-features title="Permanent link">&para;</a></h3> <ul> <li><strong>(<code>src/ui/</code>)</strong>:<ul> <li> <p>This is where the user interface components of the web application are located.</p> <ul> <li> <p><strong><code>chat_interface.py</code> (<code>BeatDebateChatInterface</code>):</strong></p> <ul> <li>This is the central component, creating the primary chat window where users interact with BeatDebate.</li> <li><strong>Chat Input &amp; Display:</strong> Provides a familiar textbox for users to type their music queries and a chat area to display the conversation history (user prompts and agent responses).</li> <li><strong>Example Prompts:</strong> To help users get started, the interface (as seen in <code>create_interface</code>) presents clickable example queries categorized by intent (Artist Similarity, Discovery, Genre/Mood, Contextual, Hybrid). This showcases the system's versatility. <div class="language-python highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=c1># src/ui/chat_interface.py (Illustrative - Example Button Setup)</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=c1># (Inside create_interface method)</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=c1># ...</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=k>with</span> <span class=n>gr</span><span class=o>.</span><span class=n>Row</span><span class=p>():</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a>    <span class=k>with</span> <span class=n>gr</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=n>scale</span><span class=o>=</span><span class=mi>1</span><span class=p>):</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a>        <span class=n>gr</span><span class=o>.</span><span class=n>Markdown</span><span class=p>(</span><span class=s2>&quot;**ðŸŽ¯ Artist Similarity**&quot;</span><span class=p>)</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a>        <span class=k>for</span> <span class=n>example</span> <span class=ow>in</span> <span class=n>QUERY_EXAMPLES</span><span class=p>[</span><span class=s2>&quot;Artist Similarity&quot;</span><span class=p>]:</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a>            <span class=n>btn</span> <span class=o>=</span> <span class=n>gr</span><span class=o>.</span><span class=n>Button</span><span class=p>(</span><span class=n>example</span><span class=p>,</span> <span class=n>elem_classes</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;example-chip&quot;</span><span class=p>],</span> <span class=o>...</span><span class=p>)</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a>            <span class=n>example_buttons</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>btn</span><span class=p>,</span> <span class=n>example</span><span class=p>))</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=c1># ...</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=c1># Example button handlers</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a><span class=k>for</span> <span class=n>btn</span><span class=p>,</span> <span class=n>example_text</span> <span class=ow>in</span> <span class=n>example_buttons</span><span class=p>:</span>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a>    <span class=n>btn</span><span class=o>.</span><span class=n>click</span><span class=p>(</span><span class=n>fn</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=o>=</span><span class=n>example_text</span><span class=p>:</span> <span class=n>x</span><span class=p>,</span> <span class=n>inputs</span><span class=o>=</span><span class=p>[],</span> <span class=n>outputs</span><span class=o>=</span><span class=p>[</span><span class=n>msg_input</span><span class=p>])</span>
</span></code></pre></div></li> <li><strong>Asynchronous Processing:</strong> The <code>process_message</code> method handles user input by making an asynchronous HTTP POST request to the FastAPI backend's <code>/recommendations</code> endpoint. This ensures the UI remains responsive while the backend agents work. <div class="language-python highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=c1># src/ui/chat_interface.py (Illustrative - process_message)</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=k>class</span><span class=w> </span><span class=nc>BeatDebateChatInterface</span><span class=p>:</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>process_message</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>message</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>history</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Tuple</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]):</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a>        <span class=c1># ...</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a>        <span class=n>recommendations_response</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_recommendations</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a>        <span class=k>if</span> <span class=n>recommendations_response</span><span class=p>:</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a>            <span class=n>formatted_response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>response_formatter</span><span class=o>.</span><span class=n>format_recommendations</span><span class=p>(</span><span class=n>recommendations_response</span><span class=p>)</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a>            <span class=n>history</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>message</span><span class=p>,</span> <span class=n>formatted_response</span><span class=p>))</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a>            <span class=c1># ... update internal conversation_history for context ...</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a>            <span class=n>lastfm_player_html</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_lastfm_player_html</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span><span id=__span-15-11><a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a>            <span class=k>return</span> <span class=s2>&quot;&quot;</span><span class=p>,</span> <span class=n>history</span><span class=p>,</span> <span class=n>lastfm_player_html</span> <span class=c1># Clears input, updates chat, updates player</span>
</span><span id=__span-15-12><a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a>        <span class=c1># ... error handling ...</span>
</span></code></pre></div></li> <li><strong>Contextual History:</strong> The <code>BeatDebateChatInterface</code> maintains <code>self.conversation_history</code>. This history (recent queries and first track of recommendations) is passed back to the backend with each new request, enabling the <code>SmartContextManager</code> and <code>ContextAwareIntentAnalyzer</code> to understand multi-turn conversations and provide contextually relevant responses.</li> </ul> </li> <li> <p><strong><code>response_formatter.py</code> (<code>ResponseFormatter</code>):</strong></p> <ul> <li>This class is responsible for taking the JSON response from the backend (which includes the list of <code>UnifiedTrackMetadata</code> objects and reasoning logs) and transforming it into rich, human-readable Markdown suitable for display in the Gradio chat.</li> <li><strong>Track Display:</strong> Each recommended track is formatted with its title, artist, a confidence badge (color-coded based on the recommendation score), and the source agent.</li> <li><strong>External Links:</strong> It generates direct links for each track to Last.fm, Spotify (search), and YouTube (search), making it easy for users to listen.</li> <li><strong>Reasoning Visibility:</strong> It includes an expandable "View Detailed Agent Reasoning" section, displaying the <code>reasoning_log</code> from the backend. This directly addresses the goal of explainable AI. <div class="language-python highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=c1># src/ui/response_formatter.py (Illustrative - Single Recommendation Formatting)</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=k>class</span><span class=w> </span><span class=nc>ResponseFormatter</span><span class=p>:</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a>    <span class=k>def</span><span class=w> </span><span class=nf>_format_single_recommendation</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>rec</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>],</span> <span class=n>rank</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a>        <span class=n>title</span> <span class=o>=</span> <span class=n>rec</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;title&quot;</span><span class=p>,</span> <span class=s2>&quot;Unknown Title&quot;</span><span class=p>)</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a>        <span class=n>artist</span> <span class=o>=</span> <span class=n>rec</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;artist&quot;</span><span class=p>,</span> <span class=s2>&quot;Unknown Artist&quot;</span><span class=p>)</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a>        <span class=n>confidence</span> <span class=o>=</span> <span class=n>rec</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;confidence&quot;</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>)</span> <span class=o>*</span> <span class=mi>100</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a>        <span class=c1># ... logic for confidence badge color ...</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a>        <span class=c1># Generates links using f-strings to Last.fm, Spotify, YouTube</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a>        <span class=n>lastfm_url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;https://www.last.fm/search?q=</span><span class=si>{</span><span class=n>artist</span><span class=si>}</span><span class=s2>+</span><span class=si>{</span><span class=n>title</span><span class=si>}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot; &quot;</span><span class=p>,</span> <span class=s2>&quot;+&quot;</span><span class=p>)</span>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a>        <span class=c1># ...</span>
</span><span id=__span-16-12><a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a>
</span><span id=__span-16-13><a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a>        <span class=n>markdown</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-16-14><a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a>            <span class=sa>f</span><span class=s2>&quot;## </span><span class=si>{</span><span class=n>rank</span><span class=si>}</span><span class=s2>. </span><span class=se>\&quot;</span><span class=si>{</span><span class=n>title</span><span class=si>}</span><span class=se>\&quot;</span><span class=s2> by </span><span class=si>{</span><span class=n>artist</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
</span><span id=__span-16-15><a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a>            <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>confidence_badge_html</span><span class=si>}</span><span class=s2> â€¢ *via </span><span class=si>{</span><span class=n>rec</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;source&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;unknown&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>*&quot;</span><span class=p>,</span>
</span><span id=__span-16-16><a id=__codelineno-16-16 name=__codelineno-16-16 href=#__codelineno-16-16></a>            <span class=sa>f</span><span class=s2>&quot;ðŸŽ§ **[Listen on Last.fm](</span><span class=si>{</span><span class=n>lastfm_url</span><span class=si>}</span><span class=s2>)** ...&quot;</span>
</span><span id=__span-16-17><a id=__codelineno-16-17 name=__codelineno-16-17 href=#__codelineno-16-17></a>        <span class=p>]</span>
</span><span id=__span-16-18><a id=__codelineno-16-18 name=__codelineno-16-18 href=#__codelineno-16-18></a>        <span class=c1># ... add reasoning, genres, moods ...</span>
</span><span id=__span-16-19><a id=__codelineno-16-19 name=__codelineno-16-19 href=#__codelineno-16-19></a>        <span class=k>return</span> <span class=s2>&quot;</span><span class=se>\\</span><span class=s2>n&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>markdown</span><span class=p>)</span>
</span></code></pre></div></li> </ul> </li> <li> <p><strong>Interactive Track Information Panel:</strong></p> <ul> <li>A dedicated section of the UI (managed by <code>_create_lastfm_player_html</code> in <code>chat_interface.py</code>) dynamically updates to show details of the <em>latest</em> set of recommendations.</li> <li>Instead of an embedded player (which can be complex with API limitations), it provides styled cards for each track from the most recent response. Each card includes:<ul> <li>Artist and Title.</li> <li>A "Confidence" badge indicating the system's score for that track.</li> <li>Direct links to search for the track on Last.fm, Spotify, and YouTube.</li> </ul> </li> <li>This panel uses HTML directly rendered by a <code>gr.HTML</code> component and is updated after each successful recommendation. The styling is dark-mode compatible and uses visual cues (like border colors) to reflect recommendation confidence.</li> </ul> </li> <li> <p><strong>Styling and Layout:</strong></p> <ul> <li>The interface uses <code>gr.Blocks</code> for a custom layout, allowing for a main chat area alongside the track information panel and example prompts.</li> <li>Custom CSS is applied via the <code>css</code> parameter in <code>gr.Blocks</code> to achieve the "BeatDebate" theme (dark mode, violet/blue accents, modern feel). This includes styling for chat bubbles, input areas, buttons, and the track info panel for a polished look.</li> </ul> </li> <li> <p><strong><code>planning_display.py</code> (<code>PlanningDisplay</code>):</strong> (Though not directly shown as a separate Gradio component in <code>chat_interface.py</code>, its formatting logic would be invoked if the backend <code>/planning</code> endpoint's output were to be displayed).</p> <ul> <li>This component is designed to take the detailed <code>planning_strategy</code> JSON from the <code>PlannerAgent</code> (via the backend) and format it into a structured, readable HTML representation.</li> <li>It would break down the strategy into sections: Task Analysis (primary goal, complexity), Agent Coordination (specific instructions for <code>GenreMoodAgent</code> and <code>DiscoveryAgent</code>), Evaluation Criteria (weights, diversity targets), and Execution Monitoring.</li> <li>This visualization is key for the AgentX competition to showcase the "planning-centric" nature of BeatDebate. The <code>ResponseFormatter</code> could potentially integrate this to display parts of the planning strategy alongside recommendations if desired.</li> </ul> </li> </ul> </li> </ul> </li> </ul> <h2 id=conclusion>Conclusion<a class=headerlink href=#conclusion title="Permanent link">&para;</a></h2> <p>BeatDebate set out to explore a novel approach to music recommendation: one where explicit, LLM-driven planning and transparent agentic workflows take center stage. By decoupling query understanding and strategic planning (PlannerAgent) from specialized execution (Advocate Agents) and reasoned evaluation (JudgeAgent), the system achieves a new level of explainability and control. While currently a proof-of-concept, the architectural patterns explored in BeatDebateâ€”planning-centric design, specialized agent collaboration, and explainable outputsâ€”offer a promising direction for the next generation of intelligent recommender systems and beyond.</p> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../../19/concept-visualizer-technical-deep-dive/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Concept Visualizer: An AI-Powered Design Tool - Technical Deep Dive"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Concept Visualizer: An AI-Powered Design Tool - Technical Deep Dive </div> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://www.linkedin.com/in/sulman-khan target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href=https://github.com/sulmank target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../../../../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../../../../assets/javascripts/bundle.13a4f30d.min.js></script> <script src=../../../../../javascripts/mathjax.js></script> <script src=../../../../../javascripts/analytics.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> <script id=init-glightbox>const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>