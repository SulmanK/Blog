<!DOCTYPE html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=../../08/Reddit%20AI%20Pulse%20%28On-Prem%29/ rel=prev><link href=../../../05/19/concept-visualizer-technical-deep-dive/ rel=next><link rel=icon href=../../../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.1"><title>From Reddit to Insights: Building an AI-Powered Data Pipeline with Gemini (Cloud) - SulmanK Blog</title><link rel=stylesheet href=../../../../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../../../../assets/stylesheets/palette.ab4e12ef.min.css><style>:root{--md-admonition-icon--note:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M1%207.775V2.75C1%201.784%201.784%201%202.75%201h5.025c.464%200%20.91.184%201.238.513l6.25%206.25a1.75%201.75%200%200%201%200%202.474l-5.026%205.026a1.75%201.75%200%200%201-2.474%200l-6.25-6.25A1.75%201.75%200%200%201%201%207.775m1.5%200c0%20.066.026.13.073.177l6.25%206.25a.25.25%200%200%200%20.354%200l5.025-5.025a.25.25%200%200%200%200-.354l-6.25-6.25a.25.25%200%200%200-.177-.073H2.75a.25.25%200%200%200-.25.25ZM6%205a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E');--md-admonition-icon--abstract:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2.5%201.75v11.5c0%20.138.112.25.25.25h3.17a.75.75%200%200%201%200%201.5H2.75A1.75%201.75%200%200%201%201%2013.25V1.75C1%20.784%201.784%200%202.75%200h8.5C12.216%200%2013%20.784%2013%201.75v7.736a.75.75%200%200%201-1.5%200V1.75a.25.25%200%200%200-.25-.25h-8.5a.25.25%200%200%200-.25.25m13.274%209.537zl-4.557%204.45a.75.75%200%200%201-1.055-.008l-1.943-1.95a.75.75%200%200%201%201.062-1.058l1.419%201.425%204.026-3.932a.75.75%200%201%201%201.048%201.074M4.75%204h4.5a.75.75%200%200%201%200%201.5h-4.5a.75.75%200%200%201%200-1.5M4%207.75A.75.75%200%200%201%204.75%207h2a.75.75%200%200%201%200%201.5h-2A.75.75%200%200%201%204%207.75%22/%3E%3C/svg%3E');--md-admonition-icon--info:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M0%208a8%208%200%201%201%2016%200A8%208%200%200%201%200%208m8-6.5a6.5%206.5%200%201%200%200%2013%206.5%206.5%200%200%200%200-13M6.5%207.75A.75.75%200%200%201%207.25%207h1a.75.75%200%200%201%20.75.75v2.75h.25a.75.75%200%200%201%200%201.5h-2a.75.75%200%200%201%200-1.5h.25v-2h-.25a.75.75%200%200%201-.75-.75M8%206a1%201%200%201%201%200-2%201%201%200%200%201%200%202%22/%3E%3C/svg%3E');--md-admonition-icon--tip:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M3.499.75a.75.75%200%200%201%201.5%200v.996C5.9%202.903%206.793%203.65%207.662%204.376l.24.202c-.036-.694.055-1.422.426-2.163C9.1.873%2010.794-.045%2012.622.26%2014.408.558%2016%201.94%2016%204.25c0%201.278-.954%202.575-2.44%202.734l.146.508.065.22c.203.701.412%201.455.476%202.226.142%201.707-.4%203.03-1.487%203.898C11.714%2014.671%2010.27%2015%208.75%2015h-6a.75.75%200%200%201%200-1.5h1.376a4.5%204.5%200%200%201-.563-1.191%203.84%203.84%200%200%201-.05-2.063%204.65%204.65%200%200%201-2.025-.293.75.75%200%200%201%20.525-1.406c1.357.507%202.376-.006%202.698-.318l.009-.01a.747.747%200%200%201%201.06%200%20.75.75%200%200%201-.012%201.074c-.912.92-.992%201.835-.768%202.586.221.74.745%201.337%201.196%201.621H8.75c1.343%200%202.398-.296%203.074-.836.635-.507%201.036-1.31.928-2.602-.05-.603-.216-1.224-.422-1.93l-.064-.221c-.12-.407-.246-.84-.353-1.29a2.4%202.4%200%200%201-.507-.441%203.1%203.1%200%200%201-.633-1.248.75.75%200%200%201%201.455-.364c.046.185.144.436.31.627.146.168.353.305.712.305.738%200%201.25-.615%201.25-1.25%200-1.47-.95-2.315-2.123-2.51-1.172-.196-2.227.387-2.706%201.345-.46.92-.27%201.774.019%203.062l.042.19.01.05c.348.443.666.949.94%201.553a.75.75%200%201%201-1.365.62c-.553-1.217-1.32-1.94-2.3-2.768L6.7%205.527c-.814-.68-1.75-1.462-2.692-2.619a3.7%203.7%200%200%200-1.023.88c-.406.495-.663%201.036-.722%201.508.116.122.306.21.591.239.388.038.797-.06%201.032-.19a.75.75%200%200%201%20.728%201.31c-.515.287-1.23.439-1.906.373-.682-.067-1.473-.38-1.879-1.193L.75%205.677V5.5c0-.984.48-1.94%201.077-2.664.46-.559%201.05-1.055%201.673-1.353z%22/%3E%3C/svg%3E');--md-admonition-icon--success:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M13.78%204.22a.75.75%200%200%201%200%201.06l-7.25%207.25a.75.75%200%200%201-1.06%200L2.22%209.28a.75.75%200%200%201%20.018-1.042.75.75%200%200%201%201.042-.018L6%2010.94l6.72-6.72a.75.75%200%200%201%201.06%200%22/%3E%3C/svg%3E');--md-admonition-icon--question:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M0%208a8%208%200%201%201%2016%200A8%208%200%200%201%200%208m8-6.5a6.5%206.5%200%201%200%200%2013%206.5%206.5%200%200%200%200-13M6.92%206.085h.001a.749.749%200%201%201-1.342-.67c.169-.339.436-.701.849-.977C6.845%204.16%207.369%204%208%204a2.76%202.76%200%200%201%201.637.525c.503.377.863.965.863%201.725%200%20.448-.115.83-.329%201.15-.205.307-.47.513-.692.662-.109.072-.22.138-.313.195l-.006.004a6%206%200%200%200-.26.16%201%201%200%200%200-.276.245.75.75%200%200%201-1.248-.832c.184-.264.42-.489.692-.661q.154-.1.313-.195l.007-.004c.1-.061.182-.11.258-.161a1%201%200%200%200%20.277-.245C8.96%206.514%209%206.427%209%206.25a.61.61%200%200%200-.262-.525A1.27%201.27%200%200%200%208%205.5c-.369%200-.595.09-.74.187a1%201%200%200%200-.34.398M9%2011a1%201%200%201%201-2%200%201%201%200%200%201%202%200%22/%3E%3C/svg%3E');--md-admonition-icon--warning:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M6.457%201.047c.659-1.234%202.427-1.234%203.086%200l6.082%2011.378A1.75%201.75%200%200%201%2014.082%2015H1.918a1.75%201.75%200%200%201-1.543-2.575Zm1.763.707a.25.25%200%200%200-.44%200L1.698%2013.132a.25.25%200%200%200%20.22.368h12.164a.25.25%200%200%200%20.22-.368Zm.53%203.996v2.5a.75.75%200%200%201-1.5%200v-2.5a.75.75%200%200%201%201.5%200M9%2011a1%201%200%201%201-2%200%201%201%200%200%201%202%200%22/%3E%3C/svg%3E');--md-admonition-icon--failure:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2.344%202.343za8%208%200%200%201%2011.314%2011.314A8.002%208.002%200%200%201%20.234%2010.089a8%208%200%200%201%202.11-7.746m1.06%2010.253a6.5%206.5%200%201%200%209.108-9.275%206.5%206.5%200%200%200-9.108%209.275M6.03%204.97%208%206.94l1.97-1.97a.749.749%200%200%201%201.275.326.75.75%200%200%201-.215.734L9.06%208l1.97%201.97a.749.749%200%200%201-.326%201.275.75.75%200%200%201-.734-.215L8%209.06l-1.97%201.97a.749.749%200%200%201-1.275-.326.75.75%200%200%201%20.215-.734L6.94%208%204.97%206.03a.75.75%200%200%201%20.018-1.042.75.75%200%200%201%201.042-.018%22/%3E%3C/svg%3E');--md-admonition-icon--danger:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M9.504.43a1.516%201.516%200%200%201%202.437%201.713L10.415%205.5h2.123c1.57%200%202.346%201.909%201.22%203.004l-7.34%207.142a1.25%201.25%200%200%201-.871.354h-.302a1.25%201.25%200%200%201-1.157-1.723L5.633%2010.5H3.462c-1.57%200-2.346-1.909-1.22-3.004zm1.047%201.074L3.286%208.571A.25.25%200%200%200%203.462%209H6.75a.75.75%200%200%201%20.694%201.034l-1.713%204.188%206.982-6.793A.25.25%200%200%200%2012.538%207H9.25a.75.75%200%200%201-.683-1.06l2.008-4.418.003-.006-.004-.009-.006-.006-.008-.001q-.005%200-.009.004%22/%3E%3C/svg%3E');--md-admonition-icon--bug:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M4.72.22a.75.75%200%200%201%201.06%200l1%20.999a3.5%203.5%200%200%201%202.441%200l.999-1a.748.748%200%200%201%201.265.332.75.75%200%200%201-.205.729l-.775.776c.616.63.995%201.493.995%202.444v.327q0%20.15-.025.292c.408.14.764.392%201.029.722l1.968-.787a.75.75%200%200%201%20.556%201.392L13%207.258V9h2.25a.75.75%200%200%201%200%201.5H13v.5q-.002.615-.141%201.186l2.17.868a.75.75%200%200%201-.557%201.392l-2.184-.873A5%205%200%200%201%208%2016a5%205%200%200%201-4.288-2.427l-2.183.873a.75.75%200%200%201-.558-1.392l2.17-.868A5%205%200%200%201%203%2011v-.5H.75a.75.75%200%200%201%200-1.5H3V7.258L.971%206.446a.75.75%200%200%201%20.558-1.392l1.967.787c.265-.33.62-.583%201.03-.722a1.7%201.7%200%200%201-.026-.292V4.5c0-.951.38-1.814.995-2.444L4.72%201.28a.75.75%200%200%201%200-1.06m.53%206.28a.75.75%200%200%200-.75.75V11a3.5%203.5%200%201%200%207%200V7.25a.75.75%200%200%200-.75-.75ZM6.173%205h3.654A.17.17%200%200%200%2010%204.827V4.5a2%202%200%201%200-4%200v.327c0%20.096.077.173.173.173%22/%3E%3C/svg%3E');--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5%205.782V2.5h-.25a.75.75%200%200%201%200-1.5h6.5a.75.75%200%200%201%200%201.5H11v3.282l3.666%205.76C15.619%2013.04%2014.543%2015%2012.767%2015H3.233c-1.776%200-2.852-1.96-1.899-3.458Zm-2.4%206.565a.75.75%200%200%200%20.633%201.153h9.534a.75.75%200%200%200%20.633-1.153L12.225%2010.5h-8.45ZM9.5%202.5h-3V6c0%20.143-.04.283-.117.403L4.73%209h6.54L9.617%206.403A.75.75%200%200%201%209.5%206Z%22/%3E%3C/svg%3E');--md-admonition-icon--quote:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M1.75%202.5h10.5a.75.75%200%200%201%200%201.5H1.75a.75.75%200%200%201%200-1.5m4%205h8.5a.75.75%200%200%201%200%201.5h-8.5a.75.75%200%200%201%200-1.5m0%205h8.5a.75.75%200%200%201%200%201.5h-8.5a.75.75%200%200%201%200-1.5M2.5%207.75v6a.75.75%200%200%201-1.5%200v-6a.75.75%200%200%201%201.5%200%22/%3E%3C/svg%3E');}</style><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../../../assets/_mkdocstrings.css><script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><link href=../../../../../assets/stylesheets/glightbox.min.css rel=stylesheet><script src=../../../../../assets/javascripts/glightbox.min.js></script><style id=glightbox-style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=black data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#from-reddit-to-insights-building-an-ai-powered-data-pipeline-with-gemini-cloud class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../../.. title="SulmanK Blog" class="md-header__button md-logo" aria-label="SulmanK Blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> SulmanK Blog </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> From Reddit to Insights: Building an AI-Powered Data Pipeline with Gemini (Cloud) </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/SulmanK/blog/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </div> <div class=md-source__repository> blog </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../../.. class=md-tabs__link> Home </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../../../ class=md-tabs__link> Writing </a> </li> <li class=md-tabs__item> <a href=../../../../../contact/ class=md-tabs__link> Contact </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation hidden> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../../.. title="SulmanK Blog" class="md-nav__button md-logo" aria-label="SulmanK Blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg> </a> SulmanK Blog </label> <div class=md-nav__source> <a href=https://github.com/SulmanK/blog/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </div> <div class=md-source__repository> blog </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <div class="md-nav__link md-nav__container"> <a href=../../../../ class="md-nav__link "> <span class=md-ellipsis> Writing </span> </a> <label class="md-nav__link " for=__nav_2 id=__nav_2_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Writing </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex> <span class=md-ellipsis> Archive </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Archive </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../archive/2026/ class=md-nav__link> <span class=md-ellipsis> 2026 </span> </a> </li> <li class=md-nav__item> <a href=../../../../archive/2025/ class=md-nav__link> <span class=md-ellipsis> 2025 </span> </a> </li> <li class=md-nav__item> <a href=../../../../archive/2024/ class=md-nav__link> <span class=md-ellipsis> 2024 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex> <span class=md-ellipsis> Categories </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Categories </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../category/ai/ class=md-nav__link> <span class=md-ellipsis> AI </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/agent/ class=md-nav__link> <span class=md-ellipsis> Agent </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/agentic-workflow/ class=md-nav__link> <span class=md-ellipsis> Agentic Workflow </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/agents/ class=md-nav__link> <span class=md-ellipsis> Agents </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/benchmark/ class=md-nav__link> <span class=md-ellipsis> Benchmark </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/cloud-architecture/ class=md-nav__link> <span class=md-ellipsis> Cloud Architecture </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/data-engineering/ class=md-nav__link> <span class=md-ellipsis> Data Engineering </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/data-science/ class=md-nav__link> <span class=md-ellipsis> Data Science </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/deep-learning-recommendation-models/ class=md-nav__link> <span class=md-ellipsis> Deep Learning Recommendation Models </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/evaluation/ class=md-nav__link> <span class=md-ellipsis> Evaluation </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/exploratory-data-analysis/ class=md-nav__link> <span class=md-ellipsis> Exploratory Data Analysis </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/fastapi/ class=md-nav__link> <span class=md-ellipsis> FastAPI </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/full-stack/ class=md-nav__link> <span class=md-ellipsis> Full Stack </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/gcp/ class=md-nav__link> <span class=md-ellipsis> GCP </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/llm/ class=md-nav__link> <span class=md-ellipsis> LLM </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/llms/ class=md-nav__link> <span class=md-ellipsis> LLMs </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/ml/ class=md-nav__link> <span class=md-ellipsis> ML </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/machine-learning/ class=md-nav__link> <span class=md-ellipsis> Machine Learning </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/model-selection/ class=md-nav__link> <span class=md-ellipsis> Model Selection </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/music-technology/ class=md-nav__link> <span class=md-ellipsis> Music Technology </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/react/ class=md-nav__link> <span class=md-ellipsis> React </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/recsys-challenge-2024/ class=md-nav__link> <span class=md-ellipsis> RecSys Challenge 2024 </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/recommendation-systems/ class=md-nav__link> <span class=md-ellipsis> Recommendation Systems </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/recommender-systems/ class=md-nav__link> <span class=md-ellipsis> Recommender Systems </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/social-deduction/ class=md-nav__link> <span class=md-ellipsis> Social Deduction </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/terraform/ class=md-nav__link> <span class=md-ellipsis> Terraform </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/web-development/ class=md-nav__link> <span class=md-ellipsis> Web Development </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/cloud/ class=md-nav__link> <span class=md-ellipsis> cloud </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/end-to-end-pipeline/ class=md-nav__link> <span class=md-ellipsis> end-to-end pipeline </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../../contact/ class=md-nav__link> <span class=md-ellipsis> Contact </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> <nav class=md-nav aria-label=Introduction> <ul class=md-nav__list> <li class=md-nav__item> <a href=#what-youll-learn class=md-nav__link> <span class=md-ellipsis> What You’ll Learn </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#system-architecture-modular-and-scalable-design class=md-nav__link> <span class=md-ellipsis> System Architecture: Modular and Scalable Design </span> </a> <nav class=md-nav aria-label="System Architecture: Modular and Scalable Design"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-data-collection-layer class=md-nav__link> <span class=md-ellipsis> 1. Data Collection Layer </span> </a> </li> <li class=md-nav__item> <a href=#2-storage-layer class=md-nav__link> <span class=md-ellipsis> 2. Storage Layer </span> </a> </li> <li class=md-nav__item> <a href=#3-processing-layer class=md-nav__link> <span class=md-ellipsis> 3. Processing Layer </span> </a> </li> <li class=md-nav__item> <a href=#4-orchestration-layer class=md-nav__link> <span class=md-ellipsis> 4. Orchestration Layer </span> </a> </li> <li class=md-nav__item> <a href=#5-observability-layer class=md-nav__link> <span class=md-ellipsis> 5. Observability Layer </span> </a> </li> <li class=md-nav__item> <a href=#6-cost-management-layer class=md-nav__link> <span class=md-ellipsis> 6. Cost Management Layer </span> </a> </li> <li class=md-nav__item> <a href=#deep-dive-key-components class=md-nav__link> <span class=md-ellipsis> Deep Dive: Key Components </span> </a> <nav class=md-nav aria-label="Deep Dive: Key Components"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#resource-management class=md-nav__link> <span class=md-ellipsis> Resource Management </span> </a> <nav class=md-nav aria-label="Resource Management"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#resource-creation class=md-nav__link> <span class=md-ellipsis> Resource Creation </span> </a> </li> <li class=md-nav__item> <a href=#resource-deletion class=md-nav__link> <span class=md-ellipsis> Resource Deletion </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#reddit-data-collection-and-preprocessing class=md-nav__link> <span class=md-ellipsis> Reddit Data Collection and Preprocessing </span> </a> <nav class=md-nav aria-label="Reddit Data Collection and Preprocessing"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-data-collection-with-praw class=md-nav__link> <span class=md-ellipsis> 1. Data Collection with PRAW </span> </a> </li> <li class=md-nav__item> <a href=#2-data-preprocessing-with-pyspark class=md-nav__link> <span class=md-ellipsis> 2. Data Preprocessing with PySpark </span> </a> <nav class=md-nav aria-label="2. Data Preprocessing with PySpark"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#posts-processing class=md-nav__link> <span class=md-ellipsis> Posts Processing </span> </a> </li> <li class=md-nav__item> <a href=#comments-processing class=md-nav__link> <span class=md-ellipsis> Comments Processing </span> </a> </li> <li class=md-nav__item> <a href=#processed-data-schema class=md-nav__link> <span class=md-ellipsis> Processed Data Schema </span> </a> </li> <li class=md-nav__item> <a href=#daily-summary-processing class=md-nav__link> <span class=md-ellipsis> Daily Summary Processing </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#dbt class=md-nav__link> <span class=md-ellipsis> dbt </span> </a> <nav class=md-nav aria-label=dbt> <ul class=md-nav__list> <li class=md-nav__item> <a href=#dbt-data-transformations class=md-nav__link> <span class=md-ellipsis> DBT Data Transformations </span> </a> </li> <li class=md-nav__item> <a href=#dbt-data-quality-tests class=md-nav__link> <span class=md-ellipsis> DBT Data Quality Tests </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#text-processing-pipeline class=md-nav__link> <span class=md-ellipsis> Text Processing Pipeline </span> </a> <nav class=md-nav aria-label="Text Processing Pipeline"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-text-summarization class=md-nav__link> <span class=md-ellipsis> 1. Text Summarization </span> </a> </li> <li class=md-nav__item> <a href=#2-sentiment-analysis class=md-nav__link> <span class=md-ellipsis> 2. Sentiment Analysis </span> </a> </li> <li class=md-nav__item> <a href=#3-pipeline-integration class=md-nav__link> <span class=md-ellipsis> 3. Pipeline Integration </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#gemini-ai-analysis class=md-nav__link> <span class=md-ellipsis> Gemini AI Analysis </span> </a> <nav class=md-nav aria-label="Gemini AI Analysis"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-analysis-configuration class=md-nav__link> <span class=md-ellipsis> 1. Analysis Configuration </span> </a> </li> <li class=md-nav__item> <a href=#2-data-processing class=md-nav__link> <span class=md-ellipsis> 2. Data Processing </span> </a> </li> <li class=md-nav__item> <a href=#3-output-formatting class=md-nav__link> <span class=md-ellipsis> 3. Output Formatting </span> </a> </li> <li class=md-nav__item> <a href=#4-pipeline-integration class=md-nav__link> <span class=md-ellipsis> 4. Pipeline Integration </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#web-application class=md-nav__link> <span class=md-ellipsis> Web Application </span> </a> <nav class=md-nav aria-label="Web Application"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#automated-deployment class=md-nav__link> <span class=md-ellipsis> Automated Deployment </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#orchestrator-stack class=md-nav__link> <span class=md-ellipsis> Orchestrator Stack </span> </a> <nav class=md-nav aria-label="Orchestrator Stack"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-airflow-configuration class=md-nav__link> <span class=md-ellipsis> 1. Airflow Configuration </span> </a> </li> <li class=md-nav__item> <a href=#2-pipeline-structure class=md-nav__link> <span class=md-ellipsis> 2. Pipeline Structure </span> </a> </li> <li class=md-nav__item> <a href=#3-task-dependencies class=md-nav__link> <span class=md-ellipsis> 3. Task Dependencies </span> </a> </li> <li class=md-nav__item> <a href=#4-integration-points class=md-nav__link> <span class=md-ellipsis> 4. Integration Points </span> </a> </li> <li class=md-nav__item> <a href=#5-cloud-function class=md-nav__link> <span class=md-ellipsis> 5. Cloud Function </span> </a> <nav class=md-nav aria-label="5. Cloud Function"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#51-start-vm class=md-nav__link> <span class=md-ellipsis> 5.1. Start VM </span> </a> </li> <li class=md-nav__item> <a href=#52-stop-vm class=md-nav__link> <span class=md-ellipsis> 5.2. Stop VM </span> </a> </li> <li class=md-nav__item> <a href=#53-cloud-scheduler class=md-nav__link> <span class=md-ellipsis> 5.3. Cloud Scheduler </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#observability-stack class=md-nav__link> <span class=md-ellipsis> Observability Stack </span> </a> <nav class=md-nav aria-label="Observability Stack"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-metrics-collection-architecture class=md-nav__link> <span class=md-ellipsis> 1. Metrics Collection Architecture </span> </a> </li> <li class=md-nav__item> <a href=#2-task-specific-metrics class=md-nav__link> <span class=md-ellipsis> 2. Task-Specific Metrics </span> </a> </li> <li class=md-nav__item> <a href=#3-performance-dashboards class=md-nav__link> <span class=md-ellipsis> 3. Performance Dashboards </span> </a> </li> <li class=md-nav__item> <a href=#4-mlflow-integration class=md-nav__link> <span class=md-ellipsis> 4. MLflow Integration </span> </a> </li> <li class=md-nav__item> <a href=#5-alert-configuration class=md-nav__link> <span class=md-ellipsis> 5. Alert Configuration </span> </a> </li> <li class=md-nav__item> <a href=#6-cloud-monitoring class=md-nav__link> <span class=md-ellipsis> 6. Cloud Monitoring </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#results-and-impact class=md-nav__link> <span class=md-ellipsis> Results and Impact </span> </a> </li> <li class=md-nav__item> <a href=#future-improvements class=md-nav__link> <span class=md-ellipsis> Future Improvements </span> </a> </li> <li class=md-nav__item> <a href=#conclusion class=md-nav__link> <span class=md-ellipsis> Conclusion </span> </a> </li> <li class=md-nav__item> <a href=#resources-and-references class=md-nav__link> <span class=md-ellipsis> Resources and References </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-content md-content--post" data-md-component=content> <div class="md-sidebar md-sidebar--post" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class="md-sidebar__inner md-post"> <nav class="md-nav md-nav--primary"> <div class=md-post__back> <div class="md-nav__title md-nav__container"> <a href=../../../../ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg> <span class=md-ellipsis> Back to index </span> </a> </div> </div> <div class="md-post__authors md-typeset"> <div class="md-profile md-post__profile"> <span class="md-author md-author--long"> <img src="https://avatars.githubusercontent.com/u/43801845?v=4" alt="Sulman Khan"> </span> <span class=md-profile__description> <strong> <a href=https://github.com/SulmanK>Sulman Khan</a> </strong> <br> Creator </span> </div> </div> <ul class="md-post__meta md-nav__list"> <li class="md-nav__item md-nav__item--section"> <div class=md-post__title> <span class=md-ellipsis> Metadata </span> </div> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"></path></svg> <time datetime="2025-01-23 00:00:00+00:00" class=md-ellipsis>2025/01/23</time> </div> </li> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"></path></svg> <span class=md-ellipsis> in <a href=../../../../category/ai/ >AI</a>, <a href=../../../../category/data-engineering/ >Data Engineering</a>, <a href=../../../../category/llms/ >LLMs</a>, <a href=../../../../category/end-to-end-pipeline/ >end-to-end pipeline</a>, <a href=../../../../category/cloud/ >cloud</a>, <a href=../../../../category/gcp/ >GCP</a>, <a href=../../../../category/ml/ >ML</a></span> </div> </li> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"></path></svg> <span class=md-ellipsis> 30 min read </span> </div> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <article class="md-content__inner md-typeset"> <a href=https://github.com/SulmanK/blog/edit/master/docs/writing/posts/reddit_text_insight_sentiment_cloud.md title="Edit this page" class="md-content__button md-icon" rel=edit> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75z"></path></svg> </a> <a href=https://github.com/SulmanK/blog/raw/master/docs/writing/posts/reddit_text_insight_sentiment_cloud.md title="View source of this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5"></path></svg> </a> <h1 id=from-reddit-to-insights-building-an-ai-powered-data-pipeline-with-gemini-cloud>From Reddit to Insights: Building an AI-Powered Data Pipeline with Gemini (Cloud)<a class=headerlink href=#from-reddit-to-insights-building-an-ai-powered-data-pipeline-with-gemini-cloud title="Permanent link">¶</a></h1> <h2 id=introduction>Introduction<a class=headerlink href=#introduction title="Permanent link">¶</a></h2> <div class="admonition abstract"> <p class=admonition-title>Purpose</p> <p>In this blog post, I document the process of building an AI-driven, cloud data pipeline to automate this task. Using Google’s Gemini AI, the pipeline collects, processes, and synthesizes discussions from AI-related subreddits into structured daily reports. The system is designed to filter out irrelevant or harmful content, ensuring the extracted insights are both meaningful and actionable.</p> <p>Check out the <a href=https://github.com/SulmanK/reddit_ai_pulse_cloud_public>project GitHub repository</a> for the full code and detailed documentation and <a href=https://reddit-ai-pulse.vercel.app/ >Web Application</a>.</p> <!-- more --> </div> <div class="admonition info"> <p class=admonition-title>Problem Statement</p> <p>The field of artificial intelligence and machine learning evolves at an unprecedented pace, with new breakthroughs, trends, and discussions emerging daily. Platforms like Reddit host vibrant AI-focused communities that are rich with valuable insights. However, manually monitoring multiple subreddits to extract meaningful information is both time-consuming and inefficient.</p> </div> <h3 id=what-youll-learn><strong>What You’ll Learn</strong><a class=headerlink href=#what-youll-learn title="Permanent link">¶</a></h3> <ul> <li><strong>Leveraging Google Cloud Storage (GCS) for scalable data lake</strong>: How to use GCS for storing raw data, ML artifacts, and daily results.</li> <li><strong>Optimizing data warehousing with BigQuery and dbt</strong>: Best practices for structuring, managing, and transforming data efficiently in BigQuery.</li> <li><strong>Applying AI for sentiment analysis and summarization</strong>: Techniques to extract concise insights from unstructured Reddit discussions using BART and RoBERTa models.</li> <li><strong>Utilizing Google’s Gemini AI for content analysis</strong>: Insights into leveraging advanced AI models to categorize and interpret data.</li> <li><strong>Orchestrating data workflows with Airflow on a single VM</strong>: How to manage complex data pipelines using Airflow in a cloud environment.</li> <li><strong>Implementing cost-effective cloud solutions</strong>: Strategies for managing costs through scheduled VM start/stop, preemptible instances, and resource optimization.</li> </ul> <h2 id=system-architecture-modular-and-scalable-design>System Architecture: Modular and Scalable Design<a class=headerlink href=#system-architecture-modular-and-scalable-design title="Permanent link">¶</a></h2> <p>Our pipeline is designed with modularity and scalability in mind, comprising six main layers. Below is a high-level overview of how the components interact:</p> <p><a class=glightbox data-type=image data-width=auto data-height=auto href=../../../../img/reddit_ai_pulse_cloud_pipeline.png data-title="Pipeline Architecture Diagram" data-desc-position=bottom><img alt="Pipeline Architecture Diagram" src=../../../../img/reddit_ai_pulse_cloud_pipeline.png></a></p> <p>The diagram above illustrates the flow of data through our system, from collection to presentation. Each layer has specific responsibilities and communicates with adjacent layers through well-defined interfaces.</p> <hr> <h3 id=1-data-collection-layer>1. Data Collection Layer<a class=headerlink href=#1-data-collection-layer title="Permanent link">¶</a></h3> <ul> <li><strong>Reddit API Integration</strong>:<ul> <li>Fetch posts and comments from AI-focused subreddits</li> <li>Store raw data in GCS buckets</li> </ul> </li> <li><strong>Text Preprocessing</strong>:<ul> <li>Clean and standardize text data</li> <li>Prepare for ML processing</li> </ul> </li> <li><strong>BigQuery Integration</strong>: <ul> <li>Load data into staging tables</li> <li>Manage processing state</li> <li>Incremental processing</li> </ul> </li> </ul> <h3 id=2-storage-layer>2. Storage Layer<a class=headerlink href=#2-storage-layer title="Permanent link">¶</a></h3> <ul> <li><strong>Google Cloud Storage (GCS)</strong>:<ul> <li>Raw data storage</li> <li>ML model artifacts</li> <li>Daily results</li> </ul> </li> <li><strong>BigQuery</strong>:<ul> <li>Structured data storage</li> <li>Efficient query processing</li> <li>Cost-optimized table partitioning</li> </ul> </li> <li><strong>DBT Transformations</strong>:<ul> <li>Stage posts and comments for further processing.</li> <li>Clean and standardize data structures.</li> <li>Manage processing state for each pipeline run.</li> <li>Automate cleanup upon pipeline completion.</li> </ul> </li> </ul> <h3 id=3-processing-layer>3. Processing Layer<a class=headerlink href=#3-processing-layer title="Permanent link">¶</a></h3> <ul> <li><strong>Text Summarization</strong>: BART for concise summaries</li> <li><strong>Sentiment Analysis</strong>: RoBERTa model</li> <li><strong>Insight Generation</strong>: Google's Gemini AI</li> <li><strong>MLflow Integration</strong>: Track experiments and models</li> </ul> <h3 id=4-orchestration-layer>4. Orchestration Layer<a class=headerlink href=#4-orchestration-layer title="Permanent link">¶</a></h3> <ul> <li><strong>Single VM Deployment</strong>:<ul> <li>e2-standard-2 instance</li> <li>Docker container orchestration</li> <li>Automated start/stop</li> </ul> </li> <li><strong>Airflow DAGs</strong>:<ul> <li>Main pipeline workflow</li> <li>GitHub sync automation</li> <li>Metric collection</li> </ul> </li> </ul> <h3 id=5-observability-layer>5. Observability Layer<a class=headerlink href=#5-observability-layer title="Permanent link">¶</a></h3> <ul> <li><strong>Cloud Monitoring</strong>:<ul> <li>VM health checks</li> <li>Cost monitoring</li> <li>Alert policies</li> </ul> </li> <li><strong>Local Monitoring</strong>:<ul> <li>Prometheus metrics</li> <li>Grafana dashboards</li> <li>StatsD integration</li> </ul> </li> </ul> <h3 id=6-cost-management-layer>6. Cost Management Layer<a class=headerlink href=#6-cost-management-layer title="Permanent link">¶</a></h3> <ul> <li><strong>VM Lifecycle</strong>:<ul> <li>Scheduled start/stop</li> <li>Preemptible instances</li> <li>Resource optimization</li> </ul> </li> </ul> <hr> <p>This modular design ensures adaptability, maintainability, and scalability, enabling seamless interaction between components and the efficient transformation of Reddit data into actionable insights.</p> <h3 id=deep-dive-key-components>Deep Dive: Key Components<a class=headerlink href=#deep-dive-key-components title="Permanent link">¶</a></h3> <h4 id=resource-management>Resource Management<a class=headerlink href=#resource-management title="Permanent link">¶</a></h4> <p>The Reddit AI Pulse infrastructure on Google Cloud is a comprehensive data processing platform, designed with Terraform for scalability and security. At its heart, a custom network provides a secure foundation for a Debian VM running Airflow, which orchestrates the entire data pipeline. Data is efficiently managed using BigQuery for both raw feeds and analytics, along with a Cloud Storage bucket for logs and other artifacts. This automated, cost-effective setup ensures reliable analysis and processing of large-scale Reddit data.</p> <h5 id=resource-creation>Resource Creation<a class=headerlink href=#resource-creation title="Permanent link">¶</a></h5> <p><code>build_res.sh</code> is a shell script that builds the resources using Terraform. </p><div class="language-bash highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=c1># =============================================================================</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=c1># build_res.sh</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=c1># -----------------------------------------------------------------------------</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=c1># Main deployment script for the Reddit AI Pulse Cloud infrastructure.</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=c1># This script sets up and configures all necessary GCP resources for the project.</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=c1>#</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=c1># The script performs the following operations:</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=c1># 1. Loads environment configuration</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=c1># 2. Generates terraform.tfvars from environment variables</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=c1># 3. Sets up Docker and Artifact Registry</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=c1># 4. Builds and pushes Cloud Run images</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=c1># 5. Initializes and applies Terraform configuration</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=c1># 6. Updates Cloud Run URLs in .env file</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=c1># 7. Manages service account credentials</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=c1># 8. Uploads secrets to GitHub</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=c1># 9. Configures Git repository settings</span>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a><span class=c1>#</span>
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a><span class=c1># The script includes error handling, logging, and automatic backup</span>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a><span class=c1># of sensitive files. It can optionally commit changes to Git.</span>
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a><span class=c1>#</span>
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a><span class=c1># Usage:</span>
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a><span class=c1>#   ./build_res.sh</span>
</span><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a><span class=c1>#</span>
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a><span class=c1># Requirements:</span>
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a><span class=c1>#   - .env file with required configuration</span>
</span><span id=__span-0-26><a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a><span class=c1>#   - Authenticated gcloud CLI</span>
</span><span id=__span-0-27><a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a><span class=c1>#   - Docker installed and configured</span>
</span><span id=__span-0-28><a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a><span class=c1>#   - GitHub CLI installed and authenticated</span>
</span><span id=__span-0-29><a id=__codelineno-0-29 name=__codelineno-0-29 href=#__codelineno-0-29></a><span class=c1>#   - Terraform installed</span>
</span><span id=__span-0-30><a id=__codelineno-0-30 name=__codelineno-0-30 href=#__codelineno-0-30></a><span class=c1># =============================================================================</span>
</span></code></pre></div> Once the resources are created, secrets are securely uploaded to Google Cloud Storage (GCS) using GitHub Actions via the <code>upload-secrets.yml</code> workflow.<p></p> <div class="language-text highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>name: Upload Secrets to GCS
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>on:
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>  workflow_dispatch:  # Manual trigger
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>  repository_dispatch:
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>    types: [secrets_updated]  # Custom event type
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>  push:
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>    paths:
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>      - '.github/workflows/upload-secrets.yml'
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>jobs:
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>  upload-secrets:
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>    runs-on: ubuntu-latest
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>    permissions:
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>      contents: read
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a>      id-token: write
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a>
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a>    steps:
</span><span id=__span-1-19><a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a>    - uses: actions/checkout@v4
</span><span id=__span-1-20><a id=__codelineno-1-20 name=__codelineno-1-20 href=#__codelineno-1-20></a>
</span><span id=__span-1-21><a id=__codelineno-1-21 name=__codelineno-1-21 href=#__codelineno-1-21></a>    - id: 'auth'
</span><span id=__span-1-22><a id=__codelineno-1-22 name=__codelineno-1-22 href=#__codelineno-1-22></a>      name: 'Authenticate to Google Cloud'
</span><span id=__span-1-23><a id=__codelineno-1-23 name=__codelineno-1-23 href=#__codelineno-1-23></a>      uses: 'google-github-actions/auth@v2'
</span><span id=__span-1-24><a id=__codelineno-1-24 name=__codelineno-1-24 href=#__codelineno-1-24></a>      with:
</span><span id=__span-1-25><a id=__codelineno-1-25 name=__codelineno-1-25 href=#__codelineno-1-25></a>        credentials_json: '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}'
</span><span id=__span-1-26><a id=__codelineno-1-26 name=__codelineno-1-26 href=#__codelineno-1-26></a>
</span><span id=__span-1-27><a id=__codelineno-1-27 name=__codelineno-1-27 href=#__codelineno-1-27></a>    - name: 'Set up Cloud SDK'
</span><span id=__span-1-28><a id=__codelineno-1-28 name=__codelineno-1-28 href=#__codelineno-1-28></a>      uses: 'google-github-actions/setup-gcloud@v2'
</span><span id=__span-1-29><a id=__codelineno-1-29 name=__codelineno-1-29 href=#__codelineno-1-29></a>
</span><span id=__span-1-30><a id=__codelineno-1-30 name=__codelineno-1-30 href=#__codelineno-1-30></a>    - name: 'Create secrets directory'
</span><span id=__span-1-31><a id=__codelineno-1-31 name=__codelineno-1-31 href=#__codelineno-1-31></a>      run: mkdir -p secrets
</span><span id=__span-1-32><a id=__codelineno-1-32 name=__codelineno-1-32 href=#__codelineno-1-32></a>
</span><span id=__span-1-33><a id=__codelineno-1-33 name=__codelineno-1-33 href=#__codelineno-1-33></a>    - name: 'Create .env file'
</span><span id=__span-1-34><a id=__codelineno-1-34 name=__codelineno-1-34 href=#__codelineno-1-34></a>      run: |
</span><span id=__span-1-35><a id=__codelineno-1-35 name=__codelineno-1-35 href=#__codelineno-1-35></a>        cat &lt;&lt; EOF &gt; secrets/.env
</span><span id=__span-1-36><a id=__codelineno-1-36 name=__codelineno-1-36 href=#__codelineno-1-36></a>        # Docker Registry
</span><span id=__span-1-37><a id=__codelineno-1-37 name=__codelineno-1-37 href=#__codelineno-1-37></a>        DOCKER_REGISTRY=${{ secrets.DOCKER_REGISTRY }}
</span><span id=__span-1-38><a id=__codelineno-1-38 name=__codelineno-1-38 href=#__codelineno-1-38></a>
</span><span id=__span-1-39><a id=__codelineno-1-39 name=__codelineno-1-39 href=#__codelineno-1-39></a>        # GCP Project Configuration
</span><span id=__span-1-40><a id=__codelineno-1-40 name=__codelineno-1-40 href=#__codelineno-1-40></a>        GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}
</span><span id=__span-1-41><a id=__codelineno-1-41 name=__codelineno-1-41 href=#__codelineno-1-41></a>        GCS_BUCKET_NAME=${{ secrets.GCS_BUCKET_NAME }}
</span><span id=__span-1-42><a id=__codelineno-1-42 name=__codelineno-1-42 href=#__codelineno-1-42></a>        GCP_REGION=${{ secrets.GCP_REGION }}
</span><span id=__span-1-43><a id=__codelineno-1-43 name=__codelineno-1-43 href=#__codelineno-1-43></a>        GCP_ZONE=${{ secrets.GCP_ZONE }}
</span><span id=__span-1-44><a id=__codelineno-1-44 name=__codelineno-1-44 href=#__codelineno-1-44></a>
</span><span id=__span-1-45><a id=__codelineno-1-45 name=__codelineno-1-45 href=#__codelineno-1-45></a>        # Service Account &amp; Authentication
</span><span id=__span-1-46><a id=__codelineno-1-46 name=__codelineno-1-46 href=#__codelineno-1-46></a>        GOOGLE_APPLICATION_CREDENTIALS=/opt/airflow/credentials/service-account.json
</span><span id=__span-1-47><a id=__codelineno-1-47 name=__codelineno-1-47 href=#__codelineno-1-47></a>        SA_EMAIL=${{ secrets.SA_EMAIL }}
</span><span id=__span-1-48><a id=__codelineno-1-48 name=__codelineno-1-48 href=#__codelineno-1-48></a>
</span><span id=__span-1-49><a id=__codelineno-1-49 name=__codelineno-1-49 href=#__codelineno-1-49></a>        # VM Configuration
</span><span id=__span-1-50><a id=__codelineno-1-50 name=__codelineno-1-50 href=#__codelineno-1-50></a>        VM_INSTANCE_NAME=${{ secrets.VM_INSTANCE_NAME }}
</span><span id=__span-1-51><a id=__codelineno-1-51 name=__codelineno-1-51 href=#__codelineno-1-51></a>        VM_MACHINE_TYPE=${{ secrets.VM_MACHINE_TYPE }}
</span><span id=__span-1-52><a id=__codelineno-1-52 name=__codelineno-1-52 href=#__codelineno-1-52></a>
</span><span id=__span-1-53><a id=__codelineno-1-53 name=__codelineno-1-53 href=#__codelineno-1-53></a>        # Network Configuration
</span><span id=__span-1-54><a id=__codelineno-1-54 name=__codelineno-1-54 href=#__codelineno-1-54></a>        NETWORK_NAME=${{ secrets.NETWORK_NAME }}
</span><span id=__span-1-55><a id=__codelineno-1-55 name=__codelineno-1-55 href=#__codelineno-1-55></a>        SUBNET_NAME=${{ secrets.SUBNET_NAME }}
</span><span id=__span-1-56><a id=__codelineno-1-56 name=__codelineno-1-56 href=#__codelineno-1-56></a>        SUBNET_CIDR=${{ secrets.SUBNET_CIDR }}
</span><span id=__span-1-57><a id=__codelineno-1-57 name=__codelineno-1-57 href=#__codelineno-1-57></a>
</span><span id=__span-1-58><a id=__codelineno-1-58 name=__codelineno-1-58 href=#__codelineno-1-58></a>        # Email Configuration
</span><span id=__span-1-59><a id=__codelineno-1-59 name=__codelineno-1-59 href=#__codelineno-1-59></a>        ALERT_EMAIL=${{ secrets.ALERT_EMAIL }}
</span><span id=__span-1-60><a id=__codelineno-1-60 name=__codelineno-1-60 href=#__codelineno-1-60></a>        ALERT_EMAIL_PASSWORD=${{ secrets.ALERT_EMAIL_PASSWORD }}
</span><span id=__span-1-61><a id=__codelineno-1-61 name=__codelineno-1-61 href=#__codelineno-1-61></a>
</span><span id=__span-1-62><a id=__codelineno-1-62 name=__codelineno-1-62 href=#__codelineno-1-62></a>        # BigQuery Configuration
</span><span id=__span-1-63><a id=__codelineno-1-63 name=__codelineno-1-63 href=#__codelineno-1-63></a>        BIGQUERY_DATASET_RAW=${{ secrets.BIGQUERY_DATASET_RAW }}
</span><span id=__span-1-64><a id=__codelineno-1-64 name=__codelineno-1-64 href=#__codelineno-1-64></a>        BIGQUERY_DATASET_PROCESSED=${{ secrets.BIGQUERY_DATASET_PROCESSED }}
</span><span id=__span-1-65><a id=__codelineno-1-65 name=__codelineno-1-65 href=#__codelineno-1-65></a>
</span><span id=__span-1-66><a id=__codelineno-1-66 name=__codelineno-1-66 href=#__codelineno-1-66></a>        # Reddit API Configuration
</span><span id=__span-1-67><a id=__codelineno-1-67 name=__codelineno-1-67 href=#__codelineno-1-67></a>        REDDIT_CLIENT_ID=${{ secrets.REDDIT_CLIENT_ID }}
</span><span id=__span-1-68><a id=__codelineno-1-68 name=__codelineno-1-68 href=#__codelineno-1-68></a>        REDDIT_CLIENT_SECRET=${{ secrets.REDDIT_CLIENT_SECRET }}
</span><span id=__span-1-69><a id=__codelineno-1-69 name=__codelineno-1-69 href=#__codelineno-1-69></a>        REDDIT_USERNAME=${{ secrets.REDDIT_USERNAME }}
</span><span id=__span-1-70><a id=__codelineno-1-70 name=__codelineno-1-70 href=#__codelineno-1-70></a>        REDDIT_PASSWORD=${{ secrets.REDDIT_PASSWORD }}
</span><span id=__span-1-71><a id=__codelineno-1-71 name=__codelineno-1-71 href=#__codelineno-1-71></a>        REDDIT_USER_AGENT=${{ secrets.REDDIT_USER_AGENT }}
</span><span id=__span-1-72><a id=__codelineno-1-72 name=__codelineno-1-72 href=#__codelineno-1-72></a>
</span><span id=__span-1-73><a id=__codelineno-1-73 name=__codelineno-1-73 href=#__codelineno-1-73></a>        # Gemini API Key
</span><span id=__span-1-74><a id=__codelineno-1-74 name=__codelineno-1-74 href=#__codelineno-1-74></a>        GOOGLE_GEMINI_API_KEY=${{ secrets.GOOGLE_GEMINI_API_KEY }}
</span><span id=__span-1-75><a id=__codelineno-1-75 name=__codelineno-1-75 href=#__codelineno-1-75></a>
</span><span id=__span-1-76><a id=__codelineno-1-76 name=__codelineno-1-76 href=#__codelineno-1-76></a>        # GitHub Configuration
</span><span id=__span-1-77><a id=__codelineno-1-77 name=__codelineno-1-77 href=#__codelineno-1-77></a>        GH_PAT=${{ secrets.GH_PAT }}
</span><span id=__span-1-78><a id=__codelineno-1-78 name=__codelineno-1-78 href=#__codelineno-1-78></a>        GH_OWNER=${{ secrets.GH_OWNER }}
</span><span id=__span-1-79><a id=__codelineno-1-79 name=__codelineno-1-79 href=#__codelineno-1-79></a>        GH_REPO=${{ secrets.GH_REPO }}
</span><span id=__span-1-80><a id=__codelineno-1-80 name=__codelineno-1-80 href=#__codelineno-1-80></a>        GH_WEBSITE_REPO=${{ secrets.GH_WEBSITE_REPO }}
</span><span id=__span-1-81><a id=__codelineno-1-81 name=__codelineno-1-81 href=#__codelineno-1-81></a>        AUTO_COMMIT=${{ secrets.AUTO_COMMIT }}
</span><span id=__span-1-82><a id=__codelineno-1-82 name=__codelineno-1-82 href=#__codelineno-1-82></a>
</span><span id=__span-1-83><a id=__codelineno-1-83 name=__codelineno-1-83 href=#__codelineno-1-83></a>        # Grafana credentials
</span><span id=__span-1-84><a id=__codelineno-1-84 name=__codelineno-1-84 href=#__codelineno-1-84></a>        GF_SECURITY_ADMIN_USER=${{ secrets.GF_SECURITY_ADMIN_USER }}
</span><span id=__span-1-85><a id=__codelineno-1-85 name=__codelineno-1-85 href=#__codelineno-1-85></a>        GF_SECURITY_ADMIN_PASSWORD=${{ secrets.GF_SECURITY_ADMIN_PASSWORD }}
</span><span id=__span-1-86><a id=__codelineno-1-86 name=__codelineno-1-86 href=#__codelineno-1-86></a>
</span><span id=__span-1-87><a id=__codelineno-1-87 name=__codelineno-1-87 href=#__codelineno-1-87></a>        # Airflow PostgreSQL credentials
</span><span id=__span-1-88><a id=__codelineno-1-88 name=__codelineno-1-88 href=#__codelineno-1-88></a>        AIRFLOW_DB_USER=${{ secrets.AIRFLOW_DB_USER }}
</span><span id=__span-1-89><a id=__codelineno-1-89 name=__codelineno-1-89 href=#__codelineno-1-89></a>        AIRFLOW_DB_PASSWORD=${{ secrets.AIRFLOW_DB_PASSWORD }}
</span><span id=__span-1-90><a id=__codelineno-1-90 name=__codelineno-1-90 href=#__codelineno-1-90></a>        AIRFLOW_DB_NAME=${{ secrets.AIRFLOW_DB_NAME }}
</span><span id=__span-1-91><a id=__codelineno-1-91 name=__codelineno-1-91 href=#__codelineno-1-91></a>
</span><span id=__span-1-92><a id=__codelineno-1-92 name=__codelineno-1-92 href=#__codelineno-1-92></a>        # VM Function URLs
</span><span id=__span-1-93><a id=__codelineno-1-93 name=__codelineno-1-93 href=#__codelineno-1-93></a>        STOP_VM_FUNCTION_URL=${{ secrets.STOP_VM_FUNCTION_URL }}
</span><span id=__span-1-94><a id=__codelineno-1-94 name=__codelineno-1-94 href=#__codelineno-1-94></a>        START_VM_FUNCTION_URL=${{ secrets.START_VM_FUNCTION_URL }}
</span><span id=__span-1-95><a id=__codelineno-1-95 name=__codelineno-1-95 href=#__codelineno-1-95></a>
</span><span id=__span-1-96><a id=__codelineno-1-96 name=__codelineno-1-96 href=#__codelineno-1-96></a>        # Airflow configuration
</span><span id=__span-1-97><a id=__codelineno-1-97 name=__codelineno-1-97 href=#__codelineno-1-97></a>        AIRFLOW_UID=50000
</span><span id=__span-1-98><a id=__codelineno-1-98 name=__codelineno-1-98 href=#__codelineno-1-98></a>        AIRFLOW_GID=0
</span><span id=__span-1-99><a id=__codelineno-1-99 name=__codelineno-1-99 href=#__codelineno-1-99></a>        EOF
</span><span id=__span-1-100><a id=__codelineno-1-100 name=__codelineno-1-100 href=#__codelineno-1-100></a>
</span><span id=__span-1-101><a id=__codelineno-1-101 name=__codelineno-1-101 href=#__codelineno-1-101></a>    - name: 'Create service account key file'
</span><span id=__span-1-102><a id=__codelineno-1-102 name=__codelineno-1-102 href=#__codelineno-1-102></a>      run: |
</span><span id=__span-1-103><a id=__codelineno-1-103 name=__codelineno-1-103 href=#__codelineno-1-103></a>        echo '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' &gt; secrets/service-account.json
</span><span id=__span-1-104><a id=__codelineno-1-104 name=__codelineno-1-104 href=#__codelineno-1-104></a>
</span><span id=__span-1-105><a id=__codelineno-1-105 name=__codelineno-1-105 href=#__codelineno-1-105></a>    - name: 'Upload secrets to GCS'
</span><span id=__span-1-106><a id=__codelineno-1-106 name=__codelineno-1-106 href=#__codelineno-1-106></a>      run: |
</span><span id=__span-1-107><a id=__codelineno-1-107 name=__codelineno-1-107 href=#__codelineno-1-107></a>        gsutil cp secrets/.env gs://${{ secrets.GCS_BUCKET_NAME }}/secrets/.env
</span><span id=__span-1-108><a id=__codelineno-1-108 name=__codelineno-1-108 href=#__codelineno-1-108></a>        gsutil cp secrets/service-account.json gs://${{ secrets.GCS_BUCKET_NAME }}/secrets/service-account.json 
</span></code></pre></div> <h5 id=resource-deletion>Resource Deletion<a class=headerlink href=#resource-deletion title="Permanent link">¶</a></h5> <p><code>cleanup.sh</code> is a shell script that deletes the resources using Terraform. </p><div class="language-bash highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=c1># =============================================================================</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=c1># cleanup.sh</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=c1># -----------------------------------------------------------------------------</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=c1># A comprehensive cleanup script for the Reddit AI Pulse Cloud infrastructure.</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=c1># This script systematically removes all GCP resources created by the project.</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=c1>#</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=c1># The script performs cleanup in the following order:</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=c1># 1. IAM (roles and bindings)</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=c1># 2. Cloud Scheduler jobs</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=c1># 3. Cloud Functions</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=c1># 4. GCS buckets and contents</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=c1># 5. BigQuery datasets and tables</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=c1># 6. Artifact Registry repositories</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=c1># 7. Cloud Run services</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=c1># 8. Service accounts</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=c1># 9. Compute Engine resources</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=c1># 10. VPC, subnets, and firewall rules</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=c1># 11. Monitoring resources (alerts, dashboards)</span>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a><span class=c1># 12. Terraform state</span>
</span><span id=__span-2-20><a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a><span class=c1># 13. Log buckets</span>
</span><span id=__span-2-21><a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a><span class=c1>#</span>
</span><span id=__span-2-22><a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a><span class=c1># The script includes error handling, retries for dependent resources,</span>
</span><span id=__span-2-23><a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a><span class=c1># and creates detailed logs of the cleanup process in the resource_info directory.</span>
</span><span id=__span-2-24><a id=__codelineno-2-24 name=__codelineno-2-24 href=#__codelineno-2-24></a><span class=c1>#</span>
</span><span id=__span-2-25><a id=__codelineno-2-25 name=__codelineno-2-25 href=#__codelineno-2-25></a><span class=c1># Usage:</span>
</span><span id=__span-2-26><a id=__codelineno-2-26 name=__codelineno-2-26 href=#__codelineno-2-26></a><span class=c1>#   ./cleanup.sh</span>
</span><span id=__span-2-27><a id=__codelineno-2-27 name=__codelineno-2-27 href=#__codelineno-2-27></a><span class=c1>#</span>
</span><span id=__span-2-28><a id=__codelineno-2-28 name=__codelineno-2-28 href=#__codelineno-2-28></a><span class=c1># Requirements:</span>
</span><span id=__span-2-29><a id=__codelineno-2-29 name=__codelineno-2-29 href=#__codelineno-2-29></a><span class=c1>#   - GCP project configuration in .env file</span>
</span><span id=__span-2-30><a id=__codelineno-2-30 name=__codelineno-2-30 href=#__codelineno-2-30></a><span class=c1>#   - Authenticated gcloud CLI</span>
</span><span id=__span-2-31><a id=__codelineno-2-31 name=__codelineno-2-31 href=#__codelineno-2-31></a><span class=c1>#   - Required permissions to delete resources</span>
</span><span id=__span-2-32><a id=__codelineno-2-32 name=__codelineno-2-32 href=#__codelineno-2-32></a><span class=c1># =============================================================================</span>
</span></code></pre></div><p></p> <h4 id=reddit-data-collection-and-preprocessing>Reddit Data Collection and Preprocessing<a class=headerlink href=#reddit-data-collection-and-preprocessing title="Permanent link">¶</a></h4> <p>The foundation of our pipeline is reliable data collection and preprocessing. We utilize Python's Reddit API wrapper (PRAW) to fetch posts and comments from specified subreddits, with immediate text preprocessing for clean data storage.</p> <h5 id=1-data-collection-with-praw>1. Data Collection with PRAW<a class=headerlink href=#1-data-collection-with-praw title="Permanent link">¶</a></h5> <p>The Reddit client implementation focuses on efficient and reliable data collection. Here's how we handle both posts and their comments:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>def</span><span class=w> </span><span class=nf>fetch_and_save_posts</span><span class=p>(</span><span class=n>reddit</span><span class=p>,</span> <span class=n>subreddit_name</span><span class=p>,</span> <span class=n>db_utils</span><span class=p>,</span> <span class=n>conn</span><span class=p>):</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>    </span><span class=sd>"""Fetches new posts from a subreddit since the last processed timestamp."""</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>    <span class=n>last_processed_utc</span> <span class=o>=</span> <span class=n>get_last_processed_timestamp</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>subreddit_name</span><span class=p>)</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>    <span class=n>current_max_utc</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>    <span class=n>subreddit</span> <span class=o>=</span> <span class=n>reddit</span><span class=o>.</span><span class=n>subreddit</span><span class=p>(</span><span class=n>subreddit_name</span><span class=p>)</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>    <span class=k>for</span> <span class=n>submission</span> <span class=ow>in</span> <span class=n>subreddit</span><span class=o>.</span><span class=n>hot</span><span class=p>(</span><span class=n>limit</span><span class=o>=</span><span class=mi>20</span><span class=p>):</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>        <span class=c1># Skip already processed posts</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>        <span class=k>if</span> <span class=n>submission</span><span class=o>.</span><span class=n>created_utc</span> <span class=o>&lt;=</span> <span class=n>last_processed_utc</span><span class=p>:</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>            <span class=k>continue</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a>        <span class=c1># Process post data</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a>        <span class=n>post_data</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a>            <span class=s2>"subreddit"</span><span class=p>:</span> <span class=n>subreddit_name</span><span class=p>,</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a>            <span class=s2>"post_id"</span><span class=p>:</span> <span class=n>submission</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a>            <span class=s2>"title"</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>submission</span><span class=o>.</span><span class=n>title</span><span class=p>),</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a>            <span class=s2>"author"</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>submission</span><span class=o>.</span><span class=n>author</span><span class=p>),</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a>            <span class=s2>"url"</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>submission</span><span class=o>.</span><span class=n>url</span><span class=p>),</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a>            <span class=s2>"score"</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>submission</span><span class=o>.</span><span class=n>score</span><span class=p>),</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a>            <span class=s2>"created_utc"</span><span class=p>:</span> <span class=n>submission</span><span class=o>.</span><span class=n>created_utc</span><span class=p>,</span>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a>            <span class=s2>"comments"</span><span class=p>:</span> <span class=p>[]</span>
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a>        <span class=p>}</span>
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a>
</span><span id=__span-3-24><a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a>        <span class=c1># Handle comments if they exist</span>
</span><span id=__span-3-25><a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a>        <span class=k>if</span> <span class=n>submission</span><span class=o>.</span><span class=n>num_comments</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-3-26><a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a>            <span class=k>try</span><span class=p>:</span>
</span><span id=__span-3-27><a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a>                <span class=n>submission</span><span class=o>.</span><span class=n>comments</span><span class=o>.</span><span class=n>replace_more</span><span class=p>(</span><span class=n>limit</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>  <span class=c1># Expand comment tree</span>
</span><span id=__span-3-28><a id=__codelineno-3-28 name=__codelineno-3-28 href=#__codelineno-3-28></a>                <span class=n>post_data</span><span class=p>[</span><span class=s2>"comments"</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-3-29><a id=__codelineno-3-29 name=__codelineno-3-29 href=#__codelineno-3-29></a>                    <span class=p>{</span>
</span><span id=__span-3-30><a id=__codelineno-3-30 name=__codelineno-3-30 href=#__codelineno-3-30></a>                        <span class=s2>"comment_id"</span><span class=p>:</span> <span class=n>comment</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-3-31><a id=__codelineno-3-31 name=__codelineno-3-31 href=#__codelineno-3-31></a>                        <span class=s2>"author"</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>comment</span><span class=o>.</span><span class=n>author</span><span class=p>),</span>
</span><span id=__span-3-32><a id=__codelineno-3-32 name=__codelineno-3-32 href=#__codelineno-3-32></a>                        <span class=s2>"body"</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>comment</span><span class=o>.</span><span class=n>body</span><span class=p>),</span>
</span><span id=__span-3-33><a id=__codelineno-3-33 name=__codelineno-3-33 href=#__codelineno-3-33></a>                        <span class=s2>"created_utc"</span><span class=p>:</span> <span class=n>comment</span><span class=o>.</span><span class=n>created_utc</span><span class=p>,</span>
</span><span id=__span-3-34><a id=__codelineno-3-34 name=__codelineno-3-34 href=#__codelineno-3-34></a>                    <span class=p>}</span>
</span><span id=__span-3-35><a id=__codelineno-3-35 name=__codelineno-3-35 href=#__codelineno-3-35></a>                    <span class=k>for</span> <span class=n>comment</span> <span class=ow>in</span> <span class=n>submission</span><span class=o>.</span><span class=n>comments</span><span class=o>.</span><span class=n>list</span><span class=p>()[:</span><span class=mi>10</span><span class=p>]</span>  <span class=c1># Top 10 comments</span>
</span><span id=__span-3-36><a id=__codelineno-3-36 name=__codelineno-3-36 href=#__codelineno-3-36></a>                    <span class=k>if</span> <span class=n>comment</span><span class=o>.</span><span class=n>created_utc</span> <span class=o>&gt;</span> <span class=n>last_processed_utc</span>
</span><span id=__span-3-37><a id=__codelineno-3-37 name=__codelineno-3-37 href=#__codelineno-3-37></a>                <span class=p>]</span>
</span><span id=__span-3-38><a id=__codelineno-3-38 name=__codelineno-3-38 href=#__codelineno-3-38></a>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-3-39><a id=__codelineno-3-39 name=__codelineno-3-39 href=#__codelineno-3-39></a>                <span class=n>logging</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Error fetching comments for post </span><span class=si>{</span><span class=n>submission</span><span class=o>.</span><span class=n>id</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-3-40><a id=__codelineno-3-40 name=__codelineno-3-40 href=#__codelineno-3-40></a>
</span><span id=__span-3-41><a id=__codelineno-3-41 name=__codelineno-3-41 href=#__codelineno-3-41></a>        <span class=c1># Save to database</span>
</span><span id=__span-3-42><a id=__codelineno-3-42 name=__codelineno-3-42 href=#__codelineno-3-42></a>        <span class=n>db_utils</span><span class=o>.</span><span class=n>insert_raw_post_data</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>post_data</span><span class=p>)</span>
</span><span id=__span-3-43><a id=__codelineno-3-43 name=__codelineno-3-43 href=#__codelineno-3-43></a>        <span class=n>current_max_utc</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>current_max_utc</span><span class=p>,</span> <span class=n>submission</span><span class=o>.</span><span class=n>created_utc</span><span class=p>)</span>
</span></code></pre></div> <p>The raw data is stored in GCS as a JSON file.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>def</span><span class=w> </span><span class=nf>save_to_gcs</span><span class=p>(</span><span class=n>storage_client</span><span class=p>:</span> <span class=n>storage</span><span class=o>.</span><span class=n>Client</span><span class=p>,</span> <span class=n>bucket_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>                <span class=n>subreddit_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>posts</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=w>    </span><span class=sd>"""Saves posts data to Google Cloud Storage."""</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>    <span class=k>try</span><span class=p>:</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>        <span class=c1># Get bucket</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>        <span class=n>bucket</span> <span class=o>=</span> <span class=n>storage_client</span><span class=o>.</span><span class=n>bucket</span><span class=p>(</span><span class=n>bucket_name</span><span class=p>)</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>        <span class=c1># Generate blob name with current timestamp</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>        <span class=n>batch_timestamp</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>        <span class=n>blob_name</span> <span class=o>=</span> <span class=n>get_gcs_blob_name</span><span class=p>(</span><span class=n>subreddit_name</span><span class=p>,</span> <span class=n>batch_timestamp</span><span class=p>)</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>        <span class=n>blob</span> <span class=o>=</span> <span class=n>bucket</span><span class=o>.</span><span class=n>blob</span><span class=p>(</span><span class=n>blob_name</span><span class=p>)</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a>        <span class=c1># Convert to newline-delimited JSON</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a>        <span class=n>ndjson_data</span> <span class=o>=</span> <span class=s1>'</span><span class=se>\n</span><span class=s1>'</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>post</span><span class=p>)</span> <span class=k>for</span> <span class=n>post</span> <span class=ow>in</span> <span class=n>posts</span><span class=p>)</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a>        <span class=n>blob</span><span class=o>.</span><span class=n>upload_from_string</span><span class=p>(</span><span class=n>ndjson_data</span><span class=p>)</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Saved </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>posts</span><span class=p>)</span><span class=si>}</span><span class=s2> posts to GCS: </span><span class=si>{</span><span class=n>blob_name</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-4-19><a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Error saving to GCS: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-4-20><a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a>        <span class=k>raise</span>
</span></code></pre></div> <p>Our system is designed for efficient and reliable data processing. We use incremental data collection, fetching only new data based on timestamps. To manage the volume of Reddit data, we focus on the top 10 comments per post, allowing us to process approximately 1,000 comments daily in about 50 minutes. This can be easily scaled by adding more compute resources. We store comments in JSONB format, which provides flexibility for handling semi-structured data.</p> <p>We've implemented robust error handling with retry mechanisms and transaction management to ensure data consistency. Batch processing is used to improve scalability and efficiency when dealing with large datasets. While stream processing could further enhance scalability, we opted for batch processing for this use case.</p> <p>JSON was chosen for its ability to handle semi-structured data like Reddit comments, which often vary in format and content. By storing comments as JSON, the system accommodates diverse data structures without rigid schemas, while still allowing efficient querying and indexing for analytics.</p> <h5 id=2-data-preprocessing-with-pyspark>2. Data Preprocessing with PySpark<a class=headerlink href=#2-data-preprocessing-with-pyspark title="Permanent link">¶</a></h5> <p>To ensure the quality of our analysis, we implement a series of preprocessing steps for Reddit posts using PySpark. The following code snippet demonstrates how we filter and clean post titles:</p> <h6 id=posts-processing>Posts Processing<a class=headerlink href=#posts-processing title="Permanent link">¶</a></h6> <p>The following code snippet demonstrates how we parse, filter, and clean posts: </p><div class="language-python highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=k>def</span><span class=w> </span><span class=nf>preprocess_posts</span><span class=p>(</span><span class=n>df</span><span class=p>):</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=w>    </span><span class=sd>"""Preprocesses Reddit posts with content filtering and cleaning."""</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>    <span class=c1># Content filtering patterns</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>    <span class=n>profanity_pattern</span> <span class=o>=</span> <span class=sa>r</span><span class=s1>'(?i)\b(wordword2|word3|word4|word5)\b|'</span> <span class=o>+</span> \
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>                       <span class=sa>r</span><span class=s1>'(?i)\b(w\*\*d1|w\*rd2|w\*rd3|w\*\*d4)\b|'</span> <span class=o>+</span> \
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>                       <span class=sa>r</span><span class=s1>'(?i)w[^\w]?r[^\w]?d1|'</span> <span class=o>+</span> \
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>                       <span class=sa>r</span><span class=s1>'(?i)w[^\w]?r[^\w]?d2'</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>    <span class=c1># Filter and clean posts</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a>    <span class=k>return</span> <span class=n>df</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a>        <span class=c1># Basic validation</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a>        <span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"title"</span><span class=p>)</span><span class=o>.</span><span class=n>isNotNull</span><span class=p>())</span> <span class=o>&amp;</span> 
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a>        <span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"title"</span><span class=p>)</span> <span class=o>!=</span> <span class=s2>""</span><span class=p>)</span> <span class=o>&amp;</span> 
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a>        <span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"title"</span><span class=p>)</span> <span class=o>!=</span> <span class=s2>"[deleted]"</span><span class=p>)</span> <span class=o>&amp;</span>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a>        <span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"author"</span><span class=p>)</span><span class=o>.</span><span class=n>isNotNull</span><span class=p>())</span> <span class=o>&amp;</span> 
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a>        <span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"author"</span><span class=p>)</span> <span class=o>!=</span> <span class=s2>"[deleted]"</span><span class=p>)</span> <span class=o>&amp;</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a>        <span class=c1># Content filtering</span>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a>        <span class=o>~</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"title"</span><span class=p>)</span><span class=o>.</span><span class=n>rlike</span><span class=p>(</span><span class=n>profanity_pattern</span><span class=p>)</span>
</span><span id=__span-5-19><a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a>    <span class=p>)</span><span class=o>.</span><span class=n>withColumn</span><span class=p>(</span>
</span><span id=__span-5-20><a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a>        <span class=c1># Clean and normalize text</span>
</span><span id=__span-5-21><a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a>        <span class=s2>"title"</span><span class=p>,</span> <span class=n>F</span><span class=o>.</span><span class=n>regexp_replace</span><span class=p>(</span><span class=s2>"title"</span><span class=p>,</span> <span class=sa>r</span><span class=s1>'[\n\r\t]'</span><span class=p>,</span> <span class=s1>' '</span><span class=p>)</span>
</span><span id=__span-5-22><a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a>    <span class=p>)</span><span class=o>.</span><span class=n>withColumn</span><span class=p>(</span>
</span><span id=__span-5-23><a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a>        <span class=c1># Remove multiple spaces</span>
</span><span id=__span-5-24><a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a>        <span class=s2>"title"</span><span class=p>,</span> <span class=n>F</span><span class=o>.</span><span class=n>regexp_replace</span><span class=p>(</span><span class=s2>"title"</span><span class=p>,</span> <span class=sa>r</span><span class=s1>'\s+'</span><span class=p>,</span> <span class=s1>' '</span><span class=p>)</span>
</span><span id=__span-5-25><a id=__codelineno-5-25 name=__codelineno-5-25 href=#__codelineno-5-25></a>    <span class=p>)</span><span class=o>.</span><span class=n>dropDuplicates</span><span class=p>([</span><span class=s2>"post_id"</span><span class=p>])</span>
</span></code></pre></div> Our post preprocessing involves several key steps: we filter out offensive content using regular expressions, validate the <code>title</code> and <code>author</code> fields, clean and normalize the text, and remove duplicate posts. This ensures our analysis is based on clean and relevant data.<p></p> <h6 id=comments-processing>Comments Processing<a class=headerlink href=#comments-processing title="Permanent link">¶</a></h6> <p>Similar to posts, we also preprocess Reddit comments to ensure data quality. The following code snippet demonstrates how we parse, filter, and clean comments stored in JSON format:</p> <p></p><div class="language-python highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=k>def</span><span class=w> </span><span class=nf>preprocess_comments</span><span class=p>(</span><span class=n>df</span><span class=p>):</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=w>    </span><span class=sd>"""Preprocesses Reddit comments with content filtering and cleaning."""</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>    <span class=c1># Parse and explode comments from JSONB</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>    <span class=n>comments_schema</span> <span class=o>=</span> <span class=n>ArrayType</span><span class=p>(</span><span class=n>StructType</span><span class=p>([</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>        <span class=n>StructField</span><span class=p>(</span><span class=s2>"body"</span><span class=p>,</span> <span class=n>StringType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>        <span class=n>StructField</span><span class=p>(</span><span class=s2>"author"</span><span class=p>,</span> <span class=n>StringType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>        <span class=n>StructField</span><span class=p>(</span><span class=s2>"comment_id"</span><span class=p>,</span> <span class=n>StringType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>),</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>        <span class=n>StructField</span><span class=p>(</span><span class=s2>"created_utc"</span><span class=p>,</span> <span class=n>DoubleType</span><span class=p>(),</span> <span class=kc>True</span><span class=p>)</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a>    <span class=p>]))</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>    <span class=k>return</span> <span class=n>df</span><span class=o>.</span><span class=n>withColumn</span><span class=p>(</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a>        <span class=s2>"comments_parsed"</span><span class=p>,</span>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a>        <span class=n>F</span><span class=o>.</span><span class=n>from_json</span><span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"comments"</span><span class=p>),</span> <span class=n>comments_schema</span><span class=p>)</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a>    <span class=p>)</span><span class=o>.</span><span class=n>withColumn</span><span class=p>(</span>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a>        <span class=s2>"comment"</span><span class=p>,</span> <span class=n>F</span><span class=o>.</span><span class=n>explode</span><span class=p>(</span><span class=s2>"comments_parsed"</span><span class=p>)</span>
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a>    <span class=p>)</span><span class=o>.</span><span class=n>select</span><span class=p>(</span>
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a>        <span class=s2>"post_id"</span><span class=p>,</span>
</span><span id=__span-6-18><a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a>        <span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"comment.body"</span><span class=p>)</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>"body"</span><span class=p>),</span>
</span><span id=__span-6-19><a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a>        <span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"comment.author"</span><span class=p>)</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>"author"</span><span class=p>),</span>
</span><span id=__span-6-20><a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a>        <span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"comment.comment_id"</span><span class=p>)</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>"comment_id"</span><span class=p>),</span>
</span><span id=__span-6-21><a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a>        <span class=n>F</span><span class=o>.</span><span class=n>to_timestamp</span><span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"comment.created_utc"</span><span class=p>))</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>"created_utc"</span><span class=p>)</span>
</span><span id=__span-6-22><a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a>    <span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span><span id=__span-6-23><a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a>        <span class=c1># Remove deleted/empty comments</span>
</span><span id=__span-6-24><a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a>        <span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"body"</span><span class=p>)</span><span class=o>.</span><span class=n>isNotNull</span><span class=p>())</span> <span class=o>&amp;</span>
</span><span id=__span-6-25><a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a>        <span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"body"</span><span class=p>)</span> <span class=o>!=</span> <span class=s2>""</span><span class=p>)</span> <span class=o>&amp;</span>
</span><span id=__span-6-26><a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a>        <span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"body"</span><span class=p>)</span> <span class=o>!=</span> <span class=s2>"[deleted]"</span><span class=p>)</span> <span class=o>&amp;</span>
</span><span id=__span-6-27><a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a>        <span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"author"</span><span class=p>)</span> <span class=o>!=</span> <span class=s2>"[deleted]"</span><span class=p>)</span>
</span><span id=__span-6-28><a id=__codelineno-6-28 name=__codelineno-6-28 href=#__codelineno-6-28></a>    <span class=p>)</span><span class=o>.</span><span class=n>withColumn</span><span class=p>(</span>
</span><span id=__span-6-29><a id=__codelineno-6-29 name=__codelineno-6-29 href=#__codelineno-6-29></a>        <span class=c1># Clean and normalize text</span>
</span><span id=__span-6-30><a id=__codelineno-6-30 name=__codelineno-6-30 href=#__codelineno-6-30></a>        <span class=s2>"body"</span><span class=p>,</span> <span class=n>F</span><span class=o>.</span><span class=n>regexp_replace</span><span class=p>(</span><span class=s2>"body"</span><span class=p>,</span> <span class=sa>r</span><span class=s1>'[\n\r\t]'</span><span class=p>,</span> <span class=s1>' '</span><span class=p>)</span>
</span><span id=__span-6-31><a id=__codelineno-6-31 name=__codelineno-6-31 href=#__codelineno-6-31></a>    <span class=p>)</span><span class=o>.</span><span class=n>withColumn</span><span class=p>(</span>
</span><span id=__span-6-32><a id=__codelineno-6-32 name=__codelineno-6-32 href=#__codelineno-6-32></a>        <span class=c1># Remove multiple spaces</span>
</span><span id=__span-6-33><a id=__codelineno-6-33 name=__codelineno-6-33 href=#__codelineno-6-33></a>        <span class=s2>"body"</span><span class=p>,</span> <span class=n>F</span><span class=o>.</span><span class=n>regexp_replace</span><span class=p>(</span><span class=s2>"body"</span><span class=p>,</span> <span class=sa>r</span><span class=s1>'\s+'</span><span class=p>,</span> <span class=s1>' '</span><span class=p>)</span>
</span><span id=__span-6-34><a id=__codelineno-6-34 name=__codelineno-6-34 href=#__codelineno-6-34></a>    <span class=p>)</span><span class=o>.</span><span class=n>dropDuplicates</span><span class=p>([</span><span class=s2>"comment_id"</span><span class=p>])</span>
</span></code></pre></div> Our comment preprocessing involves defining a schema for the JSON data, parsing and exploding the comments, selecting and aliasing relevant fields (including converting the timestamp), filtering out invalid comments, cleaning and normalizing the text, and removing duplicates.<p></p> <h6 id=processed-data-schema>Processed Data Schema<a class=headerlink href=#processed-data-schema title="Permanent link">¶</a></h6> <p>The cleaned data is stored in separate tables for posts and comments:</p> <div class="language-terraform highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=c1># Dynamic processed posts tables for each subreddit</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=kr>resource</span><span class=w> </span><span class=nc>"google_bigquery_table"</span><span class=w> </span><span class=nv>"processed_posts_tables"</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=w>  </span><span class=na>for_each</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>toset</span><span class=p>(</span><span class=nv>var.subreddits</span><span class=p>)</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=w>  </span><span class=na>dataset_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>google_bigquery_dataset.processed_data.dataset_id</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=w>  </span><span class=na>table_id</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s2>"posts_${lower(each.value)}"</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=w>  </span><span class=na>project</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=nv>var.project</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=w>  </span><span class=na>deletion_protection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>false</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=w>  </span><span class=na>schema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>jsonencode</span><span class=p>([</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"post_id"</span><span class=p>,</span>
</span><span id=__span-7-14><a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"STRING"</span><span class=p>,</span>
</span><span id=__span-7-15><a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"REQUIRED"</span>
</span><span id=__span-7-16><a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-7-17><a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-18><a id=__codelineno-7-18 name=__codelineno-7-18 href=#__codelineno-7-18></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"subreddit"</span><span class=p>,</span>
</span><span id=__span-7-19><a id=__codelineno-7-19 name=__codelineno-7-19 href=#__codelineno-7-19></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"STRING"</span><span class=p>,</span>
</span><span id=__span-7-20><a id=__codelineno-7-20 name=__codelineno-7-20 href=#__codelineno-7-20></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"REQUIRED"</span>
</span><span id=__span-7-21><a id=__codelineno-7-21 name=__codelineno-7-21 href=#__codelineno-7-21></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-7-22><a id=__codelineno-7-22 name=__codelineno-7-22 href=#__codelineno-7-22></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-23><a id=__codelineno-7-23 name=__codelineno-7-23 href=#__codelineno-7-23></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"title"</span><span class=p>,</span>
</span><span id=__span-7-24><a id=__codelineno-7-24 name=__codelineno-7-24 href=#__codelineno-7-24></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"STRING"</span><span class=p>,</span>
</span><span id=__span-7-25><a id=__codelineno-7-25 name=__codelineno-7-25 href=#__codelineno-7-25></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"NULLABLE"</span>
</span><span id=__span-7-26><a id=__codelineno-7-26 name=__codelineno-7-26 href=#__codelineno-7-26></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-7-27><a id=__codelineno-7-27 name=__codelineno-7-27 href=#__codelineno-7-27></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-28><a id=__codelineno-7-28 name=__codelineno-7-28 href=#__codelineno-7-28></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"author"</span><span class=p>,</span>
</span><span id=__span-7-29><a id=__codelineno-7-29 name=__codelineno-7-29 href=#__codelineno-7-29></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"STRING"</span><span class=p>,</span>
</span><span id=__span-7-30><a id=__codelineno-7-30 name=__codelineno-7-30 href=#__codelineno-7-30></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"NULLABLE"</span>
</span><span id=__span-7-31><a id=__codelineno-7-31 name=__codelineno-7-31 href=#__codelineno-7-31></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-7-32><a id=__codelineno-7-32 name=__codelineno-7-32 href=#__codelineno-7-32></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-33><a id=__codelineno-7-33 name=__codelineno-7-33 href=#__codelineno-7-33></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"url"</span><span class=p>,</span>
</span><span id=__span-7-34><a id=__codelineno-7-34 name=__codelineno-7-34 href=#__codelineno-7-34></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"STRING"</span><span class=p>,</span>
</span><span id=__span-7-35><a id=__codelineno-7-35 name=__codelineno-7-35 href=#__codelineno-7-35></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"NULLABLE"</span>
</span><span id=__span-7-36><a id=__codelineno-7-36 name=__codelineno-7-36 href=#__codelineno-7-36></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-7-37><a id=__codelineno-7-37 name=__codelineno-7-37 href=#__codelineno-7-37></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-38><a id=__codelineno-7-38 name=__codelineno-7-38 href=#__codelineno-7-38></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"score"</span><span class=p>,</span>
</span><span id=__span-7-39><a id=__codelineno-7-39 name=__codelineno-7-39 href=#__codelineno-7-39></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"INTEGER"</span><span class=p>,</span>
</span><span id=__span-7-40><a id=__codelineno-7-40 name=__codelineno-7-40 href=#__codelineno-7-40></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"NULLABLE"</span>
</span><span id=__span-7-41><a id=__codelineno-7-41 name=__codelineno-7-41 href=#__codelineno-7-41></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-7-42><a id=__codelineno-7-42 name=__codelineno-7-42 href=#__codelineno-7-42></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-43><a id=__codelineno-7-43 name=__codelineno-7-43 href=#__codelineno-7-43></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"created_utc"</span><span class=p>,</span>
</span><span id=__span-7-44><a id=__codelineno-7-44 name=__codelineno-7-44 href=#__codelineno-7-44></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"TIMESTAMP"</span><span class=p>,</span>
</span><span id=__span-7-45><a id=__codelineno-7-45 name=__codelineno-7-45 href=#__codelineno-7-45></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"NULLABLE"</span>
</span><span id=__span-7-46><a id=__codelineno-7-46 name=__codelineno-7-46 href=#__codelineno-7-46></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-7-47><a id=__codelineno-7-47 name=__codelineno-7-47 href=#__codelineno-7-47></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-48><a id=__codelineno-7-48 name=__codelineno-7-48 href=#__codelineno-7-48></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"ingestion_timestamp"</span><span class=p>,</span>
</span><span id=__span-7-49><a id=__codelineno-7-49 name=__codelineno-7-49 href=#__codelineno-7-49></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"TIMESTAMP"</span><span class=p>,</span>
</span><span id=__span-7-50><a id=__codelineno-7-50 name=__codelineno-7-50 href=#__codelineno-7-50></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"NULLABLE"</span>
</span><span id=__span-7-51><a id=__codelineno-7-51 name=__codelineno-7-51 href=#__codelineno-7-51></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-52><a id=__codelineno-7-52 name=__codelineno-7-52 href=#__codelineno-7-52></a><span class=w>  </span><span class=p>])</span>
</span><span id=__span-7-53><a id=__codelineno-7-53 name=__codelineno-7-53 href=#__codelineno-7-53></a><span class=p>}</span>
</span><span id=__span-7-54><a id=__codelineno-7-54 name=__codelineno-7-54 href=#__codelineno-7-54></a>
</span><span id=__span-7-55><a id=__codelineno-7-55 name=__codelineno-7-55 href=#__codelineno-7-55></a><span class=c1># Dynamic processed comments tables for each subreddit</span>
</span><span id=__span-7-56><a id=__codelineno-7-56 name=__codelineno-7-56 href=#__codelineno-7-56></a><span class=kr>resource</span><span class=w> </span><span class=nc>"google_bigquery_table"</span><span class=w> </span><span class=nv>"processed_comments_tables"</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-57><a id=__codelineno-7-57 name=__codelineno-7-57 href=#__codelineno-7-57></a><span class=w>  </span><span class=na>for_each</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>toset</span><span class=p>(</span><span class=nv>var.subreddits</span><span class=p>)</span>
</span><span id=__span-7-58><a id=__codelineno-7-58 name=__codelineno-7-58 href=#__codelineno-7-58></a>
</span><span id=__span-7-59><a id=__codelineno-7-59 name=__codelineno-7-59 href=#__codelineno-7-59></a><span class=w>  </span><span class=na>dataset_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>google_bigquery_dataset.processed_data.dataset_id</span>
</span><span id=__span-7-60><a id=__codelineno-7-60 name=__codelineno-7-60 href=#__codelineno-7-60></a><span class=w>  </span><span class=na>table_id</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s2>"comments_${lower(each.value)}"</span>
</span><span id=__span-7-61><a id=__codelineno-7-61 name=__codelineno-7-61 href=#__codelineno-7-61></a><span class=w>  </span><span class=na>project</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=nv>var.project</span>
</span><span id=__span-7-62><a id=__codelineno-7-62 name=__codelineno-7-62 href=#__codelineno-7-62></a>
</span><span id=__span-7-63><a id=__codelineno-7-63 name=__codelineno-7-63 href=#__codelineno-7-63></a><span class=w>  </span><span class=na>deletion_protection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>false</span>
</span><span id=__span-7-64><a id=__codelineno-7-64 name=__codelineno-7-64 href=#__codelineno-7-64></a>
</span><span id=__span-7-65><a id=__codelineno-7-65 name=__codelineno-7-65 href=#__codelineno-7-65></a><span class=w>  </span><span class=na>schema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>jsonencode</span><span class=p>([</span>
</span><span id=__span-7-66><a id=__codelineno-7-66 name=__codelineno-7-66 href=#__codelineno-7-66></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-67><a id=__codelineno-7-67 name=__codelineno-7-67 href=#__codelineno-7-67></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"post_id"</span><span class=p>,</span>
</span><span id=__span-7-68><a id=__codelineno-7-68 name=__codelineno-7-68 href=#__codelineno-7-68></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"STRING"</span><span class=p>,</span>
</span><span id=__span-7-69><a id=__codelineno-7-69 name=__codelineno-7-69 href=#__codelineno-7-69></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"REQUIRED"</span>
</span><span id=__span-7-70><a id=__codelineno-7-70 name=__codelineno-7-70 href=#__codelineno-7-70></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-7-71><a id=__codelineno-7-71 name=__codelineno-7-71 href=#__codelineno-7-71></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-72><a id=__codelineno-7-72 name=__codelineno-7-72 href=#__codelineno-7-72></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"comment_id"</span><span class=p>,</span>
</span><span id=__span-7-73><a id=__codelineno-7-73 name=__codelineno-7-73 href=#__codelineno-7-73></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"STRING"</span><span class=p>,</span>
</span><span id=__span-7-74><a id=__codelineno-7-74 name=__codelineno-7-74 href=#__codelineno-7-74></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"REQUIRED"</span>
</span><span id=__span-7-75><a id=__codelineno-7-75 name=__codelineno-7-75 href=#__codelineno-7-75></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-7-76><a id=__codelineno-7-76 name=__codelineno-7-76 href=#__codelineno-7-76></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-77><a id=__codelineno-7-77 name=__codelineno-7-77 href=#__codelineno-7-77></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"author"</span><span class=p>,</span>
</span><span id=__span-7-78><a id=__codelineno-7-78 name=__codelineno-7-78 href=#__codelineno-7-78></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"STRING"</span><span class=p>,</span>
</span><span id=__span-7-79><a id=__codelineno-7-79 name=__codelineno-7-79 href=#__codelineno-7-79></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"NULLABLE"</span>
</span><span id=__span-7-80><a id=__codelineno-7-80 name=__codelineno-7-80 href=#__codelineno-7-80></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-7-81><a id=__codelineno-7-81 name=__codelineno-7-81 href=#__codelineno-7-81></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-82><a id=__codelineno-7-82 name=__codelineno-7-82 href=#__codelineno-7-82></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"body"</span><span class=p>,</span>
</span><span id=__span-7-83><a id=__codelineno-7-83 name=__codelineno-7-83 href=#__codelineno-7-83></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"STRING"</span><span class=p>,</span>
</span><span id=__span-7-84><a id=__codelineno-7-84 name=__codelineno-7-84 href=#__codelineno-7-84></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"NULLABLE"</span>
</span><span id=__span-7-85><a id=__codelineno-7-85 name=__codelineno-7-85 href=#__codelineno-7-85></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-7-86><a id=__codelineno-7-86 name=__codelineno-7-86 href=#__codelineno-7-86></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-7-87><a id=__codelineno-7-87 name=__codelineno-7-87 href=#__codelineno-7-87></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"created_utc"</span><span class=p>,</span>
</span><span id=__span-7-88><a id=__codelineno-7-88 name=__codelineno-7-88 href=#__codelineno-7-88></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"TIMESTAMP"</span><span class=p>,</span>
</span><span id=__span-7-89><a id=__codelineno-7-89 name=__codelineno-7-89 href=#__codelineno-7-89></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"NULLABLE"</span>
</span><span id=__span-7-90><a id=__codelineno-7-90 name=__codelineno-7-90 href=#__codelineno-7-90></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-91><a id=__codelineno-7-91 name=__codelineno-7-91 href=#__codelineno-7-91></a><span class=w>  </span><span class=p>])</span>
</span><span id=__span-7-92><a id=__codelineno-7-92 name=__codelineno-7-92 href=#__codelineno-7-92></a><span class=p>}</span>
</span></code></pre></div> <h6 id=daily-summary-processing>Daily Summary Processing<a class=headerlink href=#daily-summary-processing title="Permanent link">¶</a></h6> <p>After preprocessing, we generate daily summaries of the Reddit data using PySpark. The following code snippet demonstrates how we load, filter, and join posts and comments to create these summaries:</p> <p></p><div class="language-python highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=k>def</span><span class=w> </span><span class=nf>generate_daily_summaries</span><span class=p>(</span><span class=n>spark</span><span class=p>:</span> <span class=n>SparkSession</span><span class=p>,</span> <span class=n>project_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>dataset_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>subreddits</span><span class=p>:</span> <span class=nb>list</span><span class=p>,</span> <span class=n>bucket_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=w>    </span><span class=sd>"""</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=sd>    Generates daily summaries of the processed data using PySpark.</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=sd>    Implements incremental loading by only processing data since the last processed timestamp.</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=sd>    """</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>    <span class=n>current_timestamp</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>    <span class=n>last_processed</span> <span class=o>=</span> <span class=n>get_last_processed_timestamp</span><span class=p>(</span><span class=n>spark</span><span class=p>,</span> <span class=n>project_id</span><span class=p>,</span> <span class=n>dataset_id</span><span class=p>)</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>    <span class=n>total_summaries_added</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>    <span class=k>if</span> <span class=n>last_processed</span><span class=p>:</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Processing summaries from </span><span class=si>{</span><span class=n>last_processed</span><span class=si>}</span><span class=s2> to </span><span class=si>{</span><span class=n>current_timestamp</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>"No previous summaries found. Processing all available data."</span><span class=p>)</span>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a>    <span class=k>for</span> <span class=n>subreddit</span> <span class=ow>in</span> <span class=n>subreddits</span><span class=p>:</span>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Processing daily summary for subreddit: </span><span class=si>{</span><span class=n>subreddit</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a>
</span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a>        <span class=c1># Load posts and comments tables from BigQuery</span>
</span><span id=__span-8-19><a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a>        <span class=n>posts_df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>read</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s1>'bigquery'</span><span class=p>)</span> \
</span><span id=__span-8-20><a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a>            <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s1>'table'</span><span class=p>,</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>project_id</span><span class=si>}</span><span class=s2>.</span><span class=si>{</span><span class=n>dataset_id</span><span class=si>}</span><span class=s2>.posts_</span><span class=si>{</span><span class=n>subreddit</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span> \
</span><span id=__span-8-21><a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a>            <span class=o>.</span><span class=n>load</span><span class=p>()</span>
</span><span id=__span-8-22><a id=__codelineno-8-22 name=__codelineno-8-22 href=#__codelineno-8-22></a>
</span><span id=__span-8-23><a id=__codelineno-8-23 name=__codelineno-8-23 href=#__codelineno-8-23></a>        <span class=n>posts_count</span> <span class=o>=</span> <span class=n>posts_df</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span><span id=__span-8-24><a id=__codelineno-8-24 name=__codelineno-8-24 href=#__codelineno-8-24></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Found </span><span class=si>{</span><span class=n>posts_count</span><span class=si>}</span><span class=s2> posts for </span><span class=si>{</span><span class=n>subreddit</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-8-25><a id=__codelineno-8-25 name=__codelineno-8-25 href=#__codelineno-8-25></a>
</span><span id=__span-8-26><a id=__codelineno-8-26 name=__codelineno-8-26 href=#__codelineno-8-26></a>        <span class=n>comments_df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>read</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s1>'bigquery'</span><span class=p>)</span> \
</span><span id=__span-8-27><a id=__codelineno-8-27 name=__codelineno-8-27 href=#__codelineno-8-27></a>            <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s1>'table'</span><span class=p>,</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>project_id</span><span class=si>}</span><span class=s2>.</span><span class=si>{</span><span class=n>dataset_id</span><span class=si>}</span><span class=s2>.comments_</span><span class=si>{</span><span class=n>subreddit</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span> \
</span><span id=__span-8-28><a id=__codelineno-8-28 name=__codelineno-8-28 href=#__codelineno-8-28></a>            <span class=o>.</span><span class=n>load</span><span class=p>()</span>
</span><span id=__span-8-29><a id=__codelineno-8-29 name=__codelineno-8-29 href=#__codelineno-8-29></a>
</span><span id=__span-8-30><a id=__codelineno-8-30 name=__codelineno-8-30 href=#__codelineno-8-30></a>        <span class=n>comments_count</span> <span class=o>=</span> <span class=n>comments_df</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span><span id=__span-8-31><a id=__codelineno-8-31 name=__codelineno-8-31 href=#__codelineno-8-31></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Found </span><span class=si>{</span><span class=n>comments_count</span><span class=si>}</span><span class=s2> comments for </span><span class=si>{</span><span class=n>subreddit</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-8-32><a id=__codelineno-8-32 name=__codelineno-8-32 href=#__codelineno-8-32></a>
</span><span id=__span-8-33><a id=__codelineno-8-33 name=__codelineno-8-33 href=#__codelineno-8-33></a>        <span class=c1># Filter posts and comments based on created_utc timestamp</span>
</span><span id=__span-8-34><a id=__codelineno-8-34 name=__codelineno-8-34 href=#__codelineno-8-34></a>        <span class=k>if</span> <span class=n>last_processed</span><span class=p>:</span>
</span><span id=__span-8-35><a id=__codelineno-8-35 name=__codelineno-8-35 href=#__codelineno-8-35></a>            <span class=n>daily_posts_df</span> <span class=o>=</span> <span class=n>posts_df</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span><span id=__span-8-36><a id=__codelineno-8-36 name=__codelineno-8-36 href=#__codelineno-8-36></a>                <span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"created_utc"</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>last_processed</span><span class=p>)</span> <span class=o>&amp;</span>
</span><span id=__span-8-37><a id=__codelineno-8-37 name=__codelineno-8-37 href=#__codelineno-8-37></a>                <span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"created_utc"</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>current_timestamp</span><span class=p>)</span>
</span><span id=__span-8-38><a id=__codelineno-8-38 name=__codelineno-8-38 href=#__codelineno-8-38></a>            <span class=p>)</span>
</span><span id=__span-8-39><a id=__codelineno-8-39 name=__codelineno-8-39 href=#__codelineno-8-39></a>
</span><span id=__span-8-40><a id=__codelineno-8-40 name=__codelineno-8-40 href=#__codelineno-8-40></a>            <span class=n>daily_comments_df</span> <span class=o>=</span> <span class=n>comments_df</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span><span id=__span-8-41><a id=__codelineno-8-41 name=__codelineno-8-41 href=#__codelineno-8-41></a>                <span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"created_utc"</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>last_processed</span><span class=p>)</span> <span class=o>&amp;</span>
</span><span id=__span-8-42><a id=__codelineno-8-42 name=__codelineno-8-42 href=#__codelineno-8-42></a>                <span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"created_utc"</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>current_timestamp</span><span class=p>)</span>
</span><span id=__span-8-43><a id=__codelineno-8-43 name=__codelineno-8-43 href=#__codelineno-8-43></a>            <span class=p>)</span>
</span><span id=__span-8-44><a id=__codelineno-8-44 name=__codelineno-8-44 href=#__codelineno-8-44></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-8-45><a id=__codelineno-8-45 name=__codelineno-8-45 href=#__codelineno-8-45></a>            <span class=n>daily_posts_df</span> <span class=o>=</span> <span class=n>posts_df</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"created_utc"</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>current_timestamp</span><span class=p>)</span>
</span><span id=__span-8-46><a id=__codelineno-8-46 name=__codelineno-8-46 href=#__codelineno-8-46></a>            <span class=n>daily_comments_df</span> <span class=o>=</span> <span class=n>comments_df</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"created_utc"</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>current_timestamp</span><span class=p>)</span>
</span><span id=__span-8-47><a id=__codelineno-8-47 name=__codelineno-8-47 href=#__codelineno-8-47></a>
</span><span id=__span-8-48><a id=__codelineno-8-48 name=__codelineno-8-48 href=#__codelineno-8-48></a>        <span class=n>filtered_posts_count</span> <span class=o>=</span> <span class=n>daily_posts_df</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span><span id=__span-8-49><a id=__codelineno-8-49 name=__codelineno-8-49 href=#__codelineno-8-49></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Filtered to </span><span class=si>{</span><span class=n>filtered_posts_count</span><span class=si>}</span><span class=s2> posts for processing"</span><span class=p>)</span>
</span><span id=__span-8-50><a id=__codelineno-8-50 name=__codelineno-8-50 href=#__codelineno-8-50></a>
</span><span id=__span-8-51><a id=__codelineno-8-51 name=__codelineno-8-51 href=#__codelineno-8-51></a>        <span class=k>if</span> <span class=n>filtered_posts_count</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-8-52><a id=__codelineno-8-52 name=__codelineno-8-52 href=#__codelineno-8-52></a>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"No new posts to summarize for </span><span class=si>{</span><span class=n>subreddit</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-8-53><a id=__codelineno-8-53 name=__codelineno-8-53 href=#__codelineno-8-53></a>            <span class=k>continue</span>
</span><span id=__span-8-54><a id=__codelineno-8-54 name=__codelineno-8-54 href=#__codelineno-8-54></a>
</span><span id=__span-8-55><a id=__codelineno-8-55 name=__codelineno-8-55 href=#__codelineno-8-55></a>        <span class=c1># Join posts and comments on post_id</span>
</span><span id=__span-8-56><a id=__codelineno-8-56 name=__codelineno-8-56 href=#__codelineno-8-56></a>        <span class=n>joined_df</span> <span class=o>=</span> <span class=n>daily_posts_df</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>"posts"</span><span class=p>)</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
</span><span id=__span-8-57><a id=__codelineno-8-57 name=__codelineno-8-57 href=#__codelineno-8-57></a>            <span class=n>daily_comments_df</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>"comments"</span><span class=p>),</span> 
</span><span id=__span-8-58><a id=__codelineno-8-58 name=__codelineno-8-58 href=#__codelineno-8-58></a>            <span class=s2>"post_id"</span><span class=p>,</span> 
</span><span id=__span-8-59><a id=__codelineno-8-59 name=__codelineno-8-59 href=#__codelineno-8-59></a>            <span class=s2>"right"</span>
</span><span id=__span-8-60><a id=__codelineno-8-60 name=__codelineno-8-60 href=#__codelineno-8-60></a>        <span class=p>)</span>
</span><span id=__span-8-61><a id=__codelineno-8-61 name=__codelineno-8-61 href=#__codelineno-8-61></a>
</span><span id=__span-8-62><a id=__codelineno-8-62 name=__codelineno-8-62 href=#__codelineno-8-62></a>        <span class=c1># Prepare the daily summary</span>
</span><span id=__span-8-63><a id=__codelineno-8-63 name=__codelineno-8-63 href=#__codelineno-8-63></a>        <span class=n>daily_summary_df</span> <span class=o>=</span> <span class=n>joined_df</span><span class=o>.</span><span class=n>select</span><span class=p>(</span>
</span><span id=__span-8-64><a id=__codelineno-8-64 name=__codelineno-8-64 href=#__codelineno-8-64></a>            <span class=n>F</span><span class=o>.</span><span class=n>monotonically_increasing_id</span><span class=p>()</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>"id"</span><span class=p>),</span>
</span><span id=__span-8-65><a id=__codelineno-8-65 name=__codelineno-8-65 href=#__codelineno-8-65></a>            <span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"subreddit"</span><span class=p>),</span>
</span><span id=__span-8-66><a id=__codelineno-8-66 name=__codelineno-8-66 href=#__codelineno-8-66></a>            <span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"posts.post_id"</span><span class=p>)</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>"post_id"</span><span class=p>),</span>
</span><span id=__span-8-67><a id=__codelineno-8-67 name=__codelineno-8-67 href=#__codelineno-8-67></a>            <span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"posts.score"</span><span class=p>)</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>"post_score"</span><span class=p>),</span>
</span><span id=__span-8-68><a id=__codelineno-8-68 name=__codelineno-8-68 href=#__codelineno-8-68></a>            <span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"posts.url"</span><span class=p>)</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>"post_url"</span><span class=p>),</span>
</span><span id=__span-8-69><a id=__codelineno-8-69 name=__codelineno-8-69 href=#__codelineno-8-69></a>            <span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"comments.comment_id"</span><span class=p>)</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>"comment_id"</span><span class=p>),</span>
</span><span id=__span-8-70><a id=__codelineno-8-70 name=__codelineno-8-70 href=#__codelineno-8-70></a>            <span class=n>F</span><span class=o>.</span><span class=n>to_date</span><span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"comments.created_utc"</span><span class=p>))</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>"summary_date"</span><span class=p>),</span>
</span><span id=__span-8-71><a id=__codelineno-8-71 name=__codelineno-8-71 href=#__codelineno-8-71></a>            <span class=n>F</span><span class=o>.</span><span class=n>current_timestamp</span><span class=p>()</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>"processed_date"</span><span class=p>),</span>
</span><span id=__span-8-72><a id=__codelineno-8-72 name=__codelineno-8-72 href=#__codelineno-8-72></a>            <span class=n>F</span><span class=o>.</span><span class=n>lit</span><span class=p>(</span><span class=kc>True</span><span class=p>)</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>"needs_processing"</span><span class=p>),</span>
</span><span id=__span-8-73><a id=__codelineno-8-73 name=__codelineno-8-73 href=#__codelineno-8-73></a>            <span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"posts.title"</span><span class=p>)</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>"post_content"</span><span class=p>),</span>
</span><span id=__span-8-74><a id=__codelineno-8-74 name=__codelineno-8-74 href=#__codelineno-8-74></a>            <span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"comments.body"</span><span class=p>)</span><span class=o>.</span><span class=n>alias</span><span class=p>(</span><span class=s2>"comment_body"</span><span class=p>)</span>
</span><span id=__span-8-75><a id=__codelineno-8-75 name=__codelineno-8-75 href=#__codelineno-8-75></a>        <span class=p>)</span>
</span><span id=__span-8-76><a id=__codelineno-8-76 name=__codelineno-8-76 href=#__codelineno-8-76></a>
</span><span id=__span-8-77><a id=__codelineno-8-77 name=__codelineno-8-77 href=#__codelineno-8-77></a>        <span class=c1># Filter out rows where required fields are null</span>
</span><span id=__span-8-78><a id=__codelineno-8-78 name=__codelineno-8-78 href=#__codelineno-8-78></a>        <span class=n>daily_summary_df</span> <span class=o>=</span> <span class=n>daily_summary_df</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span><span id=__span-8-79><a id=__codelineno-8-79 name=__codelineno-8-79 href=#__codelineno-8-79></a>            <span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"comment_body"</span><span class=p>)</span><span class=o>.</span><span class=n>isNotNull</span><span class=p>())</span> <span class=o>&amp;</span> 
</span><span id=__span-8-80><a id=__codelineno-8-80 name=__codelineno-8-80 href=#__codelineno-8-80></a>            <span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"comment_id"</span><span class=p>)</span><span class=o>.</span><span class=n>isNotNull</span><span class=p>())</span> <span class=o>&amp;</span>
</span><span id=__span-8-81><a id=__codelineno-8-81 name=__codelineno-8-81 href=#__codelineno-8-81></a>            <span class=p>(</span><span class=n>F</span><span class=o>.</span><span class=n>col</span><span class=p>(</span><span class=s2>"post_id"</span><span class=p>)</span><span class=o>.</span><span class=n>isNotNull</span><span class=p>())</span>
</span><span id=__span-8-82><a id=__codelineno-8-82 name=__codelineno-8-82 href=#__codelineno-8-82></a>        <span class=p>)</span>
</span><span id=__span-8-83><a id=__codelineno-8-83 name=__codelineno-8-83 href=#__codelineno-8-83></a>
</span><span id=__span-8-84><a id=__codelineno-8-84 name=__codelineno-8-84 href=#__codelineno-8-84></a>        <span class=n>filtered_summaries_count</span> <span class=o>=</span> <span class=n>daily_summary_df</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span><span id=__span-8-85><a id=__codelineno-8-85 name=__codelineno-8-85 href=#__codelineno-8-85></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Generated </span><span class=si>{</span><span class=n>filtered_summaries_count</span><span class=si>}</span><span class=s2> summaries before deduplication"</span><span class=p>)</span>
</span><span id=__span-8-86><a id=__codelineno-8-86 name=__codelineno-8-86 href=#__codelineno-8-86></a>
</span><span id=__span-8-87><a id=__codelineno-8-87 name=__codelineno-8-87 href=#__codelineno-8-87></a>        <span class=c1># Deduplication Logic</span>
</span><span id=__span-8-88><a id=__codelineno-8-88 name=__codelineno-8-88 href=#__codelineno-8-88></a>        <span class=n>existing_summary_df</span> <span class=o>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>read</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s1>'bigquery'</span><span class=p>)</span> \
</span><span id=__span-8-89><a id=__codelineno-8-89 name=__codelineno-8-89 href=#__codelineno-8-89></a>            <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s1>'table'</span><span class=p>,</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>project_id</span><span class=si>}</span><span class=s2>.</span><span class=si>{</span><span class=n>dataset_id</span><span class=si>}</span><span class=s2>.daily_summary_data"</span><span class=p>)</span> \
</span><span id=__span-8-90><a id=__codelineno-8-90 name=__codelineno-8-90 href=#__codelineno-8-90></a>            <span class=o>.</span><span class=n>load</span><span class=p>()</span>
</span><span id=__span-8-91><a id=__codelineno-8-91 name=__codelineno-8-91 href=#__codelineno-8-91></a>
</span><span id=__span-8-92><a id=__codelineno-8-92 name=__codelineno-8-92 href=#__codelineno-8-92></a>        <span class=c1># Perform a left anti-join to get only new records</span>
</span><span id=__span-8-93><a id=__codelineno-8-93 name=__codelineno-8-93 href=#__codelineno-8-93></a>        <span class=n>new_daily_summary_df</span> <span class=o>=</span> <span class=n>daily_summary_df</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
</span><span id=__span-8-94><a id=__codelineno-8-94 name=__codelineno-8-94 href=#__codelineno-8-94></a>            <span class=n>existing_summary_df</span><span class=p>,</span>
</span><span id=__span-8-95><a id=__codelineno-8-95 name=__codelineno-8-95 href=#__codelineno-8-95></a>            <span class=p>[</span><span class=s2>"post_id"</span><span class=p>,</span> <span class=s2>"comment_id"</span><span class=p>],</span>  <span class=c1># Using composite key for deduplication</span>
</span><span id=__span-8-96><a id=__codelineno-8-96 name=__codelineno-8-96 href=#__codelineno-8-96></a>            <span class=s2>"left_anti"</span>
</span><span id=__span-8-97><a id=__codelineno-8-97 name=__codelineno-8-97 href=#__codelineno-8-97></a>        <span class=p>)</span>
</span><span id=__span-8-98><a id=__codelineno-8-98 name=__codelineno-8-98 href=#__codelineno-8-98></a>
</span><span id=__span-8-99><a id=__codelineno-8-99 name=__codelineno-8-99 href=#__codelineno-8-99></a>        <span class=n>new_summaries_count</span> <span class=o>=</span> <span class=n>new_daily_summary_df</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span><span id=__span-8-100><a id=__codelineno-8-100 name=__codelineno-8-100 href=#__codelineno-8-100></a>
</span><span id=__span-8-101><a id=__codelineno-8-101 name=__codelineno-8-101 href=#__codelineno-8-101></a>        <span class=k>if</span> <span class=n>new_summaries_count</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-8-102><a id=__codelineno-8-102 name=__codelineno-8-102 href=#__codelineno-8-102></a>            <span class=c1># Write the new daily summaries to BigQuery</span>
</span><span id=__span-8-103><a id=__codelineno-8-103 name=__codelineno-8-103 href=#__codelineno-8-103></a>            <span class=n>new_daily_summary_df</span><span class=o>.</span><span class=n>write</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s1>'bigquery'</span><span class=p>)</span> \
</span><span id=__span-8-104><a id=__codelineno-8-104 name=__codelineno-8-104 href=#__codelineno-8-104></a>                <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s1>'table'</span><span class=p>,</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>project_id</span><span class=si>}</span><span class=s2>.</span><span class=si>{</span><span class=n>dataset_id</span><span class=si>}</span><span class=s2>.daily_summary_data"</span><span class=p>)</span> \
</span><span id=__span-8-105><a id=__codelineno-8-105 name=__codelineno-8-105 href=#__codelineno-8-105></a>                <span class=o>.</span><span class=n>option</span><span class=p>(</span><span class=s1>'temporaryGcsBucket'</span><span class=p>,</span> <span class=n>bucket_name</span><span class=p>)</span> \
</span><span id=__span-8-106><a id=__codelineno-8-106 name=__codelineno-8-106 href=#__codelineno-8-106></a>                <span class=o>.</span><span class=n>mode</span><span class=p>(</span><span class=s1>'append'</span><span class=p>)</span> \
</span><span id=__span-8-107><a id=__codelineno-8-107 name=__codelineno-8-107 href=#__codelineno-8-107></a>                <span class=o>.</span><span class=n>save</span><span class=p>()</span>
</span><span id=__span-8-108><a id=__codelineno-8-108 name=__codelineno-8-108 href=#__codelineno-8-108></a>
</span><span id=__span-8-109><a id=__codelineno-8-109 name=__codelineno-8-109 href=#__codelineno-8-109></a>            <span class=n>total_summaries_added</span> <span class=o>+=</span> <span class=n>new_summaries_count</span>
</span><span id=__span-8-110><a id=__codelineno-8-110 name=__codelineno-8-110 href=#__codelineno-8-110></a>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Successfully added </span><span class=si>{</span><span class=n>new_summaries_count</span><span class=si>}</span><span class=s2> new summaries for </span><span class=si>{</span><span class=n>subreddit</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-8-111><a id=__codelineno-8-111 name=__codelineno-8-111 href=#__codelineno-8-111></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-8-112><a id=__codelineno-8-112 name=__codelineno-8-112 href=#__codelineno-8-112></a>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"No new unique summaries to add for </span><span class=si>{</span><span class=n>subreddit</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span></code></pre></div> To create daily summaries, we load new posts and comments for each subreddit. We then join these datasets on post_id, select the necessary fields, and filter out any rows with null values. This function combines post and comment data, preparing it for further analysis.<p></p> <p>The daily summary data is stored with the following schema:</p> <div class="language-terraform highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=kr>resource</span><span class=w> </span><span class=nc>"google_bigquery_table"</span><span class=w> </span><span class=nv>"daily_summary"</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=w>  </span><span class=na>dataset_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>google_bigquery_dataset.processed_data.dataset_id</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=w>  </span><span class=na>table_id</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s2>"daily_summary_data"</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=w>  </span><span class=na>project</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=nv>var.project</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=w>  </span><span class=na>deletion_protection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>false</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=w>  </span><span class=na>schema</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>jsonencode</span><span class=p>([</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"id"</span><span class=p>,</span>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"INTEGER"</span><span class=p>,</span>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"REQUIRED"</span>
</span><span id=__span-9-13><a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-9-14><a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-15><a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"subreddit"</span><span class=p>,</span>
</span><span id=__span-9-16><a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"STRING"</span><span class=p>,</span>
</span><span id=__span-9-17><a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"REQUIRED"</span>
</span><span id=__span-9-18><a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-9-19><a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-20><a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"post_id"</span><span class=p>,</span>
</span><span id=__span-9-21><a id=__codelineno-9-21 name=__codelineno-9-21 href=#__codelineno-9-21></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"STRING"</span><span class=p>,</span>
</span><span id=__span-9-22><a id=__codelineno-9-22 name=__codelineno-9-22 href=#__codelineno-9-22></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"REQUIRED"</span>
</span><span id=__span-9-23><a id=__codelineno-9-23 name=__codelineno-9-23 href=#__codelineno-9-23></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-9-24><a id=__codelineno-9-24 name=__codelineno-9-24 href=#__codelineno-9-24></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-25><a id=__codelineno-9-25 name=__codelineno-9-25 href=#__codelineno-9-25></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"post_score"</span><span class=p>,</span>
</span><span id=__span-9-26><a id=__codelineno-9-26 name=__codelineno-9-26 href=#__codelineno-9-26></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"INTEGER"</span><span class=p>,</span>
</span><span id=__span-9-27><a id=__codelineno-9-27 name=__codelineno-9-27 href=#__codelineno-9-27></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"NULLABLE"</span>
</span><span id=__span-9-28><a id=__codelineno-9-28 name=__codelineno-9-28 href=#__codelineno-9-28></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-9-29><a id=__codelineno-9-29 name=__codelineno-9-29 href=#__codelineno-9-29></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-30><a id=__codelineno-9-30 name=__codelineno-9-30 href=#__codelineno-9-30></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"post_url"</span><span class=p>,</span>
</span><span id=__span-9-31><a id=__codelineno-9-31 name=__codelineno-9-31 href=#__codelineno-9-31></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"STRING"</span><span class=p>,</span>
</span><span id=__span-9-32><a id=__codelineno-9-32 name=__codelineno-9-32 href=#__codelineno-9-32></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"NULLABLE"</span>
</span><span id=__span-9-33><a id=__codelineno-9-33 name=__codelineno-9-33 href=#__codelineno-9-33></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-9-34><a id=__codelineno-9-34 name=__codelineno-9-34 href=#__codelineno-9-34></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-35><a id=__codelineno-9-35 name=__codelineno-9-35 href=#__codelineno-9-35></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"comment_id"</span><span class=p>,</span>
</span><span id=__span-9-36><a id=__codelineno-9-36 name=__codelineno-9-36 href=#__codelineno-9-36></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"STRING"</span><span class=p>,</span>
</span><span id=__span-9-37><a id=__codelineno-9-37 name=__codelineno-9-37 href=#__codelineno-9-37></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"NULLABLE"</span>
</span><span id=__span-9-38><a id=__codelineno-9-38 name=__codelineno-9-38 href=#__codelineno-9-38></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-9-39><a id=__codelineno-9-39 name=__codelineno-9-39 href=#__codelineno-9-39></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-40><a id=__codelineno-9-40 name=__codelineno-9-40 href=#__codelineno-9-40></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"summary_date"</span><span class=p>,</span>
</span><span id=__span-9-41><a id=__codelineno-9-41 name=__codelineno-9-41 href=#__codelineno-9-41></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"DATE"</span><span class=p>,</span>
</span><span id=__span-9-42><a id=__codelineno-9-42 name=__codelineno-9-42 href=#__codelineno-9-42></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"REQUIRED"</span>
</span><span id=__span-9-43><a id=__codelineno-9-43 name=__codelineno-9-43 href=#__codelineno-9-43></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-9-44><a id=__codelineno-9-44 name=__codelineno-9-44 href=#__codelineno-9-44></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-45><a id=__codelineno-9-45 name=__codelineno-9-45 href=#__codelineno-9-45></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"processed_date"</span><span class=p>,</span>
</span><span id=__span-9-46><a id=__codelineno-9-46 name=__codelineno-9-46 href=#__codelineno-9-46></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"TIMESTAMP"</span><span class=p>,</span>
</span><span id=__span-9-47><a id=__codelineno-9-47 name=__codelineno-9-47 href=#__codelineno-9-47></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"REQUIRED"</span>
</span><span id=__span-9-48><a id=__codelineno-9-48 name=__codelineno-9-48 href=#__codelineno-9-48></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-9-49><a id=__codelineno-9-49 name=__codelineno-9-49 href=#__codelineno-9-49></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-50><a id=__codelineno-9-50 name=__codelineno-9-50 href=#__codelineno-9-50></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"needs_processing"</span><span class=p>,</span>
</span><span id=__span-9-51><a id=__codelineno-9-51 name=__codelineno-9-51 href=#__codelineno-9-51></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"BOOLEAN"</span><span class=p>,</span>
</span><span id=__span-9-52><a id=__codelineno-9-52 name=__codelineno-9-52 href=#__codelineno-9-52></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"REQUIRED"</span>
</span><span id=__span-9-53><a id=__codelineno-9-53 name=__codelineno-9-53 href=#__codelineno-9-53></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-9-54><a id=__codelineno-9-54 name=__codelineno-9-54 href=#__codelineno-9-54></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-55><a id=__codelineno-9-55 name=__codelineno-9-55 href=#__codelineno-9-55></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"post_content"</span><span class=p>,</span>
</span><span id=__span-9-56><a id=__codelineno-9-56 name=__codelineno-9-56 href=#__codelineno-9-56></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"STRING"</span><span class=p>,</span>
</span><span id=__span-9-57><a id=__codelineno-9-57 name=__codelineno-9-57 href=#__codelineno-9-57></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"NULLABLE"</span>
</span><span id=__span-9-58><a id=__codelineno-9-58 name=__codelineno-9-58 href=#__codelineno-9-58></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-9-59><a id=__codelineno-9-59 name=__codelineno-9-59 href=#__codelineno-9-59></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-9-60><a id=__codelineno-9-60 name=__codelineno-9-60 href=#__codelineno-9-60></a><span class=w>      </span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"comment_body"</span><span class=p>,</span>
</span><span id=__span-9-61><a id=__codelineno-9-61 name=__codelineno-9-61 href=#__codelineno-9-61></a><span class=w>      </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"STRING"</span><span class=p>,</span>
</span><span id=__span-9-62><a id=__codelineno-9-62 name=__codelineno-9-62 href=#__codelineno-9-62></a><span class=w>      </span><span class=na>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"NULLABLE"</span>
</span><span id=__span-9-63><a id=__codelineno-9-63 name=__codelineno-9-63 href=#__codelineno-9-63></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-9-64><a id=__codelineno-9-64 name=__codelineno-9-64 href=#__codelineno-9-64></a><span class=w>  </span><span class=p>])</span>
</span><span id=__span-9-65><a id=__codelineno-9-65 name=__codelineno-9-65 href=#__codelineno-9-65></a><span class=p>}</span>
</span></code></pre></div> <h4 id=dbt>dbt<a class=headerlink href=#dbt title="Permanent link">¶</a></h4> <h5 id=dbt-data-transformations>DBT Data Transformations<a class=headerlink href=#dbt-data-transformations title="Permanent link">¶</a></h5> <p>Our data transformations are managed using dbt, which allows us to structure our project with specific models for each stage of processing. This approach provides a clear, modular, and maintainable data pipeline.</p> <p></p><div class="language-yaml highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=c1># dbt_project.yml configuration</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>'dbt_reddit_summary_cloud'</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s>'1.0.0'</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=nt>models</span><span class=p>:</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=w>  </span><span class=nt>dbt_reddit_summary_local</span><span class=p>:</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=w>    </span><span class=nt>+materialized</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">table</span><span class=w>  </span><span class=c1># Default materialization</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=w>    </span><span class=nt>current_summary_staging</span><span class=p>:</span>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a><span class=w>      </span><span class=nt>+materialized</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">view</span><span class=w>  </span><span class=c1># Staging view</span>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=w>    </span><span class=nt>joined_summary_analysis</span><span class=p>:</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a><span class=w>      </span><span class=nt>+materialized</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">table</span><span class=w>  </span><span class=c1># Final analysis</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a><span class=w>    </span><span class=nt>update_processing_status</span><span class=p>:</span>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a><span class=w>      </span><span class=nt>+materialized</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">incremental</span>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a><span class=nt>vars</span><span class=p>:</span>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a><span class=w>  </span><span class=nt>subreddits</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>'dataengineering'</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>'datascience'</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>'machinelearning'</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>'claudeai'</span><span class="p p-Indicator">,</span>
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a><span class=w>   </span><span class=s>'singularity'</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>'localllama'</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>'openai'</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>'stablediffusion'</span><span class="p p-Indicator">]</span>
</span></code></pre></div> This dbt project configuration includes a default table materialization, a staging view for intermediate data, a final analysis table, and an incremental model for updating processing status. Additionally, we define a list of subreddits that are processed by our pipeline.<p></p> <p>The DBT workflow includes three main transformation models:</p> <ol> <li> <p><strong>Staging Model</strong> (<code>current_summary_staging</code>): </p><div class="language-sql highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=err>{{</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=w>    </span><span class=n>config</span><span class=p>(</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=w>        </span><span class=n>materialized</span><span class=o>=</span><span class=s1>'view'</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=w>    </span><span class=p>)</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=err>}}</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=k>SELECT</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=w>    </span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=w>    </span><span class=n>subreddit</span><span class=p>,</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a><span class=w>    </span><span class=n>post_id</span><span class=p>,</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=w>    </span><span class=n>post_score</span><span class=p>,</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=w>    </span><span class=n>post_url</span><span class=p>,</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=w>    </span><span class=n>comment_id</span><span class=p>,</span>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a><span class=w>    </span><span class=n>summary_date</span><span class=p>,</span>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a><span class=w>    </span><span class=n>processed_date</span><span class=p>,</span>
</span><span id=__span-11-16><a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a><span class=w>    </span><span class=n>post_content</span><span class=p>,</span>
</span><span id=__span-11-17><a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a><span class=w>    </span><span class=n>comment_body</span>
</span><span id=__span-11-18><a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a><span class=k>FROM</span><span class=w> </span><span class=err>{{</span><span class=w> </span><span class=k>source</span><span class=p>(</span><span class=s1>'summary_analytics'</span><span class=p>,</span><span class=w> </span><span class=s1>'daily_summary_data'</span><span class=p>)</span><span class=w> </span><span class=err>}}</span><span class=w> </span><span class=n>ds</span>
</span><span id=__span-11-19><a id=__codelineno-11-19 name=__codelineno-11-19 href=#__codelineno-11-19></a><span class=k>WHERE</span><span class=w> </span><span class=n>comment_body</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span>
</span><span id=__span-11-20><a id=__codelineno-11-20 name=__codelineno-11-20 href=#__codelineno-11-20></a><span class=w>    </span><span class=k>AND</span><span class=w> </span><span class=n>needs_processing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>TRUE</span>
</span></code></pre></div> The current_summary_staging model is a view that selects key fields from the daily summary data, filtering out rows with null comment bodies and those that do not need processing. This view is materialized as a view for real-time filtering.<p></p> </li> <li> <p><strong>Analysis Model</strong> (<code>joined_summary_analysis</code>): </p><div class="language-sql highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=err>{{</span><span class=w> </span><span class=n>config</span><span class=p>(</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=w>    </span><span class=n>materialized</span><span class=o>=</span><span class=s1>'table'</span><span class=p>,</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=w>    </span><span class=n>unique_key</span><span class=o>=</span><span class=s1>'comment_id'</span><span class=p>,</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=p>)</span><span class=w> </span><span class=err>}}</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=k>WITH</span><span class=w> </span><span class=n>validation_cte</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=w>        </span><span class=n>cs</span><span class=p>.</span><span class=o>*</span><span class=p>,</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a><span class=w>        </span><span class=n>ts</span><span class=p>.</span><span class=n>comment_summary</span><span class=p>,</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a><span class=w>        </span><span class=n>sa</span><span class=p>.</span><span class=n>sentiment_score</span><span class=p>,</span>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a><span class=w>        </span><span class=n>sa</span><span class=p>.</span><span class=n>sentiment_label</span><span class=p>,</span>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a><span class=w>        </span><span class=k>CASE</span><span class=w> </span>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a><span class=w>            </span><span class=k>WHEN</span><span class=w> </span><span class=k>LENGTH</span><span class=p>(</span><span class=n>cs</span><span class=p>.</span><span class=n>comment_body</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>'Too short'</span>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a><span class=w>            </span><span class=k>WHEN</span><span class=w> </span><span class=k>LENGTH</span><span class=p>(</span><span class=n>cs</span><span class=p>.</span><span class=n>comment_body</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>10000</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>'Too long'</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a><span class=w>            </span><span class=k>ELSE</span><span class=w> </span><span class=s1>'Valid'</span>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a><span class=w>        </span><span class=k>END</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>comment_quality</span><span class=p>,</span>
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17 href=#__codelineno-12-17></a><span class=w>        </span><span class=k>CASE</span><span class=w> </span>
</span><span id=__span-12-18><a id=__codelineno-12-18 name=__codelineno-12-18 href=#__codelineno-12-18></a><span class=w>            </span><span class=k>WHEN</span><span class=w> </span><span class=n>ts</span><span class=p>.</span><span class=n>comment_summary</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=k>TRIM</span><span class=p>(</span><span class=n>ts</span><span class=p>.</span><span class=n>comment_summary</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>''</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>'Missing'</span>
</span><span id=__span-12-19><a id=__codelineno-12-19 name=__codelineno-12-19 href=#__codelineno-12-19></a><span class=w>            </span><span class=k>WHEN</span><span class=w> </span><span class=k>LENGTH</span><span class=p>(</span><span class=n>ts</span><span class=p>.</span><span class=n>comment_summary</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>LENGTH</span><span class=p>(</span><span class=n>cs</span><span class=p>.</span><span class=n>comment_body</span><span class=p>)</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>'Invalid'</span>
</span><span id=__span-12-20><a id=__codelineno-12-20 name=__codelineno-12-20 href=#__codelineno-12-20></a><span class=w>            </span><span class=k>ELSE</span><span class=w> </span><span class=s1>'Valid'</span>
</span><span id=__span-12-21><a id=__codelineno-12-21 name=__codelineno-12-21 href=#__codelineno-12-21></a><span class=w>        </span><span class=k>END</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>summary_quality</span>
</span><span id=__span-12-22><a id=__codelineno-12-22 name=__codelineno-12-22 href=#__codelineno-12-22></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=err>{{</span><span class=w> </span><span class=k>source</span><span class=p>(</span><span class=s1>'summary_analytics'</span><span class=p>,</span><span class=w> </span><span class=s1>'current_summary_staging'</span><span class=p>)</span><span class=w> </span><span class=err>}}</span><span class=w> </span><span class=n>cs</span>
</span><span id=__span-12-23><a id=__codelineno-12-23 name=__codelineno-12-23 href=#__codelineno-12-23></a><span class=w>    </span><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=err>{{</span><span class=w> </span><span class=k>source</span><span class=p>(</span><span class=s1>'summary_analytics'</span><span class=p>,</span><span class=w> </span><span class=s1>'text_summary_results'</span><span class=p>)</span><span class=w> </span><span class=err>}}</span><span class=w> </span><span class=n>ts</span><span class=w> </span>
</span><span id=__span-12-24><a id=__codelineno-12-24 name=__codelineno-12-24 href=#__codelineno-12-24></a><span class=w>        </span><span class=k>ON</span><span class=w> </span><span class=n>cs</span><span class=p>.</span><span class=n>comment_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ts</span><span class=p>.</span><span class=n>comment_id</span>
</span><span id=__span-12-25><a id=__codelineno-12-25 name=__codelineno-12-25 href=#__codelineno-12-25></a><span class=w>    </span><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=err>{{</span><span class=w> </span><span class=k>source</span><span class=p>(</span><span class=s1>'summary_analytics'</span><span class=p>,</span><span class=w> </span><span class=s1>'sentiment_analysis_results'</span><span class=p>)</span><span class=w> </span><span class=err>}}</span><span class=w> </span><span class=n>sa</span><span class=w> </span>
</span><span id=__span-12-26><a id=__codelineno-12-26 name=__codelineno-12-26 href=#__codelineno-12-26></a><span class=w>        </span><span class=k>ON</span><span class=w> </span><span class=n>cs</span><span class=p>.</span><span class=n>comment_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sa</span><span class=p>.</span><span class=n>comment_id</span>
</span><span id=__span-12-27><a id=__codelineno-12-27 name=__codelineno-12-27 href=#__codelineno-12-27></a><span class=p>)</span>
</span><span id=__span-12-28><a id=__codelineno-12-28 name=__codelineno-12-28 href=#__codelineno-12-28></a>
</span><span id=__span-12-29><a id=__codelineno-12-29 name=__codelineno-12-29 href=#__codelineno-12-29></a><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-12-30><a id=__codelineno-12-30 name=__codelineno-12-30 href=#__codelineno-12-30></a><span class=w>    </span><span class=o>*</span><span class=p>,</span>
</span><span id=__span-12-31><a id=__codelineno-12-31 name=__codelineno-12-31 href=#__codelineno-12-31></a><span class=w>    </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>processed_at</span><span class=p>,</span>
</span><span id=__span-12-32><a id=__codelineno-12-32 name=__codelineno-12-32 href=#__codelineno-12-32></a><span class=w>    </span><span class=s1>'dbt'</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>processed_by</span>
</span><span id=__span-12-33><a id=__codelineno-12-33 name=__codelineno-12-33 href=#__codelineno-12-33></a><span class=k>FROM</span><span class=w> </span><span class=n>validation_cte</span>
</span><span id=__span-12-34><a id=__codelineno-12-34 name=__codelineno-12-34 href=#__codelineno-12-34></a><span class=k>WHERE</span><span class=w> </span><span class=n>comment_quality</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>'Valid'</span><span class=w> </span>
</span><span id=__span-12-35><a id=__codelineno-12-35 name=__codelineno-12-35 href=#__codelineno-12-35></a><span class=w>  </span><span class=k>AND</span><span class=w> </span><span class=n>summary_quality</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>'Valid'</span>
</span></code></pre></div> The joined_summary_analysis model joins the staging data with text summary and sentiment analysis results. It then validates the quality of comments and summaries, selecting only valid rows for further analysis. This model also adds processing metadata.<p></p> </li> <li> <p><strong>Processing Status Model</strong> (<code>update_processing_status</code>): </p><div class="language-sql highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=err>{{</span><span class=w> </span><span class=n>config</span><span class=p>(</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=w>    </span><span class=n>materialized</span><span class=o>=</span><span class=s1>'incremental'</span><span class=p>,</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=w>    </span><span class=n>unique_key</span><span class=o>=</span><span class=p>[</span><span class=s1>'comment_id'</span><span class=p>,</span><span class=w> </span><span class=s1>'post_id'</span><span class=p>],</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=w>    </span><span class=n>post_hook</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=w>        </span><span class=ss>"""</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=ss>        UPDATE {{ source('summary_analytics', 'daily_summary_data') }}</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=ss>        SET needs_processing = FALSE</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=ss>        WHERE comment_id IN (</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=ss>            SELECT comment_id </span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=ss>            FROM {{ this }}</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a><span class=ss>        );</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a><span class=ss>        """</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a><span class=w>    </span><span class=p>]</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a><span class=p>)</span><span class=w> </span><span class=err>}}</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a><span class=c1>-- Select all records that were attempted to be processed, including failed validations</span>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a><span class=k>WITH</span><span class=w> </span><span class=n>validation_cte</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-13-19><a id=__codelineno-13-19 name=__codelineno-13-19 href=#__codelineno-13-19></a><span class=w>        </span><span class=n>comment_id</span><span class=p>,</span>
</span><span id=__span-13-20><a id=__codelineno-13-20 name=__codelineno-13-20 href=#__codelineno-13-20></a><span class=w>        </span><span class=n>comment_body</span><span class=p>,</span>
</span><span id=__span-13-21><a id=__codelineno-13-21 name=__codelineno-13-21 href=#__codelineno-13-21></a><span class=w>        </span><span class=n>post_id</span>
</span><span id=__span-13-22><a id=__codelineno-13-22 name=__codelineno-13-22 href=#__codelineno-13-22></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=err>{{</span><span class=w> </span><span class=k>source</span><span class=p>(</span><span class=s1>'summary_analytics'</span><span class=p>,</span><span class=w> </span><span class=s1>'current_summary_staging'</span><span class=p>)</span><span class=w> </span><span class=err>}}</span>
</span><span id=__span-13-23><a id=__codelineno-13-23 name=__codelineno-13-23 href=#__codelineno-13-23></a><span class=p>),</span>
</span><span id=__span-13-24><a id=__codelineno-13-24 name=__codelineno-13-24 href=#__codelineno-13-24></a><span class=n>all_processed_records</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-13-25><a id=__codelineno-13-25 name=__codelineno-13-25 href=#__codelineno-13-25></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-13-26><a id=__codelineno-13-26 name=__codelineno-13-26 href=#__codelineno-13-26></a><span class=w>        </span><span class=n>cs</span><span class=p>.</span><span class=n>comment_id</span><span class=p>,</span>
</span><span id=__span-13-27><a id=__codelineno-13-27 name=__codelineno-13-27 href=#__codelineno-13-27></a><span class=w>        </span><span class=n>cs</span><span class=p>.</span><span class=n>post_id</span><span class=p>,</span>
</span><span id=__span-13-28><a id=__codelineno-13-28 name=__codelineno-13-28 href=#__codelineno-13-28></a><span class=w>        </span><span class=n>v</span><span class=p>.</span><span class=n>comment_quality</span>
</span><span id=__span-13-29><a id=__codelineno-13-29 name=__codelineno-13-29 href=#__codelineno-13-29></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=err>{{</span><span class=w> </span><span class=k>source</span><span class=p>(</span><span class=s1>'summary_analytics'</span><span class=p>,</span><span class=w> </span><span class=s1>'current_summary_staging'</span><span class=p>)</span><span class=w> </span><span class=err>}}</span><span class=w> </span><span class=n>cs</span>
</span><span id=__span-13-30><a id=__codelineno-13-30 name=__codelineno-13-30 href=#__codelineno-13-30></a><span class=w>    </span><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-13-31><a id=__codelineno-13-31 name=__codelineno-13-31 href=#__codelineno-13-31></a><span class=w>        </span><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-13-32><a id=__codelineno-13-32 name=__codelineno-13-32 href=#__codelineno-13-32></a><span class=w>            </span><span class=n>comment_id</span><span class=p>,</span>
</span><span id=__span-13-33><a id=__codelineno-13-33 name=__codelineno-13-33 href=#__codelineno-13-33></a><span class=w>            </span><span class=k>CASE</span><span class=w> </span>
</span><span id=__span-13-34><a id=__codelineno-13-34 name=__codelineno-13-34 href=#__codelineno-13-34></a><span class=w>                </span><span class=k>WHEN</span><span class=w> </span><span class=k>LENGTH</span><span class=p>(</span><span class=n>comment_body</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>'Too short'</span>
</span><span id=__span-13-35><a id=__codelineno-13-35 name=__codelineno-13-35 href=#__codelineno-13-35></a><span class=w>                </span><span class=k>WHEN</span><span class=w> </span><span class=k>LENGTH</span><span class=p>(</span><span class=n>comment_body</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>10000</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>'Too long'</span>
</span><span id=__span-13-36><a id=__codelineno-13-36 name=__codelineno-13-36 href=#__codelineno-13-36></a><span class=w>                </span><span class=k>ELSE</span><span class=w> </span><span class=s1>'Valid'</span>
</span><span id=__span-13-37><a id=__codelineno-13-37 name=__codelineno-13-37 href=#__codelineno-13-37></a><span class=w>            </span><span class=k>END</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>comment_quality</span>
</span><span id=__span-13-38><a id=__codelineno-13-38 name=__codelineno-13-38 href=#__codelineno-13-38></a><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>validation_cte</span>
</span><span id=__span-13-39><a id=__codelineno-13-39 name=__codelineno-13-39 href=#__codelineno-13-39></a><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>cs</span><span class=p>.</span><span class=n>comment_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=n>comment_id</span>
</span><span id=__span-13-40><a id=__codelineno-13-40 name=__codelineno-13-40 href=#__codelineno-13-40></a><span class=p>)</span>
</span><span id=__span-13-41><a id=__codelineno-13-41 name=__codelineno-13-41 href=#__codelineno-13-41></a>
</span><span id=__span-13-42><a id=__codelineno-13-42 name=__codelineno-13-42 href=#__codelineno-13-42></a><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-13-43><a id=__codelineno-13-43 name=__codelineno-13-43 href=#__codelineno-13-43></a><span class=w>    </span><span class=n>comment_id</span><span class=p>,</span>
</span><span id=__span-13-44><a id=__codelineno-13-44 name=__codelineno-13-44 href=#__codelineno-13-44></a><span class=w>    </span><span class=n>post_id</span>
</span><span id=__span-13-45><a id=__codelineno-13-45 name=__codelineno-13-45 href=#__codelineno-13-45></a><span class=k>FROM</span><span class=w> </span><span class=n>all_processed_records</span>
</span></code></pre></div> The update_processing_status model is an incremental model that updates the processing status of comments. It selects all records that were attempted to be processed, including those that failed validation, and uses a post-hook to mark them as processed in the source table. This ensures that comments are not reprocessed.<p></p> </li> </ol> <h5 id=dbt-data-quality-tests>DBT Data Quality Tests<a class=headerlink href=#dbt-data-quality-tests title="Permanent link">¶</a></h5> <p>Our project implements comprehensive data quality tests using DBT's testing framework. These tests are defined in our <code>schema.yml</code>:</p> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=nt>sources</span><span class=p>:</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">raw_data</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=w>    </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">raw_data</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=w>    </span><span class=nt>tables</span><span class=p>:</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">raw_dataengineering</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=w>        </span><span class=nt>columns</span><span class=p>:</span><span class=w> </span><span class=nl>&amp;raw_columns</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=w>          </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">post_id</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=w>            </span><span class=nt>tests</span><span class=p>:</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=w>              </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">not_null</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a><span class=w>              </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">unique</span>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=w>              </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">is_text</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=w>          </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">subreddit</span>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a><span class=w>            </span><span class=nt>tests</span><span class=p>:</span>
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a><span class=w>              </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">not_null</span>
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a><span class=w>              </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">is_text</span>
</span><span id=__span-14-18><a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a><span class=w>              </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>accepted_values</span><span class=p>:</span>
</span><span id=__span-14-19><a id=__codelineno-14-19 name=__codelineno-14-19 href=#__codelineno-14-19></a><span class=w>                  </span><span class=nt>values</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>"dataengineering"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"datascience"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"machinelearning"</span><span class="p p-Indicator">,</span><span class=w> </span>
</span><span id=__span-14-20><a id=__codelineno-14-20 name=__codelineno-14-20 href=#__codelineno-14-20></a><span class=w>                          </span><span class=s>"claudeai"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"singularity"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"localllama"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"openai"</span><span class="p p-Indicator">,</span><span class=w> </span>
</span><span id=__span-14-21><a id=__codelineno-14-21 name=__codelineno-14-21 href=#__codelineno-14-21></a><span class=w>                          </span><span class=s>"stablediffusion"</span><span class="p p-Indicator">]</span>
</span><span id=__span-14-22><a id=__codelineno-14-22 name=__codelineno-14-22 href=#__codelineno-14-22></a><span class=w>          </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">score</span>
</span><span id=__span-14-23><a id=__codelineno-14-23 name=__codelineno-14-23 href=#__codelineno-14-23></a><span class=w>            </span><span class=nt>tests</span><span class=p>:</span>
</span><span id=__span-14-24><a id=__codelineno-14-24 name=__codelineno-14-24 href=#__codelineno-14-24></a><span class=w>              </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">not_null</span>
</span><span id=__span-14-25><a id=__codelineno-14-25 name=__codelineno-14-25 href=#__codelineno-14-25></a><span class=w>              </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">is_int</span>
</span><span id=__span-14-26><a id=__codelineno-14-26 name=__codelineno-14-26 href=#__codelineno-14-26></a><span class=w>              </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>dbt_utils.expression_is_true</span><span class=p>:</span>
</span><span id=__span-14-27><a id=__codelineno-14-27 name=__codelineno-14-27 href=#__codelineno-14-27></a><span class=w>                  </span><span class=nt>expression</span><span class=p>:</span><span class=w> </span><span class=s>"{{</span><span class=nv> </span><span class=s>column_name</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>&gt;=</span><span class=nv> </span><span class=s>0"</span>
</span><span id=__span-14-28><a id=__codelineno-14-28 name=__codelineno-14-28 href=#__codelineno-14-28></a><span class=w>          </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">comments</span>
</span><span id=__span-14-29><a id=__codelineno-14-29 name=__codelineno-14-29 href=#__codelineno-14-29></a><span class=w>            </span><span class=nt>tests</span><span class=p>:</span>
</span><span id=__span-14-30><a id=__codelineno-14-30 name=__codelineno-14-30 href=#__codelineno-14-30></a><span class=w>              </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">not_null</span>
</span><span id=__span-14-31><a id=__codelineno-14-31 name=__codelineno-14-31 href=#__codelineno-14-31></a><span class=w>              </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">is_json</span>
</span></code></pre></div> <p>Our testing strategy includes generic tests for data presence and type validation, custom tests for specific data structures and rules, relationship tests for data integrity, and data quality metrics to monitor data health. These tests are integrated into our CI/CD pipeline for early detection of issues.</p> <h4 id=text-processing-pipeline>Text Processing Pipeline<a class=headerlink href=#text-processing-pipeline title="Permanent link">¶</a></h4> <p>Our cleaned data is analyzed using transformer models for text summarization and sentiment analysis, with MLflow for experiment tracking.</p> <h5 id=1-text-summarization>1. Text Summarization<a class=headerlink href=#1-text-summarization title="Permanent link">¶</a></h5> <p>We use a fine-tuned BART model for generating concise summaries of Reddit comments:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=k>def</span><span class=w> </span><span class=nf>create_summarizer</span><span class=p>():</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=w>    </span><span class=sd>"""Initialize the summarization model."""</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>    <span class=n>model_name</span> <span class=o>=</span> <span class=s2>"philschmid/bart-large-cnn-samsum"</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a>    <span class=n>local_model_path</span> <span class=o>=</span> <span class=s2>"/models/models--philschmid--bart-large-cnn-samsum/snapshots/e49b3d60d923f12db22bdd363356f1a4c68532ad"</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a>    <span class=n>tokenizer</span> <span class=o>=</span> <span class=n>AutoTokenizer</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>local_model_path</span><span class=p>)</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a>    <span class=n>model</span> <span class=o>=</span> <span class=n>AutoModelForSeq2SeqLM</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a>        <span class=n>local_model_path</span><span class=p>,</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a>        <span class=n>torch_dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>float32</span><span class=p>,</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a>        <span class=n>device_map</span><span class=o>=</span><span class=s2>"auto"</span><span class=p>,</span>
</span><span id=__span-15-11><a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a>        <span class=n>low_cpu_mem_usage</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-15-12><a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a>    <span class=p>)</span>
</span><span id=__span-15-13><a id=__codelineno-15-13 name=__codelineno-15-13 href=#__codelineno-15-13></a>
</span><span id=__span-15-14><a id=__codelineno-15-14 name=__codelineno-15-14 href=#__codelineno-15-14></a>    <span class=k>return</span> <span class=n>pipeline</span><span class=p>(</span>
</span><span id=__span-15-15><a id=__codelineno-15-15 name=__codelineno-15-15 href=#__codelineno-15-15></a>        <span class=s2>"summarization"</span><span class=p>,</span>
</span><span id=__span-15-16><a id=__codelineno-15-16 name=__codelineno-15-16 href=#__codelineno-15-16></a>        <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span>
</span><span id=__span-15-17><a id=__codelineno-15-17 name=__codelineno-15-17 href=#__codelineno-15-17></a>        <span class=n>tokenizer</span><span class=o>=</span><span class=n>tokenizer</span><span class=p>,</span>
</span><span id=__span-15-18><a id=__codelineno-15-18 name=__codelineno-15-18 href=#__codelineno-15-18></a>        <span class=n>framework</span><span class=o>=</span><span class=s2>"pt"</span>
</span><span id=__span-15-19><a id=__codelineno-15-19 name=__codelineno-15-19 href=#__codelineno-15-19></a>    <span class=p>)</span>
</span><span id=__span-15-20><a id=__codelineno-15-20 name=__codelineno-15-20 href=#__codelineno-15-20></a>
</span><span id=__span-15-21><a id=__codelineno-15-21 name=__codelineno-15-21 href=#__codelineno-15-21></a><span class=k>def</span><span class=w> </span><span class=nf>generate_summary</span><span class=p>(</span><span class=n>comment_body</span><span class=p>,</span> <span class=n>summarizer</span><span class=p>):</span>
</span><span id=__span-15-22><a id=__codelineno-15-22 name=__codelineno-15-22 href=#__codelineno-15-22></a><span class=w>    </span><span class=sd>"""Generate summary for a given comment."""</span>
</span><span id=__span-15-23><a id=__codelineno-15-23 name=__codelineno-15-23 href=#__codelineno-15-23></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>comment_body</span><span class=o>.</span><span class=n>split</span><span class=p>())</span> <span class=o>&lt;=</span> <span class=mi>59</span><span class=p>:</span>
</span><span id=__span-15-24><a id=__codelineno-15-24 name=__codelineno-15-24 href=#__codelineno-15-24></a>        <span class=k>return</span> <span class=n>comment_body</span> 
</span><span id=__span-15-25><a id=__codelineno-15-25 name=__codelineno-15-25 href=#__codelineno-15-25></a>
</span><span id=__span-15-26><a id=__codelineno-15-26 name=__codelineno-15-26 href=#__codelineno-15-26></a>    <span class=k>try</span><span class=p>:</span>
</span><span id=__span-15-27><a id=__codelineno-15-27 name=__codelineno-15-27 href=#__codelineno-15-27></a>        <span class=n>summary</span> <span class=o>=</span> <span class=n>summarizer</span><span class=p>(</span>
</span><span id=__span-15-28><a id=__codelineno-15-28 name=__codelineno-15-28 href=#__codelineno-15-28></a>            <span class=n>comment_body</span><span class=p>,</span> 
</span><span id=__span-15-29><a id=__codelineno-15-29 name=__codelineno-15-29 href=#__codelineno-15-29></a>            <span class=n>max_length</span><span class=o>=</span><span class=mi>60</span><span class=p>,</span> 
</span><span id=__span-15-30><a id=__codelineno-15-30 name=__codelineno-15-30 href=#__codelineno-15-30></a>            <span class=n>min_length</span><span class=o>=</span><span class=mi>15</span><span class=p>,</span> 
</span><span id=__span-15-31><a id=__codelineno-15-31 name=__codelineno-15-31 href=#__codelineno-15-31></a>            <span class=n>do_sample</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> 
</span><span id=__span-15-32><a id=__codelineno-15-32 name=__codelineno-15-32 href=#__codelineno-15-32></a>            <span class=n>truncation</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-15-33><a id=__codelineno-15-33 name=__codelineno-15-33 href=#__codelineno-15-33></a>        <span class=p>)</span>
</span><span id=__span-15-34><a id=__codelineno-15-34 name=__codelineno-15-34 href=#__codelineno-15-34></a>        <span class=k>if</span> <span class=n>summary</span> <span class=ow>and</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>summary</span><span class=p>,</span> <span class=nb>list</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>summary</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-15-35><a id=__codelineno-15-35 name=__codelineno-15-35 href=#__codelineno-15-35></a>            <span class=k>return</span> <span class=n>summary</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=s1>'summary_text'</span><span class=p>]</span>
</span><span id=__span-15-36><a id=__codelineno-15-36 name=__codelineno-15-36 href=#__codelineno-15-36></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-15-37><a id=__codelineno-15-37 name=__codelineno-15-37 href=#__codelineno-15-37></a>        <span class=n>logging</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Summarization failed: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-15-38><a id=__codelineno-15-38 name=__codelineno-15-38 href=#__codelineno-15-38></a>
</span><span id=__span-15-39><a id=__codelineno-15-39 name=__codelineno-15-39 href=#__codelineno-15-39></a>    <span class=k>return</span> <span class=s2>""</span>
</span></code></pre></div> <p>We use a fine-tuned BART-large model for dialogue summarization, which outperforms the standard model on Reddit comments. It's optimized for local machine use with efficient memory management.</p> <h5 id=2-sentiment-analysis>2. Sentiment Analysis<a class=headerlink href=#2-sentiment-analysis title="Permanent link">¶</a></h5> <p>We employ a RoBERTa-based model fine-tuned for emotion detection:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=k>def</span><span class=w> </span><span class=nf>initialize_emotion_analyzer</span><span class=p>():</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=w>    </span><span class=sd>"""Initialize the emotion analysis model."""</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a>    <span class=n>model_name</span> <span class=o>=</span> <span class=s2>"SamLowe/roberta-base-go_emotions"</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a>    <span class=n>local_model_path</span> <span class=o>=</span> <span class=s2>"/models/models--SamLowe--roberta-base-go_emotions/snapshots/58b6c5b44a7a12093f782442969019c7e2982299"</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a>    <span class=n>model</span> <span class=o>=</span> <span class=n>AutoModelForSequenceClassification</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>local_model_path</span><span class=p>)</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a>    <span class=n>tokenizer</span> <span class=o>=</span> <span class=n>AutoTokenizer</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>local_model_path</span><span class=p>)</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a>    <span class=k>return</span> <span class=n>pipeline</span><span class=p>(</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a>        <span class=s2>"text-classification"</span><span class=p>,</span>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a>        <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span>
</span><span id=__span-16-12><a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a>        <span class=n>tokenizer</span><span class=o>=</span><span class=n>tokenizer</span>
</span><span id=__span-16-13><a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a>    <span class=p>)</span>
</span><span id=__span-16-14><a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a>
</span><span id=__span-16-15><a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a><span class=k>def</span><span class=w> </span><span class=nf>perform_sentiment_analysis</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>emotion_analyzer</span><span class=p>):</span>
</span><span id=__span-16-16><a id=__codelineno-16-16 name=__codelineno-16-16 href=#__codelineno-16-16></a><span class=w>    </span><span class=sd>"""Perform sentiment analysis on the given text."""</span>
</span><span id=__span-16-17><a id=__codelineno-16-17 name=__codelineno-16-17 href=#__codelineno-16-17></a>    <span class=k>try</span><span class=p>:</span>
</span><span id=__span-16-18><a id=__codelineno-16-18 name=__codelineno-16-18 href=#__codelineno-16-18></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>text</span> <span class=ow>or</span> <span class=n>text</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span> <span class=o>==</span> <span class=s2>""</span><span class=p>:</span>
</span><span id=__span-16-19><a id=__codelineno-16-19 name=__codelineno-16-19 href=#__codelineno-16-19></a>            <span class=k>return</span> <span class=s2>"Neutral"</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=s2>"No content"</span>
</span><span id=__span-16-20><a id=__codelineno-16-20 name=__codelineno-16-20 href=#__codelineno-16-20></a>
</span><span id=__span-16-21><a id=__codelineno-16-21 name=__codelineno-16-21 href=#__codelineno-16-21></a>        <span class=n>truncated_text</span> <span class=o>=</span> <span class=n>truncate_text</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=mi>500</span><span class=p>)</span>
</span><span id=__span-16-22><a id=__codelineno-16-22 name=__codelineno-16-22 href=#__codelineno-16-22></a>        <span class=n>emotion_output</span> <span class=o>=</span> <span class=n>emotion_analyzer</span><span class=p>(</span><span class=n>truncated_text</span><span class=p>)</span>
</span><span id=__span-16-23><a id=__codelineno-16-23 name=__codelineno-16-23 href=#__codelineno-16-23></a>
</span><span id=__span-16-24><a id=__codelineno-16-24 name=__codelineno-16-24 href=#__codelineno-16-24></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>emotion_output</span><span class=p>:</span>
</span><span id=__span-16-25><a id=__codelineno-16-25 name=__codelineno-16-25 href=#__codelineno-16-25></a>            <span class=k>return</span> <span class=s2>"Neutral"</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=s2>"Analysis failed"</span>
</span><span id=__span-16-26><a id=__codelineno-16-26 name=__codelineno-16-26 href=#__codelineno-16-26></a>
</span><span id=__span-16-27><a id=__codelineno-16-27 name=__codelineno-16-27 href=#__codelineno-16-27></a>        <span class=n>emotion_label</span> <span class=o>=</span> <span class=n>emotion_output</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=s1>'label'</span><span class=p>]</span>
</span><span id=__span-16-28><a id=__codelineno-16-28 name=__codelineno-16-28 href=#__codelineno-16-28></a>        <span class=n>emotion_score</span> <span class=o>=</span> <span class=n>emotion_output</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=s1>'score'</span><span class=p>]</span>
</span><span id=__span-16-29><a id=__codelineno-16-29 name=__codelineno-16-29 href=#__codelineno-16-29></a>
</span><span id=__span-16-30><a id=__codelineno-16-30 name=__codelineno-16-30 href=#__codelineno-16-30></a>        <span class=c1># Map emotions to sentiment categories</span>
</span><span id=__span-16-31><a id=__codelineno-16-31 name=__codelineno-16-31 href=#__codelineno-16-31></a>        <span class=n>sentiment_mapping</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-16-32><a id=__codelineno-16-32 name=__codelineno-16-32 href=#__codelineno-16-32></a>            <span class=s1>'joy'</span><span class=p>:</span> <span class=s1>'Positive'</span><span class=p>,</span>
</span><span id=__span-16-33><a id=__codelineno-16-33 name=__codelineno-16-33 href=#__codelineno-16-33></a>            <span class=s1>'love'</span><span class=p>:</span> <span class=s1>'Positive'</span><span class=p>,</span>
</span><span id=__span-16-34><a id=__codelineno-16-34 name=__codelineno-16-34 href=#__codelineno-16-34></a>            <span class=s1>'admiration'</span><span class=p>:</span> <span class=s1>'Positive'</span><span class=p>,</span>
</span><span id=__span-16-35><a id=__codelineno-16-35 name=__codelineno-16-35 href=#__codelineno-16-35></a>            <span class=s1>'approval'</span><span class=p>:</span> <span class=s1>'Positive'</span><span class=p>,</span>
</span><span id=__span-16-36><a id=__codelineno-16-36 name=__codelineno-16-36 href=#__codelineno-16-36></a>            <span class=s1>'excitement'</span><span class=p>:</span> <span class=s1>'Positive'</span><span class=p>,</span>
</span><span id=__span-16-37><a id=__codelineno-16-37 name=__codelineno-16-37 href=#__codelineno-16-37></a>            <span class=s1>'gratitude'</span><span class=p>:</span> <span class=s1>'Positive'</span><span class=p>,</span>
</span><span id=__span-16-38><a id=__codelineno-16-38 name=__codelineno-16-38 href=#__codelineno-16-38></a>            <span class=s1>'optimism'</span><span class=p>:</span> <span class=s1>'Positive'</span><span class=p>,</span>
</span><span id=__span-16-39><a id=__codelineno-16-39 name=__codelineno-16-39 href=#__codelineno-16-39></a>            <span class=s1>'anger'</span><span class=p>:</span> <span class=s1>'Negative'</span><span class=p>,</span>
</span><span id=__span-16-40><a id=__codelineno-16-40 name=__codelineno-16-40 href=#__codelineno-16-40></a>            <span class=s1>'disappointment'</span><span class=p>:</span> <span class=s1>'Negative'</span><span class=p>,</span>
</span><span id=__span-16-41><a id=__codelineno-16-41 name=__codelineno-16-41 href=#__codelineno-16-41></a>            <span class=s1>'disgust'</span><span class=p>:</span> <span class=s1>'Negative'</span><span class=p>,</span>
</span><span id=__span-16-42><a id=__codelineno-16-42 name=__codelineno-16-42 href=#__codelineno-16-42></a>            <span class=s1>'fear'</span><span class=p>:</span> <span class=s1>'Negative'</span><span class=p>,</span>
</span><span id=__span-16-43><a id=__codelineno-16-43 name=__codelineno-16-43 href=#__codelineno-16-43></a>            <span class=s1>'sadness'</span><span class=p>:</span> <span class=s1>'Negative'</span><span class=p>,</span>
</span><span id=__span-16-44><a id=__codelineno-16-44 name=__codelineno-16-44 href=#__codelineno-16-44></a>            <span class=s1>'confusion'</span><span class=p>:</span> <span class=s1>'Neutral'</span><span class=p>,</span>
</span><span id=__span-16-45><a id=__codelineno-16-45 name=__codelineno-16-45 href=#__codelineno-16-45></a>            <span class=s1>'curiosity'</span><span class=p>:</span> <span class=s1>'Neutral'</span><span class=p>,</span>
</span><span id=__span-16-46><a id=__codelineno-16-46 name=__codelineno-16-46 href=#__codelineno-16-46></a>            <span class=s1>'surprise'</span><span class=p>:</span> <span class=s1>'Neutral'</span>
</span><span id=__span-16-47><a id=__codelineno-16-47 name=__codelineno-16-47 href=#__codelineno-16-47></a>        <span class=p>}</span>
</span><span id=__span-16-48><a id=__codelineno-16-48 name=__codelineno-16-48 href=#__codelineno-16-48></a>
</span><span id=__span-16-49><a id=__codelineno-16-49 name=__codelineno-16-49 href=#__codelineno-16-49></a>        <span class=n>sentiment_label</span> <span class=o>=</span> <span class=n>sentiment_mapping</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>emotion_label</span><span class=o>.</span><span class=n>lower</span><span class=p>(),</span> <span class=s1>'Neutral'</span><span class=p>)</span>
</span><span id=__span-16-50><a id=__codelineno-16-50 name=__codelineno-16-50 href=#__codelineno-16-50></a>        <span class=k>return</span> <span class=n>sentiment_label</span><span class=p>,</span> <span class=nb>float</span><span class=p>(</span><span class=n>emotion_score</span><span class=p>),</span> <span class=n>emotion_label</span>
</span><span id=__span-16-51><a id=__codelineno-16-51 name=__codelineno-16-51 href=#__codelineno-16-51></a>
</span><span id=__span-16-52><a id=__codelineno-16-52 name=__codelineno-16-52 href=#__codelineno-16-52></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-16-53><a id=__codelineno-16-53 name=__codelineno-16-53 href=#__codelineno-16-53></a>        <span class=n>logging</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Error during sentiment analysis: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-16-54><a id=__codelineno-16-54 name=__codelineno-16-54 href=#__codelineno-16-54></a>        <span class=k>return</span> <span class=s2>"Neutral"</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=s2>"Error in analysis"</span>
</span></code></pre></div> <p>Our sentiment analysis component uses a RoBERTa model fine-tuned for emotion detection, which we found to be more effective than standard sentiment analysis for Reddit comments. Key features include smart text truncation, mapping to sentiment categories (Positive, Negative, or Neutral), and comprehensive error handling.</p> <h5 id=3-pipeline-integration>3. Pipeline Integration<a class=headerlink href=#3-pipeline-integration title="Permanent link">¶</a></h5> <p>Both components are integrated into the data pipeline with MLflow, which we use for experiment tracking, allowing us to monitor model performance and manage different model versions. We also use MLflow for model serving, enabling us to deploy our models.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=c1># MLflow configuration</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=n>mlflow</span><span class=o>.</span><span class=n>set_tracking_uri</span><span class=p>(</span><span class=s2>"http://mlflow:5000"</span><span class=p>)</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=n>mlflow</span><span class=o>.</span><span class=n>set_experiment</span><span class=p>(</span><span class=s2>"reddit_sentiment_analysis_experiments"</span><span class=p>)</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=k>with</span> <span class=n>mlflow</span><span class=o>.</span><span class=n>start_run</span><span class=p>()</span> <span class=k>as</span> <span class=n>run</span><span class=p>:</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a>    <span class=c1># Log parameters</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a>    <span class=n>mlflow</span><span class=o>.</span><span class=n>log_param</span><span class=p>(</span><span class=s2>"model_name"</span><span class=p>,</span> <span class=s2>"SamLowe/roberta-base-go_emotions"</span><span class=p>)</span>
</span></code></pre></div> <h4 id=gemini-ai-analysis>Gemini AI Analysis<a class=headerlink href=#gemini-ai-analysis title="Permanent link">¶</a></h4> <p>We use Google's Gemini AI for advanced analysis, generating structured insights from Reddit discussions with a focus on content safety and consistent formatting.</p> <h5 id=1-analysis-configuration>1. Analysis Configuration<a class=headerlink href=#1-analysis-configuration title="Permanent link">¶</a></h5> <p>The Gemini analysis is guided by a prompt template that instructs the model to filter content for safety, rank threads by score, summarize content, analyze emotions, extract top viewpoints, and embed links. The output is structured with a title, date, description, tags, overall ranking, and detailed thread analysis.</p> <p></p><div class="language-python highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=k>def</span><span class=w> </span><span class=nf>create_prompt_template</span><span class=p>():</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=w>    </span><span class=sd>"""Return the standard prompt template for Gemini analysis."""</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>    <span class=n>current_date</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>'%Y-%m-</span><span class=si>%d</span><span class=s1>'</span><span class=p>)</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a>    <span class=k>return</span> <span class=sa>f</span><span class=s2>"""</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=s2>    Analyze the provided text files, which contain Reddit posts and comments.</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=s2>    **Instructions:**</span>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a><span class=s2>    1.  **Content Filtering:** Check for harassment, hate speech, or explicit material</span>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=s2>    2.  **Ranking:** Rank threads by total "Score"</span>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a><span class=s2>    3.  **Summarization:** Utilize "Summary" fields for thread overviews</span>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a><span class=s2>    4.  **Emotional Analysis:** Analyze "Emotion Label" and "Emotion Score"</span>
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a><span class=s2>    5.  **Point of View Extraction:** Extract top 3 viewpoints per thread</span>
</span><span id=__span-18-13><a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a><span class=s2>    6.  **Links:** Embed URLs in thread titles using Markdown</span>
</span><span id=__span-18-14><a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a>
</span><span id=__span-18-15><a id=__codelineno-18-15 name=__codelineno-18-15 href=#__codelineno-18-15></a><span class=s2>    **Output Format:**</span>
</span><span id=__span-18-16><a id=__codelineno-18-16 name=__codelineno-18-16 href=#__codelineno-18-16></a><span class=s2>    ---</span>
</span><span id=__span-18-17><a id=__codelineno-18-17 name=__codelineno-18-17 href=#__codelineno-18-17></a><span class=s2>    title: "</span><span class=se>{{</span><span class=s2>subreddit_name</span><span class=se>}}</span><span class=s2> subreddit"</span>
</span><span id=__span-18-18><a id=__codelineno-18-18 name=__codelineno-18-18 href=#__codelineno-18-18></a><span class=s2>    date: "</span><span class=si>{</span><span class=n>current_date</span><span class=si>}</span><span class=s2>"</span>
</span><span id=__span-18-19><a id=__codelineno-18-19 name=__codelineno-18-19 href=#__codelineno-18-19></a><span class=s2>    description: "Analysis of top discussions and trends"</span>
</span><span id=__span-18-20><a id=__codelineno-18-20 name=__codelineno-18-20 href=#__codelineno-18-20></a><span class=s2>    tags: ["tag1", "tag2", "tag3"]</span>
</span><span id=__span-18-21><a id=__codelineno-18-21 name=__codelineno-18-21 href=#__codelineno-18-21></a><span class=s2>    ---</span>
</span><span id=__span-18-22><a id=__codelineno-18-22 name=__codelineno-18-22 href=#__codelineno-18-22></a>
</span><span id=__span-18-23><a id=__codelineno-18-23 name=__codelineno-18-23 href=#__codelineno-18-23></a><span class=s2>    # Overall Ranking and Top Discussions</span>
</span><span id=__span-18-24><a id=__codelineno-18-24 name=__codelineno-18-24 href=#__codelineno-18-24></a><span class=s2>    [Ranked list of threads with scores and summaries]</span>
</span><span id=__span-18-25><a id=__codelineno-18-25 name=__codelineno-18-25 href=#__codelineno-18-25></a>
</span><span id=__span-18-26><a id=__codelineno-18-26 name=__codelineno-18-26 href=#__codelineno-18-26></a><span class=s2>    # Detailed Analysis by Thread </span>
</span><span id=__span-18-27><a id=__codelineno-18-27 name=__codelineno-18-27 href=#__codelineno-18-27></a><span class=s2>    [Thread-by-thread analysis with summaries, emotions, and viewpoints]</span>
</span><span id=__span-18-28><a id=__codelineno-18-28 name=__codelineno-18-28 href=#__codelineno-18-28></a><span class=s2>    """</span>
</span></code></pre></div> The Gemini analysis is guided by a prompt template that instructs the model to filter content for safety, rank threads by score, summarize content, analyze emotions, extract top viewpoints, and embed links. The output is structured with a title, date, description, tags, overall ranking, and detailed thread analysis.<p></p> <h5 id=2-data-processing>2. Data Processing<a class=headerlink href=#2-data-processing title="Permanent link">¶</a></h5> <p>The system processes data subreddit by subreddit, formatting each post and its comments:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=k>def</span><span class=w> </span><span class=nf>process_subreddit</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>cur</span><span class=p>,</span> <span class=n>subreddit</span><span class=p>,</span> <span class=n>output_dir</span><span class=p>):</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=w>    </span><span class=sd>"""Process a single subreddit's data."""</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a>    <span class=c1># Fetch processed data</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a>    <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>"""</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=s2>        SELECT post_id, subreddit, post_score, post_url, comment_id,</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=s2>               summary_date, post_content, comment_body, comment_summary,</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=s2>               sentiment_score, sentiment_label</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=s2>        FROM processed_data.joined_summary_analysis</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a><span class=s2>        WHERE subreddit = </span><span class=si>%s</span>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=s2>        ORDER BY post_score DESC</span>
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a><span class=s2>    """</span><span class=p>,</span> <span class=p>(</span><span class=n>subreddit</span><span class=p>,))</span>
</span><span id=__span-19-12><a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a>
</span><span id=__span-19-13><a id=__codelineno-19-13 name=__codelineno-19-13 href=#__codelineno-19-13></a>    <span class=c1># Format data for analysis</span>
</span><span id=__span-19-14><a id=__codelineno-19-14 name=__codelineno-19-14 href=#__codelineno-19-14></a>    <span class=n>text_files</span> <span class=o>=</span> <span class=s2>""</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
</span><span id=__span-19-15><a id=__codelineno-19-15 name=__codelineno-19-15 href=#__codelineno-19-15></a>        <span class=n>format_text_file</span><span class=p>(</span><span class=n>row</span><span class=p>)</span> <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>cur</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>
</span><span id=__span-19-16><a id=__codelineno-19-16 name=__codelineno-19-16 href=#__codelineno-19-16></a>    <span class=p>)</span>
</span><span id=__span-19-17><a id=__codelineno-19-17 name=__codelineno-19-17 href=#__codelineno-19-17></a>
</span><span id=__span-19-18><a id=__codelineno-19-18 name=__codelineno-19-18 href=#__codelineno-19-18></a>    <span class=c1># Generate insights using Gemini</span>
</span><span id=__span-19-19><a id=__codelineno-19-19 name=__codelineno-19-19 href=#__codelineno-19-19></a>    <span class=n>response</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>generate_content</span><span class=p>(</span><span class=n>final_prompt</span> <span class=o>+</span> <span class=n>text_files</span><span class=p>)</span>
</span><span id=__span-19-20><a id=__codelineno-19-20 name=__codelineno-19-20 href=#__codelineno-19-20></a>
</span><span id=__span-19-21><a id=__codelineno-19-21 name=__codelineno-19-21 href=#__codelineno-19-21></a>    <span class=c1># Save formatted output</span>
</span><span id=__span-19-22><a id=__codelineno-19-22 name=__codelineno-19-22 href=#__codelineno-19-22></a>    <span class=n>output_file_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>output_dir</span><span class=p>,</span> <span class=sa>f</span><span class=s2>"llm_</span><span class=si>{</span><span class=n>subreddit</span><span class=si>}</span><span class=s2>.md"</span><span class=p>)</span>
</span><span id=__span-19-23><a id=__codelineno-19-23 name=__codelineno-19-23 href=#__codelineno-19-23></a>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>output_file_path</span><span class=p>,</span> <span class=s2>"w"</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>"utf-8"</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span><span id=__span-19-24><a id=__codelineno-19-24 name=__codelineno-19-24 href=#__codelineno-19-24></a>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></code></pre></div> <h5 id=3-output-formatting>3. Output Formatting<a class=headerlink href=#3-output-formatting title="Permanent link">¶</a></h5> <p>The system ensures consistent formatting across all analyses:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=k>def</span><span class=w> </span><span class=nf>get_formatted_subreddit_name</span><span class=p>(</span><span class=n>subreddit</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=w>    </span><span class=sd>"""Returns a properly formatted subreddit name for display."""</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a>    <span class=n>subreddit_formats</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a>        <span class=s2>"claudeai"</span><span class=p>:</span> <span class=s2>"ClaudeAI"</span><span class=p>,</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a>        <span class=s2>"dataengineering"</span><span class=p>:</span> <span class=s2>"Data Engineering"</span><span class=p>,</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a>        <span class=s2>"datascience"</span><span class=p>:</span> <span class=s2>"Data Science"</span><span class=p>,</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a>        <span class=s2>"localllama"</span><span class=p>:</span> <span class=s2>"LocalLLaMA"</span><span class=p>,</span>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a>        <span class=s2>"machinelearning"</span><span class=p>:</span> <span class=s2>"Machine Learning"</span><span class=p>,</span>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a>        <span class=s2>"openai"</span><span class=p>:</span> <span class=s2>"OpenAI"</span><span class=p>,</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a>        <span class=s2>"singularity"</span><span class=p>:</span> <span class=s2>"Singularity"</span><span class=p>,</span>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a>        <span class=s2>"stablediffusion"</span><span class=p>:</span> <span class=s2>"Stable Diffusion"</span>
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a>    <span class=p>}</span>
</span><span id=__span-20-13><a id=__codelineno-20-13 name=__codelineno-20-13 href=#__codelineno-20-13></a>    <span class=k>return</span> <span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>subreddit_formats</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>subreddit</span><span class=o>.</span><span class=n>lower</span><span class=p>(),</span><span class=w> </span><span class=n>subreddit</span><span class=p>)</span><span class=si>}</span><span class=s2> Subreddit"</span>
</span></code></pre></div> <h5 id=4-pipeline-integration>4. Pipeline Integration<a class=headerlink href=#4-pipeline-integration title="Permanent link">¶</a></h5> <p>The analysis is integrated into the main pipeline with organized output storage:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=k>def</span><span class=w> </span><span class=nf>analyze_data</span><span class=p>():</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=w>    </span><span class=sd>"""</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=sd>    Main function to analyze Reddit data using Google's Gemini model.</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=sd>    Pipeline steps:</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a><span class=sd>    1. Set up logging and output directory with current date</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=sd>    2. Initialize Gemini model</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a><span class=sd>    3. Connect to BigQuery and GCS</span>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a><span class=sd>    4. Process each subreddit</span>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a><span class=sd>    5. Clean generated markdown files</span>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a><span class=sd>    6. Upload results to GCS</span>
</span><span id=__span-21-12><a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a><span class=sd>    """</span>
</span><span id=__span-21-13><a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a>    <span class=k>try</span><span class=p>:</span>
</span><span id=__span-21-14><a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a>        <span class=c1># 1. Set up output directory with year/month/day structure</span>
</span><span id=__span-21-15><a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a>        <span class=n>current_date</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span><span id=__span-21-16><a id=__codelineno-21-16 name=__codelineno-21-16 href=#__codelineno-21-16></a>        <span class=n>year</span> <span class=o>=</span> <span class=n>current_date</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>'%Y'</span><span class=p>)</span>
</span><span id=__span-21-17><a id=__codelineno-21-17 name=__codelineno-21-17 href=#__codelineno-21-17></a>        <span class=n>month</span> <span class=o>=</span> <span class=n>current_date</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>'%m'</span><span class=p>)</span>
</span><span id=__span-21-18><a id=__codelineno-21-18 name=__codelineno-21-18 href=#__codelineno-21-18></a>        <span class=n>day</span> <span class=o>=</span> <span class=n>current_date</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>'</span><span class=si>%d</span><span class=s1>'</span><span class=p>)</span>
</span><span id=__span-21-19><a id=__codelineno-21-19 name=__codelineno-21-19 href=#__codelineno-21-19></a>
</span><span id=__span-21-20><a id=__codelineno-21-20 name=__codelineno-21-20 href=#__codelineno-21-20></a>        <span class=n>output_dir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>CLOUD_DIR</span><span class=p>,</span> <span class=s1>'results'</span><span class=p>,</span> <span class=n>year</span><span class=p>,</span> <span class=n>month</span><span class=p>,</span> <span class=n>day</span><span class=p>)</span>
</span><span id=__span-21-21><a id=__codelineno-21-21 name=__codelineno-21-21 href=#__codelineno-21-21></a>        <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=n>output_dir</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-21-22><a id=__codelineno-21-22 name=__codelineno-21-22 href=#__codelineno-21-22></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Output directory set to </span><span class=si>{</span><span class=n>output_dir</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-21-23><a id=__codelineno-21-23 name=__codelineno-21-23 href=#__codelineno-21-23></a>
</span><span id=__span-21-24><a id=__codelineno-21-24 name=__codelineno-21-24 href=#__codelineno-21-24></a>        <span class=c1># 2. Initialize model</span>
</span><span id=__span-21-25><a id=__codelineno-21-25 name=__codelineno-21-25 href=#__codelineno-21-25></a>        <span class=n>genai</span><span class=o>.</span><span class=n>configure</span><span class=p>(</span><span class=n>api_key</span><span class=o>=</span><span class=n>GEMINI_CONFIG</span><span class=p>[</span><span class=s1>'GOOGLE_GEMINI_API_KEY'</span><span class=p>])</span>
</span><span id=__span-21-26><a id=__codelineno-21-26 name=__codelineno-21-26 href=#__codelineno-21-26></a>        <span class=n>model</span> <span class=o>=</span> <span class=n>genai</span><span class=o>.</span><span class=n>GenerativeModel</span><span class=p>(</span><span class=s1>'gemini-2.0-flash-exp'</span><span class=p>)</span>
</span><span id=__span-21-27><a id=__codelineno-21-27 name=__codelineno-21-27 href=#__codelineno-21-27></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>"Model loaded"</span><span class=p>)</span>
</span><span id=__span-21-28><a id=__codelineno-21-28 name=__codelineno-21-28 href=#__codelineno-21-28></a>
</span><span id=__span-21-29><a id=__codelineno-21-29 name=__codelineno-21-29 href=#__codelineno-21-29></a>        <span class=c1># 3. Connect to BigQuery and GCS</span>
</span><span id=__span-21-30><a id=__codelineno-21-30 name=__codelineno-21-30 href=#__codelineno-21-30></a>        <span class=n>bq_client</span> <span class=o>=</span> <span class=n>bigquery</span><span class=o>.</span><span class=n>Client</span><span class=p>()</span>
</span><span id=__span-21-31><a id=__codelineno-21-31 name=__codelineno-21-31 href=#__codelineno-21-31></a>        <span class=n>storage_client</span> <span class=o>=</span> <span class=n>storage</span><span class=o>.</span><span class=n>Client</span><span class=p>()</span>
</span><span id=__span-21-32><a id=__codelineno-21-32 name=__codelineno-21-32 href=#__codelineno-21-32></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>"BigQuery and GCS clients initialized"</span><span class=p>)</span>
</span><span id=__span-21-33><a id=__codelineno-21-33 name=__codelineno-21-33 href=#__codelineno-21-33></a>
</span><span id=__span-21-34><a id=__codelineno-21-34 name=__codelineno-21-34 href=#__codelineno-21-34></a>        <span class=c1># 4. Process subreddits</span>
</span><span id=__span-21-35><a id=__codelineno-21-35 name=__codelineno-21-35 href=#__codelineno-21-35></a>        <span class=k>for</span> <span class=n>subreddit</span> <span class=ow>in</span> <span class=n>SUBREDDITS</span><span class=p>:</span>
</span><span id=__span-21-36><a id=__codelineno-21-36 name=__codelineno-21-36 href=#__codelineno-21-36></a>            <span class=n>process_subreddit</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>bq_client</span><span class=p>,</span> <span class=n>subreddit</span><span class=p>,</span> <span class=n>output_dir</span><span class=p>)</span>
</span><span id=__span-21-37><a id=__codelineno-21-37 name=__codelineno-21-37 href=#__codelineno-21-37></a>
</span><span id=__span-21-38><a id=__codelineno-21-38 name=__codelineno-21-38 href=#__codelineno-21-38></a>        <span class=c1># 5. Clean markdown files and upload to GCS</span>
</span><span id=__span-21-39><a id=__codelineno-21-39 name=__codelineno-21-39 href=#__codelineno-21-39></a>        <span class=k>for</span> <span class=n>filename</span> <span class=ow>in</span> <span class=n>os</span><span class=o>.</span><span class=n>listdir</span><span class=p>(</span><span class=n>output_dir</span><span class=p>):</span>
</span><span id=__span-21-40><a id=__codelineno-21-40 name=__codelineno-21-40 href=#__codelineno-21-40></a>            <span class=k>if</span> <span class=n>filename</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s1>'.md'</span><span class=p>):</span>
</span><span id=__span-21-41><a id=__codelineno-21-41 name=__codelineno-21-41 href=#__codelineno-21-41></a>                <span class=n>local_file_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>output_dir</span><span class=p>,</span> <span class=n>filename</span><span class=p>)</span>
</span><span id=__span-21-42><a id=__codelineno-21-42 name=__codelineno-21-42 href=#__codelineno-21-42></a>
</span><span id=__span-21-43><a id=__codelineno-21-43 name=__codelineno-21-43 href=#__codelineno-21-43></a>                <span class=c1># Clean the markdown file</span>
</span><span id=__span-21-44><a id=__codelineno-21-44 name=__codelineno-21-44 href=#__codelineno-21-44></a>                <span class=n>clean_markdown_file</span><span class=p>(</span><span class=n>local_file_path</span><span class=p>)</span>
</span><span id=__span-21-45><a id=__codelineno-21-45 name=__codelineno-21-45 href=#__codelineno-21-45></a>
</span><span id=__span-21-46><a id=__codelineno-21-46 name=__codelineno-21-46 href=#__codelineno-21-46></a>                <span class=c1># Upload to GCS</span>
</span><span id=__span-21-47><a id=__codelineno-21-47 name=__codelineno-21-47 href=#__codelineno-21-47></a>                <span class=n>gcs_blob_path</span> <span class=o>=</span> <span class=n>get_gcs_path</span><span class=p>(</span><span class=n>year</span><span class=p>,</span> <span class=n>month</span><span class=p>,</span> <span class=n>day</span><span class=p>,</span> <span class=n>filename</span><span class=p>)</span>
</span><span id=__span-21-48><a id=__codelineno-21-48 name=__codelineno-21-48 href=#__codelineno-21-48></a>                <span class=n>upload_to_gcs</span><span class=p>(</span><span class=n>local_file_path</span><span class=p>,</span> <span class=n>gcs_blob_path</span><span class=p>,</span> <span class=n>storage_client</span><span class=p>)</span>
</span><span id=__span-21-49><a id=__codelineno-21-49 name=__codelineno-21-49 href=#__codelineno-21-49></a>
</span><span id=__span-21-50><a id=__codelineno-21-50 name=__codelineno-21-50 href=#__codelineno-21-50></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>"Analysis complete - all files processed and uploaded to GCS"</span><span class=p>)</span>
</span><span id=__span-21-51><a id=__codelineno-21-51 name=__codelineno-21-51 href=#__codelineno-21-51></a>
</span><span id=__span-21-52><a id=__codelineno-21-52 name=__codelineno-21-52 href=#__codelineno-21-52></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-21-53><a id=__codelineno-21-53 name=__codelineno-21-53 href=#__codelineno-21-53></a>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Pipeline failed: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-21-54><a id=__codelineno-21-54 name=__codelineno-21-54 href=#__codelineno-21-54></a>        <span class=k>raise</span>
</span></code></pre></div> <h4 id=web-application>Web Application<a class=headerlink href=#web-application title="Permanent link">¶</a></h4> <p>Our web application, built with Next.js 15, React 18, TypeScript, and MDX, provides a modern and user-friendly way to explore our insights. The application automatically syncs with our on-premise analysis results and deploys to Vercel using GitHub Actions, with build optimizations for performance.</p> <h5 id=automated-deployment>Automated Deployment<a class=headerlink href=#automated-deployment title="Permanent link">¶</a></h5> <p>The deployment process leverages GitHub Actions:</p> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=c1># .github/workflows/deploy.yml</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deploy to Vercel</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=nt>on</span><span class=p>:</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=w>  </span><span class=nt>push</span><span class=p>:</span>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a><span class=w>    </span><span class=nt>branches</span><span class=p>:</span>
</span><span id=__span-22-7><a id=__codelineno-22-7 name=__codelineno-22-7 href=#__codelineno-22-7></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">main</span>
</span><span id=__span-22-8><a id=__codelineno-22-8 name=__codelineno-22-8 href=#__codelineno-22-8></a><span class=w>  </span><span class=nt>pull_request</span><span class=p>:</span>
</span><span id=__span-22-9><a id=__codelineno-22-9 name=__codelineno-22-9 href=#__codelineno-22-9></a><span class=w>    </span><span class=nt>branches</span><span class=p>:</span>
</span><span id=__span-22-10><a id=__codelineno-22-10 name=__codelineno-22-10 href=#__codelineno-22-10></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">main</span>
</span><span id=__span-22-11><a id=__codelineno-22-11 name=__codelineno-22-11 href=#__codelineno-22-11></a>
</span><span id=__span-22-12><a id=__codelineno-22-12 name=__codelineno-22-12 href=#__codelineno-22-12></a><span class=nt>env</span><span class=p>:</span>
</span><span id=__span-22-13><a id=__codelineno-22-13 name=__codelineno-22-13 href=#__codelineno-22-13></a><span class=w>  </span><span class=nt>VERCEL_ORG_ID</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">${{ secrets.VERCEL_ORG_ID }}</span>
</span><span id=__span-22-14><a id=__codelineno-22-14 name=__codelineno-22-14 href=#__codelineno-22-14></a><span class=w>  </span><span class=nt>VERCEL_PROJECT_ID</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">${{ secrets.VERCEL_PROJECT_ID }}</span>
</span><span id=__span-22-15><a id=__codelineno-22-15 name=__codelineno-22-15 href=#__codelineno-22-15></a>
</span><span id=__span-22-16><a id=__codelineno-22-16 name=__codelineno-22-16 href=#__codelineno-22-16></a><span class=nt>jobs</span><span class=p>:</span>
</span><span id=__span-22-17><a id=__codelineno-22-17 name=__codelineno-22-17 href=#__codelineno-22-17></a><span class=w>  </span><span class=nt>deploy</span><span class=p>:</span>
</span><span id=__span-22-18><a id=__codelineno-22-18 name=__codelineno-22-18 href=#__codelineno-22-18></a><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
</span><span id=__span-22-19><a id=__codelineno-22-19 name=__codelineno-22-19 href=#__codelineno-22-19></a><span class=w>    </span><span class=nt>steps</span><span class=p>:</span>
</span><span id=__span-22-20><a id=__codelineno-22-20 name=__codelineno-22-20 href=#__codelineno-22-20></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>
</span><span id=__span-22-21><a id=__codelineno-22-21 name=__codelineno-22-21 href=#__codelineno-22-21></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Setup Node.js</span>
</span><span id=__span-22-22><a id=__codelineno-22-22 name=__codelineno-22-22 href=#__codelineno-22-22></a><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-node@v4</span>
</span><span id=__span-22-23><a id=__codelineno-22-23 name=__codelineno-22-23 href=#__codelineno-22-23></a><span class=w>        </span><span class=nt>with</span><span class=p>:</span>
</span><span id=__span-22-24><a id=__codelineno-22-24 name=__codelineno-22-24 href=#__codelineno-22-24></a><span class=w>          </span><span class=nt>node-version</span><span class=p>:</span><span class=w> </span><span class=s>'20'</span>
</span><span id=__span-22-25><a id=__codelineno-22-25 name=__codelineno-22-25 href=#__codelineno-22-25></a><span class=w>          </span><span class=nt>cache</span><span class=p>:</span><span class=w> </span><span class=s>'npm'</span>
</span><span id=__span-22-26><a id=__codelineno-22-26 name=__codelineno-22-26 href=#__codelineno-22-26></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
</span><span id=__span-22-27><a id=__codelineno-22-27 name=__codelineno-22-27 href=#__codelineno-22-27></a><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">npm ci</span>
</span><span id=__span-22-28><a id=__codelineno-22-28 name=__codelineno-22-28 href=#__codelineno-22-28></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Install Vercel CLI</span>
</span><span id=__span-22-29><a id=__codelineno-22-29 name=__codelineno-22-29 href=#__codelineno-22-29></a><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">npm install --global vercel@latest</span>
</span><span id=__span-22-30><a id=__codelineno-22-30 name=__codelineno-22-30 href=#__codelineno-22-30></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pull Vercel Environment Information</span>
</span><span id=__span-22-31><a id=__codelineno-22-31 name=__codelineno-22-31 href=#__codelineno-22-31></a><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}</span>
</span><span id=__span-22-32><a id=__codelineno-22-32 name=__codelineno-22-32 href=#__codelineno-22-32></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Build Project Artifacts</span>
</span><span id=__span-22-33><a id=__codelineno-22-33 name=__codelineno-22-33 href=#__codelineno-22-33></a><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}</span>
</span><span id=__span-22-34><a id=__codelineno-22-34 name=__codelineno-22-34 href=#__codelineno-22-34></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deploy Project Artifacts to Vercel</span>
</span><span id=__span-22-35><a id=__codelineno-22-35 name=__codelineno-22-35 href=#__codelineno-22-35></a><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}</span>
</span></code></pre></div> <h4 id=orchestrator-stack>Orchestrator Stack<a class=headerlink href=#orchestrator-stack title="Permanent link">¶</a></h4> <p>Our pipeline is orchestrated using Apache Airflow, configured with a robust setup that ensures reliability, scalability, and observability. The orchestration layer manages the entire data pipeline from ingestion to analysis.</p> <h5 id=1-airflow-configuration>1. Airflow Configuration<a class=headerlink href=#1-airflow-configuration title="Permanent link">¶</a></h5> <p>The Airflow setup is containerized using Docker Compose with several key components:</p> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=nt>x-common-env</span><span class=p>:</span><span class=w> </span><span class=nl>&amp;common-env</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=w>  </span><span class=nt>AIRFLOW__CORE__EXECUTOR</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CeleryExecutor</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=w>  </span><span class=nt>AIRFLOW__DATABASE__SQL_ALCHEMY_CONN</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">postgresql+psycopg2://${AIRFLOW_DB_USER}:${AIRFLOW_DB_PASSWORD}@postgres/${AIRFLOW_DB_NAME}</span>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a><span class=w>  </span><span class=nt>AIRFLOW__CELERY__RESULT_BACKEND</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">db+postgresql://${AIRFLOW_DB_USER}:${AIRFLOW_DB_PASSWORD}@postgres/${AIRFLOW_DB_NAME}</span>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a><span class=w>  </span><span class=nt>AIRFLOW__CELERY__BROKER_URL</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">redis://:@redis:6379/0</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a><span class=w>  </span><span class=nt>AIRFLOW__CORE__LOAD_EXAMPLES</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a><span class=w>  </span><span class=nt>AIRFLOW__CORE__DAGS_FOLDER</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/opt/airflow/airflow_project/dags</span>
</span><span id=__span-23-8><a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a><span class=w>  </span><span class=nt>AIRFLOW__LOGGING__BASE_LOG_FOLDER</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/opt/airflow/airflow_project/logs</span>
</span><span id=__span-23-9><a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a><span class=w>  </span><span class=nt>AIRFLOW__CORE__PLUGINS_FOLDER</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/opt/airflow/airflow_project/plugins</span>
</span><span id=__span-23-10><a id=__codelineno-23-10 name=__codelineno-23-10 href=#__codelineno-23-10></a><span class=w>  </span><span class=nt>AIRFLOW__LOGGING__LOGGING_LEVEL</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">INFO</span>
</span><span id=__span-23-11><a id=__codelineno-23-11 name=__codelineno-23-11 href=#__codelineno-23-11></a><span class=w>  </span><span class=nt>AIRFLOW__LOGGING__FAB_LOGGING_LEVEL</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">WARNING</span>
</span><span id=__span-23-12><a id=__codelineno-23-12 name=__codelineno-23-12 href=#__codelineno-23-12></a><span class=w>  </span><span class=nt>AIRFLOW__LOGGING__LOGGING_CONFIG_CLASS</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">airflow.config_templates.airflow_local_settings.DEFAULT_LOGGING_CONFIG</span>
</span><span id=__span-23-13><a id=__codelineno-23-13 name=__codelineno-23-13 href=#__codelineno-23-13></a><span class=w>  </span><span class=nt>AIRFLOW__LOGGING__DELETE_LOCAL_LOGS</span><span class=p>:</span><span class=w> </span><span class=s>"true"</span>
</span><span id=__span-23-14><a id=__codelineno-23-14 name=__codelineno-23-14 href=#__codelineno-23-14></a><span class=w>  </span><span class=nt>AIRFLOW__LOGGING__MAX_LOG_AGE_IN_DAYS</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">7</span>
</span><span id=__span-23-15><a id=__codelineno-23-15 name=__codelineno-23-15 href=#__codelineno-23-15></a><span class=w>  </span><span class=nt>PYTHONPATH</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/opt/airflow</span>
</span><span id=__span-23-16><a id=__codelineno-23-16 name=__codelineno-23-16 href=#__codelineno-23-16></a><span class=w>  </span><span class=nt>AIRFLOW__METRICS__STATSD_ON</span><span class=p>:</span><span class=w> </span><span class=s>"true"</span>
</span><span id=__span-23-17><a id=__codelineno-23-17 name=__codelineno-23-17 href=#__codelineno-23-17></a><span class=w>  </span><span class=nt>AIRFLOW__METRICS__STATSD_HOST</span><span class=p>:</span><span class=w> </span><span class=s>"statsd-exporter"</span>
</span><span id=__span-23-18><a id=__codelineno-23-18 name=__codelineno-23-18 href=#__codelineno-23-18></a><span class=w>  </span><span class=nt>AIRFLOW__METRICS__STATSD_PORT</span><span class=p>:</span><span class=w> </span><span class=s>"9125"</span>
</span><span id=__span-23-19><a id=__codelineno-23-19 name=__codelineno-23-19 href=#__codelineno-23-19></a><span class=w>  </span><span class=nt>AIRFLOW__METRICS__STATSD_PREFIX</span><span class=p>:</span><span class=w> </span><span class=s>"airflow"</span>
</span><span id=__span-23-20><a id=__codelineno-23-20 name=__codelineno-23-20 href=#__codelineno-23-20></a><span class=w>  </span><span class=nt>AIRFLOW__METRICS__STATSD_ALLOW_LIST</span><span class=p>:</span><span class=w> </span><span class=s>"*"</span>
</span><span id=__span-23-21><a id=__codelineno-23-21 name=__codelineno-23-21 href=#__codelineno-23-21></a><span class=w>  </span><span class=nt>AIRFLOW__METRICS__METRICS_ALLOW_LIST</span><span class=p>:</span><span class=w> </span><span class=s>"*"</span>
</span><span id=__span-23-22><a id=__codelineno-23-22 name=__codelineno-23-22 href=#__codelineno-23-22></a><span class=w>  </span><span class=nt>AIRFLOW__WEBSERVER__EXPOSE_METRICS</span><span class=p>:</span><span class=w> </span><span class=s>'true'</span>
</span><span id=__span-23-23><a id=__codelineno-23-23 name=__codelineno-23-23 href=#__codelineno-23-23></a><span class=w>  </span><span class=nt>AIRFLOW__METRICS__STATSD_INTERVAL</span><span class=p>:</span><span class=w> </span><span class=s>"30"</span>
</span><span id=__span-23-24><a id=__codelineno-23-24 name=__codelineno-23-24 href=#__codelineno-23-24></a><span class=w>  </span><span class=nt>GOOGLE_APPLICATION_CREDENTIALS</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">${GOOGLE_APPLICATION_CREDENTIALS}</span>
</span><span id=__span-23-25><a id=__codelineno-23-25 name=__codelineno-23-25 href=#__codelineno-23-25></a><span class=w>  </span><span class=nt>GH_PAT</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">${GH_PAT}</span>
</span><span id=__span-23-26><a id=__codelineno-23-26 name=__codelineno-23-26 href=#__codelineno-23-26></a><span class=w>  </span><span class=nt>GH_OWNER</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">${GH_OWNER}</span>
</span><span id=__span-23-27><a id=__codelineno-23-27 name=__codelineno-23-27 href=#__codelineno-23-27></a><span class=w>  </span><span class=nt>GH_REPO</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">${GH_REPO}</span>
</span><span id=__span-23-28><a id=__codelineno-23-28 name=__codelineno-23-28 href=#__codelineno-23-28></a><span class=w>  </span><span class=nt>GH_WEBSITE_REPO</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">${GH_WEBSITE_REPO}</span>
</span><span id=__span-23-29><a id=__codelineno-23-29 name=__codelineno-23-29 href=#__codelineno-23-29></a><span class=w>  </span><span class=nt>GCP_PROJECT_ID</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">${GCP_PROJECT_ID}</span>
</span><span id=__span-23-30><a id=__codelineno-23-30 name=__codelineno-23-30 href=#__codelineno-23-30></a><span class=w>  </span><span class=nt>GCS_BUCKET_NAME</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">${GCS_BUCKET_NAME}</span>
</span><span id=__span-23-31><a id=__codelineno-23-31 name=__codelineno-23-31 href=#__codelineno-23-31></a><span class=w>  </span><span class=nt>STOP_VM_FUNCTION_URL</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">${STOP_VM_FUNCTION_URL}</span>
</span><span id=__span-23-32><a id=__codelineno-23-32 name=__codelineno-23-32 href=#__codelineno-23-32></a><span class=w>  </span><span class=nt>ALERT_EMAIL</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">${ALERT_EMAIL}</span>
</span><span id=__span-23-33><a id=__codelineno-23-33 name=__codelineno-23-33 href=#__codelineno-23-33></a><span class=w>  </span><span class=nt>AIRFLOW__SMTP__SMTP_HOST</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">smtp.gmail.com</span>
</span><span id=__span-23-34><a id=__codelineno-23-34 name=__codelineno-23-34 href=#__codelineno-23-34></a><span class=w>  </span><span class=nt>AIRFLOW__SMTP__SMTP_USER</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">${ALERT_EMAIL}</span>
</span><span id=__span-23-35><a id=__codelineno-23-35 name=__codelineno-23-35 href=#__codelineno-23-35></a><span class=w>  </span><span class=nt>AIRFLOW__SMTP__SMTP_PASSWORD</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">${ALERT_EMAIL_PASSWORD}</span>
</span><span id=__span-23-36><a id=__codelineno-23-36 name=__codelineno-23-36 href=#__codelineno-23-36></a><span class=w>  </span><span class=nt>AIRFLOW__SMTP__SMTP_PORT</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">587</span>
</span><span id=__span-23-37><a id=__codelineno-23-37 name=__codelineno-23-37 href=#__codelineno-23-37></a><span class=w>  </span><span class=nt>AIRFLOW__SMTP__SMTP_MAIL_FROM</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">${ALERT_EMAIL}</span>
</span><span id=__span-23-38><a id=__codelineno-23-38 name=__codelineno-23-38 href=#__codelineno-23-38></a><span class=w>  </span><span class=nt>AIRFLOW__SMTP__SMTP_STARTTLS</span><span class=p>:</span><span class=w> </span><span class=s>"true"</span>
</span><span id=__span-23-39><a id=__codelineno-23-39 name=__codelineno-23-39 href=#__codelineno-23-39></a><span class=w>  </span><span class=nt>AIRFLOW__SMTP__SMTP_SSL</span><span class=p>:</span><span class=w> </span><span class=s>"false"</span>
</span><span id=__span-23-40><a id=__codelineno-23-40 name=__codelineno-23-40 href=#__codelineno-23-40></a>
</span><span id=__span-23-41><a id=__codelineno-23-41 name=__codelineno-23-41 href=#__codelineno-23-41></a><span class=nt>x-common-volumes</span><span class=p>:</span><span class=w> </span><span class=nl>&amp;common-volumes</span>
</span><span id=__span-23-42><a id=__codelineno-23-42 name=__codelineno-23-42 href=#__codelineno-23-42></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">..:/opt/airflow</span>
</span><span id=__span-23-43><a id=__codelineno-23-43 name=__codelineno-23-43 href=#__codelineno-23-43></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">../credentials:/opt/airflow/credentials</span>
</span><span id=__span-23-44><a id=__codelineno-23-44 name=__codelineno-23-44 href=#__codelineno-23-44></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">../mlflow:/mlflow</span>
</span><span id=__span-23-45><a id=__codelineno-23-45 name=__codelineno-23-45 href=#__codelineno-23-45></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">../results:/opt/airflow/results</span>
</span><span id=__span-23-46><a id=__codelineno-23-46 name=__codelineno-23-46 href=#__codelineno-23-46></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">../dbt_reddit_summary_cloud:/opt/airflow/dbt_reddit_summary_cloud</span>
</span><span id=__span-23-47><a id=__codelineno-23-47 name=__codelineno-23-47 href=#__codelineno-23-47></a>
</span><span id=__span-23-48><a id=__codelineno-23-48 name=__codelineno-23-48 href=#__codelineno-23-48></a><span class=nt>x-airflow-common</span><span class=p>:</span><span class=w> </span><span class=nl>&amp;airflow-common</span>
</span><span id=__span-23-49><a id=__codelineno-23-49 name=__codelineno-23-49 href=#__codelineno-23-49></a><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w> </span><span class=nv>*common-volumes</span>
</span><span id=__span-23-50><a id=__codelineno-23-50 name=__codelineno-23-50 href=#__codelineno-23-50></a><span class=w>  </span><span class=nt>environment</span><span class=p>:</span>
</span><span id=__span-23-51><a id=__codelineno-23-51 name=__codelineno-23-51 href=#__codelineno-23-51></a><span class=w>    </span><span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span><span class=nv>*common-env</span>
</span><span id=__span-23-52><a id=__codelineno-23-52 name=__codelineno-23-52 href=#__codelineno-23-52></a><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=s>"${AIRFLOW_UID:-50000}:0"</span>
</span></code></pre></div> <p>The Airflow services are deployed as separate containers, each with specific responsibilities:</p> <ol> <li> <p><strong>Airflow Webserver</strong> </p><div class="language-yaml highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=nt>airflow-webserver</span><span class=p>:</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=w>   </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">${DOCKER_REGISTRY}/reddit-airflow-webserver:latest</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=w>   </span><span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span><span class=nv>*airflow-common</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=w>   </span><span class=nt>depends_on</span><span class=p>:</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=w>     </span><span class=nt>airflow-init</span><span class=p>:</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=w>       </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">service_completed_successfully</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=w>   </span><span class=nt>ports</span><span class=p>:</span>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=w>     </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>"8080:8080"</span>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=w>   </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">airflow webserver</span>
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a><span class=w>   </span><span class=nt>healthcheck</span><span class=p>:</span>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=w>     </span><span class=nt>test</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>"CMD"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"curl"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"--fail"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"http://localhost:8080/health"</span><span class="p p-Indicator">]</span>
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a><span class=w>     </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a><span class=w>     </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=w>     </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a><span class=w>     </span><span class=nt>start_period</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">60s</span>
</span><span id=__span-24-16><a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a><span class=w>   </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
</span></code></pre></div> Our Airflow webserver provides the web UI for DAG management and monitoring, handles user authentication and authorization, exposes REST API endpoints, and includes health checks to ensure UI availability.<p></p> </li> <li> <p><strong>Airflow Scheduler</strong> </p><div class="language-yaml highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=nt>airflow-scheduler</span><span class=p>:</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=w>   </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">${DOCKER_REGISTRY}/reddit-airflow-scheduler:latest</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=w>   </span><span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span><span class=nv>*airflow-common</span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=w>   </span><span class=nt>depends_on</span><span class=p>:</span>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=w>     </span><span class=nt>airflow-webserver</span><span class=p>:</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=w>       </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a><span class=w>     </span><span class=nt>postgres</span><span class=p>:</span>
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a><span class=w>       </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
</span><span id=__span-25-9><a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=w>     </span><span class=nt>redis</span><span class=p>:</span>
</span><span id=__span-25-10><a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a><span class=w>       </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
</span><span id=__span-25-11><a id=__codelineno-25-11 name=__codelineno-25-11 href=#__codelineno-25-11></a><span class=w>   </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">airflow scheduler</span>
</span><span id=__span-25-12><a id=__codelineno-25-12 name=__codelineno-25-12 href=#__codelineno-25-12></a><span class=w>   </span><span class=nt>healthcheck</span><span class=p>:</span>
</span><span id=__span-25-13><a id=__codelineno-25-13 name=__codelineno-25-13 href=#__codelineno-25-13></a><span class=w>     </span><span class=nt>test</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>"CMD-SHELL"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>'airflow</span><span class=nv> </span><span class=s>jobs</span><span class=nv> </span><span class=s>check</span><span class=nv> </span><span class=s>--job-type</span><span class=nv> </span><span class=s>SchedulerJob</span><span class=nv> </span><span class=s>--hostname</span><span class=nv> </span><span class=s>"$${HOSTNAME}"'</span><span class="p p-Indicator">]</span>
</span><span id=__span-25-14><a id=__codelineno-25-14 name=__codelineno-25-14 href=#__codelineno-25-14></a><span class=w>     </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
</span><span id=__span-25-15><a id=__codelineno-25-15 name=__codelineno-25-15 href=#__codelineno-25-15></a><span class=w>     </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
</span><span id=__span-25-16><a id=__codelineno-25-16 name=__codelineno-25-16 href=#__codelineno-25-16></a><span class=w>     </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</span><span id=__span-25-17><a id=__codelineno-25-17 name=__codelineno-25-17 href=#__codelineno-25-17></a><span class=w>     </span><span class=nt>start_period</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">60s</span>
</span><span id=__span-25-18><a id=__codelineno-25-18 name=__codelineno-25-18 href=#__codelineno-25-18></a><span class=w>   </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
</span></code></pre></div> The Airflow scheduler monitors and triggers task execution, manages DAG parsing and scheduling, handles task dependencies and queuing, and ensures proper task distribution to workers. This component is crucial for orchestrating our data pipeline.<p></p> </li> <li> <p><strong>Airflow Worker</strong> </p><div class="language-yaml highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=nt>airflow-worker</span><span class=p>:</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=w>   </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">${DOCKER_REGISTRY}/reddit-airflow-worker:latest</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=w>   </span><span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span><span class=nv>*airflow-common</span>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=w>   </span><span class=nt>depends_on</span><span class=p>:</span>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=w>     </span><span class=nt>airflow-webserver</span><span class=p>:</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=w>       </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=w>   </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">airflow celery worker</span>
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a><span class=w>   </span><span class=nt>healthcheck</span><span class=p>:</span>
</span><span id=__span-26-9><a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a><span class=w>     </span><span class=nt>test</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>"CMD-SHELL"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>'celery</span><span class=nv> </span><span class=s>--app</span><span class=nv> </span><span class=s>airflow.providers.celery.executors.celery_executor.app</span><span class=nv> </span><span class=s>inspect</span><span class=nv> </span><span class=s>ping</span><span class=nv> </span><span class=s>-d</span><span class=nv> </span><span class=s>"celery@$${HOSTNAME}"'</span><span class="p p-Indicator">]</span>
</span><span id=__span-26-10><a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a><span class=w>     </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
</span><span id=__span-26-11><a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a><span class=w>     </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
</span><span id=__span-26-12><a id=__codelineno-26-12 name=__codelineno-26-12 href=#__codelineno-26-12></a><span class=w>     </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</span><span id=__span-26-13><a id=__codelineno-26-13 name=__codelineno-26-13 href=#__codelineno-26-13></a><span class=w>   </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
</span></code></pre></div> Our Airflow worker executes the actual tasks, handles ML model inference, manages resource allocation, supports parallel task execution, and is configured for ML workloads with PyTorch and Transformers.<p></p> </li> <li> <p><strong>Airflow Init</strong> </p><div class="language-yaml highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=nt>airflow-init</span><span class=p>:</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=w>   </span><span class=nt>build</span><span class=p>:</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=w>     </span><span class=nt>context</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=w>     </span><span class=nt>dockerfile</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.webserver</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=w>   </span><span class=nt>env_file</span><span class=p>:</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=w>     </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">../.env</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=w>   </span><span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span><span class=nv>*airflow-common</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=w>   </span><span class=nt>depends_on</span><span class=p>:</span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=w>     </span><span class=nt>postgres</span><span class=p>:</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=w>       </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=w>     </span><span class=nt>redis</span><span class=p>:</span>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=w>       </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=w>   </span><span class=nt>environment</span><span class=p>:</span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a><span class=w>     </span><span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span><span class=nv>*common-env</span>
</span><span id=__span-27-15><a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a><span class=w>     </span><span class=nt>GIT_PYTHON_REFRESH</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">quiet</span>
</span><span id=__span-27-16><a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a><span class=w>   </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">&gt;</span>
</span><span id=__span-27-17><a id=__codelineno-27-17 name=__codelineno-27-17 href=#__codelineno-27-17></a><span class=w>     </span><span class=no>bash -c "</span>
</span><span id=__span-27-18><a id=__codelineno-27-18 name=__codelineno-27-18 href=#__codelineno-27-18></a><span class=w>     </span><span class=no>airflow db init &amp;&amp;</span>
</span><span id=__span-27-19><a id=__codelineno-27-19 name=__codelineno-27-19 href=#__codelineno-27-19></a><span class=w>     </span><span class=no>airflow db upgrade &amp;&amp;</span>
</span><span id=__span-27-20><a id=__codelineno-27-20 name=__codelineno-27-20 href=#__codelineno-27-20></a><span class=w>     </span><span class=no>airflow users create -r Admin -u admin -p admin -e admin@example.com -f Anonymous -l Admin</span>
</span><span id=__span-27-21><a id=__codelineno-27-21 name=__codelineno-27-21 href=#__codelineno-27-21></a><span class=w>     </span><span class=no>"</span>
</span></code></pre></div> The Airflow init service initializes the Airflow database, creates an admin user, performs database migrations, and runs only during the initial setup. This component is essential for setting up the Airflow environment.<p></p> </li> </ol> <h5 id=2-pipeline-structure>2. Pipeline Structure<a class=headerlink href=#2-pipeline-structure title="Permanent link">¶</a></h5> <p>Our DAG (<code>reddit_pipeline</code>) is organized into 27 stages but can be categorized into 6 main sections, each with specific responsibilities and metrics collection:</p> <ol> <li><strong>Data Collection and Preprocessing</strong> <div class="language-python highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=n>ingest_task</span> <span class=o>=</span> <span class=n>PythonOperator</span><span class=p>(</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a>    <span class=n>task_id</span><span class=o>=</span><span class=s1>'ingest_and_preprocess'</span><span class=p>,</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a>    <span class=n>python_callable</span><span class=o>=</span><span class=n>ingest_preprocess_process</span><span class=p>,</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a>    <span class=n>provide_context</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=p>)</span>
</span></code></pre></div> Data is ingested and preprocessed.</li> <li><strong>DBT Transformations</strong> <div class="language-python highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=n>dbt_staging_task</span> <span class=o>=</span> <span class=n>BashOperator</span><span class=p>(</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a>    <span class=n>task_id</span><span class=o>=</span><span class=s1>'run_dbt_staging'</span><span class=p>,</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a>    <span class=n>bash_command</span><span class=o>=</span><span class=s1>'cd /opt/airflow/dags/dbt_reddit_summary_cloud &amp;&amp; dbt run --select current_summary_staging'</span><span class=p>,</span>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a>    <span class=n>dag</span><span class=o>=</span><span class=n>dag</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=p>)</span>
</span></code></pre></div> DBT transformations are run to prepare the data for analysis.</li> <li> <p><strong>Model Processing</strong> </p><div class="language-python highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a>    <span class=n>summarize_metrics_task</span> <span class=o>=</span> <span class=n>PythonOperator</span><span class=p>(</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a>        <span class=n>task_id</span><span class=o>=</span><span class=s1>'parse_summarize_metrics'</span><span class=p>,</span>
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a>        <span class=n>python_callable</span><span class=o>=</span><span class=n>parse_summarize_metrics</span><span class=p>,</span>
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a>        <span class=n>provide_context</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-30-5><a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a>    <span class=p>)</span>
</span><span id=__span-30-6><a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a>
</span><span id=__span-30-7><a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a>    <span class=n>sentiment_task</span> <span class=o>=</span> <span class=n>PythonOperator</span><span class=p>(</span>
</span><span id=__span-30-8><a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a>        <span class=n>task_id</span><span class=o>=</span><span class=s1>'run_sentiment_analysis'</span><span class=p>,</span>
</span><span id=__span-30-9><a id=__codelineno-30-9 name=__codelineno-30-9 href=#__codelineno-30-9></a>        <span class=n>python_callable</span><span class=o>=</span><span class=n>sentiment_analysis_process</span><span class=p>,</span>
</span><span id=__span-30-10><a id=__codelineno-30-10 name=__codelineno-30-10 href=#__codelineno-30-10></a>        <span class=n>provide_context</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-30-11><a id=__codelineno-30-11 name=__codelineno-30-11 href=#__codelineno-30-11></a>    <span class=p>)</span>
</span><span id=__span-30-12><a id=__codelineno-30-12 name=__codelineno-30-12 href=#__codelineno-30-12></a>
</span><span id=__span-30-13><a id=__codelineno-30-13 name=__codelineno-30-13 href=#__codelineno-30-13></a>
</span><span id=__span-30-14><a id=__codelineno-30-14 name=__codelineno-30-14 href=#__codelineno-30-14></a>    <span class=n>gemini_task</span> <span class=o>=</span> <span class=n>PythonOperator</span><span class=p>(</span>
</span><span id=__span-30-15><a id=__codelineno-30-15 name=__codelineno-30-15 href=#__codelineno-30-15></a>        <span class=n>task_id</span><span class=o>=</span><span class=s1>'run_gemini'</span><span class=p>,</span>
</span><span id=__span-30-16><a id=__codelineno-30-16 name=__codelineno-30-16 href=#__codelineno-30-16></a>        <span class=n>python_callable</span><span class=o>=</span><span class=n>gemini_analysis_process</span><span class=p>,</span>
</span><span id=__span-30-17><a id=__codelineno-30-17 name=__codelineno-30-17 href=#__codelineno-30-17></a>        <span class=n>dag</span><span class=o>=</span><span class=n>dag</span>
</span><span id=__span-30-18><a id=__codelineno-30-18 name=__codelineno-30-18 href=#__codelineno-30-18></a>    <span class=p>)</span>
</span></code></pre></div> Our analysis pipeline includes text summarization using BART, sentiment analysis with RoBERTa, and advanced analysis with Gemini AI.<p></p> </li> <li> <p><strong>Quality Checks</strong> </p><div class="language-python highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=n>dbt_test_raw_sources</span> <span class=o>=</span> <span class=n>BashOperator</span><span class=p>(</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a>    <span class=n>task_id</span><span class=o>=</span><span class=s1>'test_raw_sources'</span><span class=p>,</span>
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a>    <span class=n>bash_command</span><span class=o>=</span><span class=n>DBT_TEST_CMD</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>selector</span><span class=o>=</span><span class=s1>'source:raw_data source:processed_data'</span><span class=p>),</span>
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a>    <span class=n>dag</span><span class=o>=</span><span class=n>dag</span>
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a><span class=p>)</span>
</span></code></pre></div> DBT tests are run to ensure the data is valid.<p></p> </li> <li> <p><strong>Metrics Collection</strong></p> <ul> <li>We monitor our pipeline with dedicated metrics tasks, using a StatsD exporter to send real-time data to Prometheus, and MLflow tracking for model performance.</li> </ul> </li> <li> <p><strong>Shutdown VM using Cloud Function</strong> </p><div class="language-python highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a>    <span class=n>shutdown_vm</span> <span class=o>=</span> <span class=n>PythonOperator</span><span class=p>(</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a>        <span class=n>task_id</span><span class=o>=</span><span class=s1>'shutdown_vm'</span><span class=p>,</span>
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a>        <span class=n>python_callable</span><span class=o>=</span><span class=n>trigger_vm_shutdown</span><span class=p>,</span>
</span><span id=__span-32-4><a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a>        <span class=n>provide_context</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-32-5><a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a>        <span class=n>trigger_rule</span><span class=o>=</span><span class=s1>'all_done'</span><span class=p>,</span>  <span class=c1># Run even if upstream tasks fail</span>
</span><span id=__span-32-6><a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a>        <span class=n>retries</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>  <span class=c1># Don't retry on failure since VM will be shutting down</span>
</span><span id=__span-32-7><a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a>        <span class=n>dag</span><span class=o>=</span><span class=n>dag</span><span class=p>,</span>
</span><span id=__span-32-8><a id=__codelineno-32-8 name=__codelineno-32-8 href=#__codelineno-32-8></a>        <span class=n>email_on_failure</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-32-9><a id=__codelineno-32-9 name=__codelineno-32-9 href=#__codelineno-32-9></a>    <span class=p>)</span>
</span></code></pre></div> We use a Cloud Function to shutdown the VM after the pipeline is complete.<p></p> </li> </ol> <h5 id=3-task-dependencies>3. Task Dependencies<a class=headerlink href=#3-task-dependencies title="Permanent link">¶</a></h5> <p>The pipeline follows a clear dependency chain: </p><div class="language-python highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=n>ingest_task</span> <span class=o>&gt;&gt;</span> <span class=n>ingest_metrics_task</span> <span class=o>&gt;&gt;</span> \
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a><span class=n>dbt_test_raw_sources</span> <span class=o>&gt;&gt;</span> <span class=n>dbt_test_raw_metrics_task</span> <span class=o>&gt;&gt;</span> \
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a><span class=n>dbt_staging_task</span> <span class=o>&gt;&gt;</span> <span class=n>dbt_test_staging_models</span> <span class=o>&gt;&gt;</span> \
</span><span id=__span-33-4><a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a><span class=n>summarize_task</span> <span class=o>&gt;&gt;</span> <span class=n>sentiment_task</span> <span class=o>&gt;&gt;</span> \
</span><span id=__span-33-5><a id=__codelineno-33-5 name=__codelineno-33-5 href=#__codelineno-33-5></a><span class=n>dbt_join_summary_analysis_task</span> <span class=o>&gt;&gt;</span> \
</span><span id=__span-33-6><a id=__codelineno-33-6 name=__codelineno-33-6 href=#__codelineno-33-6></a><span class=n>gemini_task</span> <span class=o>&gt;&gt;</span> <span class=n>push_gemini_results_task</span> <span class=o>&gt;&gt;</span> <span class=n>shutdown_vm</span>
</span></code></pre></div> Our pipeline starts with data ingestion and preprocessing, followed by DBT testing and staging, then text summarization and sentiment analysis, and finally Gemini AI analysis, result pushing and VM shutdown.<p></p> <h5 id=4-integration-points>4. Integration Points<a class=headerlink href=#4-integration-points title="Permanent link">¶</a></h5> <p>The orchestrator connects with BigQuery for pipeline data storage, local model deployment for model serving, StatsD and Prometheus for monitoring, and GitHub for version control of results. These connections are essential for the functionality of our pipeline.</p> <h5 id=5-cloud-function>5. Cloud Function<a class=headerlink href=#5-cloud-function title="Permanent link">¶</a></h5> <h6 id=51-start-vm>5.1. Start VM<a class=headerlink href=#51-start-vm title="Permanent link">¶</a></h6> <p>The Cloud Function to start the VM is deployed using Cloud Run. It ensures seamless startup of virtual machines on-demand, optimizing resource utilization.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=c1># Create Flask app</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a>
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=k>def</span><span class=w> </span><span class=nf>get_gcloud_path</span><span class=p>():</span>
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a><span class=w>    </span><span class=sd>"""Get the full path to gcloud executable based on OS"""</span>
</span><span id=__span-34-6><a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a>    <span class=k>if</span> <span class=n>platform</span><span class=o>.</span><span class=n>system</span><span class=p>()</span> <span class=o>==</span> <span class=s2>"Windows"</span><span class=p>:</span>
</span><span id=__span-34-7><a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a>        <span class=c1># Common installation paths for gcloud on Windows</span>
</span><span id=__span-34-8><a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a>        <span class=n>possible_paths</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-34-9><a id=__codelineno-34-9 name=__codelineno-34-9 href=#__codelineno-34-9></a>            <span class=sa>r</span><span class=s2>"C:\Program Files (x86)\Google\Cloud SDK\google-cloud-sdk\bin\gcloud.cmd"</span><span class=p>,</span>
</span><span id=__span-34-10><a id=__codelineno-34-10 name=__codelineno-34-10 href=#__codelineno-34-10></a>            <span class=sa>r</span><span class=s2>"C:\Program Files\Google\Cloud SDK\google-cloud-sdk\bin\gcloud.cmd"</span><span class=p>,</span>
</span><span id=__span-34-11><a id=__codelineno-34-11 name=__codelineno-34-11 href=#__codelineno-34-11></a>            <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>expanduser</span><span class=p>(</span><span class=s2>"~"</span><span class=p>)</span> <span class=o>+</span> <span class=sa>r</span><span class=s2>"\AppData\Local\Google\Cloud SDK\google-cloud-sdk\bin\gcloud.cmd"</span>
</span><span id=__span-34-12><a id=__codelineno-34-12 name=__codelineno-34-12 href=#__codelineno-34-12></a>        <span class=p>]</span>
</span><span id=__span-34-13><a id=__codelineno-34-13 name=__codelineno-34-13 href=#__codelineno-34-13></a>        <span class=k>for</span> <span class=n>path</span> <span class=ow>in</span> <span class=n>possible_paths</span><span class=p>:</span>
</span><span id=__span-34-14><a id=__codelineno-34-14 name=__codelineno-34-14 href=#__codelineno-34-14></a>            <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>path</span><span class=p>):</span>
</span><span id=__span-34-15><a id=__codelineno-34-15 name=__codelineno-34-15 href=#__codelineno-34-15></a>                <span class=k>return</span> <span class=n>path</span>
</span><span id=__span-34-16><a id=__codelineno-34-16 name=__codelineno-34-16 href=#__codelineno-34-16></a>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>"gcloud not found. Please ensure Google Cloud SDK is installed and in PATH"</span><span class=p>)</span>
</span><span id=__span-34-17><a id=__codelineno-34-17 name=__codelineno-34-17 href=#__codelineno-34-17></a>    <span class=k>return</span> <span class=s2>"gcloud"</span>  <span class=c1># For non-Windows systems, assume it's in PATH</span>
</span><span id=__span-34-18><a id=__codelineno-34-18 name=__codelineno-34-18 href=#__codelineno-34-18></a>
</span><span id=__span-34-19><a id=__codelineno-34-19 name=__codelineno-34-19 href=#__codelineno-34-19></a><span class=nd>@app</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s2>"/"</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s2>"POST"</span><span class=p>])</span>
</span><span id=__span-34-20><a id=__codelineno-34-20 name=__codelineno-34-20 href=#__codelineno-34-20></a><span class=k>def</span><span class=w> </span><span class=nf>start_vm_http</span><span class=p>():</span>
</span><span id=__span-34-21><a id=__codelineno-34-21 name=__codelineno-34-21 href=#__codelineno-34-21></a><span class=w>    </span><span class=sd>"""</span>
</span><span id=__span-34-22><a id=__codelineno-34-22 name=__codelineno-34-22 href=#__codelineno-34-22></a><span class=sd>    HTTP endpoint for Cloud Run to start a Compute Engine instance.</span>
</span><span id=__span-34-23><a id=__codelineno-34-23 name=__codelineno-34-23 href=#__codelineno-34-23></a><span class=sd>    Accepts POST requests with optional JSON body:</span>
</span><span id=__span-34-24><a id=__codelineno-34-24 name=__codelineno-34-24 href=#__codelineno-34-24></a><span class=sd>    {'trigger_source': 'scheduler'|'manual'|'dag'}</span>
</span><span id=__span-34-25><a id=__codelineno-34-25 name=__codelineno-34-25 href=#__codelineno-34-25></a><span class=sd>    """</span>
</span><span id=__span-34-26><a id=__codelineno-34-26 name=__codelineno-34-26 href=#__codelineno-34-26></a>    <span class=k>return</span> <span class=n>start_vm</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span><span id=__span-34-27><a id=__codelineno-34-27 name=__codelineno-34-27 href=#__codelineno-34-27></a>
</span><span id=__span-34-28><a id=__codelineno-34-28 name=__codelineno-34-28 href=#__codelineno-34-28></a><span class=k>def</span><span class=w> </span><span class=nf>start_vm</span><span class=p>(</span><span class=n>request</span><span class=p>):</span>
</span><span id=__span-34-29><a id=__codelineno-34-29 name=__codelineno-34-29 href=#__codelineno-34-29></a><span class=w>    </span><span class=sd>"""</span>
</span><span id=__span-34-30><a id=__codelineno-34-30 name=__codelineno-34-30 href=#__codelineno-34-30></a><span class=sd>    Function to start a Compute Engine instance and execute startup script.</span>
</span><span id=__span-34-31><a id=__codelineno-34-31 name=__codelineno-34-31 href=#__codelineno-34-31></a><span class=sd>    """</span>
</span><span id=__span-34-32><a id=__codelineno-34-32 name=__codelineno-34-32 href=#__codelineno-34-32></a>    <span class=n>project</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>'PROJECT_ID'</span><span class=p>)</span>
</span><span id=__span-34-33><a id=__codelineno-34-33 name=__codelineno-34-33 href=#__codelineno-34-33></a>    <span class=n>zone</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>'ZONE'</span><span class=p>)</span>
</span><span id=__span-34-34><a id=__codelineno-34-34 name=__codelineno-34-34 href=#__codelineno-34-34></a>    <span class=n>instance</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>'INSTANCE'</span><span class=p>)</span>
</span><span id=__span-34-35><a id=__codelineno-34-35 name=__codelineno-34-35 href=#__codelineno-34-35></a>    <span class=n>gh_repo</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>'GH_REPO'</span><span class=p>)</span>
</span><span id=__span-34-36><a id=__codelineno-34-36 name=__codelineno-34-36 href=#__codelineno-34-36></a>
</span><span id=__span-34-37><a id=__codelineno-34-37 name=__codelineno-34-37 href=#__codelineno-34-37></a>    <span class=c1># Setup logging</span>
</span><span id=__span-34-38><a id=__codelineno-34-38 name=__codelineno-34-38 href=#__codelineno-34-38></a>    <span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>,</span> <span class=nb>format</span><span class=o>=</span><span class=s1>'</span><span class=si>%(asctime)s</span><span class=s1> - </span><span class=si>%(levelname)s</span><span class=s1> - </span><span class=si>%(message)s</span><span class=s1>'</span><span class=p>)</span>
</span><span id=__span-34-39><a id=__codelineno-34-39 name=__codelineno-34-39 href=#__codelineno-34-39></a>    <span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span><span id=__span-34-40><a id=__codelineno-34-40 name=__codelineno-34-40 href=#__codelineno-34-40></a>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Environment: PROJECT_ID=</span><span class=si>{</span><span class=n>project</span><span class=si>}</span><span class=s2>, ZONE=</span><span class=si>{</span><span class=n>zone</span><span class=si>}</span><span class=s2>, INSTANCE=</span><span class=si>{</span><span class=n>instance</span><span class=si>}</span><span class=s2>, GH_REPO=</span><span class=si>{</span><span class=n>gh_repo</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-34-41><a id=__codelineno-34-41 name=__codelineno-34-41 href=#__codelineno-34-41></a>
</span><span id=__span-34-42><a id=__codelineno-34-42 name=__codelineno-34-42 href=#__codelineno-34-42></a>    <span class=c1># Parse request data</span>
</span><span id=__span-34-43><a id=__codelineno-34-43 name=__codelineno-34-43 href=#__codelineno-34-43></a>    <span class=n>trigger_source</span> <span class=o>=</span> <span class=s2>"scheduler"</span>
</span><span id=__span-34-44><a id=__codelineno-34-44 name=__codelineno-34-44 href=#__codelineno-34-44></a>    <span class=k>if</span> <span class=n>request</span> <span class=ow>and</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=s1>'is_json'</span><span class=p>)</span> <span class=ow>and</span> <span class=n>request</span><span class=o>.</span><span class=n>is_json</span><span class=p>:</span>
</span><span id=__span-34-45><a id=__codelineno-34-45 name=__codelineno-34-45 href=#__codelineno-34-45></a>        <span class=n>data</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>get_json</span><span class=p>()</span>
</span><span id=__span-34-46><a id=__codelineno-34-46 name=__codelineno-34-46 href=#__codelineno-34-46></a>        <span class=k>if</span> <span class=n>data</span> <span class=ow>and</span> <span class=s1>'trigger_source'</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span><span id=__span-34-47><a id=__codelineno-34-47 name=__codelineno-34-47 href=#__codelineno-34-47></a>            <span class=n>trigger_source</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>'trigger_source'</span><span class=p>)</span>
</span><span id=__span-34-48><a id=__codelineno-34-48 name=__codelineno-34-48 href=#__codelineno-34-48></a>
</span><span id=__span-34-49><a id=__codelineno-34-49 name=__codelineno-34-49 href=#__codelineno-34-49></a>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Start triggered by: </span><span class=si>{</span><span class=n>trigger_source</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-34-50><a id=__codelineno-34-50 name=__codelineno-34-50 href=#__codelineno-34-50></a>
</span><span id=__span-34-51><a id=__codelineno-34-51 name=__codelineno-34-51 href=#__codelineno-34-51></a>    <span class=k>try</span><span class=p>:</span>
</span><span id=__span-34-52><a id=__codelineno-34-52 name=__codelineno-34-52 href=#__codelineno-34-52></a>        <span class=c1># Get gcloud path</span>
</span><span id=__span-34-53><a id=__codelineno-34-53 name=__codelineno-34-53 href=#__codelineno-34-53></a>        <span class=n>gcloud_path</span> <span class=o>=</span> <span class=n>get_gcloud_path</span><span class=p>()</span>
</span><span id=__span-34-54><a id=__codelineno-34-54 name=__codelineno-34-54 href=#__codelineno-34-54></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Using gcloud path: </span><span class=si>{</span><span class=n>gcloud_path</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-34-55><a id=__codelineno-34-55 name=__codelineno-34-55 href=#__codelineno-34-55></a>
</span><span id=__span-34-56><a id=__codelineno-34-56 name=__codelineno-34-56 href=#__codelineno-34-56></a>        <span class=c1># Check if instance is running</span>
</span><span id=__span-34-57><a id=__codelineno-34-57 name=__codelineno-34-57 href=#__codelineno-34-57></a>        <span class=n>status_cmd</span> <span class=o>=</span> <span class=p>[</span><span class=n>gcloud_path</span><span class=p>,</span> <span class=s2>"compute"</span><span class=p>,</span> <span class=s2>"instances"</span><span class=p>,</span> <span class=s2>"describe"</span><span class=p>,</span> <span class=n>instance</span><span class=p>,</span>
</span><span id=__span-34-58><a id=__codelineno-34-58 name=__codelineno-34-58 href=#__codelineno-34-58></a>                     <span class=sa>f</span><span class=s2>"--zone=</span><span class=si>{</span><span class=n>zone</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span> <span class=sa>f</span><span class=s2>"--project=</span><span class=si>{</span><span class=n>project</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span>
</span><span id=__span-34-59><a id=__codelineno-34-59 name=__codelineno-34-59 href=#__codelineno-34-59></a>                     <span class=s2>"--format=get(status)"</span><span class=p>]</span>
</span><span id=__span-34-60><a id=__codelineno-34-60 name=__codelineno-34-60 href=#__codelineno-34-60></a>        <span class=n>status</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>status_cmd</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>capture_output</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-34-61><a id=__codelineno-34-61 name=__codelineno-34-61 href=#__codelineno-34-61></a>
</span><span id=__span-34-62><a id=__codelineno-34-62 name=__codelineno-34-62 href=#__codelineno-34-62></a>        <span class=n>is_running</span> <span class=o>=</span> <span class=n>status</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span> <span class=o>==</span> <span class=s2>"RUNNING"</span>
</span><span id=__span-34-63><a id=__codelineno-34-63 name=__codelineno-34-63 href=#__codelineno-34-63></a>
</span><span id=__span-34-64><a id=__codelineno-34-64 name=__codelineno-34-64 href=#__codelineno-34-64></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>is_running</span><span class=p>:</span>
</span><span id=__span-34-65><a id=__codelineno-34-65 name=__codelineno-34-65 href=#__codelineno-34-65></a>            <span class=c1># Start the instance</span>
</span><span id=__span-34-66><a id=__codelineno-34-66 name=__codelineno-34-66 href=#__codelineno-34-66></a>            <span class=n>start_cmd</span> <span class=o>=</span> <span class=p>[</span><span class=n>gcloud_path</span><span class=p>,</span> <span class=s2>"compute"</span><span class=p>,</span> <span class=s2>"instances"</span><span class=p>,</span> <span class=s2>"start"</span><span class=p>,</span> <span class=n>instance</span><span class=p>,</span>
</span><span id=__span-34-67><a id=__codelineno-34-67 name=__codelineno-34-67 href=#__codelineno-34-67></a>                        <span class=sa>f</span><span class=s2>"--zone=</span><span class=si>{</span><span class=n>zone</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span> <span class=sa>f</span><span class=s2>"--project=</span><span class=si>{</span><span class=n>project</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span> <span class=s2>"--quiet"</span><span class=p>]</span>
</span><span id=__span-34-68><a id=__codelineno-34-68 name=__codelineno-34-68 href=#__codelineno-34-68></a>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Starting instance with command: </span><span class=si>{</span><span class=s1>' '</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>start_cmd</span><span class=p>)</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-34-69><a id=__codelineno-34-69 name=__codelineno-34-69 href=#__codelineno-34-69></a>            <span class=n>process</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>start_cmd</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>capture_output</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-34-70><a id=__codelineno-34-70 name=__codelineno-34-70 href=#__codelineno-34-70></a>
</span><span id=__span-34-71><a id=__codelineno-34-71 name=__codelineno-34-71 href=#__codelineno-34-71></a>            <span class=k>if</span> <span class=n>process</span><span class=o>.</span><span class=n>returncode</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-34-72><a id=__codelineno-34-72 name=__codelineno-34-72 href=#__codelineno-34-72></a>                <span class=n>error_msg</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>"Failed to start instance: </span><span class=si>{</span><span class=n>process</span><span class=o>.</span><span class=n>stderr</span><span class=si>}</span><span class=s2>"</span>
</span><span id=__span-34-73><a id=__codelineno-34-73 name=__codelineno-34-73 href=#__codelineno-34-73></a>                <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=n>error_msg</span><span class=p>)</span>
</span><span id=__span-34-74><a id=__codelineno-34-74 name=__codelineno-34-74 href=#__codelineno-34-74></a>                <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s1>'status'</span><span class=p>:</span> <span class=s1>'error'</span><span class=p>,</span> <span class=s1>'message'</span><span class=p>:</span> <span class=n>error_msg</span><span class=p>}),</span> <span class=mi>500</span>
</span><span id=__span-34-75><a id=__codelineno-34-75 name=__codelineno-34-75 href=#__codelineno-34-75></a>
</span><span id=__span-34-76><a id=__codelineno-34-76 name=__codelineno-34-76 href=#__codelineno-34-76></a>            <span class=c1># Wait for VM to be fully started</span>
</span><span id=__span-34-77><a id=__codelineno-34-77 name=__codelineno-34-77 href=#__codelineno-34-77></a>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>"Waiting 90 seconds for VM to be fully ready..."</span><span class=p>)</span>
</span><span id=__span-34-78><a id=__codelineno-34-78 name=__codelineno-34-78 href=#__codelineno-34-78></a>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>90</span><span class=p>)</span>
</span><span id=__span-34-79><a id=__codelineno-34-79 name=__codelineno-34-79 href=#__codelineno-34-79></a>
</span><span id=__span-34-80><a id=__codelineno-34-80 name=__codelineno-34-80 href=#__codelineno-34-80></a>        <span class=c1># Execute startup script</span>
</span><span id=__span-34-81><a id=__codelineno-34-81 name=__codelineno-34-81 href=#__codelineno-34-81></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>"Executing startup script..."</span><span class=p>)</span>
</span><span id=__span-34-82><a id=__codelineno-34-82 name=__codelineno-34-82 href=#__codelineno-34-82></a>        <span class=n>startup_cmd</span> <span class=o>=</span> <span class=p>[</span><span class=n>gcloud_path</span><span class=p>,</span> <span class=s2>"compute"</span><span class=p>,</span> <span class=s2>"ssh"</span><span class=p>,</span> <span class=s2>"--quiet"</span><span class=p>,</span> <span class=sa>f</span><span class=s2>"airflow@</span><span class=si>{</span><span class=n>instance</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span>
</span><span id=__span-34-83><a id=__codelineno-34-83 name=__codelineno-34-83 href=#__codelineno-34-83></a>                      <span class=sa>f</span><span class=s2>"--zone=</span><span class=si>{</span><span class=n>zone</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span> <span class=sa>f</span><span class=s2>"--project=</span><span class=si>{</span><span class=n>project</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span> 
</span><span id=__span-34-84><a id=__codelineno-34-84 name=__codelineno-34-84 href=#__codelineno-34-84></a>                      <span class=s2>"--command"</span><span class=p>,</span> <span class=sa>f</span><span class=s2>"bash /opt/airflow/</span><span class=si>{</span><span class=n>gh_repo</span><span class=si>}</span><span class=s2>/Cloud/infrastructure/terraform/vm_scripts/start_dag.sh"</span><span class=p>]</span>
</span><span id=__span-34-85><a id=__codelineno-34-85 name=__codelineno-34-85 href=#__codelineno-34-85></a>
</span><span id=__span-34-86><a id=__codelineno-34-86 name=__codelineno-34-86 href=#__codelineno-34-86></a>        <span class=n>process</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>startup_cmd</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>capture_output</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-34-87><a id=__codelineno-34-87 name=__codelineno-34-87 href=#__codelineno-34-87></a>
</span><span id=__span-34-88><a id=__codelineno-34-88 name=__codelineno-34-88 href=#__codelineno-34-88></a>        <span class=k>if</span> <span class=n>process</span><span class=o>.</span><span class=n>returncode</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-34-89><a id=__codelineno-34-89 name=__codelineno-34-89 href=#__codelineno-34-89></a>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>"Startup script executed successfully"</span><span class=p>)</span>
</span><span id=__span-34-90><a id=__codelineno-34-90 name=__codelineno-34-90 href=#__codelineno-34-90></a>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Startup stdout: </span><span class=si>{</span><span class=n>process</span><span class=o>.</span><span class=n>stdout</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-34-91><a id=__codelineno-34-91 name=__codelineno-34-91 href=#__codelineno-34-91></a>            <span class=n>msg</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>'Successfully started instance and executed startup script'</span>
</span><span id=__span-34-92><a id=__codelineno-34-92 name=__codelineno-34-92 href=#__codelineno-34-92></a>            <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s1>'status'</span><span class=p>:</span> <span class=s1>'success'</span><span class=p>,</span> <span class=s1>'message'</span><span class=p>:</span> <span class=n>msg</span><span class=p>})</span>
</span><span id=__span-34-93><a id=__codelineno-34-93 name=__codelineno-34-93 href=#__codelineno-34-93></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-34-94><a id=__codelineno-34-94 name=__codelineno-34-94 href=#__codelineno-34-94></a>            <span class=n>error_msg</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>"Startup script failed: </span><span class=si>{</span><span class=n>process</span><span class=o>.</span><span class=n>stderr</span><span class=si>}</span><span class=s2>"</span>
</span><span id=__span-34-95><a id=__codelineno-34-95 name=__codelineno-34-95 href=#__codelineno-34-95></a>            <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=n>error_msg</span><span class=p>)</span>
</span><span id=__span-34-96><a id=__codelineno-34-96 name=__codelineno-34-96 href=#__codelineno-34-96></a>            <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s1>'status'</span><span class=p>:</span> <span class=s1>'error'</span><span class=p>,</span> <span class=s1>'message'</span><span class=p>:</span> <span class=n>error_msg</span><span class=p>}),</span> <span class=mi>500</span>
</span><span id=__span-34-97><a id=__codelineno-34-97 name=__codelineno-34-97 href=#__codelineno-34-97></a>
</span><span id=__span-34-98><a id=__codelineno-34-98 name=__codelineno-34-98 href=#__codelineno-34-98></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-34-99><a id=__codelineno-34-99 name=__codelineno-34-99 href=#__codelineno-34-99></a>        <span class=n>error_msg</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>'Error during startup process: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s1>'</span>
</span><span id=__span-34-100><a id=__codelineno-34-100 name=__codelineno-34-100 href=#__codelineno-34-100></a>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=n>error_msg</span><span class=p>)</span>
</span><span id=__span-34-101><a id=__codelineno-34-101 name=__codelineno-34-101 href=#__codelineno-34-101></a>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Full stack trace: </span><span class=si>{</span><span class=n>traceback</span><span class=o>.</span><span class=n>format_exc</span><span class=p>()</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-34-102><a id=__codelineno-34-102 name=__codelineno-34-102 href=#__codelineno-34-102></a>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s1>'status'</span><span class=p>:</span> <span class=s1>'error'</span><span class=p>,</span> <span class=s1>'message'</span><span class=p>:</span> <span class=n>error_msg</span><span class=p>}),</span> <span class=mi>500</span>
</span></code></pre></div> <h6 id=52-stop-vm>5.2. Stop VM<a class=headerlink href=#52-stop-vm title="Permanent link">¶</a></h6> <p>The Cloud Function to stop the VM is deployed using Cloud Run. This helps automate shutdown processes, reducing costs by powering down unused resources.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=kn>import</span><span class=w> </span><span class=nn>os</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a><span class=kn>import</span><span class=w> </span><span class=nn>json</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=kn>import</span><span class=w> </span><span class=nn>logging</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=kn>import</span><span class=w> </span><span class=nn>subprocess</span>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=kn>from</span><span class=w> </span><span class=nn>flask</span><span class=w> </span><span class=kn>import</span> <span class=n>Flask</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>jsonify</span>
</span><span id=__span-35-6><a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a><span class=kn>import</span><span class=w> </span><span class=nn>platform</span>
</span><span id=__span-35-7><a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a><span class=kn>import</span><span class=w> </span><span class=nn>traceback</span>
</span><span id=__span-35-8><a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a>
</span><span id=__span-35-9><a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a><span class=c1># Create Flask app</span>
</span><span id=__span-35-10><a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a><span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span><span id=__span-35-11><a id=__codelineno-35-11 name=__codelineno-35-11 href=#__codelineno-35-11></a>
</span><span id=__span-35-12><a id=__codelineno-35-12 name=__codelineno-35-12 href=#__codelineno-35-12></a><span class=k>def</span><span class=w> </span><span class=nf>get_gcloud_path</span><span class=p>():</span>
</span><span id=__span-35-13><a id=__codelineno-35-13 name=__codelineno-35-13 href=#__codelineno-35-13></a><span class=w>    </span><span class=sd>"""Get the full path to gcloud executable based on OS"""</span>
</span><span id=__span-35-14><a id=__codelineno-35-14 name=__codelineno-35-14 href=#__codelineno-35-14></a>    <span class=k>if</span> <span class=n>platform</span><span class=o>.</span><span class=n>system</span><span class=p>()</span> <span class=o>==</span> <span class=s2>"Windows"</span><span class=p>:</span>
</span><span id=__span-35-15><a id=__codelineno-35-15 name=__codelineno-35-15 href=#__codelineno-35-15></a>        <span class=c1># Common installation paths for gcloud on Windows</span>
</span><span id=__span-35-16><a id=__codelineno-35-16 name=__codelineno-35-16 href=#__codelineno-35-16></a>        <span class=n>possible_paths</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-35-17><a id=__codelineno-35-17 name=__codelineno-35-17 href=#__codelineno-35-17></a>            <span class=sa>r</span><span class=s2>"C:\Program Files (x86)\Google\Cloud SDK\google-cloud-sdk\bin\gcloud.cmd"</span><span class=p>,</span>
</span><span id=__span-35-18><a id=__codelineno-35-18 name=__codelineno-35-18 href=#__codelineno-35-18></a>            <span class=sa>r</span><span class=s2>"C:\Program Files\Google\Cloud SDK\google-cloud-sdk\bin\gcloud.cmd"</span><span class=p>,</span>
</span><span id=__span-35-19><a id=__codelineno-35-19 name=__codelineno-35-19 href=#__codelineno-35-19></a>            <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>expanduser</span><span class=p>(</span><span class=s2>"~"</span><span class=p>)</span> <span class=o>+</span> <span class=sa>r</span><span class=s2>"\AppData\Local\Google\Cloud SDK\google-cloud-sdk\bin\gcloud.cmd"</span>
</span><span id=__span-35-20><a id=__codelineno-35-20 name=__codelineno-35-20 href=#__codelineno-35-20></a>        <span class=p>]</span>
</span><span id=__span-35-21><a id=__codelineno-35-21 name=__codelineno-35-21 href=#__codelineno-35-21></a>        <span class=k>for</span> <span class=n>path</span> <span class=ow>in</span> <span class=n>possible_paths</span><span class=p>:</span>
</span><span id=__span-35-22><a id=__codelineno-35-22 name=__codelineno-35-22 href=#__codelineno-35-22></a>            <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>path</span><span class=p>):</span>
</span><span id=__span-35-23><a id=__codelineno-35-23 name=__codelineno-35-23 href=#__codelineno-35-23></a>                <span class=k>return</span> <span class=n>path</span>
</span><span id=__span-35-24><a id=__codelineno-35-24 name=__codelineno-35-24 href=#__codelineno-35-24></a>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>"gcloud not found. Please ensure Google Cloud SDK is installed and in PATH"</span><span class=p>)</span>
</span><span id=__span-35-25><a id=__codelineno-35-25 name=__codelineno-35-25 href=#__codelineno-35-25></a>    <span class=k>return</span> <span class=s2>"gcloud"</span>  <span class=c1># For non-Windows systems, assume it's in PATH</span>
</span><span id=__span-35-26><a id=__codelineno-35-26 name=__codelineno-35-26 href=#__codelineno-35-26></a>
</span><span id=__span-35-27><a id=__codelineno-35-27 name=__codelineno-35-27 href=#__codelineno-35-27></a><span class=nd>@app</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s2>"/"</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s2>"POST"</span><span class=p>])</span>
</span><span id=__span-35-28><a id=__codelineno-35-28 name=__codelineno-35-28 href=#__codelineno-35-28></a><span class=k>def</span><span class=w> </span><span class=nf>stop_vm_http</span><span class=p>():</span>
</span><span id=__span-35-29><a id=__codelineno-35-29 name=__codelineno-35-29 href=#__codelineno-35-29></a><span class=w>    </span><span class=sd>"""</span>
</span><span id=__span-35-30><a id=__codelineno-35-30 name=__codelineno-35-30 href=#__codelineno-35-30></a><span class=sd>    HTTP endpoint for Cloud Run to stop a Compute Engine instance.</span>
</span><span id=__span-35-31><a id=__codelineno-35-31 name=__codelineno-35-31 href=#__codelineno-35-31></a><span class=sd>    Accepts POST requests with optional JSON body:</span>
</span><span id=__span-35-32><a id=__codelineno-35-32 name=__codelineno-35-32 href=#__codelineno-35-32></a><span class=sd>    {'trigger_source': 'scheduler'|'manual'|'dag'}</span>
</span><span id=__span-35-33><a id=__codelineno-35-33 name=__codelineno-35-33 href=#__codelineno-35-33></a><span class=sd>    """</span>
</span><span id=__span-35-34><a id=__codelineno-35-34 name=__codelineno-35-34 href=#__codelineno-35-34></a>    <span class=k>return</span> <span class=n>stop_vm</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span><span id=__span-35-35><a id=__codelineno-35-35 name=__codelineno-35-35 href=#__codelineno-35-35></a>
</span><span id=__span-35-36><a id=__codelineno-35-36 name=__codelineno-35-36 href=#__codelineno-35-36></a><span class=k>def</span><span class=w> </span><span class=nf>stop_vm</span><span class=p>(</span><span class=n>request</span><span class=p>):</span>
</span><span id=__span-35-37><a id=__codelineno-35-37 name=__codelineno-35-37 href=#__codelineno-35-37></a><span class=w>    </span><span class=sd>"""</span>
</span><span id=__span-35-38><a id=__codelineno-35-38 name=__codelineno-35-38 href=#__codelineno-35-38></a><span class=sd>    Function to stop a Compute Engine instance.</span>
</span><span id=__span-35-39><a id=__codelineno-35-39 name=__codelineno-35-39 href=#__codelineno-35-39></a><span class=sd>    Only runs shutdown script if VM is running.</span>
</span><span id=__span-35-40><a id=__codelineno-35-40 name=__codelineno-35-40 href=#__codelineno-35-40></a>
</span><span id=__span-35-41><a id=__codelineno-35-41 name=__codelineno-35-41 href=#__codelineno-35-41></a><span class=sd>    Args:</span>
</span><span id=__span-35-42><a id=__codelineno-35-42 name=__codelineno-35-42 href=#__codelineno-35-42></a><span class=sd>        request (flask.Request): The request object</span>
</span><span id=__span-35-43><a id=__codelineno-35-43 name=__codelineno-35-43 href=#__codelineno-35-43></a><span class=sd>        - If called from manual trigger: expects JSON with {'trigger_source': 'manual'}</span>
</span><span id=__span-35-44><a id=__codelineno-35-44 name=__codelineno-35-44 href=#__codelineno-35-44></a><span class=sd>        - If called from Scheduler: no specific payload needed</span>
</span><span id=__span-35-45><a id=__codelineno-35-45 name=__codelineno-35-45 href=#__codelineno-35-45></a><span class=sd>    Returns:</span>
</span><span id=__span-35-46><a id=__codelineno-35-46 name=__codelineno-35-46 href=#__codelineno-35-46></a><span class=sd>        JSON response with status message</span>
</span><span id=__span-35-47><a id=__codelineno-35-47 name=__codelineno-35-47 href=#__codelineno-35-47></a><span class=sd>    """</span>
</span><span id=__span-35-48><a id=__codelineno-35-48 name=__codelineno-35-48 href=#__codelineno-35-48></a>    <span class=n>project</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>'PROJECT_ID'</span><span class=p>)</span>
</span><span id=__span-35-49><a id=__codelineno-35-49 name=__codelineno-35-49 href=#__codelineno-35-49></a>    <span class=n>zone</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>'ZONE'</span><span class=p>)</span>
</span><span id=__span-35-50><a id=__codelineno-35-50 name=__codelineno-35-50 href=#__codelineno-35-50></a>    <span class=n>instance</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>'INSTANCE'</span><span class=p>)</span>
</span><span id=__span-35-51><a id=__codelineno-35-51 name=__codelineno-35-51 href=#__codelineno-35-51></a>    <span class=n>gh_repo</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>'GH_REPO'</span><span class=p>)</span>
</span><span id=__span-35-52><a id=__codelineno-35-52 name=__codelineno-35-52 href=#__codelineno-35-52></a>
</span><span id=__span-35-53><a id=__codelineno-35-53 name=__codelineno-35-53 href=#__codelineno-35-53></a>    <span class=c1># Setup detailed logging</span>
</span><span id=__span-35-54><a id=__codelineno-35-54 name=__codelineno-35-54 href=#__codelineno-35-54></a>    <span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span>
</span><span id=__span-35-55><a id=__codelineno-35-55 name=__codelineno-35-55 href=#__codelineno-35-55></a>        <span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>,</span>
</span><span id=__span-35-56><a id=__codelineno-35-56 name=__codelineno-35-56 href=#__codelineno-35-56></a>        <span class=nb>format</span><span class=o>=</span><span class=s1>'</span><span class=si>%(asctime)s</span><span class=s1> - </span><span class=si>%(levelname)s</span><span class=s1> - </span><span class=si>%(message)s</span><span class=s1>'</span>
</span><span id=__span-35-57><a id=__codelineno-35-57 name=__codelineno-35-57 href=#__codelineno-35-57></a>    <span class=p>)</span>
</span><span id=__span-35-58><a id=__codelineno-35-58 name=__codelineno-35-58 href=#__codelineno-35-58></a>    <span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span><span id=__span-35-59><a id=__codelineno-35-59 name=__codelineno-35-59 href=#__codelineno-35-59></a>
</span><span id=__span-35-60><a id=__codelineno-35-60 name=__codelineno-35-60 href=#__codelineno-35-60></a>    <span class=c1># Log environment variables (excluding any sensitive data)</span>
</span><span id=__span-35-61><a id=__codelineno-35-61 name=__codelineno-35-61 href=#__codelineno-35-61></a>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Environment: PROJECT_ID=</span><span class=si>{</span><span class=n>project</span><span class=si>}</span><span class=s2>, ZONE=</span><span class=si>{</span><span class=n>zone</span><span class=si>}</span><span class=s2>, INSTANCE=</span><span class=si>{</span><span class=n>instance</span><span class=si>}</span><span class=s2>, GH_REPO=</span><span class=si>{</span><span class=n>gh_repo</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-35-62><a id=__codelineno-35-62 name=__codelineno-35-62 href=#__codelineno-35-62></a>
</span><span id=__span-35-63><a id=__codelineno-35-63 name=__codelineno-35-63 href=#__codelineno-35-63></a>    <span class=c1># Parse request data if present</span>
</span><span id=__span-35-64><a id=__codelineno-35-64 name=__codelineno-35-64 href=#__codelineno-35-64></a>    <span class=n>trigger_source</span> <span class=o>=</span> <span class=s2>"scheduler"</span>
</span><span id=__span-35-65><a id=__codelineno-35-65 name=__codelineno-35-65 href=#__codelineno-35-65></a>    <span class=k>if</span> <span class=n>request</span> <span class=ow>and</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=s1>'is_json'</span><span class=p>)</span> <span class=ow>and</span> <span class=n>request</span><span class=o>.</span><span class=n>is_json</span><span class=p>:</span>
</span><span id=__span-35-66><a id=__codelineno-35-66 name=__codelineno-35-66 href=#__codelineno-35-66></a>        <span class=n>data</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>get_json</span><span class=p>()</span>
</span><span id=__span-35-67><a id=__codelineno-35-67 name=__codelineno-35-67 href=#__codelineno-35-67></a>        <span class=k>if</span> <span class=n>data</span> <span class=ow>and</span> <span class=s1>'trigger_source'</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span><span id=__span-35-68><a id=__codelineno-35-68 name=__codelineno-35-68 href=#__codelineno-35-68></a>            <span class=n>trigger_source</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>'trigger_source'</span><span class=p>)</span>
</span><span id=__span-35-69><a id=__codelineno-35-69 name=__codelineno-35-69 href=#__codelineno-35-69></a>
</span><span id=__span-35-70><a id=__codelineno-35-70 name=__codelineno-35-70 href=#__codelineno-35-70></a>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Shutdown triggered by: </span><span class=si>{</span><span class=n>trigger_source</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-35-71><a id=__codelineno-35-71 name=__codelineno-35-71 href=#__codelineno-35-71></a>
</span><span id=__span-35-72><a id=__codelineno-35-72 name=__codelineno-35-72 href=#__codelineno-35-72></a>    <span class=k>try</span><span class=p>:</span>
</span><span id=__span-35-73><a id=__codelineno-35-73 name=__codelineno-35-73 href=#__codelineno-35-73></a>        <span class=c1># Get gcloud path</span>
</span><span id=__span-35-74><a id=__codelineno-35-74 name=__codelineno-35-74 href=#__codelineno-35-74></a>        <span class=n>gcloud_path</span> <span class=o>=</span> <span class=n>get_gcloud_path</span><span class=p>()</span>
</span><span id=__span-35-75><a id=__codelineno-35-75 name=__codelineno-35-75 href=#__codelineno-35-75></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Using gcloud path: </span><span class=si>{</span><span class=n>gcloud_path</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-35-76><a id=__codelineno-35-76 name=__codelineno-35-76 href=#__codelineno-35-76></a>
</span><span id=__span-35-77><a id=__codelineno-35-77 name=__codelineno-35-77 href=#__codelineno-35-77></a>        <span class=c1># Check if instance is running</span>
</span><span id=__span-35-78><a id=__codelineno-35-78 name=__codelineno-35-78 href=#__codelineno-35-78></a>        <span class=n>status_cmd</span> <span class=o>=</span> <span class=p>[</span><span class=n>gcloud_path</span><span class=p>,</span> <span class=s2>"compute"</span><span class=p>,</span> <span class=s2>"instances"</span><span class=p>,</span> <span class=s2>"describe"</span><span class=p>,</span> <span class=n>instance</span><span class=p>,</span> 
</span><span id=__span-35-79><a id=__codelineno-35-79 name=__codelineno-35-79 href=#__codelineno-35-79></a>                     <span class=sa>f</span><span class=s2>"--zone=</span><span class=si>{</span><span class=n>zone</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span> <span class=sa>f</span><span class=s2>"--project=</span><span class=si>{</span><span class=n>project</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span> 
</span><span id=__span-35-80><a id=__codelineno-35-80 name=__codelineno-35-80 href=#__codelineno-35-80></a>                     <span class=s2>"--format=get(status)"</span><span class=p>]</span>
</span><span id=__span-35-81><a id=__codelineno-35-81 name=__codelineno-35-81 href=#__codelineno-35-81></a>        <span class=n>status</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>status_cmd</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>capture_output</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-35-82><a id=__codelineno-35-82 name=__codelineno-35-82 href=#__codelineno-35-82></a>
</span><span id=__span-35-83><a id=__codelineno-35-83 name=__codelineno-35-83 href=#__codelineno-35-83></a>        <span class=n>is_running</span> <span class=o>=</span> <span class=n>status</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span> <span class=o>==</span> <span class=s2>"RUNNING"</span>
</span><span id=__span-35-84><a id=__codelineno-35-84 name=__codelineno-35-84 href=#__codelineno-35-84></a>
</span><span id=__span-35-85><a id=__codelineno-35-85 name=__codelineno-35-85 href=#__codelineno-35-85></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>is_running</span><span class=p>:</span>
</span><span id=__span-35-86><a id=__codelineno-35-86 name=__codelineno-35-86 href=#__codelineno-35-86></a>            <span class=n>msg</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>'Instance </span><span class=si>{</span><span class=n>instance</span><span class=si>}</span><span class=s1> is already stopped (Triggered by: </span><span class=si>{</span><span class=n>trigger_source</span><span class=si>}</span><span class=s1>)'</span>
</span><span id=__span-35-87><a id=__codelineno-35-87 name=__codelineno-35-87 href=#__codelineno-35-87></a>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
</span><span id=__span-35-88><a id=__codelineno-35-88 name=__codelineno-35-88 href=#__codelineno-35-88></a>            <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s1>'status'</span><span class=p>:</span> <span class=s1>'success'</span><span class=p>,</span> <span class=s1>'message'</span><span class=p>:</span> <span class=n>msg</span><span class=p>})</span>
</span><span id=__span-35-89><a id=__codelineno-35-89 name=__codelineno-35-89 href=#__codelineno-35-89></a>
</span><span id=__span-35-90><a id=__codelineno-35-90 name=__codelineno-35-90 href=#__codelineno-35-90></a>        <span class=c1># Execute shutdown script via SSH since VM is running</span>
</span><span id=__span-35-91><a id=__codelineno-35-91 name=__codelineno-35-91 href=#__codelineno-35-91></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>"Executing shutdown script via SSH..."</span><span class=p>)</span>
</span><span id=__span-35-92><a id=__codelineno-35-92 name=__codelineno-35-92 href=#__codelineno-35-92></a>        <span class=n>shutdown_cmd</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>"bash /opt/airflow/</span><span class=si>{</span><span class=n>gh_repo</span><span class=si>}</span><span class=s2>/Cloud/infrastructure/terraform/vm_scripts/shutdown.sh"</span>
</span><span id=__span-35-93><a id=__codelineno-35-93 name=__codelineno-35-93 href=#__codelineno-35-93></a>        <span class=n>ssh_cmd</span> <span class=o>=</span> <span class=p>[</span><span class=n>gcloud_path</span><span class=p>,</span> <span class=s2>"compute"</span><span class=p>,</span> <span class=s2>"ssh"</span><span class=p>,</span> <span class=s2>"--quiet"</span><span class=p>,</span> <span class=sa>f</span><span class=s2>"airflow@</span><span class=si>{</span><span class=n>instance</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span> 
</span><span id=__span-35-94><a id=__codelineno-35-94 name=__codelineno-35-94 href=#__codelineno-35-94></a>                  <span class=sa>f</span><span class=s2>"--zone=</span><span class=si>{</span><span class=n>zone</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span> <span class=sa>f</span><span class=s2>"--project=</span><span class=si>{</span><span class=n>project</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span> <span class=s2>"--command"</span><span class=p>,</span> <span class=n>shutdown_cmd</span><span class=p>]</span>
</span><span id=__span-35-95><a id=__codelineno-35-95 name=__codelineno-35-95 href=#__codelineno-35-95></a>
</span><span id=__span-35-96><a id=__codelineno-35-96 name=__codelineno-35-96 href=#__codelineno-35-96></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Executing command: </span><span class=si>{</span><span class=s1>' '</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>ssh_cmd</span><span class=p>)</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-35-97><a id=__codelineno-35-97 name=__codelineno-35-97 href=#__codelineno-35-97></a>        <span class=n>process</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>ssh_cmd</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>capture_output</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-35-98><a id=__codelineno-35-98 name=__codelineno-35-98 href=#__codelineno-35-98></a>
</span><span id=__span-35-99><a id=__codelineno-35-99 name=__codelineno-35-99 href=#__codelineno-35-99></a>        <span class=k>if</span> <span class=n>process</span><span class=o>.</span><span class=n>returncode</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-35-100><a id=__codelineno-35-100 name=__codelineno-35-100 href=#__codelineno-35-100></a>            <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>"SSH command failed with return code </span><span class=si>{</span><span class=n>process</span><span class=o>.</span><span class=n>returncode</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-35-101><a id=__codelineno-35-101 name=__codelineno-35-101 href=#__codelineno-35-101></a>            <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>"SSH stderr: </span><span class=si>{</span><span class=n>process</span><span class=o>.</span><span class=n>stderr</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-35-102><a id=__codelineno-35-102 name=__codelineno-35-102 href=#__codelineno-35-102></a>            <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>"SSH stdout: </span><span class=si>{</span><span class=n>process</span><span class=o>.</span><span class=n>stdout</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-35-103><a id=__codelineno-35-103 name=__codelineno-35-103 href=#__codelineno-35-103></a>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Failed to execute shutdown script: </span><span class=si>{</span><span class=n>process</span><span class=o>.</span><span class=n>stderr</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-35-104><a id=__codelineno-35-104 name=__codelineno-35-104 href=#__codelineno-35-104></a>
</span><span id=__span-35-105><a id=__codelineno-35-105 name=__codelineno-35-105 href=#__codelineno-35-105></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>"Shutdown script executed successfully. Stopping instance..."</span><span class=p>)</span>
</span><span id=__span-35-106><a id=__codelineno-35-106 name=__codelineno-35-106 href=#__codelineno-35-106></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"SSH stdout: </span><span class=si>{</span><span class=n>process</span><span class=o>.</span><span class=n>stdout</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-35-107><a id=__codelineno-35-107 name=__codelineno-35-107 href=#__codelineno-35-107></a>
</span><span id=__span-35-108><a id=__codelineno-35-108 name=__codelineno-35-108 href=#__codelineno-35-108></a>        <span class=c1># Stop the instance</span>
</span><span id=__span-35-109><a id=__codelineno-35-109 name=__codelineno-35-109 href=#__codelineno-35-109></a>        <span class=n>stop_cmd</span> <span class=o>=</span> <span class=p>[</span><span class=n>gcloud_path</span><span class=p>,</span> <span class=s2>"compute"</span><span class=p>,</span> <span class=s2>"instances"</span><span class=p>,</span> <span class=s2>"stop"</span><span class=p>,</span> <span class=n>instance</span><span class=p>,</span> 
</span><span id=__span-35-110><a id=__codelineno-35-110 name=__codelineno-35-110 href=#__codelineno-35-110></a>                   <span class=sa>f</span><span class=s2>"--zone=</span><span class=si>{</span><span class=n>zone</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span> <span class=sa>f</span><span class=s2>"--project=</span><span class=si>{</span><span class=n>project</span><span class=si>}</span><span class=s2>"</span><span class=p>,</span> <span class=s2>"--quiet"</span><span class=p>]</span>
</span><span id=__span-35-111><a id=__codelineno-35-111 name=__codelineno-35-111 href=#__codelineno-35-111></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Executing stop command: </span><span class=si>{</span><span class=s1>' '</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>stop_cmd</span><span class=p>)</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-35-112><a id=__codelineno-35-112 name=__codelineno-35-112 href=#__codelineno-35-112></a>        <span class=n>process</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>stop_cmd</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>capture_output</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-35-113><a id=__codelineno-35-113 name=__codelineno-35-113 href=#__codelineno-35-113></a>
</span><span id=__span-35-114><a id=__codelineno-35-114 name=__codelineno-35-114 href=#__codelineno-35-114></a>        <span class=k>if</span> <span class=n>process</span><span class=o>.</span><span class=n>returncode</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-35-115><a id=__codelineno-35-115 name=__codelineno-35-115 href=#__codelineno-35-115></a>            <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Stop command failed with return code </span><span class=si>{</span><span class=n>process</span><span class=o>.</span><span class=n>returncode</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-35-116><a id=__codelineno-35-116 name=__codelineno-35-116 href=#__codelineno-35-116></a>            <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Stop stderr: </span><span class=si>{</span><span class=n>process</span><span class=o>.</span><span class=n>stderr</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-35-117><a id=__codelineno-35-117 name=__codelineno-35-117 href=#__codelineno-35-117></a>            <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Stop stdout: </span><span class=si>{</span><span class=n>process</span><span class=o>.</span><span class=n>stdout</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-35-118><a id=__codelineno-35-118 name=__codelineno-35-118 href=#__codelineno-35-118></a>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Failed to stop instance: </span><span class=si>{</span><span class=n>process</span><span class=o>.</span><span class=n>stderr</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-35-119><a id=__codelineno-35-119 name=__codelineno-35-119 href=#__codelineno-35-119></a>
</span><span id=__span-35-120><a id=__codelineno-35-120 name=__codelineno-35-120 href=#__codelineno-35-120></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Stop command stdout: </span><span class=si>{</span><span class=n>process</span><span class=o>.</span><span class=n>stdout</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-35-121><a id=__codelineno-35-121 name=__codelineno-35-121 href=#__codelineno-35-121></a>        <span class=n>msg</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>'Successfully executed shutdown script and stopped instance </span><span class=si>{</span><span class=n>instance</span><span class=si>}</span><span class=s1> (Triggered by: </span><span class=si>{</span><span class=n>trigger_source</span><span class=si>}</span><span class=s1>)'</span>
</span><span id=__span-35-122><a id=__codelineno-35-122 name=__codelineno-35-122 href=#__codelineno-35-122></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
</span><span id=__span-35-123><a id=__codelineno-35-123 name=__codelineno-35-123 href=#__codelineno-35-123></a>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s1>'status'</span><span class=p>:</span> <span class=s1>'success'</span><span class=p>,</span> <span class=s1>'message'</span><span class=p>:</span> <span class=n>msg</span><span class=p>})</span>
</span><span id=__span-35-124><a id=__codelineno-35-124 name=__codelineno-35-124 href=#__codelineno-35-124></a>
</span><span id=__span-35-125><a id=__codelineno-35-125 name=__codelineno-35-125 href=#__codelineno-35-125></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-35-126><a id=__codelineno-35-126 name=__codelineno-35-126 href=#__codelineno-35-126></a>        <span class=n>error_msg</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>'Error during shutdown process: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s1>'</span>
</span><span id=__span-35-127><a id=__codelineno-35-127 name=__codelineno-35-127 href=#__codelineno-35-127></a>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=n>error_msg</span><span class=p>)</span>
</span><span id=__span-35-128><a id=__codelineno-35-128 name=__codelineno-35-128 href=#__codelineno-35-128></a>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Full stack trace: </span><span class=si>{</span><span class=n>traceback</span><span class=o>.</span><span class=n>format_exc</span><span class=p>()</span><span class=si>}</span><span class=s2>"</span><span class=p>)</span>
</span><span id=__span-35-129><a id=__codelineno-35-129 name=__codelineno-35-129 href=#__codelineno-35-129></a>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s1>'status'</span><span class=p>:</span> <span class=s1>'error'</span><span class=p>,</span> <span class=s1>'message'</span><span class=p>:</span> <span class=n>error_msg</span><span class=p>}),</span> <span class=mi>500</span>
</span><span id=__span-35-130><a id=__codelineno-35-130 name=__codelineno-35-130 href=#__codelineno-35-130></a>
</span><span id=__span-35-131><a id=__codelineno-35-131 name=__codelineno-35-131 href=#__codelineno-35-131></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>"__main__"</span><span class=p>:</span>
</span><span id=__span-35-132><a id=__codelineno-35-132 name=__codelineno-35-132 href=#__codelineno-35-132></a>    <span class=c1># For local testing with Flask</span>
</span><span id=__span-35-133><a id=__codelineno-35-133 name=__codelineno-35-133 href=#__codelineno-35-133></a>    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s2>"0.0.0.0"</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=nb>int</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>"PORT"</span><span class=p>,</span> <span class=mi>9099</span><span class=p>)),</span> <span class=n>debug</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span> 
</span></code></pre></div> <h6 id=53-cloud-scheduler>5.3. Cloud Scheduler<a class=headerlink href=#53-cloud-scheduler title="Permanent link">¶</a></h6> <p>Cloud Scheduler is used to trigger the Cloud Function to start and stop the VM daily at 4:00 PM EST and 6:00 PM EST respectively.</p> <div class="language-terraform highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=c1># Service account for Cloud Scheduler</span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a><span class=kr>resource</span><span class=w> </span><span class=nc>"google_service_account"</span><span class=w> </span><span class=nv>"scheduler_sa"</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a><span class=w>  </span><span class=na>account_id</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s2>"vm-scheduler-sa"</span>
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a><span class=w>  </span><span class=na>display_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"Service Account for VM Scheduler"</span>
</span><span id=__span-36-5><a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a>
</span><span id=__span-36-6><a id=__codelineno-36-6 name=__codelineno-36-6 href=#__codelineno-36-6></a><span class=w>  </span><span class=nb>lifecycle</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-7><a id=__codelineno-36-7 name=__codelineno-36-7 href=#__codelineno-36-7></a><span class=w>    </span><span class=na>ignore_changes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-36-8><a id=__codelineno-36-8 name=__codelineno-36-8 href=#__codelineno-36-8></a><span class=nb>      account_id,</span>
</span><span id=__span-36-9><a id=__codelineno-36-9 name=__codelineno-36-9 href=#__codelineno-36-9></a><span class=nb>      display_name</span>
</span><span id=__span-36-10><a id=__codelineno-36-10 name=__codelineno-36-10 href=#__codelineno-36-10></a><span class=nb>    </span><span class=p>]</span>
</span><span id=__span-36-11><a id=__codelineno-36-11 name=__codelineno-36-11 href=#__codelineno-36-11></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-36-12><a id=__codelineno-36-12 name=__codelineno-36-12 href=#__codelineno-36-12></a><span class=p>}</span>
</span><span id=__span-36-13><a id=__codelineno-36-13 name=__codelineno-36-13 href=#__codelineno-36-13></a>
</span><span id=__span-36-14><a id=__codelineno-36-14 name=__codelineno-36-14 href=#__codelineno-36-14></a><span class=c1># Grant necessary permissions</span>
</span><span id=__span-36-15><a id=__codelineno-36-15 name=__codelineno-36-15 href=#__codelineno-36-15></a><span class=kr>resource</span><span class=w> </span><span class=nc>"google_project_iam_member"</span><span class=w> </span><span class=nv>"scheduler_sa_compute_admin"</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-16><a id=__codelineno-36-16 name=__codelineno-36-16 href=#__codelineno-36-16></a><span class=w>  </span><span class=na>project</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>var.project</span>
</span><span id=__span-36-17><a id=__codelineno-36-17 name=__codelineno-36-17 href=#__codelineno-36-17></a><span class=w>  </span><span class=na>role</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=s2>"roles/compute.instanceAdmin.v1"</span>
</span><span id=__span-36-18><a id=__codelineno-36-18 name=__codelineno-36-18 href=#__codelineno-36-18></a><span class=w>  </span><span class=na>member</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=s2>"serviceAccount:${google_service_account.scheduler_sa.email}"</span>
</span><span id=__span-36-19><a id=__codelineno-36-19 name=__codelineno-36-19 href=#__codelineno-36-19></a><span class=p>}</span>
</span><span id=__span-36-20><a id=__codelineno-36-20 name=__codelineno-36-20 href=#__codelineno-36-20></a>
</span><span id=__span-36-21><a id=__codelineno-36-21 name=__codelineno-36-21 href=#__codelineno-36-21></a><span class=c1># Cloud Scheduler job for starting VM (4:00 PM EST)</span>
</span><span id=__span-36-22><a id=__codelineno-36-22 name=__codelineno-36-22 href=#__codelineno-36-22></a><span class=kr>resource</span><span class=w> </span><span class=nc>"google_cloud_scheduler_job"</span><span class=w> </span><span class=nv>"start_vm_schedule"</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-23><a id=__codelineno-36-23 name=__codelineno-36-23 href=#__codelineno-36-23></a><span class=w>  </span><span class=na>name</span><span class=w>             </span><span class=o>=</span><span class=w> </span><span class=s2>"start-vm-daily"</span>
</span><span id=__span-36-24><a id=__codelineno-36-24 name=__codelineno-36-24 href=#__codelineno-36-24></a><span class=w>  </span><span class=na>description</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=s2>"Starts the Airflow VM daily at 4:00 PM EST"</span>
</span><span id=__span-36-25><a id=__codelineno-36-25 name=__codelineno-36-25 href=#__codelineno-36-25></a><span class=w>  </span><span class=na>schedule</span><span class=w>         </span><span class=o>=</span><span class=w> </span><span class=s2>"0 16 * * *"</span><span class=c1>  # 16:00 = 4:00 PM</span>
</span><span id=__span-36-26><a id=__codelineno-36-26 name=__codelineno-36-26 href=#__codelineno-36-26></a><span class=w>  </span><span class=na>time_zone</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=s2>"America/New_York"</span>
</span><span id=__span-36-27><a id=__codelineno-36-27 name=__codelineno-36-27 href=#__codelineno-36-27></a><span class=w>  </span><span class=na>attempt_deadline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"900s"</span><span class=c1>  # 15 minutes</span>
</span><span id=__span-36-28><a id=__codelineno-36-28 name=__codelineno-36-28 href=#__codelineno-36-28></a>
</span><span id=__span-36-29><a id=__codelineno-36-29 name=__codelineno-36-29 href=#__codelineno-36-29></a><span class=w>  </span><span class=nb>http_target</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-30><a id=__codelineno-36-30 name=__codelineno-36-30 href=#__codelineno-36-30></a><span class=w>    </span><span class=na>http_method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"POST"</span>
</span><span id=__span-36-31><a id=__codelineno-36-31 name=__codelineno-36-31 href=#__codelineno-36-31></a><span class=w>    </span><span class=na>uri</span><span class=w>         </span><span class=o>=</span><span class=w> </span><span class=nv>google_cloud_run_service.start_vm.status[0].url</span>
</span><span id=__span-36-32><a id=__codelineno-36-32 name=__codelineno-36-32 href=#__codelineno-36-32></a>
</span><span id=__span-36-33><a id=__codelineno-36-33 name=__codelineno-36-33 href=#__codelineno-36-33></a><span class=w>    </span><span class=na>body</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>base64encode</span><span class=p>(</span><span class=nf>jsonencode</span><span class=p>({</span>
</span><span id=__span-36-34><a id=__codelineno-36-34 name=__codelineno-36-34 href=#__codelineno-36-34></a><span class=w>      </span><span class=na>trigger_source</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"scheduler"</span>
</span><span id=__span-36-35><a id=__codelineno-36-35 name=__codelineno-36-35 href=#__codelineno-36-35></a><span class=w>    </span><span class=p>}))</span>
</span><span id=__span-36-36><a id=__codelineno-36-36 name=__codelineno-36-36 href=#__codelineno-36-36></a>
</span><span id=__span-36-37><a id=__codelineno-36-37 name=__codelineno-36-37 href=#__codelineno-36-37></a><span class=w>    </span><span class=nb>headers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-38><a id=__codelineno-36-38 name=__codelineno-36-38 href=#__codelineno-36-38></a><span class=w>      </span><span class=s2>"Content-Type"</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"application/json"</span>
</span><span id=__span-36-39><a id=__codelineno-36-39 name=__codelineno-36-39 href=#__codelineno-36-39></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-36-40><a id=__codelineno-36-40 name=__codelineno-36-40 href=#__codelineno-36-40></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-36-41><a id=__codelineno-36-41 name=__codelineno-36-41 href=#__codelineno-36-41></a><span class=p>}</span>
</span><span id=__span-36-42><a id=__codelineno-36-42 name=__codelineno-36-42 href=#__codelineno-36-42></a>
</span><span id=__span-36-43><a id=__codelineno-36-43 name=__codelineno-36-43 href=#__codelineno-36-43></a><span class=c1># Cloud Scheduler job for stopping VM (6:00 PM EST)</span>
</span><span id=__span-36-44><a id=__codelineno-36-44 name=__codelineno-36-44 href=#__codelineno-36-44></a><span class=kr>resource</span><span class=w> </span><span class=nc>"google_cloud_scheduler_job"</span><span class=w> </span><span class=nv>"stop_vm_schedule"</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-45><a id=__codelineno-36-45 name=__codelineno-36-45 href=#__codelineno-36-45></a><span class=w>  </span><span class=na>name</span><span class=w>             </span><span class=o>=</span><span class=w> </span><span class=s2>"stop-vm-daily"</span>
</span><span id=__span-36-46><a id=__codelineno-36-46 name=__codelineno-36-46 href=#__codelineno-36-46></a><span class=w>  </span><span class=na>description</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=s2>"Stops the Airflow VM daily at 6:00 PM EST (backup)"</span>
</span><span id=__span-36-47><a id=__codelineno-36-47 name=__codelineno-36-47 href=#__codelineno-36-47></a><span class=w>  </span><span class=na>schedule</span><span class=w>         </span><span class=o>=</span><span class=w> </span><span class=s2>"0 18 * * *"</span><span class=c1>  # 18:00 = 6:00 PM</span>
</span><span id=__span-36-48><a id=__codelineno-36-48 name=__codelineno-36-48 href=#__codelineno-36-48></a><span class=w>  </span><span class=na>time_zone</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=s2>"America/New_York"</span>
</span><span id=__span-36-49><a id=__codelineno-36-49 name=__codelineno-36-49 href=#__codelineno-36-49></a><span class=w>  </span><span class=na>attempt_deadline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"900s"</span><span class=c1>  # 15 minutes</span>
</span><span id=__span-36-50><a id=__codelineno-36-50 name=__codelineno-36-50 href=#__codelineno-36-50></a>
</span><span id=__span-36-51><a id=__codelineno-36-51 name=__codelineno-36-51 href=#__codelineno-36-51></a><span class=w>  </span><span class=nb>http_target</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-52><a id=__codelineno-36-52 name=__codelineno-36-52 href=#__codelineno-36-52></a><span class=w>    </span><span class=na>http_method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"POST"</span>
</span><span id=__span-36-53><a id=__codelineno-36-53 name=__codelineno-36-53 href=#__codelineno-36-53></a><span class=w>    </span><span class=na>uri</span><span class=w>         </span><span class=o>=</span><span class=w> </span><span class=nv>google_cloud_run_service.stop_vm.status[0].url</span>
</span><span id=__span-36-54><a id=__codelineno-36-54 name=__codelineno-36-54 href=#__codelineno-36-54></a>
</span><span id=__span-36-55><a id=__codelineno-36-55 name=__codelineno-36-55 href=#__codelineno-36-55></a><span class=w>    </span><span class=na>body</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>base64encode</span><span class=p>(</span><span class=nf>jsonencode</span><span class=p>({</span>
</span><span id=__span-36-56><a id=__codelineno-36-56 name=__codelineno-36-56 href=#__codelineno-36-56></a><span class=w>      </span><span class=na>trigger_source</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"scheduler"</span>
</span><span id=__span-36-57><a id=__codelineno-36-57 name=__codelineno-36-57 href=#__codelineno-36-57></a><span class=w>    </span><span class=p>}))</span>
</span><span id=__span-36-58><a id=__codelineno-36-58 name=__codelineno-36-58 href=#__codelineno-36-58></a>
</span><span id=__span-36-59><a id=__codelineno-36-59 name=__codelineno-36-59 href=#__codelineno-36-59></a><span class=w>    </span><span class=nb>headers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-60><a id=__codelineno-36-60 name=__codelineno-36-60 href=#__codelineno-36-60></a><span class=w>      </span><span class=s2>"Content-Type"</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"application/json"</span>
</span><span id=__span-36-61><a id=__codelineno-36-61 name=__codelineno-36-61 href=#__codelineno-36-61></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-36-62><a id=__codelineno-36-62 name=__codelineno-36-62 href=#__codelineno-36-62></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-36-63><a id=__codelineno-36-63 name=__codelineno-36-63 href=#__codelineno-36-63></a><span class=p>}</span><span class=w> </span>
</span></code></pre></div> <h4 id=observability-stack>Observability Stack<a class=headerlink href=#observability-stack title="Permanent link">¶</a></h4> <p>We use Grafana, Prometheus, and MLflow for comprehensive pipeline observability, with each component containerized and integrated through a centralized metrics system.</p> <h5 id=1-metrics-collection-architecture>1. Metrics Collection Architecture<a class=headerlink href=#1-metrics-collection-architecture title="Permanent link">¶</a></h5> <p>The metrics collection is structured in layers:</p> <ol> <li> <p><strong>Source Metrics</strong> (via StatsD) </p><div class="language-yaml highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=nt>AIRFLOW__METRICS__STATSD_ON</span><span class=p>:</span><span class=w> </span><span class=s>"true"</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a><span class=nt>AIRFLOW__METRICS__STATSD_HOST</span><span class=p>:</span><span class=w> </span><span class=s>"statsd-exporter"</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a><span class=nt>AIRFLOW__METRICS__STATSD_PORT</span><span class=p>:</span><span class=w> </span><span class=s>"9125"</span>
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a><span class=nt>AIRFLOW__METRICS__STATSD_PREFIX</span><span class=p>:</span><span class=w> </span><span class=s>"airflow"</span>
</span></code></pre></div><p></p> </li> <li> <p><strong>Prometheus Targets</strong> </p><div class="language-yaml highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=nt>scrape_configs</span><span class=p>:</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s>'airflow'</span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=w>    </span><span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>'statsd-exporter:9102'</span><span class="p p-Indicator">]</span>
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s>'redis'</span>
</span><span id=__span-38-5><a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a><span class=w>    </span><span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>'redis-exporter:9121'</span><span class="p p-Indicator">]</span>
</span><span id=__span-38-6><a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s>'postgres'</span>
</span><span id=__span-38-7><a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a><span class=w>    </span><span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>'postgres-exporter:9187'</span><span class="p p-Indicator">]</span>
</span><span id=__span-38-8><a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s>'mlflow'</span>
</span><span id=__span-38-9><a id=__codelineno-38-9 name=__codelineno-38-9 href=#__codelineno-38-9></a><span class=w>    </span><span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>'mlflow:5000'</span><span class="p p-Indicator">]</span>
</span></code></pre></div><p></p> </li> </ol> <h5 id=2-task-specific-metrics>2. Task-Specific Metrics<a class=headerlink href=#2-task-specific-metrics title="Permanent link">¶</a></h5> <p>Each pipeline component has dedicated metrics tracking:</p> <ol> <li> <p><strong>Gemini Analysis Metrics</strong> </p><div class="language-python highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=c1># From log_gemini_metrics.py</span>
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a><span class=n>metrics</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-39-3><a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a>    <span class=s1>'outputs_generated'</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>      <span class=c1># Number of successful analyses</span>
</span><span id=__span-39-4><a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a>    <span class=s1>'subreddits_processed'</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>   <span class=c1># Subreddits completed</span>
</span><span id=__span-39-5><a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a>    <span class=s1>'duration_seconds'</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>       <span class=c1># Processing time</span>
</span><span id=__span-39-6><a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a>    <span class=s1>'attempt'</span><span class=p>:</span> <span class=n>current_attempt</span>   <span class=c1># Retry tracking</span>
</span><span id=__span-39-7><a id=__codelineno-39-7 name=__codelineno-39-7 href=#__codelineno-39-7></a><span class=p>}</span>
</span></code></pre></div><p></p> </li> <li> <p><strong>Sentiment Analysis Performance</strong> </p><div class="language-python highlight"><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a><span class=c1># From log_sentiment_analysis_metrics.py</span>
</span><span id=__span-40-2><a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a><span class=n>metrics</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-40-3><a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a>    <span class=s1>'sentiments_processed'</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>   <span class=c1># Comments analyzed</span>
</span><span id=__span-40-4><a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a>    <span class=s1>'duration_seconds'</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>       <span class=c1># Processing duration</span>
</span><span id=__span-40-5><a id=__codelineno-40-5 name=__codelineno-40-5 href=#__codelineno-40-5></a>    <span class=s1>'attempt'</span><span class=p>:</span> <span class=n>current_attempt</span>   <span class=c1># Execution attempts</span>
</span><span id=__span-40-6><a id=__codelineno-40-6 name=__codelineno-40-6 href=#__codelineno-40-6></a><span class=p>}</span>
</span></code></pre></div><p></p> </li> <li> <p><strong>Pipeline Processing Volumes</strong> </p><div class="language-json highlight"><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=p>{</span>
</span><span id=__span-41-2><a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a><span class=w>  </span><span class=nt>"targets"</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-41-3><a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a><span class=w>    </span><span class=p>{</span><span class=nt>"expr"</span><span class=p>:</span><span class=w> </span><span class=s2>"reddit_ingest_preprocess_posts_total"</span><span class=p>},</span>
</span><span id=__span-41-4><a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a><span class=w>    </span><span class=p>{</span><span class=nt>"expr"</span><span class=p>:</span><span class=w> </span><span class=s2>"reddit_summarize_summaries_added"</span><span class=p>},</span>
</span><span id=__span-41-5><a id=__codelineno-41-5 name=__codelineno-41-5 href=#__codelineno-41-5></a><span class=w>    </span><span class=p>{</span><span class=nt>"expr"</span><span class=p>:</span><span class=w> </span><span class=s2>"reddit_sentiment_processed_total"</span><span class=p>},</span>
</span><span id=__span-41-6><a id=__codelineno-41-6 name=__codelineno-41-6 href=#__codelineno-41-6></a><span class=w>    </span><span class=p>{</span><span class=nt>"expr"</span><span class=p>:</span><span class=w> </span><span class=s2>"reddit_joined_table_rows"</span><span class=p>}</span>
</span><span id=__span-41-7><a id=__codelineno-41-7 name=__codelineno-41-7 href=#__codelineno-41-7></a><span class=w>  </span><span class=p>]</span>
</span><span id=__span-41-8><a id=__codelineno-41-8 name=__codelineno-41-8 href=#__codelineno-41-8></a><span class=p>}</span>
</span></code></pre></div><p></p> </li> </ol> <h5 id=3-performance-dashboards>3. Performance Dashboards<a class=headerlink href=#3-performance-dashboards title="Permanent link">¶</a></h5> <p>Our Grafana dashboard is designed to visualize processing efficiency (task durations, volumes, success rates, resource utilization), data quality (DBT test results, validation metrics, processing status, error rates), and provide real-time monitoring.</p> <h5 id=4-mlflow-integration>4. MLflow Integration<a class=headerlink href=#4-mlflow-integration title="Permanent link">¶</a></h5> <p>MLflow's model versioning, experiment tracking, model serving, and artifact management features aid in model selection by allowing us to identify the best-performing models.</p> <h5 id=5-alert-configuration>5. Alert Configuration<a class=headerlink href=#5-alert-configuration title="Permanent link">¶</a></h5> <p>The system monitors critical thresholds for performance, including task duration, error rate spikes, resource exhaustion, and pipeline stalls. It also monitors quality thresholds, including data validation failures, model performance degradation, processing anomalies, and system health issues</p> <h5 id=6-cloud-monitoring>6. Cloud Monitoring<a class=headerlink href=#6-cloud-monitoring title="Permanent link">¶</a></h5> <p>We use Cloud Monitoring to monitor the health of our VM and Cloud Run service, and to set up alerts for critical issues.</p> <div class="language-terraform highlight"><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=c1># Cloud Monitoring Dashboard</span>
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a><span class=kr>resource</span><span class=w> </span><span class=nc>"google_monitoring_dashboard"</span><span class=w> </span><span class=nv>"airflow_dashboard"</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a><span class=w>  </span><span class=na>dashboard_json</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>jsonencode</span><span class=p>({</span>
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a><span class=w>    </span><span class=na>displayName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"Reddit Pipeline Dashboard"</span>
</span><span id=__span-42-5><a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a><span class=w>    </span><span class=nb>gridLayout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-6><a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a><span class=w>      </span><span class=na>columns</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"2"</span>
</span><span id=__span-42-7><a id=__codelineno-42-7 name=__codelineno-42-7 href=#__codelineno-42-7></a><span class=w>      </span><span class=na>widgets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-42-8><a id=__codelineno-42-8 name=__codelineno-42-8 href=#__codelineno-42-8></a><span class=c1>        # VM Metrics</span>
</span><span id=__span-42-9><a id=__codelineno-42-9 name=__codelineno-42-9 href=#__codelineno-42-9></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-42-10><a id=__codelineno-42-10 name=__codelineno-42-10 href=#__codelineno-42-10></a><span class=w>          </span><span class=na>title</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"VM CPU Utilization"</span>
</span><span id=__span-42-11><a id=__codelineno-42-11 name=__codelineno-42-11 href=#__codelineno-42-11></a><span class=w>          </span><span class=nb>xyChart</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-12><a id=__codelineno-42-12 name=__codelineno-42-12 href=#__codelineno-42-12></a><span class=w>            </span><span class=na>dataSets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[{</span>
</span><span id=__span-42-13><a id=__codelineno-42-13 name=__codelineno-42-13 href=#__codelineno-42-13></a><span class=w>              </span><span class=nb>timeSeriesQuery</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-14><a id=__codelineno-42-14 name=__codelineno-42-14 href=#__codelineno-42-14></a><span class=w>                </span><span class=nb>timeSeriesFilter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-15><a id=__codelineno-42-15 name=__codelineno-42-15 href=#__codelineno-42-15></a><span class=w>                  </span><span class=na>filter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"metric.type=\"compute.googleapis.com/instance/cpu/utilization\" resource.type=\"gce_instance\""</span>
</span><span id=__span-42-16><a id=__codelineno-42-16 name=__codelineno-42-16 href=#__codelineno-42-16></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-42-17><a id=__codelineno-42-17 name=__codelineno-42-17 href=#__codelineno-42-17></a><span class=w>              </span><span class=p>}</span>
</span><span id=__span-42-18><a id=__codelineno-42-18 name=__codelineno-42-18 href=#__codelineno-42-18></a><span class=w>            </span><span class=p>}]</span>
</span><span id=__span-42-19><a id=__codelineno-42-19 name=__codelineno-42-19 href=#__codelineno-42-19></a><span class=w>          </span><span class=p>}</span>
</span><span id=__span-42-20><a id=__codelineno-42-20 name=__codelineno-42-20 href=#__codelineno-42-20></a><span class=w>        </span><span class=p>},</span>
</span><span id=__span-42-21><a id=__codelineno-42-21 name=__codelineno-42-21 href=#__codelineno-42-21></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-42-22><a id=__codelineno-42-22 name=__codelineno-42-22 href=#__codelineno-42-22></a><span class=w>          </span><span class=na>title</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"VM Memory Usage"</span>
</span><span id=__span-42-23><a id=__codelineno-42-23 name=__codelineno-42-23 href=#__codelineno-42-23></a><span class=w>          </span><span class=nb>xyChart</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-24><a id=__codelineno-42-24 name=__codelineno-42-24 href=#__codelineno-42-24></a><span class=w>            </span><span class=na>dataSets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[{</span>
</span><span id=__span-42-25><a id=__codelineno-42-25 name=__codelineno-42-25 href=#__codelineno-42-25></a><span class=w>              </span><span class=nb>timeSeriesQuery</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-26><a id=__codelineno-42-26 name=__codelineno-42-26 href=#__codelineno-42-26></a><span class=w>                </span><span class=nb>timeSeriesFilter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-27><a id=__codelineno-42-27 name=__codelineno-42-27 href=#__codelineno-42-27></a><span class=w>                  </span><span class=na>filter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"metric.type=\"compute.googleapis.com/instance/memory/usage\" resource.type=\"gce_instance\""</span>
</span><span id=__span-42-28><a id=__codelineno-42-28 name=__codelineno-42-28 href=#__codelineno-42-28></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-42-29><a id=__codelineno-42-29 name=__codelineno-42-29 href=#__codelineno-42-29></a><span class=w>              </span><span class=p>}</span>
</span><span id=__span-42-30><a id=__codelineno-42-30 name=__codelineno-42-30 href=#__codelineno-42-30></a><span class=w>            </span><span class=p>}]</span>
</span><span id=__span-42-31><a id=__codelineno-42-31 name=__codelineno-42-31 href=#__codelineno-42-31></a><span class=w>          </span><span class=p>}</span>
</span><span id=__span-42-32><a id=__codelineno-42-32 name=__codelineno-42-32 href=#__codelineno-42-32></a><span class=w>        </span><span class=p>},</span>
</span><span id=__span-42-33><a id=__codelineno-42-33 name=__codelineno-42-33 href=#__codelineno-42-33></a><span class=c1>        # Airflow Task Metrics</span>
</span><span id=__span-42-34><a id=__codelineno-42-34 name=__codelineno-42-34 href=#__codelineno-42-34></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-42-35><a id=__codelineno-42-35 name=__codelineno-42-35 href=#__codelineno-42-35></a><span class=w>          </span><span class=na>title</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"DAG Success Rate"</span>
</span><span id=__span-42-36><a id=__codelineno-42-36 name=__codelineno-42-36 href=#__codelineno-42-36></a><span class=w>          </span><span class=nb>xyChart</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-37><a id=__codelineno-42-37 name=__codelineno-42-37 href=#__codelineno-42-37></a><span class=w>            </span><span class=na>dataSets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[{</span>
</span><span id=__span-42-38><a id=__codelineno-42-38 name=__codelineno-42-38 href=#__codelineno-42-38></a><span class=w>              </span><span class=nb>timeSeriesQuery</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-39><a id=__codelineno-42-39 name=__codelineno-42-39 href=#__codelineno-42-39></a><span class=w>                </span><span class=nb>timeSeriesFilter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-40><a id=__codelineno-42-40 name=__codelineno-42-40 href=#__codelineno-42-40></a><span class=w>                  </span><span class=na>filter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"metric.type=\"custom.googleapis.com/airflow/dag_success_rate\""</span>
</span><span id=__span-42-41><a id=__codelineno-42-41 name=__codelineno-42-41 href=#__codelineno-42-41></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-42-42><a id=__codelineno-42-42 name=__codelineno-42-42 href=#__codelineno-42-42></a><span class=w>              </span><span class=p>}</span>
</span><span id=__span-42-43><a id=__codelineno-42-43 name=__codelineno-42-43 href=#__codelineno-42-43></a><span class=w>            </span><span class=p>}]</span>
</span><span id=__span-42-44><a id=__codelineno-42-44 name=__codelineno-42-44 href=#__codelineno-42-44></a><span class=w>          </span><span class=p>}</span>
</span><span id=__span-42-45><a id=__codelineno-42-45 name=__codelineno-42-45 href=#__codelineno-42-45></a><span class=w>        </span><span class=p>},</span>
</span><span id=__span-42-46><a id=__codelineno-42-46 name=__codelineno-42-46 href=#__codelineno-42-46></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-42-47><a id=__codelineno-42-47 name=__codelineno-42-47 href=#__codelineno-42-47></a><span class=w>          </span><span class=na>title</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"Task Duration"</span>
</span><span id=__span-42-48><a id=__codelineno-42-48 name=__codelineno-42-48 href=#__codelineno-42-48></a><span class=w>          </span><span class=nb>xyChart</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-49><a id=__codelineno-42-49 name=__codelineno-42-49 href=#__codelineno-42-49></a><span class=w>            </span><span class=na>dataSets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[{</span>
</span><span id=__span-42-50><a id=__codelineno-42-50 name=__codelineno-42-50 href=#__codelineno-42-50></a><span class=w>              </span><span class=nb>timeSeriesQuery</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-51><a id=__codelineno-42-51 name=__codelineno-42-51 href=#__codelineno-42-51></a><span class=w>                </span><span class=nb>timeSeriesFilter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-52><a id=__codelineno-42-52 name=__codelineno-42-52 href=#__codelineno-42-52></a><span class=w>                  </span><span class=na>filter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"metric.type=\"custom.googleapis.com/airflow/task_duration\""</span>
</span><span id=__span-42-53><a id=__codelineno-42-53 name=__codelineno-42-53 href=#__codelineno-42-53></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-42-54><a id=__codelineno-42-54 name=__codelineno-42-54 href=#__codelineno-42-54></a><span class=w>              </span><span class=p>}</span>
</span><span id=__span-42-55><a id=__codelineno-42-55 name=__codelineno-42-55 href=#__codelineno-42-55></a><span class=w>            </span><span class=p>}]</span>
</span><span id=__span-42-56><a id=__codelineno-42-56 name=__codelineno-42-56 href=#__codelineno-42-56></a><span class=w>          </span><span class=p>}</span>
</span><span id=__span-42-57><a id=__codelineno-42-57 name=__codelineno-42-57 href=#__codelineno-42-57></a><span class=w>        </span><span class=p>},</span>
</span><span id=__span-42-58><a id=__codelineno-42-58 name=__codelineno-42-58 href=#__codelineno-42-58></a><span class=c1>        # Pipeline Metrics</span>
</span><span id=__span-42-59><a id=__codelineno-42-59 name=__codelineno-42-59 href=#__codelineno-42-59></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-42-60><a id=__codelineno-42-60 name=__codelineno-42-60 href=#__codelineno-42-60></a><span class=w>          </span><span class=na>title</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"Records Processed"</span>
</span><span id=__span-42-61><a id=__codelineno-42-61 name=__codelineno-42-61 href=#__codelineno-42-61></a><span class=w>          </span><span class=nb>xyChart</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-62><a id=__codelineno-42-62 name=__codelineno-42-62 href=#__codelineno-42-62></a><span class=w>            </span><span class=na>dataSets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[{</span>
</span><span id=__span-42-63><a id=__codelineno-42-63 name=__codelineno-42-63 href=#__codelineno-42-63></a><span class=w>              </span><span class=nb>timeSeriesQuery</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-64><a id=__codelineno-42-64 name=__codelineno-42-64 href=#__codelineno-42-64></a><span class=w>                </span><span class=nb>timeSeriesFilter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-65><a id=__codelineno-42-65 name=__codelineno-42-65 href=#__codelineno-42-65></a><span class=w>                  </span><span class=na>filter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"metric.type=\"custom.googleapis.com/reddit/records_processed\""</span>
</span><span id=__span-42-66><a id=__codelineno-42-66 name=__codelineno-42-66 href=#__codelineno-42-66></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-42-67><a id=__codelineno-42-67 name=__codelineno-42-67 href=#__codelineno-42-67></a><span class=w>              </span><span class=p>}</span>
</span><span id=__span-42-68><a id=__codelineno-42-68 name=__codelineno-42-68 href=#__codelineno-42-68></a><span class=w>            </span><span class=p>}]</span>
</span><span id=__span-42-69><a id=__codelineno-42-69 name=__codelineno-42-69 href=#__codelineno-42-69></a><span class=w>          </span><span class=p>}</span>
</span><span id=__span-42-70><a id=__codelineno-42-70 name=__codelineno-42-70 href=#__codelineno-42-70></a><span class=w>        </span><span class=p>},</span>
</span><span id=__span-42-71><a id=__codelineno-42-71 name=__codelineno-42-71 href=#__codelineno-42-71></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-42-72><a id=__codelineno-42-72 name=__codelineno-42-72 href=#__codelineno-42-72></a><span class=w>          </span><span class=na>title</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"Processing Errors"</span>
</span><span id=__span-42-73><a id=__codelineno-42-73 name=__codelineno-42-73 href=#__codelineno-42-73></a><span class=w>          </span><span class=nb>xyChart</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-74><a id=__codelineno-42-74 name=__codelineno-42-74 href=#__codelineno-42-74></a><span class=w>            </span><span class=na>dataSets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[{</span>
</span><span id=__span-42-75><a id=__codelineno-42-75 name=__codelineno-42-75 href=#__codelineno-42-75></a><span class=w>              </span><span class=nb>timeSeriesQuery</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-76><a id=__codelineno-42-76 name=__codelineno-42-76 href=#__codelineno-42-76></a><span class=w>                </span><span class=nb>timeSeriesFilter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-77><a id=__codelineno-42-77 name=__codelineno-42-77 href=#__codelineno-42-77></a><span class=w>                  </span><span class=na>filter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"metric.type=\"custom.googleapis.com/reddit/processing_errors\""</span>
</span><span id=__span-42-78><a id=__codelineno-42-78 name=__codelineno-42-78 href=#__codelineno-42-78></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-42-79><a id=__codelineno-42-79 name=__codelineno-42-79 href=#__codelineno-42-79></a><span class=w>              </span><span class=p>}</span>
</span><span id=__span-42-80><a id=__codelineno-42-80 name=__codelineno-42-80 href=#__codelineno-42-80></a><span class=w>            </span><span class=p>}]</span>
</span><span id=__span-42-81><a id=__codelineno-42-81 name=__codelineno-42-81 href=#__codelineno-42-81></a><span class=w>          </span><span class=p>}</span>
</span><span id=__span-42-82><a id=__codelineno-42-82 name=__codelineno-42-82 href=#__codelineno-42-82></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-42-83><a id=__codelineno-42-83 name=__codelineno-42-83 href=#__codelineno-42-83></a><span class=w>      </span><span class=p>]</span>
</span><span id=__span-42-84><a id=__codelineno-42-84 name=__codelineno-42-84 href=#__codelineno-42-84></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-42-85><a id=__codelineno-42-85 name=__codelineno-42-85 href=#__codelineno-42-85></a><span class=w>  </span><span class=p>})</span>
</span><span id=__span-42-86><a id=__codelineno-42-86 name=__codelineno-42-86 href=#__codelineno-42-86></a><span class=p>}</span>
</span><span id=__span-42-87><a id=__codelineno-42-87 name=__codelineno-42-87 href=#__codelineno-42-87></a>
</span><span id=__span-42-88><a id=__codelineno-42-88 name=__codelineno-42-88 href=#__codelineno-42-88></a><span class=c1># Alert Policies</span>
</span><span id=__span-42-89><a id=__codelineno-42-89 name=__codelineno-42-89 href=#__codelineno-42-89></a><span class=kr>resource</span><span class=w> </span><span class=nc>"google_monitoring_alert_policy"</span><span class=w> </span><span class=nv>"vm_cpu_utilization"</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-90><a id=__codelineno-42-90 name=__codelineno-42-90 href=#__codelineno-42-90></a><span class=w>  </span><span class=na>display_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"High CPU Utilization Alert"</span>
</span><span id=__span-42-91><a id=__codelineno-42-91 name=__codelineno-42-91 href=#__codelineno-42-91></a><span class=w>  </span><span class=na>combiner</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=s2>"OR"</span>
</span><span id=__span-42-92><a id=__codelineno-42-92 name=__codelineno-42-92 href=#__codelineno-42-92></a><span class=w>  </span><span class=nb>conditions</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-93><a id=__codelineno-42-93 name=__codelineno-42-93 href=#__codelineno-42-93></a><span class=w>    </span><span class=na>display_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"CPU Usage &gt; 80%"</span>
</span><span id=__span-42-94><a id=__codelineno-42-94 name=__codelineno-42-94 href=#__codelineno-42-94></a><span class=w>    </span><span class=nb>condition_threshold</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-95><a id=__codelineno-42-95 name=__codelineno-42-95 href=#__codelineno-42-95></a><span class=w>      </span><span class=na>filter</span><span class=w>          </span><span class=o>=</span><span class=w> </span><span class=s2>"metric.type=\"compute.googleapis.com/instance/cpu/utilization\" resource.type=\"gce_instance\""</span>
</span><span id=__span-42-96><a id=__codelineno-42-96 name=__codelineno-42-96 href=#__codelineno-42-96></a><span class=w>      </span><span class=na>duration</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=s2>"300s"</span>
</span><span id=__span-42-97><a id=__codelineno-42-97 name=__codelineno-42-97 href=#__codelineno-42-97></a><span class=w>      </span><span class=na>comparison</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=s2>"COMPARISON_GT"</span>
</span><span id=__span-42-98><a id=__codelineno-42-98 name=__codelineno-42-98 href=#__codelineno-42-98></a><span class=w>      </span><span class=na>threshold_value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>0.8</span>
</span><span id=__span-42-99><a id=__codelineno-42-99 name=__codelineno-42-99 href=#__codelineno-42-99></a><span class=w>      </span><span class=nb>trigger</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-100><a id=__codelineno-42-100 name=__codelineno-42-100 href=#__codelineno-42-100></a><span class=w>        </span><span class=na>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>1</span>
</span><span id=__span-42-101><a id=__codelineno-42-101 name=__codelineno-42-101 href=#__codelineno-42-101></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-42-102><a id=__codelineno-42-102 name=__codelineno-42-102 href=#__codelineno-42-102></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-42-103><a id=__codelineno-42-103 name=__codelineno-42-103 href=#__codelineno-42-103></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-42-104><a id=__codelineno-42-104 name=__codelineno-42-104 href=#__codelineno-42-104></a><span class=w>  </span><span class=na>notification_channels</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=nv>google_monitoring_notification_channel.email.id</span><span class=p>]</span>
</span><span id=__span-42-105><a id=__codelineno-42-105 name=__codelineno-42-105 href=#__codelineno-42-105></a><span class=p>}</span>
</span><span id=__span-42-106><a id=__codelineno-42-106 name=__codelineno-42-106 href=#__codelineno-42-106></a>
</span><span id=__span-42-107><a id=__codelineno-42-107 name=__codelineno-42-107 href=#__codelineno-42-107></a><span class=kr>resource</span><span class=w> </span><span class=nc>"google_monitoring_alert_policy"</span><span class=w> </span><span class=nv>"airflow_task_failures"</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-108><a id=__codelineno-42-108 name=__codelineno-42-108 href=#__codelineno-42-108></a><span class=w>  </span><span class=na>display_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"Airflow Task Failures Alert"</span>
</span><span id=__span-42-109><a id=__codelineno-42-109 name=__codelineno-42-109 href=#__codelineno-42-109></a><span class=w>  </span><span class=na>combiner</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=s2>"OR"</span>
</span><span id=__span-42-110><a id=__codelineno-42-110 name=__codelineno-42-110 href=#__codelineno-42-110></a><span class=w>  </span><span class=nb>conditions</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-111><a id=__codelineno-42-111 name=__codelineno-42-111 href=#__codelineno-42-111></a><span class=w>    </span><span class=na>display_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"Task Failure Rate &gt; 20%"</span>
</span><span id=__span-42-112><a id=__codelineno-42-112 name=__codelineno-42-112 href=#__codelineno-42-112></a><span class=w>    </span><span class=nb>condition_threshold</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-113><a id=__codelineno-42-113 name=__codelineno-42-113 href=#__codelineno-42-113></a><span class=w>      </span><span class=na>filter</span><span class=w>          </span><span class=o>=</span><span class=w> </span><span class=s2>"metric.type=\"${google_monitoring_metric_descriptor.airflow_task_failure_rate.type}\" AND resource.type=\"gce_instance\""</span>
</span><span id=__span-42-114><a id=__codelineno-42-114 name=__codelineno-42-114 href=#__codelineno-42-114></a><span class=w>      </span><span class=na>duration</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=s2>"300s"</span>
</span><span id=__span-42-115><a id=__codelineno-42-115 name=__codelineno-42-115 href=#__codelineno-42-115></a><span class=w>      </span><span class=na>comparison</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=s2>"COMPARISON_GT"</span>
</span><span id=__span-42-116><a id=__codelineno-42-116 name=__codelineno-42-116 href=#__codelineno-42-116></a><span class=w>      </span><span class=na>threshold_value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>0.2</span>
</span><span id=__span-42-117><a id=__codelineno-42-117 name=__codelineno-42-117 href=#__codelineno-42-117></a><span class=w>      </span><span class=nb>trigger</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-118><a id=__codelineno-42-118 name=__codelineno-42-118 href=#__codelineno-42-118></a><span class=w>        </span><span class=na>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>1</span>
</span><span id=__span-42-119><a id=__codelineno-42-119 name=__codelineno-42-119 href=#__codelineno-42-119></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-42-120><a id=__codelineno-42-120 name=__codelineno-42-120 href=#__codelineno-42-120></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-42-121><a id=__codelineno-42-121 name=__codelineno-42-121 href=#__codelineno-42-121></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-42-122><a id=__codelineno-42-122 name=__codelineno-42-122 href=#__codelineno-42-122></a><span class=w>  </span><span class=na>notification_channels</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=nv>google_monitoring_notification_channel.email.id</span><span class=p>]</span>
</span><span id=__span-42-123><a id=__codelineno-42-123 name=__codelineno-42-123 href=#__codelineno-42-123></a><span class=w>  </span><span class=na>enabled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-42-124><a id=__codelineno-42-124 name=__codelineno-42-124 href=#__codelineno-42-124></a><span class=w>  </span><span class=na>depends_on</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=nv>google_monitoring_metric_descriptor.airflow_task_failure_rate</span><span class=p>]</span>
</span><span id=__span-42-125><a id=__codelineno-42-125 name=__codelineno-42-125 href=#__codelineno-42-125></a><span class=p>}</span>
</span><span id=__span-42-126><a id=__codelineno-42-126 name=__codelineno-42-126 href=#__codelineno-42-126></a>
</span><span id=__span-42-127><a id=__codelineno-42-127 name=__codelineno-42-127 href=#__codelineno-42-127></a><span class=kr>resource</span><span class=w> </span><span class=nc>"google_monitoring_alert_policy"</span><span class=w> </span><span class=nv>"pipeline_errors"</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-128><a id=__codelineno-42-128 name=__codelineno-42-128 href=#__codelineno-42-128></a><span class=w>  </span><span class=na>display_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"Pipeline Processing Errors Alert"</span>
</span><span id=__span-42-129><a id=__codelineno-42-129 name=__codelineno-42-129 href=#__codelineno-42-129></a><span class=w>  </span><span class=na>combiner</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=s2>"OR"</span>
</span><span id=__span-42-130><a id=__codelineno-42-130 name=__codelineno-42-130 href=#__codelineno-42-130></a><span class=w>  </span><span class=nb>conditions</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-131><a id=__codelineno-42-131 name=__codelineno-42-131 href=#__codelineno-42-131></a><span class=w>    </span><span class=na>display_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"Processing Error Rate"</span>
</span><span id=__span-42-132><a id=__codelineno-42-132 name=__codelineno-42-132 href=#__codelineno-42-132></a><span class=w>    </span><span class=nb>condition_threshold</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-133><a id=__codelineno-42-133 name=__codelineno-42-133 href=#__codelineno-42-133></a><span class=w>      </span><span class=na>filter</span><span class=w>          </span><span class=o>=</span><span class=w> </span><span class=s2>"metric.type=\"${google_monitoring_metric_descriptor.processing_errors.type}\" AND resource.type=\"gce_instance\""</span>
</span><span id=__span-42-134><a id=__codelineno-42-134 name=__codelineno-42-134 href=#__codelineno-42-134></a><span class=w>      </span><span class=na>duration</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=s2>"300s"</span>
</span><span id=__span-42-135><a id=__codelineno-42-135 name=__codelineno-42-135 href=#__codelineno-42-135></a><span class=w>      </span><span class=na>comparison</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=s2>"COMPARISON_GT"</span>
</span><span id=__span-42-136><a id=__codelineno-42-136 name=__codelineno-42-136 href=#__codelineno-42-136></a><span class=w>      </span><span class=na>threshold_value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>10</span>
</span><span id=__span-42-137><a id=__codelineno-42-137 name=__codelineno-42-137 href=#__codelineno-42-137></a><span class=w>      </span><span class=nb>trigger</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-138><a id=__codelineno-42-138 name=__codelineno-42-138 href=#__codelineno-42-138></a><span class=w>        </span><span class=na>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>1</span>
</span><span id=__span-42-139><a id=__codelineno-42-139 name=__codelineno-42-139 href=#__codelineno-42-139></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-42-140><a id=__codelineno-42-140 name=__codelineno-42-140 href=#__codelineno-42-140></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-42-141><a id=__codelineno-42-141 name=__codelineno-42-141 href=#__codelineno-42-141></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-42-142><a id=__codelineno-42-142 name=__codelineno-42-142 href=#__codelineno-42-142></a><span class=w>  </span><span class=na>notification_channels</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=nv>google_monitoring_notification_channel.email.id</span><span class=p>]</span>
</span><span id=__span-42-143><a id=__codelineno-42-143 name=__codelineno-42-143 href=#__codelineno-42-143></a><span class=w>  </span><span class=na>enabled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-42-144><a id=__codelineno-42-144 name=__codelineno-42-144 href=#__codelineno-42-144></a><span class=w>  </span><span class=na>depends_on</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=nv>google_monitoring_metric_descriptor.processing_errors</span><span class=p>]</span>
</span><span id=__span-42-145><a id=__codelineno-42-145 name=__codelineno-42-145 href=#__codelineno-42-145></a><span class=p>}</span>
</span><span id=__span-42-146><a id=__codelineno-42-146 name=__codelineno-42-146 href=#__codelineno-42-146></a>
</span><span id=__span-42-147><a id=__codelineno-42-147 name=__codelineno-42-147 href=#__codelineno-42-147></a><span class=kr>resource</span><span class=w> </span><span class=nc>"google_monitoring_alert_policy"</span><span class=w> </span><span class=nv>"vm_automation"</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-148><a id=__codelineno-42-148 name=__codelineno-42-148 href=#__codelineno-42-148></a><span class=w>  </span><span class=na>display_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"VM Automation Alert"</span>
</span><span id=__span-42-149><a id=__codelineno-42-149 name=__codelineno-42-149 href=#__codelineno-42-149></a><span class=w>  </span><span class=na>combiner</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=s2>"OR"</span>
</span><span id=__span-42-150><a id=__codelineno-42-150 name=__codelineno-42-150 href=#__codelineno-42-150></a><span class=w>  </span><span class=nb>conditions</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-151><a id=__codelineno-42-151 name=__codelineno-42-151 href=#__codelineno-42-151></a><span class=w>    </span><span class=na>display_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"VM Start/Stop Failures"</span>
</span><span id=__span-42-152><a id=__codelineno-42-152 name=__codelineno-42-152 href=#__codelineno-42-152></a><span class=w>    </span><span class=nb>condition_threshold</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-153><a id=__codelineno-42-153 name=__codelineno-42-153 href=#__codelineno-42-153></a><span class=w>      </span><span class=na>filter</span><span class=w>          </span><span class=o>=</span><span class=w> </span><span class=s2>"metric.type=\"${google_monitoring_metric_descriptor.vm_automation_failures.type}\" AND resource.type=\"gce_instance\""</span>
</span><span id=__span-42-154><a id=__codelineno-42-154 name=__codelineno-42-154 href=#__codelineno-42-154></a><span class=w>      </span><span class=na>duration</span><span class=w>        </span><span class=o>=</span><span class=w> </span><span class=s2>"0s"</span>
</span><span id=__span-42-155><a id=__codelineno-42-155 name=__codelineno-42-155 href=#__codelineno-42-155></a><span class=w>      </span><span class=na>comparison</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=s2>"COMPARISON_GT"</span>
</span><span id=__span-42-156><a id=__codelineno-42-156 name=__codelineno-42-156 href=#__codelineno-42-156></a><span class=w>      </span><span class=na>threshold_value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>0</span>
</span><span id=__span-42-157><a id=__codelineno-42-157 name=__codelineno-42-157 href=#__codelineno-42-157></a><span class=w>      </span><span class=nb>trigger</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-158><a id=__codelineno-42-158 name=__codelineno-42-158 href=#__codelineno-42-158></a><span class=w>        </span><span class=na>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>1</span>
</span><span id=__span-42-159><a id=__codelineno-42-159 name=__codelineno-42-159 href=#__codelineno-42-159></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-42-160><a id=__codelineno-42-160 name=__codelineno-42-160 href=#__codelineno-42-160></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-42-161><a id=__codelineno-42-161 name=__codelineno-42-161 href=#__codelineno-42-161></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-42-162><a id=__codelineno-42-162 name=__codelineno-42-162 href=#__codelineno-42-162></a><span class=w>  </span><span class=na>notification_channels</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=nv>google_monitoring_notification_channel.email.id</span><span class=p>]</span>
</span><span id=__span-42-163><a id=__codelineno-42-163 name=__codelineno-42-163 href=#__codelineno-42-163></a><span class=w>  </span><span class=na>enabled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>true</span>
</span><span id=__span-42-164><a id=__codelineno-42-164 name=__codelineno-42-164 href=#__codelineno-42-164></a><span class=w>  </span><span class=na>depends_on</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=nv>google_monitoring_metric_descriptor.vm_automation_failures</span><span class=p>]</span>
</span><span id=__span-42-165><a id=__codelineno-42-165 name=__codelineno-42-165 href=#__codelineno-42-165></a><span class=p>}</span>
</span><span id=__span-42-166><a id=__codelineno-42-166 name=__codelineno-42-166 href=#__codelineno-42-166></a>
</span><span id=__span-42-167><a id=__codelineno-42-167 name=__codelineno-42-167 href=#__codelineno-42-167></a><span class=c1># Notification Channels</span>
</span><span id=__span-42-168><a id=__codelineno-42-168 name=__codelineno-42-168 href=#__codelineno-42-168></a><span class=kr>resource</span><span class=w> </span><span class=nc>"google_monitoring_notification_channel"</span><span class=w> </span><span class=nv>"email"</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-169><a id=__codelineno-42-169 name=__codelineno-42-169 href=#__codelineno-42-169></a><span class=w>  </span><span class=na>display_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"Email Notification Channel"</span>
</span><span id=__span-42-170><a id=__codelineno-42-170 name=__codelineno-42-170 href=#__codelineno-42-170></a><span class=w>  </span><span class=na>type</span><span class=w>         </span><span class=o>=</span><span class=w> </span><span class=s2>"email"</span>
</span><span id=__span-42-171><a id=__codelineno-42-171 name=__codelineno-42-171 href=#__codelineno-42-171></a><span class=w>  </span><span class=nb>labels</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-172><a id=__codelineno-42-172 name=__codelineno-42-172 href=#__codelineno-42-172></a><span class=w>    </span><span class=na>email_address</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>var.alert_email_address</span>
</span><span id=__span-42-173><a id=__codelineno-42-173 name=__codelineno-42-173 href=#__codelineno-42-173></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-42-174><a id=__codelineno-42-174 name=__codelineno-42-174 href=#__codelineno-42-174></a><span class=p>}</span>
</span><span id=__span-42-175><a id=__codelineno-42-175 name=__codelineno-42-175 href=#__codelineno-42-175></a>
</span><span id=__span-42-176><a id=__codelineno-42-176 name=__codelineno-42-176 href=#__codelineno-42-176></a><span class=c1># Optional: Slack notification channel</span>
</span><span id=__span-42-177><a id=__codelineno-42-177 name=__codelineno-42-177 href=#__codelineno-42-177></a><span class=kr>resource</span><span class=w> </span><span class=nc>"google_monitoring_notification_channel"</span><span class=w> </span><span class=nv>"slack"</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-178><a id=__codelineno-42-178 name=__codelineno-42-178 href=#__codelineno-42-178></a><span class=w>  </span><span class=na>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>var.slack_webhook_url</span><span class=w> </span><span class=p>!=</span><span class=w> </span><span class=s2>""</span><span class=w> </span><span class=p>?</span><span class=w> </span><span class=m>1</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=m>0</span>
</span><span id=__span-42-179><a id=__codelineno-42-179 name=__codelineno-42-179 href=#__codelineno-42-179></a>
</span><span id=__span-42-180><a id=__codelineno-42-180 name=__codelineno-42-180 href=#__codelineno-42-180></a><span class=w>  </span><span class=na>display_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"Slack Notification Channel"</span>
</span><span id=__span-42-181><a id=__codelineno-42-181 name=__codelineno-42-181 href=#__codelineno-42-181></a><span class=w>  </span><span class=na>type</span><span class=w>         </span><span class=o>=</span><span class=w> </span><span class=s2>"slack"</span>
</span><span id=__span-42-182><a id=__codelineno-42-182 name=__codelineno-42-182 href=#__codelineno-42-182></a><span class=w>  </span><span class=nb>labels</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-183><a id=__codelineno-42-183 name=__codelineno-42-183 href=#__codelineno-42-183></a><span class=w>    </span><span class=na>channel_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"#airflow-alerts"</span>
</span><span id=__span-42-184><a id=__codelineno-42-184 name=__codelineno-42-184 href=#__codelineno-42-184></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-42-185><a id=__codelineno-42-185 name=__codelineno-42-185 href=#__codelineno-42-185></a><span class=w>  </span><span class=nb>sensitive_labels</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-186><a id=__codelineno-42-186 name=__codelineno-42-186 href=#__codelineno-42-186></a><span class=w>    </span><span class=na>auth_token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>var.slack_webhook_url</span>
</span><span id=__span-42-187><a id=__codelineno-42-187 name=__codelineno-42-187 href=#__codelineno-42-187></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-42-188><a id=__codelineno-42-188 name=__codelineno-42-188 href=#__codelineno-42-188></a><span class=p>}</span>
</span><span id=__span-42-189><a id=__codelineno-42-189 name=__codelineno-42-189 href=#__codelineno-42-189></a>
</span><span id=__span-42-190><a id=__codelineno-42-190 name=__codelineno-42-190 href=#__codelineno-42-190></a><span class=c1># First, define the custom metric descriptors</span>
</span><span id=__span-42-191><a id=__codelineno-42-191 name=__codelineno-42-191 href=#__codelineno-42-191></a><span class=kr>resource</span><span class=w> </span><span class=nc>"google_monitoring_metric_descriptor"</span><span class=w> </span><span class=nv>"airflow_task_failure_rate"</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-192><a id=__codelineno-42-192 name=__codelineno-42-192 href=#__codelineno-42-192></a><span class=w>  </span><span class=na>description</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"Rate of Airflow task failures"</span>
</span><span id=__span-42-193><a id=__codelineno-42-193 name=__codelineno-42-193 href=#__codelineno-42-193></a><span class=w>  </span><span class=na>display_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"Airflow Task Failure Rate"</span>
</span><span id=__span-42-194><a id=__codelineno-42-194 name=__codelineno-42-194 href=#__codelineno-42-194></a><span class=w>  </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"custom.googleapis.com/airflow/task_failure_rate"</span>
</span><span id=__span-42-195><a id=__codelineno-42-195 name=__codelineno-42-195 href=#__codelineno-42-195></a><span class=w>  </span><span class=na>metric_kind</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"GAUGE"</span>
</span><span id=__span-42-196><a id=__codelineno-42-196 name=__codelineno-42-196 href=#__codelineno-42-196></a><span class=w>  </span><span class=na>value_type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"DOUBLE"</span>
</span><span id=__span-42-197><a id=__codelineno-42-197 name=__codelineno-42-197 href=#__codelineno-42-197></a><span class=w>  </span><span class=na>unit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"1"</span>
</span><span id=__span-42-198><a id=__codelineno-42-198 name=__codelineno-42-198 href=#__codelineno-42-198></a><span class=w>  </span><span class=nb>labels</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-199><a id=__codelineno-42-199 name=__codelineno-42-199 href=#__codelineno-42-199></a><span class=w>    </span><span class=na>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"task_id"</span>
</span><span id=__span-42-200><a id=__codelineno-42-200 name=__codelineno-42-200 href=#__codelineno-42-200></a><span class=w>    </span><span class=na>value_type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"STRING"</span>
</span><span id=__span-42-201><a id=__codelineno-42-201 name=__codelineno-42-201 href=#__codelineno-42-201></a><span class=w>    </span><span class=na>description</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"The ID of the Airflow task"</span>
</span><span id=__span-42-202><a id=__codelineno-42-202 name=__codelineno-42-202 href=#__codelineno-42-202></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-42-203><a id=__codelineno-42-203 name=__codelineno-42-203 href=#__codelineno-42-203></a><span class=p>}</span>
</span><span id=__span-42-204><a id=__codelineno-42-204 name=__codelineno-42-204 href=#__codelineno-42-204></a>
</span><span id=__span-42-205><a id=__codelineno-42-205 name=__codelineno-42-205 href=#__codelineno-42-205></a><span class=kr>resource</span><span class=w> </span><span class=nc>"google_monitoring_metric_descriptor"</span><span class=w> </span><span class=nv>"processing_errors"</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-206><a id=__codelineno-42-206 name=__codelineno-42-206 href=#__codelineno-42-206></a><span class=w>  </span><span class=na>description</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"Number of processing errors in the pipeline"</span>
</span><span id=__span-42-207><a id=__codelineno-42-207 name=__codelineno-42-207 href=#__codelineno-42-207></a><span class=w>  </span><span class=na>display_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"Pipeline Processing Errors"</span>
</span><span id=__span-42-208><a id=__codelineno-42-208 name=__codelineno-42-208 href=#__codelineno-42-208></a><span class=w>  </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"custom.googleapis.com/reddit/processing_errors"</span>
</span><span id=__span-42-209><a id=__codelineno-42-209 name=__codelineno-42-209 href=#__codelineno-42-209></a><span class=w>  </span><span class=na>metric_kind</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"GAUGE"</span>
</span><span id=__span-42-210><a id=__codelineno-42-210 name=__codelineno-42-210 href=#__codelineno-42-210></a><span class=w>  </span><span class=na>value_type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"INT64"</span>
</span><span id=__span-42-211><a id=__codelineno-42-211 name=__codelineno-42-211 href=#__codelineno-42-211></a><span class=w>  </span><span class=na>unit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"1"</span>
</span><span id=__span-42-212><a id=__codelineno-42-212 name=__codelineno-42-212 href=#__codelineno-42-212></a><span class=p>}</span>
</span><span id=__span-42-213><a id=__codelineno-42-213 name=__codelineno-42-213 href=#__codelineno-42-213></a>
</span><span id=__span-42-214><a id=__codelineno-42-214 name=__codelineno-42-214 href=#__codelineno-42-214></a><span class=kr>resource</span><span class=w> </span><span class=nc>"google_monitoring_metric_descriptor"</span><span class=w> </span><span class=nv>"vm_automation_failures"</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-215><a id=__codelineno-42-215 name=__codelineno-42-215 href=#__codelineno-42-215></a><span class=w>  </span><span class=na>description</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"Number of VM automation failures"</span>
</span><span id=__span-42-216><a id=__codelineno-42-216 name=__codelineno-42-216 href=#__codelineno-42-216></a><span class=w>  </span><span class=na>display_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"VM Automation Failures"</span>
</span><span id=__span-42-217><a id=__codelineno-42-217 name=__codelineno-42-217 href=#__codelineno-42-217></a><span class=w>  </span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"custom.googleapis.com/airflow/vm_automation_failures"</span>
</span><span id=__span-42-218><a id=__codelineno-42-218 name=__codelineno-42-218 href=#__codelineno-42-218></a><span class=w>  </span><span class=na>metric_kind</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"GAUGE"</span>
</span><span id=__span-42-219><a id=__codelineno-42-219 name=__codelineno-42-219 href=#__codelineno-42-219></a><span class=w>  </span><span class=na>value_type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"INT64"</span>
</span><span id=__span-42-220><a id=__codelineno-42-220 name=__codelineno-42-220 href=#__codelineno-42-220></a><span class=w>  </span><span class=na>unit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"1"</span>
</span><span id=__span-42-221><a id=__codelineno-42-221 name=__codelineno-42-221 href=#__codelineno-42-221></a><span class=p>}</span><span class=w> </span>
</span></code></pre></div> <h2 id=results-and-impact>Results and Impact<a class=headerlink href=#results-and-impact title="Permanent link">¶</a></h2> <p>The pipeline successfully processes a thousand of Reddit posts daily, generates concise and meaningful summaries, identifies key trends and discussions, maintains high accuracy in content filtering, provides real-time insights through a web interface. </p> <h2 id=future-improvements>Future Improvements<a class=headerlink href=#future-improvements title="Permanent link">¶</a></h2> <ol> <li><strong>Enhanced Analysis</strong><ul> <li>Integration with additional AI models</li> <li>Advanced visualization features</li> <li>Real-time analysis capabilities</li> </ul> </li> <li><strong>System Scalability</strong><ul> <li>Distributed processing implementation</li> <li>Enhanced caching mechanisms</li> <li>API endpoint for analysis access</li> </ul> </li> <li><strong>User Experience</strong><ul> <li>Interactive dashboard development</li> <li>Customizable analysis parameters</li> <li>Trend prediction features</li> </ul> </li> </ol> <h2 id=conclusion>Conclusion<a class=headerlink href=#conclusion title="Permanent link">¶</a></h2> <p>This project showcases the power of automation in extracting valuable insights from social media using AI and data engineering, while handling real-world challenges. The open-source code is on GitHub, and welcome community contributions.</p> <h2 id=resources-and-references>Resources and References<a class=headerlink href=#resources-and-references title="Permanent link">¶</a></h2> <ul> <li><a href=https://github.com/SulmanK/reddit_ai_pulse_cloud_public>Project GitHub Repository</a></li> <li><a href=https://reddit-ai-pulse.vercel.app/ >Web Application</a></li> </ul> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../../08/Reddit%20AI%20Pulse%20%28On-Prem%29/ class="md-footer__link md-footer__link--prev" aria-label="Previous: From Reddit to Insights: Building an AI-Powered Data Pipeline with Gemini (On-Prem)"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> From Reddit to Insights: Building an AI-Powered Data Pipeline with Gemini (On-Prem) </div> </div> </a> <a href=../../../05/19/concept-visualizer-technical-deep-dive/ class="md-footer__link md-footer__link--next" aria-label="Next: Concept Visualizer: An AI-Powered Design Tool - Technical Deep Dive"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Concept Visualizer: An AI-Powered Design Tool - Technical Deep Dive </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://www.linkedin.com/in/sulman-khan target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"></path></svg> </a> <a href=https://github.com/sulmank target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"annotate": null, "base": "../../../../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../../../../assets/javascripts/bundle.79ae519e.min.js></script> <script src=../../../../../javascripts/mathjax.js></script> <script src=../../../../../javascripts/analytics.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> <script id=init-glightbox>const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>